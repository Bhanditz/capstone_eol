<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>app/models/data_object.rb</title>
    <link href="screen.css" media="all" rel="stylesheet" type="text/css" />
    <link href="print.css" media="print" rel="stylesheet" type="text/css" />
    
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <script type="text/javascript" src="rcov.js"></script>
  </head>
  <body>
    <h1>Eol C0 Coverage Information - RCov</h1>
    <h2>app/models/data_object.rb</h2>

    

    <div class="report_table_wrapper">
      <table class='report' id='report_table'>
        <thead>
          <tr>
            <th class="left_align">Name</th>
            <th class="right_align">Total Lines</th>
            <th class="right_align">Lines of Code</th>
            <th class="left_align">Total Coverage</th>
            <th class="left_align">Code Coverage</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="left_align"><a href="app-models-data_object_rb.html">app/models/data_object.rb</a></td>
            <td class='right_align'><tt>1694</tt></td>
            <td class='right_align'><tt>1277</tt></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>76.15%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:76px"></div>
            <div class="uncovered" style="width:24px"></div>
          </div></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>69.69%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:70px"></div>
            <div class="uncovered" style="width:30px"></div>
          </div></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <h3>Key</h3>
    
    <div class="key"><pre><span class='marked'>Code reported as executed by Ruby looks like this...</span><span class='marked1'>and this: this line is also marked as covered.</span><span class='inferred'>Lines considered as run by rcov, but not reported by Ruby, look like this,</span><span class='inferred1'>and this: these lines were inferred by rcov (using simple heuristics).</span><span class='uncovered'>Finally, here's a line marked as not executed.</span></pre></div>

    <h3>Coverage Details</h3>

    <table class="details">
      <tbody>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1">1</a> require 'set'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line2">2</a> require 'uuid'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line3">3</a> require 'erb'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line4">4</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line5">5</a> # Represents any kind of object imported from a ContentPartner, eg. an image, article, video, etc.  This is one</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line6">6</a> # of our primary models, and an awful lot of work occurs here.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line7">7</a> class DataObject &lt; SpeciesSchemaModel</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line8">8</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line9">9</a>   include ModelQueryHelper</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line10">10</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line11">11</a>   belongs_to :data_type</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line12">12</a>   belongs_to :language</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line13">13</a>   belongs_to :license</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line14">14</a>   belongs_to :mime_type</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line15">15</a>   belongs_to :visibility</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line16">16</a>   belongs_to :vetted</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line17">17</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line18">18</a>   has_many :top_images</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line19">19</a>   has_many :feed_data_objects</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line20">20</a>   has_many :top_concept_images</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line21">21</a>   has_many :languages</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line22">22</a>   has_many :agents_data_objects, :include =&gt; [ :agent, :agent_role ]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line23">23</a>   has_many :data_objects_hierarchy_entries</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line24">24</a>   has_many :comments, :as =&gt; :parent</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line25">25</a>   has_many :data_objects_harvest_events</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line26">26</a>   has_many :harvest_events, :through =&gt; :data_objects_harvest_events</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line27">27</a>   has_many :agents, :through =&gt; :agents_data_objects</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line28">28</a>   has_many :data_object_tags, :class_name =&gt; DataObjectTags.to_s</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line29">29</a>   has_many :tags, :class_name =&gt; DataObjectTag.to_s, :through =&gt; :data_object_tags, :source =&gt; :data_object_tag</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line30">30</a>   has_many :data_objects_table_of_contents</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line31">31</a>   has_many :data_objects_untrust_reasons</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line32">32</a>   has_many :untrust_reasons, :through =&gt; :data_objects_untrust_reasons</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line33">33</a>   has_many :data_objects_info_items</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line34">34</a>   has_many :info_items, :through =&gt; :data_objects_info_items</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line35">35</a>   has_many :user_ignored_data_objects</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line36">36</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line37">37</a>   has_and_belongs_to_many :hierarchy_entries</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line38">38</a>   has_and_belongs_to_many :audiences</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line39">39</a>   has_and_belongs_to_many :refs</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line40">40</a>   has_and_belongs_to_many :agents</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line41">41</a>   has_and_belongs_to_many :toc_items, :join_table =&gt; 'data_objects_table_of_contents', :association_foreign_key =&gt; 'toc_id'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line42">42</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line43">43</a>   attr_accessor :vetted_by # who changed the state of this object? (not persisted on DataObject but required by observer)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line44">44</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line45">45</a>   named_scope :visible, lambda { { :conditions =&gt; { :visibility_id =&gt; Visibility.visible.id } }}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line46">46</a>   named_scope :preview, lambda { { :conditions =&gt; { :visibility_id =&gt; Visibility.preview.id } }}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line47">47</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line48">48</a>   # for RSS feeds</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line49">49</a>   def self.for_feeds(type = :all, taxon_concept_id = nil, max_results = 100)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line50">50</a>     if type == :text</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line51">51</a>       data_type_ids = [DataType.text_type_ids[0]]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line52">52</a>     elsif type == :images</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line53">53</a>       data_type_ids = [DataType.image_type_ids[0]]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line54">54</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line55">55</a>       data_type_ids = [DataType.image_type_ids[0], DataType.text_type_ids[0]]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line56">56</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line57">57</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line58">58</a>     if taxon_concept_id.nil?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line59">59</a>       lookup_ids = HierarchyEntry.find_all_by_hierarchy_id_and_parent_id(Hierarchy.default.id, 0).collect{|he| he.taxon_concept_id}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line60">60</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line61">61</a>       lookup_ids = [taxon_concept_id]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line62">62</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line63">63</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line64">64</a>     data_object_ids = SpeciesSchemaModel.connection.execute(&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line65">65</a>       SELECT do.id, do.guid, do.created_at</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line66">66</a>       FROM feed_data_objects fdo</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line67">67</a>       JOIN #{DataObject.full_table_name} do ON (fdo.data_object_id=do.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line68">68</a>       WHERE fdo.taxon_concept_id IN (#{lookup_ids.join(',')})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line69">69</a>       AND do.published=1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line70">70</a>       AND do.data_type_id IN (#{data_type_ids.join(',')})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line71">71</a>       AND do.created_at IS NOT NULL</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line72">72</a>       AND do.created_at != '0000-00-00 00:00:00'&quot;).all_hashes.uniq</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line73">73</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line74">74</a>     return [] if data_object_ids.blank?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line75">75</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line76">76</a>     data_object_ids.sort! do |a, b|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line77">77</a>       b['created_at'] &lt;=&gt; a['created_at']</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line78">78</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line79">79</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line80">80</a>     details = details_for_objects(data_object_ids[0...max_results].collect{|obj| obj['id']}, :skip_refs =&gt; true)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line81">81</a>     return [] if details.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line82">82</a>     return details</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line83">83</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line84">84</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line85">85</a>   #----- user submitted text --------</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line86">86</a>   def self.update_user_text(all_params, user)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line87">87</a>     dato = DataObject.find(all_params[:id])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line88">88</a>     if dato.user.id != user.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line89">89</a>       raise 'Not original author'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line90">90</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line91">91</a>     taxon_concept = TaxonConcept.find(all_params[:taxon_concept_id])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line92">92</a>     do_params = {</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line93">93</a>       :guid =&gt; dato.guid,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line94">94</a>       :identifier =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line95">95</a>       :data_type =&gt; DataType.find_by_label('Text'),</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line96">96</a>       :rights_statement =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line97">97</a>       :rights_holder =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line98">98</a>       :mime_type_id =&gt; MimeType.find_by_label('text/plain').id,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line99">99</a>       :location =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line100">100</a>       :latitude =&gt; 0,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line101">101</a>       :longitude =&gt; 0,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line102">102</a>       :bibliographic_citation =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line103">103</a>       :source_url =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line104">104</a>       :altitude =&gt; 0,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line105">105</a>       :object_url =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line106">106</a>       :thumbnail_url =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line107">107</a>       :object_title =&gt; ERB::Util.h(all_params[:data_object][:object_title]), # No HTML allowed</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line108">108</a>       :description =&gt; all_params[:data_object][:description].allow_some_html,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line109">109</a>       :language_id =&gt; all_params[:data_object][:language_id],</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line110">110</a>       :license_id =&gt; all_params[:data_object][:license_id],</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line111">111</a>       :vetted_id =&gt; (user.can_curate?(taxon_concept) ? Vetted.trusted.id : Vetted.unknown.id),</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line112">112</a>       :published =&gt; 1, #not sure if this is right</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line113">113</a>       :visibility_id =&gt; Visibility.visible.id #not sure if this is right either</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line114">114</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line115">115</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line116">116</a>     d = DataObject.new(do_params)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line117">117</a>     d.toc_items &lt;&lt; TocItem.find(all_params[:data_objects_toc_category][:toc_id])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line118">118</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line119">119</a>     unless all_params[:references].blank?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line120">120</a>       all_params[:references].each do |reference|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line121">121</a>         d.refs &lt;&lt; Ref.new({:full_reference =&gt; reference, :user_submitted =&gt; true, :published =&gt; 1, :visibility =&gt; Visibility.visible}) if reference.strip != ''</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line122">122</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line123">123</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line124">124</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line125">125</a>     d.save!</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line126">126</a>     dato.published = false</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line127">127</a>     dato.save!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line128">128</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line129">129</a>     comments_from_old_dato = Comment.find(:all, :conditions =&gt; {:parent_id =&gt; dato.id})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line130">130</a>     comments_from_old_dato.map { |c| c.update_attribute :parent_id, d.id  }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line131">131</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line132">132</a>     d.curator_activity_flag(user, all_params[:taxon_concept_id])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line133">133</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line134">134</a>     udo = UsersDataObject.new({:user_id =&gt; user.id, :data_object_id =&gt; d.id, :taxon_concept_id =&gt; TaxonConcept.find(all_params[:taxon_concept_id]).id})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line135">135</a>     udo.save!</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line136">136</a>     user.track_curator_activity(udo, 'users_submitted_text', 'update')</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line137">137</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line138">138</a>     # this will give it the hash elements it needs for attributions</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line139">139</a>     d['attributions'] = Attributions.from_agents_hash(d, nil)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line140">140</a>     d['users'] = [user]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line141">141</a>     d['refs'] = d.refs unless d.refs.empty?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line142">142</a>     d</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line143">143</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line144">144</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line145">145</a>   def self.preview_user_text(all_params, user)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line146">146</a>     taxon_concept = TaxonConcept.find(all_params[:taxon_concept_id])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line147">147</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line148">148</a>     do_params = {</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line149">149</a>       :guid =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line150">150</a>       :identifier =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line151">151</a>       :data_type =&gt; DataType.text,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line152">152</a>       :rights_statement =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line153">153</a>       :rights_holder =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line154">154</a>       :mime_type_id =&gt; MimeType.find_by_label('text/plain').id,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line155">155</a>       :location =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line156">156</a>       :latitude =&gt; 0,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line157">157</a>       :longitude =&gt; 0,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line158">158</a>       :object_title =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line159">159</a>       :bibliographic_citation =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line160">160</a>       :source_url =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line161">161</a>       :altitude =&gt; 0,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line162">162</a>       :object_url =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line163">163</a>       :thumbnail_url =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line164">164</a>       :object_title =&gt; ERB::Util.h(all_params[:data_object][:object_title]), # No HTML allowed</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line165">165</a>       :description =&gt; all_params[:data_object][:description].allow_some_html,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line166">166</a>       :language_id =&gt; all_params[:data_object][:language_id],</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line167">167</a>       :license_id =&gt; all_params[:data_object][:license_id],</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line168">168</a>       :vetted_id =&gt; (user.can_curate?(taxon_concept) ? Vetted.trusted.id : Vetted.unknown.id),</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line169">169</a>       :published =&gt; 1, #not sure if this is right</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line170">170</a>       :visibility_id =&gt; Visibility.visible.id #not sure if this is right either</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line171">171</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line172">172</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line173">173</a>     d = DataObject.new(do_params)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line174">174</a>     d.toc_items &lt;&lt; TocItem.find(all_params[:data_objects_toc_category][:toc_id])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line175">175</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line176">176</a>     unless all_params[:references].blank?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line177">177</a>       all_params[:references].each do |reference|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line178">178</a>         d.refs &lt;&lt; Ref.new({:full_reference =&gt; reference, :user_submitted =&gt; true, :published =&gt; 1, :visibility =&gt; Visibility.visible}) if reference.strip != ''</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line179">179</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line180">180</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line181">181</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line182">182</a>     # this will give it the hash elements it needs for attributions</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line183">183</a>     d['attributions'] = Attributions.from_agents_hash(d, nil)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line184">184</a>     d['users'] = [user]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line185">185</a>     d['refs'] = d.refs unless d.refs.empty?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line186">186</a>     d</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line187">187</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line188">188</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line189">189</a>   def self.create_user_text(all_params,user)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line190">190</a>     taxon_concept = TaxonConcept.find(all_params[:taxon_concept_id])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line191">191</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line192">192</a>     if defined?(PhusionPassenger)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line193">193</a>       UUID.state_file(0664) # Makes the file writable, which we seem to need to do with Passenger...</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line194">194</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line195">195</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line196">196</a>     do_params = {</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line197">197</a>       :guid =&gt; UUID.generate.gsub('-',''),</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line198">198</a>       :identifier =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line199">199</a>       :data_type =&gt; DataType.text,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line200">200</a>       :rights_statement =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line201">201</a>       :rights_holder =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line202">202</a>       :mime_type_id =&gt; MimeType.find_by_label('text/plain').id,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line203">203</a>       :location =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line204">204</a>       :latitude =&gt; 0,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line205">205</a>       :longitude =&gt; 0,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line206">206</a>       :object_title =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line207">207</a>       :bibliographic_citation =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line208">208</a>       :source_url =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line209">209</a>       :altitude =&gt; 0,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line210">210</a>       :object_url =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line211">211</a>       :thumbnail_url =&gt; '',</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line212">212</a>       :object_title =&gt; ERB::Util.h(all_params[:data_object][:object_title]), # No HTML allowed</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line213">213</a>       :description =&gt; all_params[:data_object][:description].allow_some_html,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line214">214</a>       :language_id =&gt; all_params[:data_object][:language_id],</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line215">215</a>       :license_id =&gt; all_params[:data_object][:license_id],</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line216">216</a>       :vetted_id =&gt; (user.can_curate?(taxon_concept) ? Vetted.trusted.id : Vetted.unknown.id),</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line217">217</a>       :published =&gt; 1, #not sure if this is right</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line218">218</a>       :visibility_id =&gt; Visibility.visible.id #not sure if this is right either</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line219">219</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line220">220</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line221">221</a>     dato = DataObject.new(do_params)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line222">222</a>     dato.toc_items &lt;&lt; TocItem.find(all_params[:data_objects_toc_category][:toc_id])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line223">223</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line224">224</a>     unless all_params[:references].blank?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line225">225</a>       all_params[:references].each do |reference|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line226">226</a>         dato.refs &lt;&lt; Ref.new({:full_reference =&gt; reference, :user_submitted =&gt; true, :published =&gt; 1, :visibility =&gt; Visibility.visible}) if reference.strip != ''</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line227">227</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line228">228</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line229">229</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line230">230</a>     dato.save!</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line231">231</a>     dato.curator_activity_flag(user, all_params[:taxon_concept_id])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line232">232</a>     raise &quot;Unable to build a UsersDataObject if user is nil&quot; if user.nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line233">233</a>     raise &quot;Unable to build a UsersDataObject if DataObject is nil&quot; if dato.nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line234">234</a>     raise &quot;Unable to build a UsersDataObject if taxon_concept_id is missing&quot; if all_params[:taxon_concept_id].blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line235">235</a>     udo = UsersDataObject.new(:user_id =&gt; user.id, :data_object_id =&gt; dato.id,</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line236">236</a>                               :taxon_concept_id =&gt; taxon_concept.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line237">237</a>     udo.save!</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line238">238</a>     user.track_curator_activity(udo, 'users_submitted_text', 'create')</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line239">239</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line240">240</a>     # this will give it the hash elements it needs for attributions</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line241">241</a>     dato['attributions'] = Attributions.from_agents_hash(dato, nil)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line242">242</a>     dato['users'] = [user]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line243">243</a>     dato['refs'] = dato.refs unless dato.refs.empty?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line244">244</a>     dato</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line245">245</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line246">246</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line247">247</a>   def created_by_user?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line248">248</a>     user != nil</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line249">249</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line250">250</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line251">251</a>   def user</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line252">252</a>     @udo ||= UsersDataObject.find_by_data_object_id(id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line253">253</a>     @udo_user ||= @udo.nil? ? nil : User.find(@udo.user_id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line254">254</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line255">255</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line256">256</a>   def taxon_concept_for_users_text</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line257">257</a>     unless user.nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line258">258</a>       udo = UsersDataObject.find_by_data_object_id(id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line259">259</a>       TaxonConcept.find(udo.taxon_concept_id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line260">260</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line261">261</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line262">262</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line263">263</a>   #----- end of user submitted text --------</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line264">264</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line265">265</a>   def subtitle_to_show</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line266">266</a>     if object_title.blank? &amp;&amp; !info_items.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line267">267</a>       subtitle = info_items.first.label</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line268">268</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line269">269</a>       subtitle = object_title</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line270">270</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line271">271</a>     return subtitle</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line272">272</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line273">273</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line274">274</a>   def rate(user,stars)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line275">275</a>     rating = UsersDataObjectsRating.find_by_data_object_guid_and_user_id(guid, user.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line276">276</a>     if rating.nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line277">277</a>       rating = UsersDataObjectsRating.new({:data_object_guid =&gt; guid, :user_id =&gt; user.id, :rating =&gt; stars})</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line278">278</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line279">279</a>       rating.rating = stars</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line280">280</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line281">281</a>     rating.save!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line282">282</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line283">283</a>     total = 0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line284">284</a>     ratings = UsersDataObjectsRating.find_all_by_data_object_guid(guid)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line285">285</a>     ratings.each do |rating|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line286">286</a>       total += rating.rating</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line287">287</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line288">288</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line289">289</a>     divisor = ratings.length</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line290">290</a>     if divisor == 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line291">291</a>       self.data_rating = total</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line292">292</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line293">293</a>       self.data_rating = total / ratings.length</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line294">294</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line295">295</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line296">296</a>     self.save!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line297">297</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line298">298</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line299">299</a>   def rating_for_user(user)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line300">300</a>     UsersDataObjectsRating.find_by_data_object_guid_and_user_id(guid, user.id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line301">301</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line302">302</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line303">303</a>   # Add a comment to this data object</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line304">304</a>   def comment(user, body)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line305">305</a>     comment = comments.create :user_id =&gt; user.id, :body =&gt; body</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line306">306</a>     user.comments.reload # be friendly - update the user's comments automatically</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line307">307</a>     return comment</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line308">308</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line309">309</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line310">310</a>   # Test whether a user has curator rights on this object</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line311">311</a>   def is_curatable_by? user</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line312">312</a>     taxon_concepts.collect {|tc| tc.is_curatable_by?(user) }.include?(true)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line313">313</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line314">314</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line315">315</a>   # Find the Agent (only one) that supplied this data object to EOL.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line316">316</a>   def data_supplier_agent</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line317">317</a>     @data_supplier_agent ||= Agent.find_by_sql([&quot;SELECT a.*</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line318">318</a>                         FROM data_objects_harvest_events dohe</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line319">319</a>                           JOIN harvest_events he ON (dohe.harvest_event_id=he.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line320">320</a>                           JOIN agents_resources ar ON (he.resource_id=ar.resource_id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line321">321</a>                           JOIN agents a ON (ar.agent_id=a.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line322">322</a>                         WHERE dohe.data_object_id=?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line323">323</a>                         AND ar.resource_agent_role_id=?&quot;, id,</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line324">324</a>                         ResourceAgentRole.data_supplier.id]).first</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line325">325</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line326">326</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line327">327</a>   # Gets agents_data_objects, sorted by AgentRole, based on this objects' DataTypes' AgentRole attribution</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line328">328</a>   # priorities</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line329">329</a>   #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line330">330</a>   # we also fetch agents_data_objects, including (eager loading) Agents by default, assuming we will be using them</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line331">331</a>   def attributions</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line332">332</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line333">333</a>     @attributions = Attributions.new(agents_data_objects)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line334">334</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line335">335</a>     @attributions.add_supplier   self.data_supplier_agent</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line336">336</a>     @attributions.add_rights     self.rights_statement, self.rights_holder</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line337">337</a>     @attributions.add_license    self.license</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line338">338</a>     @attributions.add_location   self.location</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line339">339</a>     @attributions.add_source_url self.source_url</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line340">340</a>     @attributions.add_date       self.created_at</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line341">341</a>     @attributions.add_citation   self.bibliographic_citation</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line342">342</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line343">343</a>     return @attributions</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line344">344</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line345">345</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line346">346</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line347">347</a>   # Find all of the authors associated with this data object, including those that we dynamically add elsewhere</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line348">348</a>   def authors</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line349">349</a>     default_authors = agents_data_objects.find_all_by_agent_role_id(AgentRole.author_id).collect {|ado| ado.agent }.compact</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line350">350</a>     @fake_authors.nil? ? default_authors : default_authors + @fake_authors</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line351">351</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line352">352</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line353">353</a>   # Find all of the photographers associated with this data object, including those that we dynamically add elsewhere</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line354">354</a>   def photographers</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line355">355</a>     agents_data_objects.find_all_by_agent_role_id(AgentRole.photographer_id).collect {|ado| ado.agent }.compact</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line356">356</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line357">357</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line358">358</a>   # Add an author to this data object that isn't in the database.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line359">359</a>   def fake_author(author_options)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line360">360</a>     @fake_authors ||= []</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line361">361</a>     @fake_authors &lt;&lt; Agent.new(author_options)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line362">362</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line363">363</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line364">364</a>   # Find Agents associated with this data object as sources.  If there are none, find authors.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line365">365</a>   def sources</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line366">366</a>     list = agents_data_objects.find_all_by_agent_role_id(AgentRole.source_id).collect {|ado| ado.agent }.compact</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line367">367</a>     return list unless list.blank?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line368">368</a>     # I ended up with empty lists in cases where I thought I shouldn't, so tried to defer to authors for those:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line369">369</a>     return authors</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line370">370</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line371">371</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line372">372</a>   def revisions</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line373">373</a>     DataObject.find_all_by_guid(guid)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line374">374</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line375">375</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line376">376</a>   def all_comments</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line377">377</a>     all_comments = []</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line378">378</a>     revisions.each do |parent|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line379">379</a>       all_comments += Comment.find_all_by_parent_id(parent.id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line380">380</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line381">381</a>     return all_comments</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line382">382</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line383">383</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line384">384</a>   def visible_comments(user = nil)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line385">385</a>     return comments if (not user.nil?) and user.is_moderator?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line386">386</a>     comments.find_all {|comment| comment.visible? }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line387">387</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line388">388</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line389">389</a>   def image?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line390">390</a>     return DataType.image_type_ids.include?(data_type_id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line391">391</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line392">392</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line393">393</a>   def map?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line394">394</a>     return DataType.map_type_ids.include?(data_type_id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line395">395</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line396">396</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line397">397</a>   def text?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line398">398</a>     return DataType.text_type_ids.include?(data_type_id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line399">399</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line400">400</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line401">401</a>   def video?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line402">402</a>     return DataType.video_type_ids.include?(data_type_id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line403">403</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line404">404</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line405">405</a>   def self.cache_path(cache_url, subdir = $CONTENT_SERVER_CONTENT_PATH)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line406">406</a>     (ContentServer.next + subdir + cache_url_to_path(cache_url))</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line407">407</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line408">408</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line409">409</a>   def self.cache_url_to_path(cache_url)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line410">410</a>     cache_url.to_s.gsub(/(\d{4})(\d{2})(\d{2})(\d{2})(\d+)/, &quot;/\\1/\\2/\\3/\\4/\\5&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line411">411</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line412">412</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line413">413</a>   def self.image_cache_path(cache_url, size = :large, subdir = $CONTENT_SERVER_CONTENT_PATH)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line414">414</a>     size = size ? &quot;_&quot; + size.to_s : ''</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line415">415</a>     cache_path(cache_url, subdir) + &quot;#{size}.#{$SPECIES_IMAGE_FORMAT}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line416">416</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line417">417</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line418">418</a>   def has_thumbnail_cache?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line419">419</a>     return false if thumbnail_cache_url.blank? or thumbnail_cache_url == 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line420">420</a>     return true</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line421">421</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line422">422</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line423">423</a>   def has_object_cache_url?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line424">424</a>     return false if object_cache_url.blank? or object_cache_url == 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line425">425</a>     return true</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line426">426</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line427">427</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line428">428</a>   def thumb_or_object(size = :large)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line429">429</a>     return DataObject.image_cache_path(object_cache_url, size)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line430">430</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line431">431</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line432">432</a>   # Returns the src when you want an image tag containing a thumbnail.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line433">433</a>   def smart_thumb</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line434">434</a>     thumb_or_object(:small)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line435">435</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line436">436</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line437">437</a>   # Returns the src when you want an image tag containing a &quot;larger&quot; thumbnail (a'la main page).</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line438">438</a>   def smart_medium_thumb</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line439">439</a>     thumb_or_object(:medium)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line440">440</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line441">441</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line442">442</a>   # Returns the src when you want an image tag containing the *full* image.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line443">443</a>   def smart_image</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line444">444</a>     thumb_or_object</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line445">445</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line446">446</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line447">447</a>   def original_image</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line448">448</a>     thumb_or_object(nil)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line449">449</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line450">450</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line451">451</a>   def video_url</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line452">452</a>     if data_type.label == 'Flash'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line453">453</a>       return has_object_cache_url? ? DataObject.cache_path(object_cache_url) + '.flv' : ''</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line454">454</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line455">455</a>       return object_url</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line456">456</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line457">457</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line458">458</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line459">459</a>   def map_image</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line460">460</a>     # Sometimes, we want to serve map images right from the source:</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line461">461</a>     if ($PREFER_REMOTE_IMAGES and not object_url.blank?) or (object_cache_url.blank?)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line462">462</a>       return object_url</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line463">463</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line464">464</a>       return DataObject.cache_path(object_cache_url) + &quot;_orig.jpg&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line465">465</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line466">466</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line467">467</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line468">468</a>   # This allows multiple values, eg: 'red, blue' or 'red blue'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line469">469</a>   def tag(key, values, user)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line470">470</a>     raise &quot;You must be logged in to add tags.&quot;[] unless user</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line471">471</a>     key = 'none' if key.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line472">472</a>     return unless values</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line473">473</a>     values = DataObjectTag.clean_values(values)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line474">474</a>     values.each do |value|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line475">475</a>       tag = DataObjectTag.find_or_create_by_key_and_value key.to_s, value.to_s</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line476">476</a>       if user.tags_are_public_for_data_object?(self)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line477">477</a>         tag.update_attributes!(:is_public =&gt; true)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line478">478</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line479">479</a>       begin</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line480">480</a>         DataObjectTags.create :data_object =&gt; self, :data_object_guid =&gt; guid, :data_object_tag =&gt; tag, :user =&gt; user</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line481">481</a>       rescue</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line482">482</a>         raise FailedToCreateTag.new(&quot;Failed to add #{key}:#{value} tag&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line483">483</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line484">484</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line485">485</a>     tags.reset</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line486">486</a>     user.tags.reset</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line487">487</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line488">488</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line489">489</a>   def public_tags</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line490">490</a>     DataObjectTags.public_tags_for_data_object self</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line491">491</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line492">492</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line493">493</a>   # Names of taxa associated with this image</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line494">494</a>   def taxa_names_taxon_concept_ids</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line495">495</a>     results = SpeciesSchemaModel.connection.execute(&quot;SELECT n.string, he.taxon_concept_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line496">496</a>         FROM data_objects_hierarchy_entries dohe</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line497">497</a>         JOIN hierarchy_entries he ON (dohe.hierarchy_entry_id=he.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line498">498</a>         JOIN names n ON (he.name_id=n.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line499">499</a>         WHERE dohe.data_object_id = #{id}&quot;).all_hashes</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line500">500</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line501">501</a>     results.map{|r| {:taxon_name =&gt; r['string'], :taxon_concept_id =&gt; r['taxon_concept_id']}}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line502">502</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line503">503</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line504">504</a>   # returns a hash in the format { 'tag_key' =&gt; ['value1','value2'] }</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line505">505</a>   def tags_hash</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line506">506</a>     tags.inject({}) do |all,this|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line507">507</a>       all[this.key] = (all[this.key] || []) + [this.value]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line508">508</a>       all</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line509">509</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line510">510</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line511">511</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line512">512</a>   # returns an array of all of the keys an object is tagged with</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line513">513</a>   def tag_keys</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line514">514</a>     tags.map {|t| t.key }.uniq</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line515">515</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line516">516</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line517">517</a>   # TODO: Make documentation rdoc compatible</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line518">518</a>   # Return taxon concepts directly associated with this Dato.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line519">519</a>   # default - returns all taxon concepts</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line520">520</a>   # options:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line521">521</a>   # :published -&gt; strict - return only published taxon concepts</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line522">522</a>   # :selective -&gt; preferred same as above, but returns unpublished taxon concepts if no published ones are found</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line523">523</a>   def taxon_concepts(opts = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line524">524</a>     return @taxon_concepts if @taxon_concepts</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line525">525</a>     if created_by_user?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line526">526</a>       @taxon_concepts = [taxon_concept_for_users_text]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line527">527</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line528">528</a>       query = &quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line529">529</a>         SELECT distinct tc.*</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line530">530</a>         FROM hierarchy_entries he</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line531">531</a>         JOIN taxon_concepts tc on he.taxon_concept_id = tc.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line532">532</a>         JOIN data_objects_hierarchy_entries dh on dh.hierarchy_entry_id = he.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line533">533</a>         WHERE dh.data_object_id = ?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line534">534</a>         ORDER BY tc.id -- DataObject#taxon_concepts(true)&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line535">535</a>       @taxon_concepts = TaxonConcept.find_by_sql([query, id])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line536">536</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line537">537</a>     tc, tc_with_supercedure = @taxon_concepts.partition {|item| item.supercedure_id == 0}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line538">538</a>     # find is aliased to recursive method to find taxon_concept without supercedure_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line539">539</a>     tc += tc_with_supercedure.map {|item| TaxonConcept.find(item.id)}.compact</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line540">540</a>     if opts[:published]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line541">541</a>       published, unpublished = tc.partition {|item| item.published?}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line542">542</a>       @taxon_concepts = (!published.empty? || opts[:published] == :strict) ? published : unpublished</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line543">543</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line544">544</a>       @taxon_concepts = tc</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line545">545</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line546">546</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line547">547</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line548">548</a>   def linked_taxon_concept</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line549">549</a>     if created_by_user?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line550">550</a>       @taxon_concept ||= taxon_concept_for_users_text</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line551">551</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line552">552</a>       @taxon_concept ||= TaxonConcept.find_by_sql([&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line553">553</a>         SELECT tc.*</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line554">554</a>         FROM data_objects_hierarchy_entries dohe</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line555">555</a>         JOIN hierarchy_entries he ON (dohe.hierarchy_entry_id=he.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line556">556</a>         JOIN taxon_concepts tc ON (he.taxon_concept_id=tc.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line557">557</a>         WHERE dohe.data_object_id=?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line558">558</a>         ORDER BY tc.id -- DataObject#taxon_concepts</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line559">559</a>       &quot;, id])[0]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line560">560</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line561">561</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line562">562</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line563">563</a>   # Return all of the HEs associated with this Dato.  Not necessarily all the pages it shows up on,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line564">564</a>   # however, as Zea mays image will show up on Plantae</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line565">565</a>   def hierarchy_entries</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line566">566</a>     @hierarchy_entries ||= HierarchyEntry.find_by_sql([&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line567">567</a>       SELECT he.*</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line568">568</a>       FROM data_objects_hierarchy_entries dohe</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line569">569</a>       JOIN hierarchy_entries he ON (dohe.hierarchy_entry_id=he.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line570">570</a>       WHERE dohe.data_object_id=? -- DataObject#hierarchy_entries</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line571">571</a>     &quot;, id])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line572">572</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line573">573</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line574">574</a>   def harvested_ancestries</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line575">575</a>     hierarchy_entries = HierarchyEntry.find_by_sql([&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line576">576</a>       SELECT he.id, he.parent_id, he.name_id, he.published, he.taxon_concept_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line577">577</a>       FROM data_objects_hierarchy_entries dh</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line578">578</a>       JOIN hierarchy_entries he on he.id = dh.hierarchy_entry_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line579">579</a>       WHERE data_object_id = ?&quot; , id])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line580">580</a>     ancestries = []</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line581">581</a>     hierarchy_entries.each do |he|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line582">582</a>       ancestries &lt;&lt; he.get_ancestry</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line583">583</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line584">584</a>     ancestries</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line585">585</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line586">586</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line587">587</a>   def curate(vetted_id, visibility_id, user, untrust_reason_ids = [], comment = nil, taxon_concept_id = nil, untrust_reasons_comment = nil)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line588">588</a>     if vetted_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line589">589</a>       vetted_id = vetted_id.to_i</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line590">590</a>       if vetted_id == Vetted.untrusted.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line591">591</a>         untrust(user, untrust_reason_ids, comment, taxon_concept_id, untrust_reasons_comment)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line592">592</a>       elsif vetted_id == Vetted.trusted.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line593">593</a>         trust(user, comment, taxon_concept_id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line594">594</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line595">595</a>         raise &quot;Cannot set data object vetted id to #{vetted_id}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line596">596</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line597">597</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line598">598</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line599">599</a>     if visibility_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line600">600</a>       visibility_id = visibility_id.to_i</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line601">601</a>       if visibility_id == Visibility.visible.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line602">602</a>         show(user)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line603">603</a>       elsif visibility_id == Visibility.invisible.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line604">604</a>         hide(user)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line605">605</a>       elsif visibility_id == Visibility.inappropriate.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line606">606</a>         inappropriate(user)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line607">607</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line608">608</a>         raise &quot;Cannot set data object visibility id to #{visibility_id}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line609">609</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line610">610</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line611">611</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line612">612</a>     curator_activity_flag(user)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line613">613</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line614">614</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line615">615</a>   def show(user)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line616">616</a>     vetted_by = user</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line617">617</a>     update_attributes({:visibility_id =&gt; Visibility.visible.id, :curated =&gt; true})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line618">618</a>     user.track_curator_activity(self, 'data_object', 'show')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line619">619</a>     CuratorDataObjectLog.create :data_object =&gt; self, :user =&gt; user, :curator_activity =&gt; CuratorActivity.show</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line620">620</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line621">621</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line622">622</a>   def hide(user)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line623">623</a>     vetted_by = user</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line624">624</a>     update_attributes({:visibility_id =&gt; Visibility.invisible.id, :curated =&gt; true})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line625">625</a>     user.track_curator_activity(self, 'data_object', 'hide')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line626">626</a>     CuratorDataObjectLog.create :data_object =&gt; self, :user =&gt; user, :curator_activity =&gt; CuratorActivity.hide</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line627">627</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line628">628</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line629">629</a>   def trust(user, comment = nil, taxon_concept_id = nil)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line630">630</a>     vetted_by = user</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line631">631</a>     update_attributes({:vetted_id =&gt; Vetted.trusted.id, :curated =&gt; true})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line632">632</a>     DataObjectsUntrustReason.destroy_all(:data_object_id =&gt; id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line633">633</a>     added_comment = nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line634">634</a>     if comment &amp;&amp; !comment.blank?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line635">635</a>       added_comment = comment(user, comment)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line636">636</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line637">637</a>     user.track_curator_activity(self, 'data_object', 'trusted', :comment =&gt; added_comment, :taxon_concept_id =&gt; taxon_concept_id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line638">638</a>     CuratorDataObjectLog.create :data_object =&gt; self, :user =&gt; user, :curator_activity =&gt; CuratorActivity.approve</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line639">639</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line640">640</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line641">641</a>   def untrust(user, untrust_reason_ids = [], comment = nil, taxon_concept_id = nil, untrust_reasons_comment = nil)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line642">642</a>     vetted_by = user</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line643">643</a>     update_attributes({:vetted_id =&gt; Vetted.untrusted.id, :curated =&gt; true})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line644">644</a>     DataObjectsUntrustReason.destroy_all(:data_object_id =&gt; id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line645">645</a>     </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line646">646</a>     these_untrust_reasons = []</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line647">647</a>     if untrust_reason_ids</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line648">648</a>       untrust_reason_ids.each do |untrust_reason_id|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line649">649</a>         ur = UntrustReason.find(untrust_reason_id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line650">650</a>         these_untrust_reasons &lt;&lt; ur</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line651">651</a>         untrust_reasons &lt;&lt; ur</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line652">652</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line653">653</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line654">654</a>     unless untrust_reasons_comment.blank?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line655">655</a>       comment(user, untrust_reasons_comment)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line656">656</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line657">657</a>     added_comment = nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line658">658</a>     unless comment.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line659">659</a>       added_comment = comment(user, comment)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line660">660</a>     end </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line661">661</a>     user.track_curator_activity(self, 'data_object', 'untrusted', :comment =&gt; added_comment, :untrust_reasons =&gt; these_untrust_reasons, :taxon_concept_id =&gt; taxon_concept_id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line662">662</a>     CuratorDataObjectLog.create :data_object =&gt; self, :user =&gt; user, :curator_activity =&gt; CuratorActivity.disapprove</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line663">663</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line664">664</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line665">665</a>   def unreviewed(user)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line666">666</a>     vetted_by = user</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line667">667</a>     update_attributes({:vetted_id =&gt; Vetted.unknown.id, :curated =&gt; true})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line668">668</a>     DataObjectsUntrustReason.destroy_all(:data_object_id =&gt; id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line669">669</a>     user.track_curator_activity(self, 'data_object', 'unreviewed')</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line670">670</a>     CuratorDataObjectLog.create :data_object =&gt; self, :user =&gt; user, :curator_activity =&gt; CuratorActivity.unreviewed</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line671">671</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line672">672</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line673">673</a>   def inappropriate(user)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line674">674</a>     vetted_by = user</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line675">675</a>     update_attributes({:visibility_id =&gt; Visibility.inappropriate.id, :curated =&gt; true})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line676">676</a>     user.track_curator_activity(self, 'data_object', 'inappropriate')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line677">677</a>     CuratorDataObjectLog.create :data_object =&gt; self, :user =&gt; user, :curator_activity =&gt; CuratorActivity.inappropriate</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line678">678</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line679">679</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line680">680</a>   def curated?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line681">681</a>     curated</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line682">682</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line683">683</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line684">684</a>   def visible?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line685">685</a>     visibility_id == Visibility.visible.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line686">686</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line687">687</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line688">688</a>   def invisible?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line689">689</a>     visibility_id == Visibility.invisible.id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line690">690</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line691">691</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line692">692</a>   def inappropriate?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line693">693</a>     visibility_id == Visibility.inappropriate.id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line694">694</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line695">695</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line696">696</a>   def untrusted?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line697">697</a>     vetted_id == Vetted.untrusted.id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line698">698</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line699">699</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line700">700</a>   def unknown?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line701">701</a>     vetted_id == Vetted.unknown.id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line702">702</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line703">703</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line704">704</a>   def vetted?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line705">705</a>     vetted_id == Vetted.trusted.id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line706">706</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line707">707</a>   alias is_vetted? vetted?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line708">708</a>   alias trusted? vetted?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line709">709</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line710">710</a>   def preview?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line711">711</a>     visibility_id == Visibility.preview.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line712">712</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line713">713</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line714">714</a>   def in_wikipedia?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line715">715</a>     toc_items.include?(TocItem.wikipedia)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line716">716</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line717">717</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line718">718</a>   def publish_wikipedia_article</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line719">719</a>     return false unless in_wikipedia?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line720">720</a>     return false unless visibility_id == Visibility.preview.id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line721">721</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line722">722</a>     SpeciesSchemaModel.connection.execute(&quot;UPDATE data_objects SET published=0 WHERE guid='#{guid}'&quot;);</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line723">723</a>     reload</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line724">724</a>     self.visibility_id = Visibility.visible.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line725">725</a>     self.vetted_id = Vetted.trusted.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line726">726</a>     self.published = 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line727">727</a>     self.save!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line728">728</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line729">729</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line730">730</a>   def curator_activity_flag(user, taxon_concept_id = nil)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line731">731</a>     taxon_concept_id ||= taxon_concepts[0].id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line732">732</a>     return if taxon_concept_id == 0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line733">733</a>     if user and user.can_curate_taxon_concept_id? taxon_concept_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line734">734</a>       LastCuratedDate.create(:user_id =&gt; user.id,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line735">735</a>         :taxon_concept_id =&gt; taxon_concept_id,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line736">736</a>         :last_curated =&gt; Time.now)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line737">737</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line738">738</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line739">739</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line740">740</a>   def visible_references(options = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line741">741</a>     @all_refs ||= refs.delete_if {|r| r.published != 1 || r.visibility_id != Visibility.visible.id}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line742">742</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line743">743</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line744">744</a>   def to_s</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line745">745</a>     &quot;[DataObject id:#{id}]&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line746">746</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line747">747</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line748">748</a>   # Find data objects tagged with a particular tag</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line749">749</a>   #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line750">750</a>   # If no 'value' is provided for the tag, it will find all data objects</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line751">751</a>   # tagged with *any* value of the given key (category)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line752">752</a>   #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line753">753</a>   # Usage:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line754">754</a>   #   DataObject.search_by_tag :color, 'blue'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line755">755</a>   #   DataObject.search_by_tag :color, :blue</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line756">756</a>   #   DataObject.search_by_tag &lt;DataObjecTag&gt;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line757">757</a>   #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line758">758</a>   # TODO this is starting to get really messy ... extract some of this outta here into objects ...</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line759">759</a>   #      try a named_scope on TopImage and things like that ... move to other models or to other</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line760">760</a>   #      DataObject methods</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line761">761</a>   #</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line762">762</a>   def self.search_by_tag key_or_tag, value_or_nil = nil, options = {}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line763">763</a>     tag = (key_or_tag.is_a?DataObjectTag) ? key_or_tag : DataObjectTag[key_or_tag, value_or_nil]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line764">764</a>     data_object_tags = (tag) ? DataObjectTags.search_by_tag( tag ) : []</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line765">765</a>     return [] if data_object_tags.empty?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line766">766</a>     if options[:clade]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line767">767</a>       options[:clade] = [ options[:clade] ] unless options[:clade].is_a?Array</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line768">768</a>       data_object_ids = data_object_tags.map(&amp;:data_object_id).uniq</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line769">769</a>       clades = HierarchyEntry.find :all, :conditions =&gt; options[:clade].map {|id| &quot;id = #{id}&quot; }.join(' OR ')</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line770">770</a>       return [] if clades.empty?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line771">771</a>       sql = %[</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line772">772</a>         SELECT DISTINCT top_images.data_object_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line773">773</a>         FROM top_images</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line774">774</a>         JOIN hierarchy_entries ON top_images.hierarchy_entry_id = hierarchy_entries.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line775">775</a>         WHERE ]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line776">776</a>       sql += clades.map {|clade| &quot;(hierarchy_entries.lft &gt;= #{clade.lft} AND hierarchy_entries.lft &lt;= #{clade.rgt})&quot; }.join(' OR ')</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line777">777</a>       sql += %[ AND data_object_id IN (#{data_object_ids.join(',')})]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line778">778</a>       tagged_images_in_clade = TopImage.find_by_sql sql</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line779">779</a>       tagged_images_in_clade.map {|img| DataObject.find(img.data_object_id) }.uniq</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line780">780</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line781">781</a>       data_object_tags.map(&amp;:object).uniq</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line782">782</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line783">783</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line784">784</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line785">785</a>   # Find data objects tagged with certain tags</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line786">786</a>   #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line787">787</a>   # Usage:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line788">788</a>   #   DataObject.search_by_tags [ [&lt;DataObjecTag&gt;], [&lt;DataObjectTag&gt;, &lt;DataObjectTag] ]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line789">789</a>   #   DataObject.search_by_tags [ [[:key1,'value1']], [[:key2,:value2],['key3',:value3]] ]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line790">790</a>   #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line791">791</a>   # TODO: Optimization is necessary, the way it is now is quite resource hungry</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line792">792</a>   def self.search_by_tags tags, options = {}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line793">793</a>     t = tags.inject([]) do |res,tags_group|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line794">794</a>       if tags_group.first.is_a?(DataObjectTag)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line795">795</a>         res &lt;&lt; tags_group</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line796">796</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line797">797</a>         res &lt;&lt; tags_group.map {|k,v| DataObjectTag[k,v]}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line798">798</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line799">799</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line800">800</a>     result = t.inject(Set.new) do |res, tags_group|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line801">801</a>       search = (DataObject.search_tags_group(tags_group, options).to_set)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line802">802</a>       res = res ? search : res.intersection(search)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line803">803</a>     end.to_a</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line804">804</a>     result</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line805">805</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line806">806</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line807">807</a>   def self.search_tags_group tags, options</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line808">808</a>     tags.compact!</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line809">809</a>     return [] if tags.empty?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line810">810</a>     data_object_tags = DataObjectTags.search_by_tags_or tags, options[:user_id]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line811">811</a>     return [] if data_object_tags.empty?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line812">812</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line813">813</a>     return_objects = []</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line814">814</a>     data_object_tags.each do |dot|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line815">815</a>       if obj = DataObject.find_by_guid_and_published_and_visibility_id(dot.data_object_guid, 1, Visibility.visible.id, :order =&gt; 'id desc')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line816">816</a>         return_objects &lt;&lt; obj</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line817">817</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line818">818</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line819">819</a>     return return_objects</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line820">820</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line821">821</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line822">822</a>   def self.build_top_images_query(taxon, options = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line823">823</a>     join_hierarchy = join_agents = ''</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line824">824</a>     options[:unpublished] ||= false</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line825">825</a>     options[:filter_hierarchy] ||= nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line826">826</a>     from_table = options[:unpublished] ? 'top_unpublished_concept_images' : 'top_concept_images'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line827">827</a>     where_clause = &quot;ti.taxon_concept_id=#{taxon.id}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line828">828</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line829">829</a>     # filtering by hierarchy means we need the top_* tables which use hierarchy_entry_ids</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line830">830</a>     if !options[:filter_hierarchy].nil?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line831">831</a>       from_table = options[:unpublished] ? 'top_unpublished_images' : 'top_images'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line832">832</a>       join_hierarchy = &quot;JOIN hierarchy_entries he_filter ON (ti.hierarchy_entry_id=he_filter.id AND he_filter.hierarchy_id=#{options[:filter_hierarchy].id})&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line833">833</a>       where_clause = &quot;ti.hierarchy_entry_id IN (#{taxon.hierarchy_entries.collect {|he| he.id }.join(',')})&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line834">834</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line835">835</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line836">836</a>     # unpublished images require a few extra bits to the query:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line837">837</a>     if options[:unpublished]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line838">838</a>       from_cp = ', ar.agent_id agent_id'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line839">839</a>       join_agents = self.join_agents_clause(options[:agent])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line840">840</a>       # this next line will ensure we get ONLY the images the CP contributed, but admins see ALL preview images</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line841">841</a>       where_clause = where_clause + &quot; AND ar.agent_id IS NOT NULL&quot; unless options[:user].is_admin?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line842">842</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line843">843</a>       from_cp = ', NULL agent_id'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line844">844</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line845">845</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line846">846</a>     query_string = %Q{</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line847">847</a>       SELECT dato.id, dato.visibility_id, dato.data_rating, dato.vetted_id, dato.guid, v.view_order vetted_view_order #{from_cp}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line848">848</a>         FROM #{from_table} ti</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line849">849</a>           JOIN data_objects dato      ON ti.data_object_id = dato.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line850">850</a>           JOIN vetted v               ON dato.vetted_id = v.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line851">851</a>           #{join_agents}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line852">852</a>           #{join_hierarchy}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line853">853</a>         WHERE #{where_clause}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line854">854</a>           AND ti.view_order &lt;= #{$IMAGE_LIMIT.to_i}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line855">855</a>           #{DataObject.visibility_clause(options.merge(:taxon =&gt; taxon))} # DataObject.build_top_images_query</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line856">856</a>       }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line857">857</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line858">858</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line859">859</a>   def self.cached_images_for_taxon(taxon, options = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line860">860</a>     options[:user] = User.create_new if options[:user].nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line861">861</a>     if options[:filter_by_hierarchy] &amp;&amp; !options[:hierarchy].nil?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line862">862</a>       options[:filter_hierarchy] = options[:hierarchy]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line863">863</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line864">864</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line865">865</a>     top_images_query = DataObject.build_top_images_query(taxon, options)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line866">866</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line867">867</a>     # the user/agent has the ability to see some unpublished images, so create a UNION</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line868">868</a>     show_unpublished = ((not options[:agent].nil?) or options[:user].is_curator? or options[:user].is_admin?)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line869">869</a>     if show_unpublished</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line870">870</a>       options[:unpublished] = true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line871">871</a>       top_unpublished_images_query = DataObject.build_top_images_query(taxon, options)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line872">872</a>       top_images_query = &quot;(#{top_images_query}) UNION (#{top_unpublished_images_query})&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line873">873</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line874">874</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line875">875</a>     data_objects_result = DataObject.find_by_sql(top_images_query).uniq</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line876">876</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line877">877</a>     # when we have all the images then get the uniquq list and sort them by</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line878">878</a>     # vetted order ASC (so trusted are first), rating DESC (so best are first), id DESC (so newest are first)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line879">879</a>     data_objects_result.sort! do |a, b|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line880">880</a>       if a.vetted_view_order == b.vetted_view_order</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line881">881</a>         # TODO - this should probably also sort on visibility.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line882">882</a>         if a.data_rating == b.data_rating</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line883">883</a>           b.id &lt;=&gt; a.id # essentially, orders images by date.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line884">884</a>         else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line885">885</a>           b.data_rating &lt;=&gt; a.data_rating # Note this is reversed; higher ratings are better.</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line886">886</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line887">887</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line888">888</a>         a.vetted_view_order &lt;=&gt; b.vetted_view_order</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line889">889</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line890">890</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line891">891</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line892">892</a>     # an extra loop to ensure that we have no duplicate GUIDs</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line893">893</a>     result = []</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line894">894</a>     used_guids = {}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line895">895</a>     data_objects_result.each do |r|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line896">896</a>       result &lt;&lt; r if used_guids[r.guid].blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line897">897</a>       used_guids[r.guid] = true</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line898">898</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line899">899</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line900">900</a>     return [] if result.empty?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line901">901</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line902">902</a>     # get the rest of the metadata for the selected page</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line903">903</a>     image_page        = (options[:image_page] ||= 1).to_i</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line904">904</a>     start             = $MAX_IMAGES_PER_PAGE * (image_page - 1)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line905">905</a>     last              = start + $MAX_IMAGES_PER_PAGE - 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line906">906</a>     results_to_lookup = result[start..last]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line907">907</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line908">908</a>     results_to_lookup = DataObject.metadata_for_images(taxon.id, results_to_lookup, {:user =&gt; options[:user]})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line909">909</a>     results_to_lookup = DataObject.add_attributions_to_result(results_to_lookup)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line910">910</a>     results_to_lookup = DataObject.add_taxa_names_to_result(results_to_lookup)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line911">911</a>     result[start..last] = results_to_lookup</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line912">912</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line913">913</a>     return result</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line914">914</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line915">915</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line916">916</a>   def self.metadata_for_images(taxon_id, results, options = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line917">917</a>     data_object_ids = results.collect {|r| r.id}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line918">918</a>     return results if data_object_ids.empty?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line919">919</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line920">920</a>     comments_clause = &quot; AND c.visible_at IS NOT NULL&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line921">921</a>     comments_clause = &quot;&quot; if !options[:user].nil? &amp;&amp; options[:user].is_moderator?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line922">922</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line923">923</a>     rating_select = &quot; 0 as user_rating&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line924">924</a>     rating_from = &quot; &quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line925">925</a>     if !options[:user].nil? &amp;&amp; options[:user].id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line926">926</a>       rating_select = &quot;udor.rating user_rating&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line927">927</a>       rating_from = &quot; LEFT OUTER JOIN #{UsersDataObjectsRating.full_table_name} udor ON (dato.guid=udor.data_object_guid AND udor.user_id=#{options[:user].id})&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line928">928</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line929">929</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line930">930</a>     data_objects_with_metadata = DataObject.find_by_sql(%Q{</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line931">931</a>         SELECT 'Image' media_type, dato.*, v.view_order vetted_view_order, l.description license_text,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line932">932</a>               l.logo_url license_logo, l.source_url license_url,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line933">933</a>               #{taxon_id} taxon_id, n.string scientific_name, count(distinct c.id) as comments_count, #{rating_select}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line934">934</a>          FROM #{DataObject.full_table_name} dato</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line935">935</a>            JOIN #{Vetted.full_table_name} v                       ON (dato.vetted_id=v.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line936">936</a>            JOIN #{DataObjectsHierarchyEntry.full_table_name} dohe ON (dato.id=dohe.data_object_id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line937">937</a>            JOIN #{HierarchyEntry.full_table_name} he              ON (dohe.hierarchy_entry_id=he.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line938">938</a>            JOIN #{Name.full_table_name} n                         ON (he.name_id=n.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line939">939</a>            LEFT OUTER JOIN #{License.full_table_name} l           ON (dato.license_id=l.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line940">940</a>            LEFT OUTER JOIN #{Comment.full_table_name} c           ON (c.parent_id=dato.id AND c.parent_type='DataObject' #{comments_clause})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line941">941</a>            #{rating_from}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line942">942</a>          WHERE dato.id IN (#{data_object_ids.join(',')})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line943">943</a>          GROUP BY dato.id})</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line944">944</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line945">945</a>     metadata = {}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line946">946</a>     # add the DataObject metadata</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line947">947</a>     data_objects_with_metadata.each do |dom|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line948">948</a>       dom.description = dom.description_linked if !dom.description_linked.nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line949">949</a>       metadata[dom.id.to_i] = dom</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line950">950</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line951">951</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line952">952</a>     results.each_with_index do |r, index|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line953">953</a>       if m = metadata[r.id.to_i]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line954">954</a>         results[index] = m</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line955">955</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line956">956</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line957">957</a>     return results</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line958">958</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line959">959</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line960">960</a>   def self.add_attributions_to_result(results)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line961">961</a>     data_object_ids = results.collect {|r| r.id}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line962">962</a>     return results if data_object_ids.empty?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line963">963</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line964">964</a>     data_supplier_id = ResourceAgentRole.content_partner_upload_role.nil? ? 0 : ResourceAgentRole.content_partner_upload_role.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line965">965</a>     data_object_agents = Agent.find_by_sql(%Q{</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line966">966</a>         (SELECT a.*, 0 as data_supplier, ado.agent_role_id, ar.label agent_role_label, ado.data_object_id, ado.view_order</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line967">967</a>           FROM agents_data_objects ado JOIN agents a ON (ado.agent_id=a.id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line968">968</a>           JOIN agent_roles ar ON (ado.agent_role_id=ar.id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line969">969</a>           WHERE ado.data_object_id IN (#{data_object_ids.join(',')}))</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line970">970</a>         UNION</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line971">971</a>         (SELECT a.* , 1 as data_supplier, NULL agent_role_id, NULL agent_role_label, dohe.data_object_id, 1 view_order</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line972">972</a>           FROM data_objects_harvest_events dohe</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line973">973</a>           JOIN harvest_events he                ON (dohe.harvest_event_id=he.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line974">974</a>           JOIN agents_resources ar              ON (he.resource_id=ar.resource_id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line975">975</a>           JOIN agents a                         ON (ar.agent_id=a.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line976">976</a>           WHERE dohe.data_object_id IN (#{data_object_ids.join(',')})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line977">977</a>           AND ar.resource_agent_role_id=#{data_supplier_id})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line978">978</a>          })</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line979">979</a>     data_object_agents.sort! {|a,b| a['view_order'].to_i &lt;=&gt; b['view_order'].to_i}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line980">980</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line981">981</a>     attributions = {}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line982">982</a>     data_object_agents.each do |a|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line983">983</a>       do_id = a['data_object_id'].to_i</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line984">984</a>       attributions[do_id] ||= {</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line985">985</a>             'supplied_user_id'  =&gt; nil,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line986">986</a>             'data_supplier'     =&gt; nil,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line987">987</a>             'agents'            =&gt; {} }</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line988">988</a>       if attributions[do_id]['agents'].empty?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line989">989</a>         @all_agent_roles ||= AgentRole.all</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line990">990</a>         @all_agent_roles.each do |ar|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line991">991</a>           attributions[do_id]['agents'][ar.label] ||= []</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line992">992</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line993">993</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line994">994</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line995">995</a>       if a['data_supplier'].to_i == 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line996">996</a>         attributions[do_id]['data_supplier'] = a</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line997">997</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line998">998</a>         attributions[do_id]['agents'][a['agent_role_label']] ||= []</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line999">999</a>         attributions[do_id]['agents'][a['agent_role_label']] &lt;&lt; a</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1000">1000</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1001">1001</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1002">1002</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1003">1003</a>     results.each do |r|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1004">1004</a>       r['attributions'] = {}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1005">1005</a>       if a = attributions[r.id.to_i]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1006">1006</a>         r['data_supplier'] = a['data_supplier'] if !a['data_supplier'].nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1007">1007</a>         a['attributions'] = Attributions.from_agents_hash(r, a)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1008">1008</a>         a.each do |key, value|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1009">1009</a>           r[key] = value</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1010">1010</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1011">1011</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1012">1012</a>         r['attributions'] = Attributions.from_agents_hash(r, nil)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1013">1013</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1014">1014</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1015">1015</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1016">1016</a>     return results</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1017">1017</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1018">1018</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1019">1019</a>   def self.add_taxa_names_to_result(results)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1020">1020</a>     data_object_ids = results.collect {|r| r.id}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1021">1021</a>     return results if data_object_ids.empty?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1022">1022</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1023">1023</a>     data_object_taxa_names = SpeciesSchemaModel.connection.execute(%Q{</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1024">1024</a>         SELECT n.string as taxon_name, he.taxon_concept_id, dohe.data_object_id, tc.published as published</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1025">1025</a>           FROM data_objects_hierarchy_entries dohe</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1026">1026</a>           JOIN hierarchy_entries he ON (dohe.hierarchy_entry_id=he.id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1027">1027</a>           JOIN taxon_concepts tc ON (he.taxon_concept_id = tc.id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1028">1028</a>           JOIN names n ON (he.name_id=n.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1029">1029</a>           WHERE dohe.data_object_id IN (#{data_object_ids.join(',')})}).all_hashes.sort {|a,b| b['published'] &lt;=&gt; a['published']}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1030">1030</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1031">1031</a>     grouped_taxa_names = ModelQueryHelper.group_array_by_key(data_object_taxa_names, 'data_object_id')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1032">1032</a>     results = ModelQueryHelper.add_hash_to_object_array_as_key(results, grouped_taxa_names, 'taxa_names_ids')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1033">1033</a>     return results</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1034">1034</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1035">1035</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1036">1036</a>   def self.add_refs_to_result(results)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1037">1037</a>     data_object_ids = results.collect {|r| r.id}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1038">1038</a>     return results if data_object_ids.empty?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1039">1039</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1040">1040</a>     refs = Ref.find_by_sql(%Q{</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1041">1041</a>         SELECT r.*, dor.data_object_id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1042">1042</a>           FROM data_objects_refs dor</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1043">1043</a>           JOIN refs r ON (dor.ref_id=r.id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1044">1044</a>           WHERE dor.data_object_id IN (#{data_object_ids.join(',')})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1045">1045</a>           AND r.published=1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1046">1046</a>           AND r.visibility_id=#{Visibility.visible.id}})</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1047">1047</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1048">1048</a>     grouped_refs = ModelQueryHelper.group_array_by_key(refs, 'data_object_id')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1049">1049</a>     results = ModelQueryHelper.add_hash_to_object_array_as_key(results, grouped_refs, 'refs')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1050">1050</a>     return results</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1051">1051</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1052">1052</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1053">1053</a>   def self.add_users_to_result(results)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1054">1054</a>     data_object_ids = results.collect {|r| r.id}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1055">1055</a>     return results if data_object_ids.empty?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1056">1056</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1057">1057</a>     users = User.find_by_sql(%Q{</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1058">1058</a>         SELECT u.*, udo.data_object_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1059">1059</a>           FROM #{UsersDataObject.full_table_name} udo</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1060">1060</a>           JOIN #{User.full_table_name} u ON (udo.user_id=u.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1061">1061</a>           WHERE udo.data_object_id IN (#{data_object_ids.join(',')})})</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1062">1062</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1063">1063</a>     grouped_users = ModelQueryHelper.group_array_by_key(users, 'data_object_id')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1064">1064</a>     results = ModelQueryHelper.add_hash_to_object_array_as_key(results, grouped_users, 'users')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1065">1065</a>     return results</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1066">1066</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1067">1067</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1068">1068</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1069">1069</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1070">1070</a>   # Find all of the data objects of a particular type (text, image, etc) associated with a given taxon.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1071">1071</a>   # Options may include current agents and/or users, to affect permissions of who sees what.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1072">1072</a>   def self.for_taxon(taxon, type, options = {})</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1073">1073</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1074">1074</a>     options[:user] = User.create_new if options[:user].nil?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1075">1075</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1076">1076</a>     results = nil # scope</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1077">1077</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1078">1078</a>     if type == :image</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1079">1079</a>       # Just return the (much faster) cached images if that's the type we're dealing with:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1080">1080</a>       results = DataObject.cached_images_for_taxon(taxon, options)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1081">1081</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1082">1082</a>       # usually, we want to return data objects.  But if we want text objects, we call them toc items...</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1083">1083</a>       if type == :text &amp;&amp; options[:toc_id].nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1084">1084</a>         results = TocItem.find_by_sql(DataObject.build_query(taxon, type, options))</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1085">1085</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1086">1086</a>         results = DataObject.other_type_for_taxon(taxon, type, options)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1087">1087</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1088">1088</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1089">1089</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1090">1090</a>     # In order to display a warning about pages that include unvetted material, we check now, while the</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1091">1091</a>     # information is most readily available (data objects are the only things that can be unvetted, and only</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1092">1092</a>     # if we have to check permissions), and then flag the taxon_concept model if anything is non-trusted.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1093">1093</a>     trusted_id = Vetted.trusted.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1094">1094</a>     taxon.includes_unvetted = true if results.detect {|d| d.vetted_id != trusted_id }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1095">1095</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1096">1096</a>     # Content Partners' query included ALL invisible, untrusted and unknown items... not JUST THEIRS.  We</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1097">1097</a>     # now need to exclude those items that they did not contribute:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1098">1098</a>     if options[:agent]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1099">1099</a>       results.delete_if do |dato|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1100">1100</a>         dato.visibility_id == Visibility.preview.id and not dato['data_supplier'].nil? and</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1101">1101</a>           dato['data_supplier'].id != options[:agent].id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1102">1102</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1103">1103</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1104">1104</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1105">1105</a>     return results</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1106">1106</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1107">1107</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1108">1108</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1109">1109</a>   def self.other_type_for_taxon(taxon, type, options)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1110">1110</a>     # generate the query to search for data objects</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1111">1111</a>     query = DataObject.build_query(taxon, type, options)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1112">1112</a>     # load the objects and the info we need to sort them</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1113">1113</a>     result = DataObject.find_by_sql(query)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1114">1114</a>     result = result.uniq</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1115">1115</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1116">1116</a>     # sort objects by vetted order ASC (so trusted are first), rating DESC (so best are first), id DESC (so newest are first)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1117">1117</a>     result.sort! do |a, b|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1118">1118</a>       if a.vetted_view_order == b.vetted_view_order</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1119">1119</a>         # TODO - this should probably also sort on visibility.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1120">1120</a>         if a.data_rating == b.data_rating</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1121">1121</a>           b.id &lt;=&gt; a.id # essentially, orders images by date.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1122">1122</a>         else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1123">1123</a>           b.data_rating &lt;=&gt; a.data_rating # Note this is reversed; higher ratings are better.</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1124">1124</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1125">1125</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1126">1126</a>         a.vetted_view_order &lt;=&gt; b.vetted_view_order</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1127">1127</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1128">1128</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1129">1129</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1130">1130</a>     # query result set for attribution info, taxa info (for permalinks), and references</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1131">1131</a>     result = DataObject.add_attributions_to_result(result)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1132">1132</a>     result = DataObject.add_taxa_names_to_result(result)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1133">1133</a>     result = DataObject.add_refs_to_result(result)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1134">1134</a>     result = DataObject.add_users_to_result(result)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1135">1135</a>     return result</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1136">1136</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1137">1137</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1138">1138</a>   # TODO - MED PRIORITY - I'm assuming there's one taxa for this data object, and there could be several.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1139">1139</a>   # TODO = licenses should simply be included, and referenced directly where needed.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1140">1140</a>   def self.build_query(taxon, type, options)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1141">1141</a>     add_toc      = (type == :text and options[:toc_id].nil?) ? ', toc.*' : ''</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1142">1142</a>     add_cp       = options[:agent].nil? ? '' : ', ar.agent_id agent_id'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1143">1143</a>     join_agents  = options[:agent].nil? ? '' : self.join_agents_clause(options[:agent])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1144">1144</a>     join_toc     = type == :text        ? 'JOIN data_objects_table_of_contents dotoc ON dotoc.data_object_id = dato.id ' +</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1145">1145</a>                                                  'JOIN table_of_contents toc ON toc.id = dotoc.toc_id' : ''</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1146">1146</a>     where_toc    = options[:toc_id].nil? ? '' : ActiveRecord::Base.sanitize_sql_array(['AND toc.id = ?', options[:toc_id]])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1147">1147</a>     #sort         = 'published, vetted_id DESC, data_rating DESC' # unpublished first, then by data_rating.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1148">1148</a>     sort         = 'published, vetted_sort_order, data_rating DESC' # unpublished first, then by data_rating.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1149">1149</a>     data_type_ids = DataObject.get_type_ids(type)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1150">1150</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1151">1151</a>     query_string = %Q{</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1152">1152</a> (SELECT dt.label media_type, dato.*, dotc.taxon_concept_id taxon_id,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1153">1153</a>        l.description license_text, l.logo_url license_logo, l.source_url license_url #{add_toc} #{add_cp}, v.view_order as vetted_view_order</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1154">1154</a>   FROM data_objects_taxon_concepts dotc</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1155">1155</a>     JOIN data_objects dato     ON (dotc.data_object_id = dato.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1156">1156</a>     JOIN vetted v              ON (dato.vetted_id=v.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1157">1157</a>     JOIN data_types dt         ON (dato.data_type_id = dt.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1158">1158</a>     #{join_agents} #{join_toc}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1159">1159</a>     LEFT OUTER JOIN licenses l       ON (dato.license_id = l.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1160">1160</a>   WHERE dotc.taxon_concept_id = #{taxon.id}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1161">1161</a>     AND data_type_id IN (#{data_type_ids.join(',')})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1162">1162</a>     #{DataObject.visibility_clause(options.merge(:taxon =&gt; taxon))}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1163">1163</a>     #{where_toc})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1164">1164</a> UNION</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1165">1165</a> (SELECT dt.label media_type, dato.*, taxon_concept_id taxon_id, l.description license_text, l.logo_url license_logo, l.source_url license_url #{add_toc} #{add_cp}, v.view_order vetted_view_order</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1166">1166</a> FROM data_objects dato</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1167">1167</a> JOIN vetted v              ON (dato.vetted_id=v.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1168">1168</a> JOIN #{ UsersDataObject.full_table_name } udo ON (dato.id=udo.data_object_id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1169">1169</a> STRAIGHT_JOIN data_types dt ON (dato.data_type_id = dt.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1170">1170</a> #{join_agents} #{join_toc}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1171">1171</a> LEFT OUTER JOIN licenses l ON (dato.license_id = l.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1172">1172</a> WHERE</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1173">1173</a> udo.taxon_concept_id=#{taxon.id}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1174">1174</a> AND data_type_id IN (#{data_type_ids.join(',')})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1175">1175</a> #{DataObject.visibility_clause(options.merge(:taxon =&gt; taxon))}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1176">1176</a>     #{where_toc}) # DataObject.for_taxon</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1177">1177</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1178">1178</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1179">1179</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1180">1180</a>   alias :ar_to_xml :to_xml</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1181">1181</a>   # Be careful calling a block here.  We have our own builder, and you will be overriding that if you use a block.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1182">1182</a>   def to_xml(options = {})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1183">1183</a>     default_only   = [:id, :bibliographic_citation, :description, :guid, :rights_holder, :rights_statement]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1184">1184</a>     default_only  += [:altitude, :latitude, :location, :longitude] unless map? or text?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1185">1185</a>     options[:only] = (options[:only] ? options[:only] + default_only : default_only)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1186">1186</a>     options[:methods] ||= [:data_supplier_agent, :tags_hash]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1187">1187</a>     options[:methods] &lt;&lt; :map_image if map?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1188">1188</a>     default_block = lambda do |xml|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1189">1189</a>       xml.attributions do</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1190">1190</a>         attributions.each do |attr|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1191">1191</a>           xml.attribution do</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1192">1192</a>             xml.role attr.agent_role.label</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1193">1193</a>             attr.agent.to_xml(:builder =&gt; xml, :skip_instruct =&gt; true)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1194">1194</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1195">1195</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1196">1196</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1197">1197</a>       xml.language language.label unless map? or image?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1198">1198</a>       xml.license license.title</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1199">1199</a>       xml.type data_type.label</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1200">1200</a>       xml.url thumb_or_object unless map?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1201">1201</a>       xml.medium_thumb_url thumb_or_object(:medium) unless map?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1202">1202</a>       xml.small_thumb_url thumb_or_object(:small) unless map?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1203">1203</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1204">1204</a>     if block_given?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1205">1205</a>       ar_to_xml(options) { |xml| yield xml }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1206">1206</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1207">1207</a>       ar_to_xml(options) { |xml| default_block.call(xml) }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1208">1208</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1209">1209</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1210">1210</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1211">1211</a>   def self.latest_published_version_of(data_object_id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1212">1212</a>     # this method is in two parts so we don't have to return ALL data for ALL objects with this guid. MySQL just</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1213">1213</a>     # returns one ID, then we lookup the DataObject based on the ID. Sames a lot of data transfer and time</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1214">1214</a>     obj = DataObject.find_by_sql(&quot;SELECT do.* FROM data_objects do_old JOIN data_objects do ON (do_old.guid=do.guid) WHERE do_old.id=#{data_object_id} AND do.published=1 ORDER BY id desc LIMIT 1&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1215">1215</a>     return nil if obj.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1216">1216</a>     return obj[0]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1217">1217</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1218">1218</a>   def latest_published_version</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1219">1219</a>     obj = DataObject.find_by_sql(&quot;SELECT * FROM data_objects WHERE guid='#{guid}' AND published=1 ORDER BY id desc LIMIT 1&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1220">1220</a>     return nil if obj.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1221">1221</a>     return obj[0]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1222">1222</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1223">1223</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1224">1224</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1225">1225</a>   def self.get_toc_info(obj_ids)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1226">1226</a>     obj_toc_info = {} #same Hash.new</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1227">1227</a>     if(obj_ids.length &gt; 0) then</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1228">1228</a>       sql = &quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1229">1229</a>       SELECT do.id, vetted.label AS vetted_label, visibilities.label AS visible, concat(toc2.label, ' - ', tc.label) as toc</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1230">1230</a>       From data_objects do</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1231">1231</a>       LEFT JOIN vetted                              ON do.vetted_id = vetted.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1232">1232</a>       LEFT JOIN visibilities                        ON do.visibility_id = visibilities.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1233">1233</a>       LEFT JOIN data_objects_table_of_contents dotc ON do.id = dotc.data_object_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1234">1234</a>       LEFT JOIN table_of_contents tc                ON dotc.toc_id = tc.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1235">1235</a>       LEFT JOIN table_of_contents toc2              ON tc.parent_id = toc2.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1236">1236</a>       WHERE do.id IN (#{obj_ids.join(',')})&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1237">1237</a>       rset = DataObject.find_by_sql([sql])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1238">1238</a>       rset.each do |post|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1239">1239</a>         obj_toc_info[&quot;#{post.id}&quot;] = &quot;#{post.toc}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1240">1240</a>         obj_toc_info[&quot;e#{post.id}&quot;] = &quot;#{post.vetted_label} &lt;br&gt; #{post.visible}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1241">1241</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1242">1242</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1243">1243</a>     return obj_toc_info</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1244">1244</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1245">1245</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1246">1246</a>   def self.tc_ids_from_do_ids(obj_ids)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1247">1247</a>     obj_tc_id = {} #same Hash.new</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1248">1248</a>     if(obj_ids.length &gt; 0) then</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1249">1249</a>       sql = &quot;SELECT dotc.taxon_concept_id tc_id , do.data_type_id, do.id do_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1250">1250</a>       FROM data_objects_taxon_concepts dotc</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1251">1251</a>       JOIN data_objects do ON dotc.data_object_id = do.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1252">1252</a>       JOIN taxon_concepts tc ON dotc.taxon_concept_id = tc.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1253">1253</a>       WHERE tc.published AND dotc.data_object_id IN (#{obj_ids.join(',')})&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1254">1254</a>       rset = DataObject.find_by_sql([sql])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1255">1255</a>       rset.each do |post|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1256">1256</a>         obj_tc_id[&quot;#{post.do_id}&quot;] = post.tc_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1257">1257</a>         if(post.data_type_id == 3)then obj_tc_id[&quot;datatype#{post.do_id}&quot;] = &quot;text&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1258">1258</a>                                   else obj_tc_id[&quot;datatype#{post.do_id}&quot;] = &quot;image&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1259">1259</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1260">1260</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1261">1261</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1262">1262</a>     return obj_tc_id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1263">1263</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1264">1264</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1265">1265</a>   def self.get_dataobjects(obj_ids,page)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1266">1266</a>     query=&quot;SELECT do.* FROM data_objects do</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1267">1267</a>     JOIN vetted v ON do.vetted_id = v.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1268">1268</a>     WHERE do.id IN (#{ obj_ids.join(', ') })&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1269">1269</a>     self.paginate_by_sql [query, obj_ids], :page =&gt; page, :per_page =&gt; 20 , :order =&gt; 'id'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1270">1270</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1271">1271</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1272">1272</a>   def self.get_object_cache_url(obj_ids)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1273">1273</a>     query=&quot;SELECT do.id, do.object_cache_url FROM data_objects do WHERE do.id IN (#{ obj_ids.join(', ') })&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1274">1274</a>     obj_detail = {} #same Hash.new</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1275">1275</a>     if(obj_ids.length &gt; 0) then</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1276">1276</a>       rset = DataObject.find_by_sql([query])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1277">1277</a>       rset.each do |post|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1278">1278</a>         obj_detail[&quot;#{post.id}&quot;] = post.object_cache_url</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1279">1279</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1280">1280</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1281">1281</a>     return obj_detail</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1282">1282</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1283">1283</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1284">1284</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1285">1285</a>   def self.get_object_cache_url(obj_ids)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1286">1286</a>     query=&quot;SELECT do.id, do.object_cache_url, do.source_url FROM data_objects do WHERE do.id IN (#{ obj_ids.join(', ') })&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1287">1287</a>     obj_detail = {} #same Hash.new</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1288">1288</a>     if(obj_ids.length &gt; 0) then</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1289">1289</a>       rset = DataObject.find_by_sql([query])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1290">1290</a>       rset.each do |post|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1291">1291</a>         obj_detail[&quot;#{post.id}&quot;] = post.object_cache_url</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1292">1292</a>         obj_detail[&quot;#{post.id}_source&quot;] = post.source_url</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1293">1293</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1294">1294</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1295">1295</a>     return obj_detail</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1296">1296</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1297">1297</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1298">1298</a>   #this method is slow and was replaced by one in the PHP SiteStatistics class.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1299">1299</a>   #def self.get_SPM_count_on_dataobjects(arr_SPM)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1300">1300</a>   #  arr_count = {} #same Hash.new</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1301">1301</a>   #  arr_SPM.each do |profile|</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1302">1302</a>   #    id = profile[&quot;id&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1303">1303</a>   #    rset = DataObject.find_by_sql([&quot;SELECT Count(do.id) total</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1304">1304</a>   #    FROM data_objects do    JOIN     data_objects_info_items doii ON do.id = doii.data_object_id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1305">1305</a>   #    WHERE doii.info_item_id = #{id} AND do.published AND do.vetted_id != #{Vetted.untrusted.id}&quot;])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1306">1306</a>   #    rset.each do |rec|</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1307">1307</a>   #      arr_count[&quot;#{id}&quot;] = rec.total</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1308">1308</a>   #    end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1309">1309</a>   #  end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1310">1310</a>   #  return arr_count</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1311">1311</a>   #end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1312">1312</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1313">1313</a>   #def self.add_user_dataobjects_on_SPM_count(arr_count, arr_user_object_ids)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1314">1314</a>   #  if(arr_user_object_ids.length &gt; 0) then</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1315">1315</a>   #    rset = DataObject.find_by_sql([&quot;SELECT ii.id, Count(ii.id) total</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1316">1316</a>   #    FROM data_objects_table_of_contents dotc</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1317">1317</a>   #    JOIN info_items ii ON dotc.toc_id = ii.toc_id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1318">1318</a>   #    JOIN data_objects do ON dotc.data_object_id = do.id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1319">1319</a>   #    WHERE dotc.data_object_id IN (#{arr_user_object_ids.join(',')})</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1320">1320</a>   #    AND do.vetted_id != #{Vetted.untrusted.id}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1321">1321</a>   #    AND do.published</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1322">1322</a>   #    Group By ii.id &quot;])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1323">1323</a>   #    rset.each do |rec|</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1324">1324</a>   #      if(arr_count[&quot;#{rec.id}&quot;] != nil) then</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1325">1325</a>   #        arr_count[&quot;#{rec.id}&quot;] = arr_count[&quot;#{rec.id}&quot;].to_i + rec.total.to_i</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1326">1326</a>   #      else</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1327">1327</a>   #        arr_count[&quot;#{rec.id}&quot;] = rec.total.to_i</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1328">1328</a>   #      end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1329">1329</a>   #    end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1330">1330</a>   #  end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1331">1331</a>   #  return arr_count</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1332">1332</a>   #end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1333">1333</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1334">1334</a>   #this query is very slow and was replaced by one in the PHP SiteStatistics class.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1335">1335</a>   #def self.get_SPM_count_on_contentpartners(arr_SPM)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1336">1336</a>   #  arr_count = {} #same Hash.new</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1337">1337</a>   #  arr_SPM.each do |rec|</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1338">1338</a>   #    id = rec[&quot;id&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1339">1339</a>   #    rset = DataObject.find_by_sql([&quot;SELECT COUNT(distinct ar.agent_id) total</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1340">1340</a>   #    FROM data_objects_info_items      doii</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1341">1341</a>   #    JOIN data_objects_harvest_events  dohe  ON doii.data_object_id = dohe.data_object_id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1342">1342</a>   #    JOIN data_objects                 do    ON do.id = doii.data_object_id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1343">1343</a>   #    JOIN harvest_events               he    ON dohe.harvest_event_id = he.id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1344">1344</a>   #    JOIN resources                    r     ON he.resource_id = r.id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1345">1345</a>   #    JOIN agents_resources             ar    ON r.id = ar.resource_id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1346">1346</a>   #    WHERE doii.info_item_id = #{id} AND do.published AND do.vetted_id != #{Vetted.untrusted.id}&quot;])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1347">1347</a>   #    rset.each do |rec|</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1348">1348</a>   #      arr_count[&quot;#{id}&quot;] = rec.total</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1349">1349</a>   #    end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1350">1350</a>   #  end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1351">1351</a>   #  return arr_count</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1352">1352</a>   #end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1353">1353</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1354">1354</a>   def self.details_for_object(data_object_guid, options = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1355">1355</a>     data_objects = DataObject.find_all_by_guid(data_object_guid, :conditions =&gt; &quot;published=1 AND visibility_id=#{Visibility.visible.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1356">1356</a>     return [] if data_objects.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1357">1357</a>     data_objects.sort! {|a,b| b.id &lt;=&gt; a.id}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1358">1358</a>     data_object = data_objects[0]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1359">1359</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1360">1360</a>     details = self.details_for_objects([data_object.id])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1361">1361</a>     return [] if details.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1362">1362</a>     first_obj = details[0]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1363">1363</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1364">1364</a>     # create the objects taxon and place the object inside</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1365">1365</a>     if options[:include_taxon]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1366">1366</a>       obj = DataObject.find(first_obj['id'])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1367">1367</a>       tc = obj.taxon_concepts(:published =&gt; :preferred)[0]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1368">1368</a>       return tc.details_hash(:data_object_hash =&gt; first_obj, :common_names =&gt; options[:common_names])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1369">1369</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1370">1370</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1371">1371</a>     # return the object alone</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1372">1372</a>     return first_obj</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1373">1373</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1374">1374</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1375">1375</a>   def self.details_for_objects(data_object_ids, options = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1376">1376</a>     return [] unless data_object_ids.is_a? Array</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1377">1377</a>     return [] if data_object_ids.empty?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1378">1378</a>     options[:visible] == true if options[:visible] != false</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1379">1379</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1380">1380</a>     visibility_clause = &quot;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1381">1381</a>     if options[:visible] == true</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1382">1382</a>       visibility_clause = &quot; AND do.published = 1 AND do.visibility_id = #{Visibility.visible.id}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1383">1383</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1384">1384</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1385">1385</a>     object_details_hashes = SpeciesSchemaModel.connection.execute(&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1386">1386</a>       SELECT do.*, dt.schema_value data_type, dt.label data_type_label, mt.label mime_type, lang.iso_639_1 language,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1387">1387</a>               lic.source_url license, lic.title license_label, ii.schema_value subject, v.view_order vetted_view_order,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1388">1388</a>               v.label vetted_label, vis.label visibility_label,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1389">1389</a>               toc.view_order toc_view_order, toc.label toc_label, n.string scientific_name, he.taxon_concept_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1390">1390</a>         FROM data_objects do</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1391">1391</a>         LEFT JOIN data_types dt ON (do.data_type_id=dt.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1392">1392</a>         LEFT JOIN mime_types mt ON (do.mime_type_id=mt.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1393">1393</a>         LEFT JOIN languages lang ON (do.language_id=lang.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1394">1394</a>         LEFT JOIN licenses lic ON (do.license_id=lic.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1395">1395</a>         LEFT JOIN vetted v ON (do.vetted_id=v.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1396">1396</a>         LEFT JOIN visibilities vis ON (do.visibility_id=vis.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1397">1397</a>         LEFT JOIN (</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1398">1398</a>            info_items ii</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1399">1399</a>            JOIN table_of_contents toc ON (ii.toc_id=toc.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1400">1400</a>            JOIN data_objects_table_of_contents dotoc ON (toc.id=dotoc.toc_id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1401">1401</a>           ) ON (do.id=dotoc.data_object_id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1402">1402</a>         LEFT JOIN (</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1403">1403</a>            data_objects_hierarchy_entries dohe</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1404">1404</a>            JOIN hierarchy_entries he ON (dohe.hierarchy_entry_id=he.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1405">1405</a>            JOIN names n ON (he.name_id=n.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1406">1406</a>           ) ON (do.id=dohe.data_object_id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1407">1407</a>         WHERE do.id IN (#{data_object_ids.join(',')})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1408">1408</a>         #{visibility_clause}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1409">1409</a>     &quot;).all_hashes.uniq</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1410">1410</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1411">1411</a>     object_details_hashes.group_hashes_by!('guid')</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1412">1412</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1413">1413</a>     flash_id = DataType.flash.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1414">1414</a>     youtube_id = DataType.youtube.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1415">1415</a>     iucn_id = DataType.iucn.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1416">1416</a>     object_details_hashes.each do |r|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1417">1417</a>       if r['data_type_id'].to_i == flash_id || r['data_type_id'].to_i == youtube_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1418">1418</a>         r['data_type'] = DataType.video.schema_value</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1419">1419</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1420">1420</a>       if r['data_type_id'].to_i == iucn_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1421">1421</a>         r['data_type'] = DataType.text.schema_value</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1422">1422</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1423">1423</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1424">1424</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1425">1425</a>     if options[:sort] == 'id desc'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1426">1426</a>       object_details_hashes.sort!{ |a,b| b['id'].to_i &lt;=&gt; a['id'].to_i }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1427">1427</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1428">1428</a>       object_details_hashes = ModelQueryHelper.sort_object_hash_by_display_order(object_details_hashes)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1429">1429</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1430">1430</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1431">1431</a>     object_details_hashes = DataObject.add_refs_to_details(object_details_hashes) if options[:skip_metadata].blank? &amp;&amp; options[:skip_refs].blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1432">1432</a>     object_details_hashes = DataObject.add_agents_to_details(object_details_hashes) if options[:skip_metadata].blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1433">1433</a>     object_details_hashes = DataObject.add_common_names_to_details(object_details_hashes) unless options[:add_common_names].blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1434">1434</a>     object_details_hashes = DataObject.add_comments_to_details(object_details_hashes) unless options[:add_comments].blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1435">1435</a>     object_details_hashes</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1436">1436</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1437">1437</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1438">1438</a>   def self.add_refs_to_details(object_details_hash)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1439">1439</a>     data_object_ids = object_details_hash.collect {|r| r['id']}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1440">1440</a>     return object_details_hash if data_object_ids.blank?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1441">1441</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1442">1442</a>     refs = SpeciesSchemaModel.connection.execute(&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1443">1443</a>         SELECT r.*, dor.data_object_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1444">1444</a>           FROM data_objects_refs dor</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1445">1445</a>           JOIN refs r ON (dor.ref_id=r.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1446">1446</a>           WHERE dor.data_object_id IN (#{data_object_ids.join(',')})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1447">1447</a>           AND r.published=1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1448">1448</a>           AND r.visibility_id=#{Visibility.visible.id}&quot;).all_hashes</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1449">1449</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1450">1450</a>     grouped_refs = ModelQueryHelper.group_array_by_key(refs, 'data_object_id')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1451">1451</a>     object_details_hash = ModelQueryHelper.add_hash_to_hash_as_key(object_details_hash, grouped_refs, 'refs')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1452">1452</a>     return object_details_hash</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1453">1453</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1454">1454</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1455">1455</a>   def self.add_comments_to_details(object_details_hash)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1456">1456</a>     data_object_ids = object_details_hash.collect {|r| r['id']}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1457">1457</a>     return object_details_hash if data_object_ids.blank?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1458">1458</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1459">1459</a>     comments = SpeciesSchemaModel.connection.execute(&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1460">1460</a>         SELECT c.*, do_guid.id data_object_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1461">1461</a>           FROM #{Comment.full_table_name} c</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1462">1462</a>           JOIN data_objects do ON (c.parent_id=do.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1463">1463</a>           JOIN data_objects do_guid ON (do.guid=do_guid.guid)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1464">1464</a>           WHERE c.parent_id IN (#{data_object_ids.join(',')})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1465">1465</a>           AND c.parent_type='DataObject'&quot;).all_hashes</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1466">1466</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1467">1467</a>     grouped_comments = ModelQueryHelper.group_array_by_key(comments, 'data_object_id')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1468">1468</a>     object_details_hash = ModelQueryHelper.add_hash_to_hash_as_key(object_details_hash, grouped_comments, 'comments')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1469">1469</a>     return object_details_hash</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1470">1470</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1471">1471</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1472">1472</a>   def self.add_agents_to_details(object_details_hash)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1473">1473</a>     data_object_ids = object_details_hash.collect {|r| r['id']}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1474">1474</a>     return object_details_hash if data_object_ids.blank?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1475">1475</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1476">1476</a>     data_supplier_id = ResourceAgentRole.content_partner_upload_role.nil? ? 0 : ResourceAgentRole.content_partner_upload_role.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1477">1477</a>     agents = SpeciesSchemaModel.connection.execute(&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1478">1478</a>         (SELECT a.* , 'Provider' role, dohe.data_object_id, -1 view_order</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1479">1479</a>           FROM data_objects_harvest_events dohe</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1480">1480</a>           JOIN harvest_events he                ON (dohe.harvest_event_id=he.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1481">1481</a>           JOIN agents_resources ar              ON (he.resource_id=ar.resource_id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1482">1482</a>           JOIN agents a                         ON (ar.agent_id=a.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1483">1483</a>           WHERE dohe.data_object_id IN (#{data_object_ids.join(',')})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1484">1484</a>           AND ar.resource_agent_role_id=#{data_supplier_id})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1485">1485</a>         UNION</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1486">1486</a>         (SELECT a.*, ar.label role, ado.data_object_id, ado.view_order</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1487">1487</a>           FROM agents_data_objects ado</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1488">1488</a>           JOIN agents a ON (ado.agent_id=a.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1489">1489</a>           JOIN agent_roles ar ON (ado.agent_role_id=ar.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1490">1490</a>           WHERE ado.data_object_id IN (#{data_object_ids.join(',')}))</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1491">1491</a>         &quot;).all_hashes</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1492">1492</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1493">1493</a>     agents.sort! {|a,b| a['view_order'].to_i &lt;=&gt; b['view_order'].to_i}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1494">1494</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1495">1495</a>     grouped = ModelQueryHelper.group_array_by_key(agents, 'data_object_id')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1496">1496</a>     object_details_hash = ModelQueryHelper.add_hash_to_hash_as_key(object_details_hash, grouped, 'agents')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1497">1497</a>     return object_details_hash</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1498">1498</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1499">1499</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1500">1500</a>   def self.add_common_names_to_details(object_details_hash)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1501">1501</a>     data_object_ids = object_details_hash.collect {|r| r['id']}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1502">1502</a>     return object_details_hash if data_object_ids.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1503">1503</a>     language ||= Language.english</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1504">1504</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1505">1505</a>     common_names = SpeciesSchemaModel.connection.execute(&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1506">1506</a>         SELECT n.string name, dohe.data_object_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1507">1507</a>           FROM data_objects_hierarchy_entries dohe</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1508">1508</a>           JOIN hierarchy_entries he ON (dohe.hierarchy_entry_id=he.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1509">1509</a>           JOIN taxon_concept_names tcn ON (he.taxon_concept_id=tcn.taxon_concept_id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1510">1510</a>           JOIN names n ON (tcn.name_id = n.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1511">1511</a>           WHERE dohe.data_object_id IN (#{data_object_ids.join(',')})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1512">1512</a>           AND language_id=#{language.id}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1513">1513</a>           AND preferred=1 GROUP BY dohe.data_object_id&quot;).all_hashes</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1514">1514</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1515">1515</a>     grouped_names = ModelQueryHelper.group_array_by_key(common_names, 'data_object_id')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1516">1516</a>     object_details_hash = ModelQueryHelper.add_hash_to_hash_as_key(object_details_hash, grouped_names, 'common_names')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1517">1517</a>     return object_details_hash</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1518">1518</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1519">1519</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1520">1520</a>   # using object.untrust_reasons.include? was firing off a query every time. This is faster</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1521">1521</a>   def untrust_reasons_include?(untrust_reason)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1522">1522</a>     @untrust_reasons_cached ||= untrust_reasons</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1523">1523</a>     return true if @untrust_reasons_cached.index(untrust_reason)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1524">1524</a>     return false</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1525">1525</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1526">1526</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1527">1527</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1528">1528</a>   def self.generate_dataobject_stats(harvest_id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1529">1529</a>     query = &quot;Select do.id do_id, dt.label, v.label vetted_label, do.data_type_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1530">1530</a>     From data_objects_harvest_events dohe</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1531">1531</a>     Join data_objects do ON dohe.data_object_id = do.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1532">1532</a>     Join data_types dt ON do.data_type_id = dt.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1533">1533</a>     Join vetted v ON do.vetted_id = v.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1534">1534</a>     Where dohe.harvest_event_id = #{harvest_id}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1535">1535</a>     rset = self.find_by_sql [query]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1536">1536</a>     stats = {}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1537">1537</a>     for fld in rset</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1538">1538</a>       if stats[&quot;#{fld.label}&quot;] == nil</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1539">1539</a>         stats[&quot;#{fld.label}&quot;] = 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1540">1540</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1541">1541</a>         stats[&quot;#{fld.label}&quot;] += 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1542">1542</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1543">1543</a>       data_type_vetted = &quot;#{fld.label}_#{fld.vetted_label}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1544">1544</a>       if stats[&quot;#{data_type_vetted}&quot;] == nil</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1545">1545</a>         stats[&quot;#{data_type_vetted}&quot;] = 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1546">1546</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1547">1547</a>         stats[&quot;#{data_type_vetted}&quot;] += 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1548">1548</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1549">1549</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1550">1550</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1551">1551</a>     query = &quot;Select label from data_types order by id&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1552">1552</a>     data_types = self.find_by_sql [query]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1553">1553</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1554">1554</a>     query = &quot;Select label from vetted order by view_order&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1555">1555</a>     vetted_types = self.find_by_sql [query]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1556">1556</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1557">1557</a>     # to get total_data_objects count</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1558">1558</a>     total_data_objects=0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1559">1559</a>     for data_type in data_types</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1560">1560</a>       for vetted_type in vetted_types</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1561">1561</a>         data_type_vetted = &quot;#{data_type.label}_#{vetted_type.label}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1562">1562</a>         total_data_objects += stats[&quot;#{data_type_vetted}&quot;].to_i</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1563">1563</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1564">1564</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1565">1565</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1566">1566</a>     # to get total_taxa count</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1567">1567</a>     query = &quot;Select count(distinct he.taxon_concept_id) taxa_count</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1568">1568</a>     From harvest_events_hierarchy_entries hehe</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1569">1569</a>     Join hierarchy_entries he ON hehe.hierarchy_entry_id = he.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1570">1570</a>     Join taxon_concepts tc ON he.taxon_concept_id = tc.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1571">1571</a>     where hehe.harvest_event_id = #{harvest_id}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1572">1572</a>     and tc.supercedure_id=0 and tc.vetted_id != #{Vetted.untrusted.id}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1573">1573</a>     and tc.published=1&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1574">1574</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1575">1575</a>     rset = self.find_by_sql [query]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1576">1576</a>     for fld in rset</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1577">1577</a>       total_taxa = fld[&quot;taxa_count&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1578">1578</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1579">1579</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1580">1580</a>     arr = [stats,data_types,vetted_types,total_data_objects,total_taxa]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1581">1581</a>     return arr</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1582">1582</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1583">1583</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1584">1584</a> private</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1585">1585</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1586">1586</a>   def self.join_agents_clause(agent)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1587">1587</a>     data_supplier_id = ResourceAgentRole.content_partner_upload_role.id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1588">1588</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1589">1589</a>     # if there is a logged in agent (meaning a content partner) we should require that</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1590">1590</a>     # we only get agent values from objects they committed. This won't effect admins</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1591">1591</a>     # as they will be users and not agents</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1592">1592</a>     extra = &quot;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1593">1593</a>     extra = &quot;AND ar.agent_id = #{agent.id}&quot; unless agent.nil?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1594">1594</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1595">1595</a>     return %Q{LEFT JOIN (agents_resources ar</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1596">1596</a>               STRAIGHT_JOIN harvest_events hevt ON (ar.resource_id = hevt.resource_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1597">1597</a>                 AND ar.resource_agent_role_id = #{data_supplier_id} #{extra})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1598">1598</a>               STRAIGHT_JOIN data_objects_harvest_events dohe ON hevt.id = dohe.harvest_event_id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1599">1599</a>                 ON (dato.id = dohe.data_object_id)}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1600">1600</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1601">1601</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1602">1602</a>   # TODO - this smells like a good place to use a Strategy pattern.  The user can have certain behaviour based</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1603">1603</a>   # on their access.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1604">1604</a>   def self.visibility_clause(options)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1605">1605</a>     preview_objects = ActiveRecord::Base.sanitize_sql_array(['OR (dato.visibility_id = ? AND dato.published IN (0,1))', Visibility.preview.id])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1606">1606</a>     published    = [1] # Boolean</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1607">1607</a>     vetted       = [Vetted.trusted.id]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1608">1608</a>     visibility   = [Visibility.visible.id]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1609">1609</a>     other_visibilities = ''</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1610">1610</a>     if options[:user]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1611">1611</a>       if options[:user].is_curator? and options[:user].can_curate?(options[:taxon])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1612">1612</a>         vetted += [Vetted.untrusted.id, Vetted.unknown.id] if options[:user].show_unvetted?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1613">1613</a>         visibility &lt;&lt; Visibility.invisible.id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1614">1614</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1615">1615</a>       if options[:user].is_admin?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1616">1616</a>         vetted += [Vetted.untrusted.id, Vetted.unknown.id]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1617">1617</a>         visibility = Visibility.all_ids.dup</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1618">1618</a>         other_visibilities = preview_objects</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1619">1619</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1620">1620</a>       if options[:user].vetted == false</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1621">1621</a>         vetted += [Vetted.unknown.id,Vetted.untrusted.id]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1622">1622</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1623">1623</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1624">1624</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1625">1625</a>     if options[:toc_id] == TocItem.wikipedia</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1626">1626</a>       visibility &lt;&lt; Visibility.preview.id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1627">1627</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1628">1628</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1629">1629</a>     # TODO - The problem here is that we're Allowing CPs to see EVERYTHING, when they should only see THEIR</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1630">1630</a>     # invisibles, untrusteded, and unknowns.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1631">1631</a>     if options[:agent] # Content partner ... note that some of this is handled via the join in join_agents_clause().</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1632">1632</a>       visibility &lt;&lt; Visibility.invisible.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1633">1633</a>       vetted += [Vetted.untrusted.id, Vetted.unknown.id]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1634">1634</a>       other_visibilities = preview_objects</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1635">1635</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1636">1636</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1637">1637</a>     return ActiveRecord::Base.sanitize_sql_array([&lt;&lt;EOVISBILITYCLAUSE, vetted.uniq, published, visibility])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1638">1638</a>     AND dato.vetted_id IN (?)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1639">1639</a>     AND ((dato.published IN (?)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1640">1640</a>       AND dato.visibility_id IN (?)) #{other_visibilities})</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1641">1641</a> EOVISBILITYCLAUSE</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1642">1642</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1643">1643</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1644">1644</a>   def self.get_type_ids(type)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1645">1645</a>     case type</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1646">1646</a>     when :map</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1647">1647</a>       return DataType.map_type_ids</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1648">1648</a>     when :text</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1649">1649</a>       return DataType.text_type_ids</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1650">1650</a>     when :video</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1651">1651</a>       return DataType.video_type_ids</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1652">1652</a>     when :image</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1653">1653</a>       return DataType.image_type_ids</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1654">1654</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1655">1655</a>       raise &quot;I'm not sure what data type #{type} is.&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1656">1656</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1657">1657</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1658">1658</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1659">1659</a> end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1660">1660</a> # == Schema Info</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1661">1661</a> # Schema version: 20081020144900</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1662">1662</a> #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1663">1663</a> # Table name: data_objects</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1664">1664</a> #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1665">1665</a> #  id                     :integer(4)      not null, primary key</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1666">1666</a> #  data_type_id           :integer(2)      not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1667">1667</a> #  language_id            :integer(2)      not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1668">1668</a> #  license_id             :integer(1)      not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1669">1669</a> #  mime_type_id           :integer(2)      not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1670">1670</a> #  vetted_id              :integer(1)      not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1671">1671</a> #  visibility_id          :integer(4)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1672">1672</a> #  altitude               :float           not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1673">1673</a> #  bibliographic_citation :string(300)     not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1674">1674</a> #  curated                :boolean(1)      not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1675">1675</a> #  data_rating            :float           not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1676">1676</a> #  description            :text            not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1677">1677</a> #  guid                   :string(32)      not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1678">1678</a> #  latitude               :float           not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1679">1679</a> #  location               :string(255)     not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1680">1680</a> #  longitude              :float           not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1681">1681</a> #  object_cache_url       :string(255)     not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1682">1682</a> #  object_title           :string(255)     not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1683">1683</a> #  object_url             :string(255)     not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1684">1684</a> #  published              :boolean(1)      not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1685">1685</a> #  rights_holder          :string(255)     not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1686">1686</a> #  rights_statement       :string(300)     not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1687">1687</a> #  source_url             :string(255)     not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1688">1688</a> #  thumbnail_cache_url    :string(255)     not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1689">1689</a> #  thumbnail_url          :string(255)     not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1690">1690</a> #  created_at             :timestamp       not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1691">1691</a> #  object_created_at      :timestamp       not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1692">1692</a> #  object_modified_at     :timestamp       not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1693">1693</a> #  updated_at             :timestamp       not null</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1694">1694</a> </pre></td>
          </tr>
        
      </tbody>
    </table>

    <p>Generated on Thu Dec 23 15:15:35 -0800 2010 with <a href="http://github.com/relevance/rcov">rcov 0.9.8</a></p>

  </body>
</html>
