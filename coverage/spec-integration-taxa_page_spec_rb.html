<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>spec/integration/taxa_page_spec.rb</title>
    <link href="screen.css" media="all" rel="stylesheet" type="text/css" />
    <link href="print.css" media="print" rel="stylesheet" type="text/css" />
    
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <script type="text/javascript" src="rcov.js"></script>
  </head>
  <body>
    <h1>Eol C0 Coverage Information - RCov</h1>
    <h2>spec/integration/taxa_page_spec.rb</h2>

    

    <div class="report_table_wrapper">
      <table class='report' id='report_table'>
        <thead>
          <tr>
            <th class="left_align">Name</th>
            <th class="right_align">Total Lines</th>
            <th class="right_align">Lines of Code</th>
            <th class="left_align">Total Coverage</th>
            <th class="left_align">Code Coverage</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="left_align"><a href="spec-integration-taxa_page_spec_rb.html">spec/integration/taxa_page_spec.rb</a></td>
            <td class='right_align'><tt>486</tt></td>
            <td class='right_align'><tt>358</tt></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>99.59%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:100px"></div>
            <div class="uncovered" style="width:0px"></div>
          </div></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>99.44%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:99px"></div>
            <div class="uncovered" style="width:1px"></div>
          </div></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <h3>Key</h3>
    
    <div class="key"><pre><span class='marked'>Code reported as executed by Ruby looks like this...</span><span class='marked1'>and this: this line is also marked as covered.</span><span class='inferred'>Lines considered as run by rcov, but not reported by Ruby, look like this,</span><span class='inferred1'>and this: these lines were inferred by rcov (using simple heuristics).</span><span class='uncovered'>Finally, here's a line marked as not executed.</span></pre></div>

    <h3>Coverage Details</h3>

    <table class="details">
      <tbody>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1">1</a> require File.dirname(__FILE__) + '/../spec_helper'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line2">2</a> require 'nokogiri'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line3">3</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line4">4</a> def find_unique_tc(options)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line5">5</a>   options[:in].hierarchy_entries.each do |entry|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line6">6</a>     return entry.taxon_concept unless entry.taxon_concept.in_hierarchy?(options[:not_in])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line7">7</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line8">8</a> end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line9">9</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line10">10</a> def find_common_tc(options)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line11">11</a>   options[:in].hierarchy_entries.each do |entry|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line12">12</a>     return entry.taxon_concept if entry.taxon_concept.in_hierarchy?(options[:also_in])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line13">13</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line14">14</a> end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line15">15</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line16">16</a> describe 'Taxa page (HTML)' do</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line17">17</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line18">18</a>   before(:all) do</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line19">19</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line20">20</a>     #RandomTaxon.delete_all # this should make us green again</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line21">21</a>     truncate_all_tables</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line22">22</a>     load_foundation_cache</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line23">23</a>     Capybara.reset_sessions!</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line24">24</a>     HierarchiesContent.delete_all</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line25">25</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line26">26</a>     # Long list of items to test:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line27">27</a>     begin</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line28">28</a>       @exemplar        = build_taxon_concept(:id =&gt; 910093) # That ID is one of the (hard-coded) exemplars.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line29">29</a>     rescue</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line30">30</a>       #there's already a tc with that id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line31">31</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line32">32</a>     @parent          = build_taxon_concept(:images =&gt; [], :toc =&gt; []) # Somewhat empty, to speed things up.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line33">33</a>     @overview        = TocItem.overview</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line34">34</a>     @cnames_toc      = TocItem.common_names.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line35">35</a>     @overview_text   = 'This is a test Overview, in all its glory'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line36">36</a>     # TODO - add a reference to the text object</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line37">37</a>     @toc_item_2      = TocItem.gen(:view_order =&gt; 2)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line38">38</a>     @toc_item_3      = TocItem.gen(:view_order =&gt; 3)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line39">39</a>     @canonical_form  = Factory.next(:species)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line40">40</a>     @attribution     = Faker::Eol.attribution</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line41">41</a>     @common_name     = Faker::Eol.common_name.firstcap</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line42">42</a>     @unreviewed_name = Faker::Eol.common_name.firstcap</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line43">43</a>     @untrusted_name  = Faker::Eol.common_name.firstcap</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line44">44</a>     @scientific_name = &quot;#{@canonical_form} #{@attribution}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line45">45</a>     @italicized      = &quot;&lt;i&gt;#{@canonical_form}&lt;/i&gt; #{@attribution}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line46">46</a>     @iucn_status     = Factory.next(:iucn)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line47">47</a>     @map_text        = 'Test Map'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line48">48</a>     @image_1         = Factory.next(:image)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line49">49</a>     @image_2         = Factory.next(:image)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line50">50</a>     @image_3         = Factory.next(:image)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line51">51</a>     @video_1_text    = 'First Test Video'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line52">52</a>     @video_2_text    = 'Second Test Video'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line53">53</a>     @video_3_text    = 'YouTube Test Video'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line54">54</a>     @comment_1       = 'This is totally awesome'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line55">55</a>     @comment_bad     = 'This is totally inappropriate'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line56">56</a>     @comment_2       = 'And I can comment multiple times'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line57">57</a>     @user            = User.gen</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line58">58</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line59">59</a>     @taxon_concept   = build_taxon_concept(</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line60">60</a>        :parent_hierarchy_entry_id =&gt; @parent.hierarchy_entries.first.id,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line61">61</a>        :rank            =&gt; 'species',</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line62">62</a>        :canonical_form  =&gt; @canonical_form,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line63">63</a>        :attribution     =&gt; @attribution,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line64">64</a>        :scientific_name =&gt; @scientific_name,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line65">65</a>        :italicized      =&gt; @italicized,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line66">66</a>        :iucn_status     =&gt; @iucn_status,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line67">67</a>        :map             =&gt; {:description =&gt; @map_text},</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line68">68</a>        :flash           =&gt; [{:description =&gt; @video_1_text}, {:description =&gt; @video_2_text}],</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line69">69</a>        :youtube         =&gt; [{:description =&gt; @video_3_text}],</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line70">70</a>        :comments        =&gt; [{:user =&gt; @user, :body =&gt; @comment_1},{:user =&gt; @user, :body =&gt; @comment_bad},{:user =&gt; @user, :body =&gt; @comment_2}],</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line71">71</a>        # We want more than 10 images, to test pagination, but details don't matter:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line72">72</a>        :images          =&gt; [{:object_cache_url =&gt; @image_1}, {:object_cache_url =&gt; @image_2},</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line73">73</a>                             {:object_cache_url =&gt; @image_3}, {}, {}, {}, {}, {}, {}, {}, {}, {}],</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line74">74</a>        :toc             =&gt; [{:toc_item =&gt; @overview, :description =&gt; @overview_text}, </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line75">75</a>                             {:toc_item =&gt; @toc_item_2}, {:toc_item =&gt; @toc_item_3}])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line76">76</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line77">77</a>     # TODO - I am slowly trying to move all of those options over to methods, to make things clearer:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line78">78</a>     @taxon_concept.add_common_name_synonym(@common_name, :agent =&gt; Agent.last, :language =&gt; Language.english,</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line79">79</a>                                            :vetted =&gt; Vetted.trusted, :preferred =&gt; true)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line80">80</a>     @taxon_concept.add_common_name_synonym(@unreviewed_name, :agent =&gt; Agent.last, :language =&gt; Language.english,</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line81">81</a>                                            :vetted =&gt; Vetted.unknown, :preferred =&gt; false)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line82">82</a>     @taxon_concept.add_common_name_synonym(@untrusted_name, :agent =&gt; Agent.last, :language =&gt; Language.english,</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line83">83</a>                                            :vetted =&gt; Vetted.untrusted, :preferred =&gt; false)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line84">84</a>     @child1        = build_taxon_concept(:parent_hierarchy_entry_id =&gt; @taxon_concept.hierarchy_entries.first.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line85">85</a>     @child2        = build_taxon_concept(:parent_hierarchy_entry_id =&gt; @taxon_concept.hierarchy_entries.first.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line86">86</a>     @id            = @taxon_concept.id</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line87">87</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line88">88</a>     # This is kind of confusing, but basically the next six lines will cause us to ping a host:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line89">89</a>     @ping_url      = 'TEST_with_%ID%'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line90">90</a>     @ping_id       = '424242'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line91">91</a>     @name          = @taxon_concept.taxon_concept_names.first.name</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line92">92</a>     @collection    = Hierarchy.gen(:ping_host_url =&gt; @ping_url)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line93">93</a>     @mapping       = HierarchyEntry.gen(:hierarchy =&gt; @collection, :name =&gt; @name, :identifier =&gt; @ping_id, :taxon_concept =&gt; @taxon_concept)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line94">94</a>     @ping_url.sub!(/%ID%/, @ping_id) # So we can test that it was replaced by the code.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line95">95</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line96">96</a>     @col_collection = Hierarchy.gen(:agent =&gt; Agent.catalogue_of_life, :label =&gt; &quot;Catalogue of Life Collection&quot;, :outlink_uri =&gt; &quot;http://www.catalogueoflife.org/browse_taxa.php?selected_taxon=%%ID%%&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line97">97</a>     @col_mapping    = HierarchyEntry.gen(:hierarchy =&gt; @col_collection, :name =&gt; @taxon_concept.taxon_concept_names.first.name, :taxon_concept =&gt; @taxon_concept, :source_url =&gt; &quot;http://example.com&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line98">98</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line99">99</a>     description       = 'user wants &lt;b&gt;bold&lt;/b&gt; and &lt;i&gt;italics&lt;/i&gt; and &lt;a href=&quot;link&quot;&gt;links&lt;/a&gt;'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line100">100</a>     @description_bold = /user wants &lt;(b|strong)&gt;bold&lt;\/(b|strong)&gt;/</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line101">101</a>     @description_ital = /and &lt;(i|em)&gt;italics&lt;\/(i|em)&gt;/</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line102">102</a>     @description_link = /and &lt;a href=&quot;link&quot;&gt;links&lt;\/a&gt;/</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line103">103</a>     @taxon_concept.add_user_submitted_text(:description =&gt; description, :vetted =&gt; true)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line104">104</a>     @taxon_concept.add_user_submitted_text(:description =&gt; description, :vetted =&gt; true)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line105">105</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line106">106</a>     @toc_item_with_no_trusted_items = TocItem.gen(:label =&gt; 'Untrusted Stuff')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line107">107</a>     @taxon_concept.add_toc_item(@toc_item_with_no_trusted_items, :vetted =&gt; false)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line108">108</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line109">109</a>     @curator       = build_curator(@taxon_concept)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line110">110</a>     Comment.find_by_body(@comment_bad).hide User.last</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line111">111</a>     # doesn't work, why?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line112">112</a>     visit(&quot;/pages/#{@id}&quot;) # cache the response the taxon page gives before changes</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line113">113</a>     @result        = page </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line114">114</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line115">115</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line116">116</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line117">117</a>   after :all do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line118">118</a>     truncate_all_tables</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line119">119</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line120">120</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line121">121</a>   # This is kind of a baseline, did-the-page-actually-load test:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line122">122</a>     it 'should include the italicized name in the header' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line123">123</a>       @result.body.should have_tag('div#page-title') do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line124">124</a>         with_tag('h1', :text =&gt; @scientific_name)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line125">125</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line126">126</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line127">127</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line128">128</a>     it 'should show the common name if one exists' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line129">129</a>       @result.body.should have_tag('div#page-title') do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line130">130</a>         with_tag('h2', :text =&gt; @common_name)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line131">131</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line132">132</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line133">133</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line134">134</a>     it 'should NOT show a view/edit link after the common name when non-curator' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line135">135</a>       @result.body.should have_tag('div#page-title') do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line136">136</a>         with_tag('h2') do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line137">137</a>           without_tag(&quot;span#curate-common-names&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line138">138</a>           without_tag(&quot;span&quot;, :text =&gt; /view\/edit/)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line139">139</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line140">140</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line141">141</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line142">142</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line143">143</a>     it 'should not show the common name if none exists' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line144">144</a>       tc = build_taxon_concept</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line145">145</a>       visit(&quot;/pages/#{tc.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line146">146</a>       body.should have_tag('div#page-title') do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line147">147</a>         with_tag('h2', :text =&gt; '')</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line148">148</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line149">149</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line150">150</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line151">151</a>     it 'should use supercedure to find taxon concept' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line152">152</a>       superceded = TaxonConcept.gen(:supercedure_id =&gt; @id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line153">153</a>       visit(&quot;/pages/#{superceded.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line154">154</a>       current_path.should == &quot;/pages/#{@id}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line155">155</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line156">156</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line157">157</a>     it 'should tell the user the page is missing if the page is... uhhh... missing' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line158">158</a>       missing_id = TaxonConcept.last.id + 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line159">159</a>       while(TaxonConcept.exists?(missing_id)) do</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line160">160</a>         missing_id += 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line161">161</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line162">162</a>       visit(&quot;/pages/#{missing_id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line163">163</a>       body.should have_tag('h1', :text =&gt; 'Sorry, the page you have requested does not exist.')</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line164">164</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line165">165</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line166">166</a>     it 'should tell the user the page is missing if the TaxonConcept is unpublished' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line167">167</a>       unpublished = TaxonConcept.gen(:published =&gt; 0, :supercedure_id =&gt; 0)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line168">168</a>       visit(&quot;/pages/#{unpublished.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line169">169</a>       body.should have_tag(&quot;div#page-title&quot;) do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line170">170</a>         with_tag('h1', :text =&gt; 'Sorry, the page you have requested does not exist.')</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line171">171</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line172">172</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line173">173</a>     </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line174">174</a>     it 'should render when an object has no agents' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line175">175</a>       taxon_concept = build_taxon_concept</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line176">176</a>       first_image = taxon_concept.top_concept_images[0].data_object</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line177">177</a>       first_agent_name = first_image.agents[0].full_name</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line178">178</a>       </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line179">179</a>       visit(&quot;/pages/#{taxon_concept.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line180">180</a>       body.should have_tag(&quot;img.main-image&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line181">181</a>       body.should include(first_agent_name)  # verify the agent exists</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line182">182</a>       </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line183">183</a>       first_image.agents.each{|a| a.delete}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line184">184</a>       visit(&quot;/pages/#{taxon_concept.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line185">185</a>       body.should have_tag(&quot;img.main-image&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line186">186</a>       body.should_not include(first_agent_name) # verify the agent is gone yet the page still loads</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line187">187</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line188">188</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line189">189</a>     # it 'should be able to ping the collection host' do</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line190">190</a>     # end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line191">191</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line192">192</a>     it 'should show the Overview text by default' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line193">193</a>       visit(&quot;/pages/#{@id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line194">194</a>       body.should have_tag('div.cpc-header') do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line195">195</a>         with_tag('h3', :text =&gt; 'Overview')</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line196">196</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line197">197</a>       body.should include(@overview_text)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line198">198</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line199">199</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line200">200</a>     it 'should NOT show references for the overview text when there aren\'t any' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line201">201</a>       Ref.delete_all</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line202">202</a>       visit(&quot;/pages/#{@id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line203">203</a>       body.should_not have_tag('div.references')</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line204">204</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line205">205</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line206">206</a>     it 'should show references for the overview text (with URL and DOI identifiers ONLY) when present' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line207">207</a>       full_ref = 'This is the reference text that should show up'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line208">208</a>       # TODO - When we add &quot;helper&quot; methods to Rails classes for testing, then &quot;add_reference&quot; could be</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line209">209</a>       # extracted to do this:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line210">210</a>       url_identifier = 'some/url.html'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line211">211</a>       doi_identifier = '10.12355/foo/bar.baz.230'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line212">212</a>       bad_identifier = 'you should not see this identifier'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line213">213</a>       @taxon_concept.overview[0].refs &lt;&lt; ref = Ref.gen(:full_reference =&gt; full_ref, :published =&gt; 1, :visibility =&gt; Visibility.visible)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line214">214</a>       # I heard you like RSpec, so we put a lot of tests in your test so you could spec while you're</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line215">215</a>       # speccing.There are actually a lot of 'tests' in this test.  For one, we're testing that URLs will have http://</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line216">216</a>       # added to them if they are blank.  We're also testing the regex that pulls DOIs out of potentially</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line217">217</a>       # messy DOI identifiers:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line218">218</a>       ref.add_identifier('url', url_identifier)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line219">219</a>       ref.add_identifier('doi', &quot;doi: #{doi_identifier}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line220">220</a>       ref.add_identifier('bad', bad_identifier)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line221">221</a>       visit(&quot;/pages/#{@id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line222">222</a>       body.should have_tag('div.references')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line223">223</a>       body.should include(full_ref)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line224">224</a>       body.should have_tag(&quot;a[href=http://#{url_identifier}]&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line225">225</a>       body.should_not include(bad_identifier)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line226">226</a>       body.should have_tag(&quot;a[href=http://dx.doi.org/#{doi_identifier}]&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line227">227</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line228">228</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line229">229</a>     it 'should NOT show references for the overview text when reference is invisible' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line230">230</a>       full_ref = 'This is the reference text that should show up'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line231">231</a>       @taxon_concept.overview[0].refs &lt;&lt; ref = Ref.gen(:full_reference =&gt; full_ref, :published =&gt; 1, :visibility =&gt; Visibility.invisible)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line232">232</a>       visit(&quot;/pages/#{@id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line233">233</a>       body.should_not have_tag('div.references')</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line234">234</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line235">235</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line236">236</a>     it 'should NOT show references for the overview text when reference is unpublished' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line237">237</a>       full_ref = 'This is the reference text that should show up'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line238">238</a>       @taxon_concept.overview[0].refs &lt;&lt; ref = Ref.gen(:full_reference =&gt; full_ref, :published =&gt; 0, :visibility =&gt; Visibility.visible)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line239">239</a>       visit(&quot;/pages/#{@id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line240">240</a>       body.should_not have_tag('div.references')</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line241">241</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line242">242</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line243">243</a>     it 'should allow html in user-submitted text' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line244">244</a>       visit(&quot;/pages/#{@id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line245">245</a>       body.should match(@description_bold)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line246">246</a>       body.should match(@description_ital)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line247">247</a>       body.should match(@description_link)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line248">248</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line249">249</a>   </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line250">250</a>     # I hate to do this, since it's SO SLOW, but:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line251">251</a>     it 'should render an &quot;empty&quot; page in authoritative mode' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line252">252</a>       tc = build_taxon_concept(:common_names =&gt; [], :images =&gt; [], :toc =&gt; [], :flash =&gt; [], :youtube =&gt; [],</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line253">253</a>                                :comments =&gt; [], :bhl =&gt; [])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line254">254</a>       visit(&quot;/pages/#{tc.id}?vetted=true&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line255">255</a>       body.should_not include('Internal Server Error')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line256">256</a>       body.should have_tag('h1') # Whatever, let's just prove that it renders.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line257">257</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line258">258</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line259">259</a>     it 'should show common names with their trust levels in the Common Names toc item' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line260">260</a>       visit(&quot;/pages/#{@taxon_concept.id}?category_id=#{@cnames_toc}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line261">261</a>       body.should have_tag(&quot;div#common_names_wrapper&quot;) do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line262">262</a>         with_tag('td.trusted', :text =&gt; @common_name)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line263">263</a>         with_tag('td.unreviewed', :text =&gt; @unreviewed_name)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line264">264</a>         with_tag('td.untrusted', :text =&gt; @untrusted_name)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line265">265</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line266">266</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line267">267</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line268">268</a>     it 'should show the Catalogue of Life link in Content Partners' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line269">269</a>       visit(&quot;/pages/#{@taxon_concept.id}?category_id=#{TocItem.content_partners.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line270">270</a>       body.should include(@col_collection.label)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line271">271</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line272">272</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line273">273</a>     it 'should show the Catalogue of Life link in the header' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line274">274</a>       visit(&quot;/pages/#{@taxon_concept.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line275">275</a>       body.should include(&quot;recognized by &lt;a href=\&quot;#{@col_mapping.source_url}\&quot;&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line276">276</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line277">277</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line278">278</a>     it 'should show a Nucleotide Sequences table of content item if concept in NCBI and has identifier' do</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line279">279</a>       # make an entry in NCBI for this concept and give it an identifier</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line280">280</a>       sci_name = Name.gen(:string =&gt; Factory.next(:scientific_name))</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line281">281</a>       entry = build_hierarchy_entry(0, @taxon_concept, sci_name,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line282">282</a>                   :identifier =&gt; 1234,</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line283">283</a>                   :hierarchy =&gt; Hierarchy.ncbi )</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line284">284</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line285">285</a>       visit(&quot;/pages/#{@taxon_concept.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line286">286</a>       body.should include(&quot;Nucleotide Sequences&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line287">287</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line288">288</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line289">289</a>     it 'should show not a Nucleotide Sequences table of content item if concept in NCBI and does not have an identifier' do</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line290">290</a>       # make an entry in NCBI for this concept and dont give it an identifier</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line291">291</a>       sci_name = Name.gen(:string =&gt; Factory.next(:scientific_name))</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line292">292</a>       entry = build_hierarchy_entry(0, @taxon_concept, sci_name,</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line293">293</a>                   :hierarchy =&gt; Hierarchy.ncbi )</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line294">294</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line295">295</a>       visit(&quot;/pages/#{@taxon_concept.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line296">296</a>       body.should_not include(&quot;Nucleotide Sequences&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line297">297</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line298">298</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line299">299</a>   it 'should show the hierarchy descriptive label in the drop down if there is one' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line300">300</a>     col = Hierarchy.default</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line301">301</a>     @result.body.should match /value='#{col.id}'&gt;\s*#{col.label}\s*&lt;\/option&gt;/ # selector default</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line302">302</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line303">303</a>     col.descriptive_label = 'A DIFFERENT LABEL FOR TESTING'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line304">304</a>     col.save!</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line305">305</a>     visit(&quot;/pages/#{@id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line306">306</a>     body.should match /value='#{col.id}'&gt;\s*#{col.descriptive_label}\s*&lt;\/option&gt;/ # selector default</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line307">307</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line308">308</a>     col.descriptive_label = nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line309">309</a>     col.save!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line310">310</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line311">311</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line312">312</a>   describe 'specified hierarchies' do</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line313">313</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line314">314</a>     before(:all) do</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line315">315</a>       #creating an NCBI hierarchy and some others</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line316">316</a>       Hierarchy.delete_all(&quot;label = 'NCBI Taxonomy'&quot;) # Not sure why, but we end up with lots of these.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line317">317</a>       @ncbi = Hierarchy.gen(:agent =&gt; Agent.ncbi, :label =&gt; &quot;NCBI Taxonomy&quot;, :browsable =&gt; 1)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line318">318</a>       @browsable_hierarchy = Hierarchy.gen(:label =&gt; &quot;Browsable Hierarchy&quot;, :browsable =&gt; 1)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line319">319</a>       @non_browsable_hierarchy = Hierarchy.gen(:label =&gt; &quot;NonBrowsable Hierarchy&quot;, :browsable =&gt; 0)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line320">320</a>   </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line321">321</a>       # making entries for this concept in the new hierarchies</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line322">322</a>       HierarchyEntry.gen(:hierarchy =&gt; @ncbi, :taxon_concept =&gt; @taxon_concept)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line323">323</a>       HierarchyEntry.gen(:hierarchy =&gt; @browsable_hierarchy, :taxon_concept =&gt; @taxon_concept)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line324">324</a>       HierarchyEntry.gen(:hierarchy =&gt; @non_browsable_hierarchy, :taxon_concept =&gt; @taxon_concept)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line325">325</a>   </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line326">326</a>       # and another entry just in NCBI</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line327">327</a>       HierarchyEntry.gen(:hierarchy =&gt; @ncbi)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line328">328</a>       @user_with_default_hierarchy = User.gen(:default_hierarchy_id =&gt; Hierarchy.default.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line329">329</a>       @user_with_ncbi_hierarchy    = User.gen(:default_hierarchy_id =&gt; @ncbi.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line330">330</a>       @user_with_nil_hierarchy     = User.gen(:default_hierarchy_id =&gt; nil)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line331">331</a>       @user_with_missing_hierarchy = User.gen(:default_hierarchy_id =&gt; 100056) # Seems safe not to assert this</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line332">332</a>       @default_tc = find_unique_tc(:in =&gt; Hierarchy.default, :not_in =&gt; @ncbi)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line333">333</a>       @ncbi_tc    = find_unique_tc(:not_in =&gt; Hierarchy.default, :in =&gt; @ncbi)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line334">334</a>       @common_tc  = find_common_tc(:in =&gt; Hierarchy.default, :also_in =&gt; @ncbi)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line335">335</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line336">336</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line337">337</a>     after(:each) do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line338">338</a>       visit(&quot;/logout&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line339">339</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line340">340</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line341">341</a>     it &quot;should see 'not in hierarchy' message when the user doesn't specify a default hierarchy and page is not in default hierarchy&quot; do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line342">342</a>       login_as @user_with_nil_hierarchy</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line343">343</a>       visit(&quot;/pages/#{@ncbi_tc.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line344">344</a>       body.should match /Name not in\s*#{Hierarchy.default.label}/</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line345">345</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line346">346</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line347">347</a>     it &quot;should set the class of the hierarchy select drop-down based on whether a hierarchy is in or out of that hierarchy&quot; do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line348">348</a>       login_as @user_with_ncbi_hierarchy</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line349">349</a>       visit(&quot;/pages/#{@ncbi_tc.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line350">350</a>       body.should have_tag('select.choose-hierarchy-select') do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line351">351</a>         with_tag('option.in', :text =&gt; /#{@ncbi.label}/)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line352">352</a>         with_tag('option.out', :text =&gt; /#{Hierarchy.default.label}/)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line353">353</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line354">354</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line355">355</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line356">356</a>     it &quot;should recognize the browsable hierarchy attribute&quot; do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line357">357</a>       visit(&quot;/pages/#{@taxon_concept.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line358">358</a>       body.should have_tag('select.choose-hierarchy-select') do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line359">359</a>         with_tag('option[selected=selected]', :text =&gt; /#{Hierarchy.default.label}/)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line360">360</a>         with_tag('option', :text =&gt; /#{@ncbi.label}/)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line361">361</a>         with_tag('option', :text =&gt; /#{@browsable_hierarchy.label}/)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line362">362</a>         without_tag('option', :text =&gt; /#{@non_browsable_hierarchy.label}/)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line363">363</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line364">364</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line365">365</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line366">366</a>     it &quot;should attribute the default hierarchy when the user doesn't specify one and the page is in both hierarchies&quot; do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line367">367</a>       login_as @user_with_nil_hierarchy</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line368">368</a>       visit(&quot;/pages/#{@common_tc.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line369">369</a>       body.should have_tag('span.classification-attribution-name', :text =&gt; /Species recognized by/) do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line370">370</a>         with_tag(&quot;a[href^=#{@col_mapping.outlink[:outlink_url]}]&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line371">371</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line372">372</a>       body.should have_tag('select.choose-hierarchy-select') do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line373">373</a>         with_tag('option[selected=selected]', :text =&gt; /#{Hierarchy.default.label}/)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line374">374</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line375">375</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line376">376</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line377">377</a>     it &quot;should attribute the default hierarchy when the user has it as the default and page is in both hierarchies&quot; do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line378">378</a>       login_as @user_with_default_hierarchy</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line379">379</a>       visit(&quot;/pages/#{@common_tc.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line380">380</a>       body.should have_tag('span.classification-attribution-name', :text =&gt; /Species recognized by/) do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line381">381</a>         with_tag(&quot;a[href^=#{@col_mapping.outlink[:outlink_url]}]&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line382">382</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line383">383</a>       body.should have_tag('select.choose-hierarchy-select') do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line384">384</a>         with_tag('option[selected=selected]', :text =&gt; /#{Hierarchy.default.label}/)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line385">385</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line386">386</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line387">387</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line388">388</a>     it &quot;should use the label from the NCBI hierarchy when the user has it as the default and page is in both hierarchies&quot; do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line389">389</a>       login_as @user_with_ncbi_hierarchy</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line390">390</a>       visit(&quot;/pages/#{@common_tc.id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line391">391</a>       body.should have_tag('span.classification-attribution-name', :text =&gt; /Species recognized by/) do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line392">392</a>         with_tag(&quot;a[href^=#{@ncbi.agent.homepage.strip}]&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line393">393</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line394">394</a>       body.should have_tag('select.choose-hierarchy-select') do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line395">395</a>         with_tag('option[selected=selected]', :text =&gt; /#{@ncbi.label}/)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line396">396</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line397">397</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line398">398</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line399">399</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line400">400</a>   # # Red background/icon on untrusted videos</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line401">401</a>   # it &quot;should show red background for untrusted video links&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line402">402</a>   # it &quot;should not show red background for trusted video links&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line403">403</a>   # it &quot;should show red box with 'Videos in red are not trusted.' if there are untrusted videos&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line404">404</a>   # it &quot;should not show red box with 'Videos in red are not trusted.' if there are no untrusted videos&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line405">405</a>   # it &quot;should show red background around player for untrusted videos&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line406">406</a>   # it &quot;should not show red background around player for trusted videos&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line407">407</a>   # it &quot;should show red information button if untrusted video plays&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line408">408</a>   # it &quot;should show green information button if trusted video plays&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line409">409</a>   # it &quot;should show red background for notes area if untrusted video plays&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line410">410</a>   # it &quot;should not show red background for notes area if trusted video plays&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line411">411</a>   # </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line412">412</a>   # # LigerCat Medical Concepts Tag Cloud</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line413">413</a>   # it 'should link to LigerCat when the Medical Concepts content is displayed'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line414">414</a>   #   # TODO - this will simply: 1) ensure the TC has a biomedical_terms toc item, 2) load that page with the</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line415">415</a>   #   # content_id for biomedical_terms, and 3) verify that the page includes the URL we expect.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line416">416</a>   #   </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line417">417</a>   # # permalinks for species comments</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line418">418</a>   # it 'should load comment with the id when comment_id is specified'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line419">419</a>   # it 'should hide image when load comment'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line420">420</a>   # it 'should have only comments tab active (blue dot)'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line421">421</a>   # it 'should not show comment when another tab chosen'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line422">422</a>   # </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line423">423</a>   # #image permalinks</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line424">424</a>   # it 'should load image as main image when image_id is specified'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line425">425</a>   # it 'should switch current_user.vetted to false when image_id is specified and is a unknown or untrusted image'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line426">426</a>   # it 'should paginate to the correct page when image_id is specified and does not exist on the first page of thumbnails'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line427">427</a>   # it 'should return 404 page when permalink image_id is specified that doesn\'t exist in the database'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line428">428</a>   # it 'should return 404 page when permalink image_id is specified that isn\'t associated with species page'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line429">429</a>   # it 'should return 404 page when permalink image_id is specified for an image which is hidden and user which isn\'t a curator'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line430">430</a>   # it 'should load hidden image via permalink when user is a curator of the page'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line431">431</a>   # it 'should return 404 page when permalink image_id is specified for an image which has been removed'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line432">432</a>   # it 'should load removed image via permalink when user is an admin'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line433">433</a>   # </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line434">434</a>   # #text permalinks</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line435">435</a>   # it 'should switch selected TOC when text_id is specified and not on the default selected TOC'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line436">436</a>   # it 'should current_user.vetted to false when permalink with text_id is specified for a text object which is unknown or untrusted'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line437">437</a>   # it 'should return 404 page when loading permalink for text which doesn\'t exist in the database'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line438">438</a>   # it 'should return 404 page when loading permalink for text which isn\'t associated with species page'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line439">439</a>   # it 'should return 404 page when loading permalink for text which is hidden when the user isn\'t a curator'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line440">440</a>   # it 'should load hidden text via permalink when user is a curator of the page'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line441">441</a>   # it 'should return 404 page when loading permalink for text which has been removed and user isn\'t an admin'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line442">442</a>   # it 'should load removed text via permalink when user is an admin'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line443">443</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line444">444</a>   it 'should include the TocItem with only unvetted content in it' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line445">445</a>     Capybara.reset_sessions! #previous session influenced this spec</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line446">446</a>     visit(&quot;/pages/#{@id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line447">447</a>     body.should have_tag('a', :text =&gt; /#{@toc_item_with_no_trusted_items.label}/)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line448">448</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line449">449</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line450">450</a>   it 'should show info item label for the overview text when there isn\'t an object_title' do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line451">451</a>     info_item_title = InfoItem.find(:last)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line452">452</a>     data_object = @taxon_concept.overview.first</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line453">453</a>     DataObjectsInfoItem.gen(:data_object =&gt; data_object, :info_item =&gt; InfoItem.find(:last))</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line454">454</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line455">455</a>     data_object.object_title = &quot;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line456">456</a>     data_object.save!</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line457">457</a>     visit(&quot;/pages/#{@id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line458">458</a>     body.should include(info_item_title.label)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line459">459</a>   </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line460">460</a>     # show object_title if it exists</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line461">461</a>     data_object.object_title = &quot;Some Title&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line462">462</a>     data_object.save!</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line463">463</a>     visit(&quot;/pages/#{@id}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line464">464</a>     body.should include(data_object.object_title)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line465">465</a>     body.should_not include(info_item_title.label)        </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line466">466</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line467">467</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line468">468</a>   it 'should show images on the page' do </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line469">469</a>     tc = build_taxon_concept(:images =&gt; </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line470">470</a>       [{:vetted =&gt; Vetted.untrusted}, </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line471">471</a>        {:vetted =&gt; Vetted.unknown},</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line472">472</a>        {}])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line473">473</a>     unvetted_count = tc.images.select {|i| i.vetted? == false}.size</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line474">474</a>     visit(&quot;/pages/#{tc.id}?vetted=true&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line475">475</a>     body_vetted = body</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line476">476</a>     body_vetted.should include &quot;authoritative information&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line477">477</a>     visit(&quot;/pages/#{tc.id}?vetted=false&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line478">478</a>     body_all = body</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line479">479</a>     body_all.should include &quot;all information&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line480">480</a>     dom_all = Nokogiri.HTML(body_all)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line481">481</a>     dom_vetted = Nokogiri.HTML(body_vetted)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line482">482</a>     unvetted_count.should == 2 </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line483">483</a>     (dom_all.xpath(&quot;//div[@id='thumbnails']//img&quot;).size - dom_vetted.xpath(&quot;//div[@id='thumbnails']//img&quot;).size).should == unvetted_count</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line484">484</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line485">485</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line486">486</a> end</pre></td>
          </tr>
        
      </tbody>
    </table>

    <p>Generated on Thu Dec 23 15:15:36 -0800 2010 with <a href="http://github.com/relevance/rcov">rcov 0.9.8</a></p>

  </body>
</html>
