<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>app/models/user.rb</title>
    <link href="screen.css" media="all" rel="stylesheet" type="text/css" />
    <link href="print.css" media="print" rel="stylesheet" type="text/css" />
    
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <script type="text/javascript" src="rcov.js"></script>
  </head>
  <body>
    <h1>Eol C0 Coverage Information - RCov</h1>
    <h2>app/models/user.rb</h2>

    

    <div class="report_table_wrapper">
      <table class='report' id='report_table'>
        <thead>
          <tr>
            <th class="left_align">Name</th>
            <th class="right_align">Total Lines</th>
            <th class="right_align">Lines of Code</th>
            <th class="left_align">Total Coverage</th>
            <th class="left_align">Code Coverage</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="left_align"><a href="app-models-user_rb.html">app/models/user.rb</a></td>
            <td class='right_align'><tt>746</tt></td>
            <td class='right_align'><tt>574</tt></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>80.83%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:81px"></div>
            <div class="uncovered" style="width:19px"></div>
          </div></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>76.66%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:77px"></div>
            <div class="uncovered" style="width:23px"></div>
          </div></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <h3>Key</h3>
    
    <div class="key"><pre><span class='marked'>Code reported as executed by Ruby looks like this...</span><span class='marked1'>and this: this line is also marked as covered.</span><span class='inferred'>Lines considered as run by rcov, but not reported by Ruby, look like this,</span><span class='inferred1'>and this: these lines were inferred by rcov (using simple heuristics).</span><span class='uncovered'>Finally, here's a line marked as not executed.</span></pre></div>

    <h3>Coverage Details</h3>

    <table class="details">
      <tbody>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1">1</a> # NOTE - there is a method called #stale? (toward the bottom) which needs to be kept up-to-date with any changes made</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line2">2</a> # to the user model.  We *could* achieve a similar result with method_missing, but I worry that it would cause other</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line3">3</a> # problems.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line4">4</a> #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line5">5</a> # Note that email is NOT a unique field: one email address is allowed to have multiple accounts.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line6">6</a> # NOTE this inherist from MASTER.  All queries against a user need to be up-to-date, since this contains config information</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line7">7</a> # which can change quickly.  There is a similar clause in the execute() method in the connection proxy for masochism.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line8">8</a> class User &lt; $PARENT_CLASS_MUST_USE_MASTER</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line9">9</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line10">10</a>   belongs_to :curator_hierarchy_entry, :class_name =&gt; &quot;HierarchyEntry&quot;, :foreign_key =&gt; :curator_hierarchy_entry_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line11">11</a>   belongs_to :curator_verdict_by, :class_name =&gt; &quot;User&quot;, :foreign_key =&gt; :curator_verdict_by_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line12">12</a>   belongs_to :language</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line13">13</a>   belongs_to :agent</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line14">14</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line15">15</a>   has_many :curators_evaluated, :class_name =&gt; &quot;User&quot;, :foreign_key =&gt; :curator_verdict_by_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line16">16</a>   has_many :members</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line17">17</a>   has_many :data_object_tags, :class_name =&gt; DataObjectTags.to_s</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line18">18</a>   has_many :tags, :class_name =&gt; DataObjectTag.to_s, :through =&gt; :data_object_tags, :source =&gt; :data_object_tag</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line19">19</a>   has_many :comments</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line20">20</a>   has_many :last_curated_dates</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line21">21</a>   has_many :actions_histories</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line22">22</a>   has_many :users_data_objects</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line23">23</a>   has_many :user_ignored_data_objects</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line24">24</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line25">25</a>   has_one    :user_info</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line26">26</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line27">27</a>   before_save :check_curator_status</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line28">28</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line29">29</a>   accepts_nested_attributes_for :user_info</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line30">30</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line31">31</a>   @email_format_re = %r{^(?:[_\+a-z0-9-]+)(\.[_\+a-z0-9-]+)*@([a-z0-9-]+)(\.[a-zA-Z0-9\-\.]+)*(\.[a-z]{2,4})$}i</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line32">32</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line33">33</a>   validate :ensure_unique_username_against_master, :on =&gt; :create</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line34">34</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line35">35</a>   validates_presence_of :curator_verdict_by, :if =&gt; Proc.new { |obj| !obj.curator_verdict_at.blank? }</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line36">36</a>   validates_presence_of :curator_verdict_at, :if =&gt; Proc.new { |obj| !obj.curator_verdict_by.blank? }</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line37">37</a>   validates_presence_of :username</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line38">38</a>   validates_presence_of :given_name</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line39">39</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line40">40</a>   validates_length_of :username, :within =&gt; 4..32</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line41">41</a>   validates_length_of :entered_password, :within =&gt; 4..16, :on =&gt; :create</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line42">42</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line43">43</a>   validates_format_of :email, :with =&gt; @email_format_re</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line44">44</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line45">45</a>   validates_confirmation_of :entered_password</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line46">46</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line47">47</a>   attr_accessor :entered_password, :entered_password_confirmation, :curator_request</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line48">48</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line49">49</a>   # create a new user using default attributes and then update with supplied parameters</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line50">50</a>   def self.create_new options = {}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line51">51</a>     # NOTE - the agent_id is assigned in account controller, not in the model</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line52">52</a>     new_user = User.new</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line53">53</a>     new_user.send(:set_defaults) # It's a private method.  This is cheating, but we really DO want it private.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line54">54</a>     new_user.attributes = options</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line55">55</a>     new_user</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line56">56</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line57">57</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line58">58</a>   def self.authenticate(username, password)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line59">59</a>     user = self.find_by_username_and_active(username, true)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line60">60</a>     if user.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line61">61</a>       self.authenticate_by_email(username, password)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line62">62</a>     elsif user.hashed_password == self.hash_password(password)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line63">63</a>       user.reset_login_attempts # found a matching username and password matched!</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line64">64</a>       return true, user</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line65">65</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line66">66</a>       user.invalid_login_attempt</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line67">67</a>       return false, &quot;Invalid login or password&quot;[]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line68">68</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line69">69</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line70">70</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line71">71</a>   def self.authenticate_by_email(email, password)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line72">72</a>     users = User.find_all_by_email_and_active(email, true)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line73">73</a>     if users.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line74">74</a>       return self.fail_authentication_with_master_check(email)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line75">75</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line76">76</a>     users.each do |u| # check all users with matching email addresses to see if one of them matches the password</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line77">77</a>       if u.hashed_password == User.hash_password(password)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line78">78</a>         u.reset_login_attempts # found a match with email and password</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line79">79</a>         return true, u</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line80">80</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line81">81</a>         u.invalid_login_attempt # log the bad attempt for this user!</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line82">82</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line83">83</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line84">84</a>     if users.size &gt; 1 # more than 1 email address with no matching passwords</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line85">85</a>       return false, &quot;The email address is not unique - you must enter a username&quot;[]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line86">86</a>     else  # no matches yet again :(</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line87">87</a>       return false, &quot;Invalid login or password&quot;[]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line88">88</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line89">89</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line90">90</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line91">91</a>   def self.fail_authentication_with_master_check(user_identifier)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line92">92</a>     if self.active_on_master?(user_identifier)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line93">93</a>       return false, &quot;Your account is registered but not ready for you to access. Please try again in five minutes.&quot;[:account_registered_but_not_ready_try_later]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line94">94</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line95">95</a>       return false, &quot;Invalid login or password&quot;[]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line96">96</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line97">97</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line98">98</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line99">99</a>   def self.generate_key</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line100">100</a>     Digest::SHA1.hexdigest(rand(10**16).to_s + Time.now.to_f.to_s)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line101">101</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line102">102</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line103">103</a>   def self.active_on_master?(username)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line104">104</a>     User.with_master do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line105">105</a>       user = User.find_by_username_and_active(username, true)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line106">106</a>       user ||= User.find_by_email_and_active(username, true)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line107">107</a>       user.nil? ? false : true  # Just cleaning up the nil, is all.  False is less likely to annoy.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line108">108</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line109">109</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line110">110</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line111">111</a>   # TODO - test</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line112">112</a>   def self.users_with_submitted_text</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line113">113</a>     sql = &quot;SELECT DISTINCT users.id , users.given_name, users.family_name</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line114">114</a>       FROM users Join users_data_objects ON users.id = users_data_objects.user_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line115">115</a>       ORDER BY users.family_name, users.given_name&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line116">116</a>     rset = User.find_by_sql([sql])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line117">117</a>     return rset</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line118">118</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line119">119</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line120">120</a>   # TODO - test</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line121">121</a>   def self.users_with_activity_log</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line122">122</a>     sql = &quot;SELECT distinct u.id , u.given_name, u.family_name</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line123">123</a>       FROM users u</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line124">124</a>         JOIN #{ActivityLog.full_table_name} al ON u.id = al.user_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line125">125</a>       ORDER BY u.family_name, u.given_name&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line126">126</a>     </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line127">127</a>     User.with_master do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line128">128</a>       User.find_by_sql([sql])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line129">129</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line130">130</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line131">131</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line132">132</a>   # TODO - test</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line133">133</a>   def self.curated_data_object_ids(arr_dataobject_ids, year, month, agent_id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line134">134</a>     obj_ids = []</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line135">135</a>     user_ids = []</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line136">136</a>     if(arr_dataobject_ids.length &gt; 0 or agent_id == 'All') then</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line137">137</a>       sql = &quot;SELECT ah.object_id data_object_id, ah.user_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line138">138</a>         FROM action_with_objects awo</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line139">139</a>           JOIN actions_histories ah ON ah.action_with_object_id = awo.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line140">140</a>           JOIN changeable_object_types cot ON ah.changeable_object_type_id = cot.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line141">141</a>           JOIN users u ON ah.user_id = u.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line142">142</a>         WHERE cot.ch_object_type = 'data_object' &quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line143">143</a>       if(agent_id != 'All') then</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line144">144</a>         sql += &quot; AND ah.object_id IN (&quot; + arr_dataobject_ids * &quot;,&quot; + &quot;)&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line145">145</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line146">146</a>       if(year.to_i &gt; 0) then sql += &quot; AND year(ah.updated_at) = #{year} AND month(ah.updated_at) = #{month} &quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line147">147</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line148">148</a>       rset = User.find_by_sql([sql])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line149">149</a>       rset.each do |post|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line150">150</a>         obj_ids &lt;&lt; post.data_object_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line151">151</a>         user_ids &lt;&lt; post.user_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line152">152</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line153">153</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line154">154</a>     arr = [obj_ids, user_ids]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line155">155</a>     return arr</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line156">156</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line157">157</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line158">158</a>   # TODO - test</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line159">159</a>   def self.curated_data_objects(arr_dataobject_ids, year, month, page, report_type)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line160">160</a>     page = 1 if page == 0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line161">161</a>     sql = &quot;SELECT ah.object_id data_object_id, cot.ch_object_type,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line162">162</a>         awo.action_code code, u.given_name, u.family_name, ah.updated_at, ah.user_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line163">163</a>       FROM action_with_objects awo</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line164">164</a>         JOIN actions_histories ah ON ah.action_with_object_id = awo.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line165">165</a>         JOIN changeable_object_types cot ON ah.changeable_object_type_id = cot.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line166">166</a>         JOIN users u ON ah.user_id = u.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line167">167</a>       WHERE cot.ch_object_type = 'data_object'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line168">168</a>         AND ah.object_id IN (&quot; + arr_dataobject_ids * &quot;,&quot; + &quot;)&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line169">169</a>     if(year.to_i &gt; 0) then sql += &quot; AND year(ah.updated_at) = #{year} AND month(ah.updated_at) = #{month} &quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line170">170</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line171">171</a>     sql += &quot; AND awo.action_code in ('trusted', 'untrusted', 'inappropriate', 'delete') &quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line172">172</a>     sql += &quot; ORDER BY ah.id Desc&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line173">173</a>     if(report_type == &quot;rss feed&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line174">174</a>       self.find_by_sql [sql]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line175">175</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line176">176</a>       self.paginate_by_sql [sql], :per_page =&gt; 30, :page =&gt; page</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line177">177</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line178">178</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line179">179</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line180">180</a>   def self.hash_password(raw)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line181">181</a>     Digest::MD5.hexdigest(raw)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line182">182</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line183">183</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line184">184</a>   # returns true or false indicating if username is unique</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line185">185</a>   def self.unique_user?(username)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line186">186</a>     User.with_master do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line187">187</a>       User.count(:conditions =&gt; ['username = ?', username]) == 0</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line188">188</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line189">189</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line190">190</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line191">191</a>   # returns true or false indicating if email is unique</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line192">192</a>   def self.unique_email?(email)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line193">193</a>     User.with_master do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line194">194</a>       User.count(:conditions =&gt; ['email = ?', email]) == 0</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line195">195</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line196">196</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line197">197</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line198">198</a>   def password</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line199">199</a>     self.entered_password</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line200">200</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line201">201</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line202">202</a>   def validate</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line203">203</a>     errors.add_to_base &quot;Secondary hierarchy must be different than default&quot; if !secondary_hierarchy_id.nil? &amp;&amp; secondary_hierarchy_id == default_hierarchy_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line204">204</a>     if EOLConvert.to_boolean(curator_request)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line205">205</a>       if(credentials.blank?)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line206">206</a>         errors.add_to_base &quot;You must indicate your credentials and area of expertise to request curator privileges.&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line207">207</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line208">208</a>       if(curator_scope.blank? &amp;&amp; curator_hierarchy_entry.blank?)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line209">209</a>         errors.add_to_base &quot;You must either select a clade or indicate your scope to request curator privileges.&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line210">210</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line211">211</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line212">212</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line213">213</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line214">214</a>   def full_name</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line215">215</a>     return_value = given_name || &quot;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line216">216</a>     return_value += &quot; &quot; + family_name unless family_name.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line217">217</a>     return_value</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line218">218</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line219">219</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line220">220</a>   # TODO - test.  And move this (and many of the following methods) to their own module.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line221">221</a>   def objects_vetted</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line222">222</a>     # TODO - use eager loading to avoid the #map</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line223">223</a>     CuratorDataObjectLog.find_all_by_user_id_and_curator_activity_id( id, CuratorActivity.approve ).map(&amp;:object)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line224">224</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line225">225</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line226">226</a>   # TODO - test</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line227">227</a>   def total_objects_vetted</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line228">228</a>     # TODO - this needs to become a simple COUNT query</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line229">229</a>     CuratorDataObjectLog.find_all_by_user_id_and_curator_activity_id( id, CuratorActivity.approve ).length</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line230">230</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line231">231</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line232">232</a>   # TODO - test</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line233">233</a>   # get the total objects curated for a particular curator activity type</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line234">234</a>   def total_objects_curated_by_action(action)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line235">235</a>     curator_activity_id = CuratorActivity.send action+'!'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line236">236</a>     if !curator_activity_id.nil?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line237">237</a>       # TODO - change this to a #count.</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line238">238</a>       CuratorDataObjectLog.find_all_by_user_id_and_curator_activity_id( id, curator_activity_id ).length</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line239">239</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line240">240</a>       return 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line241">241</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line242">242</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line243">243</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line244">244</a>   # TODO - test</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line245">245</a>   def data_objects_curated</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line246">246</a>     hashes = connection.execute(&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line247">247</a>       SELECT ah.object_id data_object_id, awo.action_code, ah.updated_at action_time</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line248">248</a>       FROM actions_histories ah</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line249">249</a>         JOIN action_with_objects awo ON (ah.action_with_object_id = awo.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line250">250</a>       WHERE ah.user_id=#{id}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line251">251</a>         AND ah.changeable_object_type_id=#{ChangeableObjectType.data_object.id}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line252">252</a>         AND awo.action_code!='rate'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line253">253</a>       GROUP BY data_object_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line254">254</a>       ORDER BY action_time DESC&quot;).all_hashes.uniq</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line255">255</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line256">256</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line257">257</a>   # TODO - test</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line258">258</a>   def total_objects_curated</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line259">259</a>     data_objects_curated.length</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line260">260</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line261">261</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line262">262</a>   # TODO - test</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line263">263</a>   def comments_curated</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line264">264</a>     connection.execute(&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line265">265</a>       SELECT awo.action_code, ah.updated_at action_time, c.*</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line266">266</a>       FROM actions_histories ah</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line267">267</a>         JOIN action_with_objects awo ON (ah.action_with_object_id = awo.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line268">268</a>         JOIN comments c ON (ah.object_id = c.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line269">269</a>       WHERE ah.user_id=#{id}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line270">270</a>         AND ah.changeable_object_type_id=#{ChangeableObjectType.comment.id}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line271">271</a>         AND ah.action_with_object_id!=#{ActionWithObject.created.id}&quot;).all_hashes.uniq</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line272">272</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line273">273</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line274">274</a>   # TODO - test</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line275">275</a>   def total_comments_curated</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line276">276</a>     comments_curated.length</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line277">277</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line278">278</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line279">279</a>   # TODO - test</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line280">280</a>   def taxon_concept_ids_curated</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line281">281</a>     connection.select_values(&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line282">282</a>       SELECT dotc.taxon_concept_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line283">283</a>       FROM actions_histories ah</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line284">284</a>         JOIN action_with_objects awo ON (ah.action_with_object_id = awo.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line285">285</a>         JOIN #{DataObjectsTaxonConcept.full_table_name} dotc ON (ah.object_id = dotc.data_object_id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line286">286</a>       WHERE ah.user_id=#{id}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line287">287</a>         AND ah.changeable_object_type_id=#{ChangeableObjectType.data_object.id}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line288">288</a>         AND awo.action_code!='rate'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line289">289</a>       GROUP BY ah.object_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line290">290</a>       ORDER BY ah.updated_at DESC&quot;).uniq</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line291">291</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line292">292</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line293">293</a>   # TODO - test</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line294">294</a>   def total_species_curated</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line295">295</a>     taxon_concept_ids_curated.length</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line296">296</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line297">297</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line298">298</a>   # TODO - test all of these taggy things.  And move this to a module, I think.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line299">299</a>   def data_object_tags_for data_object</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line300">300</a>     data_object_tags.find_all_by_data_object_guid data_object.guid, :include =&gt; :data_object_tag</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line301">301</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line302">302</a>   def tags_for(data_object)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line303">303</a>     data_object_tags_for(data_object).map(&amp;:tag).uniq</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line304">304</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line305">305</a>   def tagged_objects</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line306">306</a>     data_object_tags.find_all.map(&amp;:object)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line307">307</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line308">308</a>   def tag_keys</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line309">309</a>     tags.map(&amp;:key).uniq</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line310">310</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line311">311</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line312">312</a>   # object might be a data object or taxon concept</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line313">313</a>   def can_curate? object</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line314">314</a>     return false unless curator_approved</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line315">315</a>     return false unless curator_hierarchy_entry</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line316">316</a>     return false unless object</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line317">317</a>     raise &quot;Don't know how to curate object of type #{ object.class }&quot; unless object.respond_to?:is_curatable_by?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line318">318</a>     object.is_curatable_by? self</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line319">319</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line320">320</a>   alias is_curator_for? can_curate?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line321">321</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line322">322</a>   # TODO - TEST (or remove... this seems silly.)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line323">323</a>   def can_curate_taxon_concept_id? taxon_concept_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line324">324</a>     can_curate? TaxonConcept.find(taxon_concept_id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line325">325</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line326">326</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line327">327</a>   def special</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line328">328</a>     @special ||= member_of(Community.special)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line329">329</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line330">330</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line331">331</a>   def approve_to_administrate</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line332">332</a>     grant_special_role(Role.administrator)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line333">333</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line334">334</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line335">335</a>   # Grants rights to their currently-selected HE.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line336">336</a>   def approve_to_curate</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line337">337</a>     approve_to_curate_clade curator_hierarchy_entry</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line338">338</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line339">339</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line340">340</a>   # Grants rights to a specific clade.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line341">341</a>   def approve_to_curate_clade clade</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line342">342</a>     clade = clade.id if clade.is_a? HierarchyEntry</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line343">343</a>     self.curator_hierarchy_entry_id = clade</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line344">344</a>     self.curator_approved = true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line345">345</a>     grant_special_role(Role.curator)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line346">346</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line347">347</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line348">348</a>   def grant_special_role(role)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line349">349</a>     join_community(Community.special)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line350">350</a>     special.add_role(role)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line351">351</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line352">352</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line353">353</a>   def revoke_curatorship</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line354">354</a>     self.curator_hierarchy_entry = nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line355">355</a>     self.curator_approved = false</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line356">356</a>     if special</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line357">357</a>       special.remove_role(Role.curator)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line358">358</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line359">359</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line360">360</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line361">361</a>   # Grants or revokes rights to their currently-selected HE *and* updates fields indicating who allowed this (and when).</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line362">362</a>   def approve_to_curate_by_user approved, updated_by</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line363">363</a>     # TODO - this will happen EVERY time the user's record is updated by an admin. So the name curator_verdict_at is</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line364">364</a>     # now misleading because it will get updated even when nothing about the user is changed (the edit form is loaded and</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line365">365</a>     # immediately saved).</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line366">366</a>     self.curator_verdict_at = Time.now</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line367">367</a>     self.curator_verdict_by = updated_by</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line368">368</a>     if (approved &amp;&amp; ! curator_approved) # The user wasn't a curator and is now approved</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line369">369</a>       approve_to_curate</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line370">370</a>       Notifier.deliver_curator_approved(self)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line371">371</a>     elsif ((! approved) &amp;&amp; curator_approved) # The user *was* a curator and is now rejected</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line372">372</a>       revoke_curatorship</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line373">373</a>       Notifier.deliver_curator_unapproved(self)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line374">374</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line375">375</a>     debugger</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line376">376</a>     self.save! unless self.validating</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line377">377</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line378">378</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line379">379</a>   def clear_curatorship updated_by, update_notes=&quot;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line380">380</a>     revoke_curatorship</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line381">381</a>     self.credentials = &quot;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line382">382</a>     self.curator_scope = &quot;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line383">383</a>     self.curator_verdict_at = Time.now</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line384">384</a>     self.curator_verdict_by = updated_by</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line385">385</a>     self.notes = &quot;&quot; if self.notes.nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line386">386</a>     unless update_notes.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line387">387</a>       self.notes += ' ; (' + updated_by.username + ' on ' + Date.today.to_s + '): ' + update_notes</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line388">388</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line389">389</a>     self.save!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line390">390</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line391">391</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line392">392</a>   def vet object</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line393">393</a>     object.vet(self) if object and object.respond_to? :vet and can_curate? object</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line394">394</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line395">395</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line396">396</a>   def unvet object</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line397">397</a>     object.unvet(self) if object and object.respond_to? :unvet and can_curate? object</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line398">398</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line399">399</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line400">400</a>   def reset_login_attempts</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line401">401</a>     self.failed_login_attempts = 0</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line402">402</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line403">403</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line404">404</a>   def invalid_login_attempt</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line405">405</a>     self.failed_login_attempts += 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line406">406</a>     logger.error &quot;Possible dictionary attack on user #{self.id} - #{self.failed_login_attempts} failed login attempts&quot; if</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line407">407</a>       self.failed_login_attempts &gt; 10 # Smells like a dictionary attack!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line408">408</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line409">409</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line410">410</a>   # set the password</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line411">411</a>   #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line412">412</a>   # this sets both the #entered_password (for temporary retrieval)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line413">413</a>   # and the #hashed_password</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line414">414</a>   #</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line415">415</a>   def password=(value)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line416">416</a>     self.entered_password = value</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line417">417</a>     self.hashed_password = User.hash_password(value)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line418">418</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line419">419</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line420">420</a>   # set the language from the abbreviation</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line421">421</a>   def language_abbr=(value)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line422">422</a>     self.language = Language.find_by_iso_639_1(value.downcase)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line423">423</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line424">424</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line425">425</a>   # grab the language abbreviation</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line426">426</a>   def language_abbr</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line427">427</a>     return language.nil? ? Language.english.iso_639_1 : language.iso_639_1</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line428">428</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line429">429</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line430">430</a>   def is_moderator?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line431">431</a>     return false if special.nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line432">432</a>     special.can?(Privilege.show_hide_comments)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line433">433</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line434">434</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line435">435</a>   def has_special_role?(role)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line436">436</a>     return false unless special</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line437">437</a>     special.roles.include?(role)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line438">438</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line439">439</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line440">440</a>   def is_admin?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line441">441</a>     has_special_role?(Role.administrator)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line442">442</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line443">443</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line444">444</a>   # TODO - whaaa?  Seriously?  All CPs are admins?  ...We should change this.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line445">445</a>   def is_content_partner?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line446">446</a>     has_special_role?(Role.administrator)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line447">447</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line448">448</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line449">449</a>   def curator_attempted?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line450">450</a>     !curator_hierarchy_entry.nil?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line451">451</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line452">452</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line453">453</a>   def is_curator?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line454">454</a>     return (has_special_role?(Role.curator) &amp;&amp; !curator_hierarchy_entry.blank?)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line455">455</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line456">456</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line457">457</a>   def selected_default_hierarchy</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line458">458</a>     hierarchy = Hierarchy.find_by_id(default_hierarchy_id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line459">459</a>     hierarchy.blank? ? '' : hierarchy.label</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line460">460</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line461">461</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line462">462</a>   def last_curator_activity</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line463">463</a>     lcd = LastCuratedDate.find_by_user_id(id, :order =&gt; 'last_curated DESC', :limit =&gt; 1)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line464">464</a>     return nil if lcd.nil?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line465">465</a>     return lcd.last_curated</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line466">466</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line467">467</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line468">468</a>   def show_unvetted?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line469">469</a>     return !vetted</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line470">470</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line471">471</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line472">472</a>   def check_curator_status</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line473">473</a>     credentials = '' if credentials.nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line474">474</a>     if curator_hierarchy_entry.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line475">475</a>       revoke_curatorship</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line476">476</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line477">477</a>       approve_to_curate</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line478">478</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line479">479</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line480">480</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line481">481</a>   alias :ar_to_xml :to_xml</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line482">482</a>   def to_xml(options = {})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line483">483</a>     default_only   = [:id, :credentials, :username] # TODO - should we add Given / Family names? I'm not sure, privacy an issue</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line484">484</a>     options[:only] = (options[:only] ? options[:only] + default_only : default_only)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line485">485</a>     ar_to_xml(options)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line486">486</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line487">487</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line488">488</a>   def tags_are_public_for_data_object?(data_object)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line489">489</a>     return can_curate?(data_object)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line490">490</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line491">491</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line492">492</a>   # Returns an array of data objects submitted by this user.  NOT USED ANYWHERE.  This is a convenience method for</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line493">493</a>   # developers to use.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line494">494</a>   def all_submitted_datos</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line495">495</a>     UsersDataObject.find(:all, :conditions =&gt; &quot;user_id = #{self[:id]}&quot;).map {|udo| DataObject.find(udo.data_object_id) }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line496">496</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line497">497</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line498">498</a>   # Returns an array of descriptions from all of the data objects submitted by this user.  NOT USED ANYWHERE.  This</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line499">499</a>   # is a convenience method for developers to use.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line500">500</a>   def all_submitted_dato_descriptions</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line501">501</a>     all_submitted_datos.map {|dato| dato.description }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line502">502</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line503">503</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line504">504</a>   # Sets the visibility to invisible and the vetted to untrusted on all DataObjects submitted by this user.  NOT</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line505">505</a>   # USED ANYWHERE.  This is a convenience method for developers to use.  ...particularly where they are submitting</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line506">506</a>   # lots of text objects for testing, but don't want the rest of the world to see them when they are done.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line507">507</a>   #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line508">508</a>   # No return value; will raise exceptions if things fail.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line509">509</a>   def hide_all_submitted_datos</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line510">510</a>     all_submitted_datos.each do |dato|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line511">511</a>       dato.vetted = Vetted.untrusted</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line512">512</a>       dato.visibility = Visibility.invisible</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line513">513</a>       dato.save!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line514">514</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line515">515</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line516">516</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line517">517</a>   def default_hierarchy_valid?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line518">518</a>     return(self[:default_hierarchy_id] and Hierarchy.exists?(self[:default_hierarchy_id]))</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line519">519</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line520">520</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line521">521</a>   # These create and unset the fields required for remembering users between browser closes</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line522">522</a>   def remember_me</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line523">523</a>     remember_me_for 2.weeks</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line524">524</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line525">525</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line526">526</a>   def remember_me_for(time)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line527">527</a>     remember_me_until time.from_now.utc</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line528">528</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line529">529</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line530">530</a>   def remember_me_until(time)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line531">531</a>     self.remember_token_expires_at = time</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line532">532</a>     self.remember_token = User.hash_password(&quot;#{email}--#{remember_token_expires_at}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line533">533</a>     self.save(false)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line534">534</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line535">535</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line536">536</a>   def forget_me</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line537">537</a>     self.remember_token_expires_at = nil</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line538">538</a>     self.remember_token            = nil</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line539">539</a>     self.save(false)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line540">540</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line541">541</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line542">542</a>   def content_page_cache_str</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line543">543</a>     str = &quot;#{language_abbr}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line544">544</a>     str += &quot;_#{default_hierarchy_id.to_s}&quot; unless default_hierarchy_id.to_s.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line545">545</a>     str</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line546">546</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line547">547</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line548">548</a>   def taxa_page_cache_str</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line549">549</a>     return &quot;#{language_abbr}_#{expertise}_#{vetted}_#{default_taxonomic_browser}_#{default_hierarchy_id}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line550">550</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line551">551</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line552">552</a>   # This is a method that checks if the user model pulled from a session is actually up-to-date:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line553">553</a>   #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line554">554</a>   # YOU SHOULD ADD NEW USER ATTRIBUTES TO THIS METHOD WHEN YOU TWEAK THE USER TABLE.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line555">555</a>   def stale?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line556">556</a>     # if you add to this, use 'and'; KEEP ALL OLD METHOD CHECKS.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line557">557</a>     return true unless attributes.keys.include?(&quot;filter_content_by_hierarchy&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line558">558</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line559">559</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line560">560</a>   def password_reset_url(original_port)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line561">561</a>     port = [&quot;80&quot;, &quot;443&quot;].include?(original_port.to_s) ? &quot;&quot; : &quot;:#{original_port}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line562">562</a>     new_token = User.generate_key</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line563">563</a>     success = self.update_attributes(:password_reset_token =&gt; new_token, :password_reset_token_expires_at =&gt; 24.hours.from_now)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line564">564</a>     http_string = $USE_SSL_FOR_LOGIN ? &quot;https&quot; : &quot;http&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line565">565</a>     if success</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line566">566</a>       return &quot;#{http_string}://#{$SITE_DOMAIN_OR_IP}#{port}/account/reset_password/#{new_token}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line567">567</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line568">568</a>       raise RuntimeError(&quot;Cannot save reset password data to the database&quot;) #TODO write it correctly</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line569">569</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line570">570</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line571">571</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line572">572</a>   def ensure_unique_username_against_master</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line573">573</a>     # NOTE - this weird id.blank? line was introduced because the :on =&gt; :create clause on the validation was not working.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line574">574</a>     # Very frustrating.  So, essentially, we make sure this user is newly created before proceeding.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line575">575</a>     if id.blank? # We don't care if the username is unique if the user is already in the system...</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line576">576</a>       errors.add('username', &quot;#{username} is already taken&quot;) unless User.unique_user?(username)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line577">577</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line578">578</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line579">579</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line580">580</a>   def rating_for_object_guid(guid)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line581">581</a>     UsersDataObjectsRating.find_by_data_object_guid_and_user_id(guid, self.id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line582">582</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line583">583</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line584">584</a>   def images_to_curate(options = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line585">585</a>     page = options[:page].blank? ? 1 : options[:page].to_i</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line586">586</a>     per_page = options[:per_page].blank? ? 30 : options[:per_page].to_i</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line587">587</a>     hierarchy_entry_id = options[:hierarchy_entry_id] || curator_hierarchy_entry_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line588">588</a>     hierarchy_entry = HierarchyEntry.find(hierarchy_entry_id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line589">589</a>     vetted_id = options[:vetted_id].nil? ? Vetted.unknown.id : options[:vetted_id]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line590">590</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line591">591</a>     solr_query = &quot;ancestor_id:#{hierarchy_entry.taxon_concept_id} AND published:1 AND data_type_id:#{DataType.image.id} AND visibility_id:#{Visibility.visible.id}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line592">592</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line593">593</a>     unless options[:content_partner_id].blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line594">594</a>       content_partner = ContentPartner.find(options[:content_partner_id].to_i)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line595">595</a>       resource_clause = content_partner.agent.resources.collect{|r| r.id}.join(&quot; OR resource_id:&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line596">596</a>       if resource_clause.blank?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line597">597</a>         solr_query &lt;&lt; &quot; AND resource_id:0&quot;  # This will return nothing, when the content partner has no resources</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line598">598</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line599">599</a>         solr_query &lt;&lt; &quot; AND (resource_id:#{resource_clause})&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line600">600</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line601">601</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line602">602</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line603">603</a>     data_object_ids = EOL::Solr::SolrSearchDataObjects.images_for_concept(solr_query, :fields =&gt; 'data_object_id', :rows =&gt; 500, :sort =&gt; 'created_at desc')</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line604">604</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line605">605</a>     return [] if data_object_ids.empty?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line606">606</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line607">607</a>     vetted_clause = vetted_id != 'all' ? &quot; AND do.vetted_id = #{vetted_id}&quot; : &quot;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line608">608</a>     result = DataObject.find_by_sql(&quot;SELECT do.id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line609">609</a>         FROM #{DataObject.full_table_name} do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line610">610</a>           LEFT JOIN #{UserIgnoredDataObject.full_table_name} uido ON (do.id=uido.data_object_id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line611">611</a>         WHERE do.id IN (#{data_object_ids.join(',')})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line612">612</a>           AND uido.id IS NULL</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line613">613</a>           #{vetted_clause}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line614">614</a>         GROUP BY do.guid</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line615">615</a>         ORDER BY do.created_at DESC</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line616">616</a>         LIMIT 0, 300&quot;);</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line617">617</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line618">618</a>     start = per_page * (page - 1)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line619">619</a>     last = start + per_page - 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line620">620</a>     data_object_ids_to_lookup = result[start..last].collect{|d| d.id}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line621">621</a>     result[start..last] = DataObject.details_for_objects(data_object_ids_to_lookup, :skip_refs =&gt; true, :add_common_names =&gt; true, :add_comments =&gt; true, :sort =&gt; 'id desc')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line622">622</a>     return result</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line623">623</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line624">624</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line625">625</a>   def ignored_data_objects(options = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line626">626</a>     hierarchy_entry_id = options[:hierarchy_entry_id] || curator_hierarchy_entry_id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line627">627</a>     hierarchy_entry = HierarchyEntry.find(hierarchy_entry_id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line628">628</a>     data_type_clause = options[:data_type_id].nil? ? '' : &quot; AND do.data_type_id = #{options[:data_type_id]}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line629">629</a>     </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line630">630</a>     data_object_ids = DataObjectsHierarchyEntry.find_by_sql(&quot;SELECT dohe.data_object_id </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line631">631</a>         FROM #{DataObject.full_table_name} do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line632">632</a>           JOIN #{UserIgnoredDataObject.full_table_name} uido ON (do.id=uido.data_object_id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line633">633</a>           JOIN #{DataObjectsHierarchyEntry.full_table_name} dohe ON (uido.data_object_id=dohe.data_object_id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line634">634</a>           JOIN #{HierarchyEntry.full_table_name} he on (dohe.hierarchy_entry_id = he.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line635">635</a>           JOIN #{HierarchyEntry.full_table_name} he1 on (he.taxon_concept_id = he1.taxon_concept_id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line636">636</a>         WHERE uido.user_id = #{self.id} </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line637">637</a>           AND he1.lft between #{hierarchy_entry.lft} and #{hierarchy_entry.rgt} </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line638">638</a>           #{data_type_clause}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line639">639</a>           AND he1.hierarchy_id = #{hierarchy_entry.hierarchy_id}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line640">640</a>           GROUP BY do.guid</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line641">641</a>           ORDER BY do.created_at DESC&quot;);</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line642">642</a>     return [] if data_object_ids.empty?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line643">643</a>     </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line644">644</a>     data_object_ids_to_lookup = data_object_ids.collect{|d| d.data_object_id}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line645">645</a>     result = DataObject.details_for_objects(data_object_ids_to_lookup, :skip_refs =&gt; true, :add_common_names =&gt; true, :add_comments =&gt; true, :sort =&gt; 'id desc')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line646">646</a>     return result</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line647">647</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line648">648</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line649">649</a>   def uservoice_token</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line650">650</a>     return nil if $USERVOICE_ACCOUNT_KEY.blank?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line651">651</a>     user_hash = Hash.new</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line652">652</a>     user_hash[:guid] = &quot;eol_#{self.id}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line653">653</a>     user_hash[:expires] = Time.now + 5.hours</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line654">654</a>     user_hash[:email] = self.email</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line655">655</a>     user_hash[:display_name] = self.full_name</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line656">656</a>     user_hash[:locale] = self.language.iso_639_1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line657">657</a>     self.is_admin? ? user_hash[:admin]='accept' : user_hash[:admin]='deny'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line658">658</a>     json_token = user_hash.to_json</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line659">659</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line660">660</a>     key = EzCrypto::Key.with_password $USERVOICE_ACCOUNT_KEY, $USERVOICE_API_KEY</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line661">661</a>     encrypted = key.encrypt(json_token)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line662">662</a>     token = CGI.escape(Base64.encode64(encrypted)).gsub(/\n/, '')</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line663">663</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line664">664</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line665">665</a>   # This is *very* generalized and tracks nearly everything:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line666">666</a>   def log_activity(what, options = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line667">667</a>     ActivityLog.log(what, options.merge(:user =&gt; self)) if self.id &amp;&amp; self.id != 0</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line668">668</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line669">669</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line670">670</a>   # This is at the object level (and is specific to curators)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line671">671</a>   def track_curator_activity(object, changeable_object_type, action, options = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line672">672</a>     comment_id = options[:comment] ? options[:comment].id : nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line673">673</a>     untrust_reasons = options[:untrust_reasons] || nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line674">674</a>     taxon_concept_id = options[:taxon_concept_id] || nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line675">675</a>     action_with_object_id     = ActionWithObject.find_by_action_code(action).id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line676">676</a>     changeable_object_type_id = ChangeableObjectType.find_by_ch_object_type(changeable_object_type).id</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line677">677</a>     actions_history = ActionsHistory.create(</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line678">678</a>       :user_id                   =&gt; self.id,</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line679">679</a>       :object_id                 =&gt; object.id,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line680">680</a>       :changeable_object_type_id =&gt; changeable_object_type_id,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line681">681</a>       :action_with_object_id     =&gt; action_with_object_id,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line682">682</a>       :comment_id                =&gt; comment_id,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line683">683</a>       :taxon_concept_id          =&gt; taxon_concept_id,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line684">684</a>       :created_at                =&gt; Time.now,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line685">685</a>       :updated_at                =&gt; Time.now</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line686">686</a>     )</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line687">687</a>     if untrust_reasons</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line688">688</a>       untrust_reasons.each do |ur|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line689">689</a>         actions_history.untrust_reasons &lt;&lt; ur</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line690">690</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line691">691</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line692">692</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line693">693</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line694">694</a>   def join_community(community)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line695">695</a>     member = Member.find_by_community_id_and_user_id(community.id, id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line696">696</a>     unless member</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line697">697</a>       member = Member.create!(:user_id =&gt; id, :community_id =&gt; community.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line698">698</a>       self.members &lt;&lt; member</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line699">699</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line700">700</a>     member</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line701">701</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line702">702</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line703">703</a>   def leave_community(community)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line704">704</a>     member = Member.find_by_user_id_and_community_id(id, community.id)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line705">705</a>     raise &quot;Couldn't find a member for this user&quot;[:could_not_find_user] unless member</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line706">706</a>     member.destroy</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line707">707</a>     self.reload</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line708">708</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line709">709</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line710">710</a>   def member_of?(community)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line711">711</a>     reload_if_stale</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line712">712</a>     self.members.map {|m| m.community_id}.include?(community.id)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line713">713</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line714">714</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line715">715</a>   def member_of(community)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line716">716</a>     reload_if_stale</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line717">717</a>     self.members.select {|m| m.community_id == community.id}.first</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line718">718</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line719">719</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line720">720</a> private</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line721">721</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line722">722</a>   # set the defaults on this user object</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line723">723</a>   # TODO - move the defaults to the database (LOW PRIO)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line724">724</a>   def set_defaults</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line725">725</a>     self.default_taxonomic_browser = $DEFAULT_TAXONOMIC_BROWSER</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line726">726</a>     self.expertise     = $DEFAULT_EXPERTISE.to_s</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line727">727</a>     self.language      = Language.english</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line728">728</a>     self.mailing_list  = false</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line729">729</a>     self.content_level = $DEFAULT_CONTENT_LEVEL</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line730">730</a>     self.vetted        = $DEFAULT_VETTED</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line731">731</a>     self.credentials   = ''</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line732">732</a>     self.curator_scope = ''</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line733">733</a>     self.active        = true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line734">734</a>     self.flash_enabled = true</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line735">735</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line736">736</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line737">737</a>   def reload_if_stale</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line738">738</a>     return false if new_record? or changed?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line739">739</a>     self.reload</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line740">740</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line741">741</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line742">742</a>   def password_required?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line743">743</a>     (hashed_password.blank? || hashed_password.nil?)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line744">744</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line745">745</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line746">746</a> end</pre></td>
          </tr>
        
      </tbody>
    </table>

    <p>Generated on Thu Dec 23 15:15:35 -0800 2010 with <a href="http://github.com/relevance/rcov">rcov 0.9.8</a></p>

  </body>
</html>
