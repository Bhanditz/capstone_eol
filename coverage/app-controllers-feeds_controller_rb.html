<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>app/controllers/feeds_controller.rb</title>
    <link href="screen.css" media="all" rel="stylesheet" type="text/css" />
    <link href="print.css" media="print" rel="stylesheet" type="text/css" />
    
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <script type="text/javascript" src="rcov.js"></script>
  </head>
  <body>
    <h1>Eol C0 Coverage Information - RCov</h1>
    <h2>app/controllers/feeds_controller.rb</h2>

    

    <div class="report_table_wrapper">
      <table class='report' id='report_table'>
        <thead>
          <tr>
            <th class="left_align">Name</th>
            <th class="right_align">Total Lines</th>
            <th class="right_align">Lines of Code</th>
            <th class="left_align">Total Coverage</th>
            <th class="left_align">Code Coverage</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="left_align"><a href="app-controllers-feeds_controller_rb.html">app/controllers/feeds_controller.rb</a></td>
            <td class='right_align'><tt>194</tt></td>
            <td class='right_align'><tt>145</tt></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>16.49%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:16px"></div>
            <div class="uncovered" style="width:84px"></div>
          </div></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>8.97%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:9px"></div>
            <div class="uncovered" style="width:91px"></div>
          </div></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <h3>Key</h3>
    
    <div class="key"><pre><span class='marked'>Code reported as executed by Ruby looks like this...</span><span class='marked1'>and this: this line is also marked as covered.</span><span class='inferred'>Lines considered as run by rcov, but not reported by Ruby, look like this,</span><span class='inferred1'>and this: these lines were inferred by rcov (using simple heuristics).</span><span class='uncovered'>Finally, here's a line marked as not executed.</span></pre></div>

    <h3>Coverage Details</h3>

    <table class="details">
      <tbody>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1">1</a> class FeedsController &lt; ApplicationController</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line2">2</a>   </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line3">3</a>   #/feeds/images/25 or texts or comments or all</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line4">4</a>   before_filter :set_session_hierarchy_variable</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line5">5</a>   caches_page :all, :images, :texts, :comments, :expires_in =&gt; 2.minutes</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line6">6</a>   @@maximum_feed_entries = 50</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line7">7</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line8">8</a>   def all</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line9">9</a>     lookup_content(:type =&gt; :all)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line10">10</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line11">11</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line12">12</a>   def images</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line13">13</a>     lookup_content(:type =&gt; :images, :title =&gt; 'Latest Images')</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line14">14</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line15">15</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line16">16</a>   def text</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line17">17</a>     lookup_content(:type =&gt; :text, :title =&gt; 'Latest Text')</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line18">18</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line19">19</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line20">20</a>   def comments</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line21">21</a>     lookup_content(:type =&gt; :comments, :title =&gt; 'Latest Comments')</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line22">22</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line23">23</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line24">24</a>   def lookup_content(options = {})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line25">25</a>     taxon_concept_id = params[:id] || nil</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line26">26</a>     options[:type] ||= :all</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line27">27</a>     options[:title] ||= 'Latest Images, Text and Comments'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line28">28</a>     begin</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line29">29</a>       taxon_concept = TaxonConcept.find(taxon_concept_id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line30">30</a>     rescue</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line31">31</a>       render_404</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line32">32</a>       return false</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line33">33</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line34">34</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line35">35</a>     feed_link = url_for(:controller =&gt; :taxa, :action =&gt; :show, :id =&gt; taxon_concept.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line36">36</a>     options[:title] += &quot; for #{taxon_concept.quick_scientific_name(:normal, @session_hierarchy)}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line37">37</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line38">38</a>     feed_items = []</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line39">39</a>     if options[:type] != :comments</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line40">40</a>       feed_items += DataObject.for_feeds(options[:type], taxon_concept.id, @@maximum_feed_entries)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line41">41</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line42">42</a>     if options[:type] == :comments</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line43">43</a>       feed_items += Comment.for_feeds(:comments, taxon_concept_id, @@maximum_feed_entries)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line44">44</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line45">45</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line46">46</a>     self.create_feed(feed_items, :type =&gt; options[:type], :id =&gt; taxon_concept_id, :title =&gt; options[:title], :link =&gt; feed_link)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line47">47</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line48">48</a>   </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line49">49</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line50">50</a>   def create_feed(feed_items, options = {})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line51">51</a>     @feed_url = url_for(:controller =&gt; 'feeds', :action =&gt; options[:type], :id =&gt; options[:id])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line52">52</a>     @feed_link = options[:link] || root_url</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line53">53</a>     @feed_title = options[:title] || 'Latest Images, Text and Comments'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line54">54</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line55">55</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line56">56</a>     feed_items.sort! {|x,y| y['created_at'] &lt;=&gt; x['created_at']}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line57">57</a>     feed_items = feed_items[0..@@maximum_feed_entries]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line58">58</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line59">59</a>     @feed_entries = []</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line60">60</a>     feed_items.each do |hash|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line61">61</a>       @feed_entries &lt;&lt; feed_entry(hash)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line62">62</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line63">63</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line64">64</a>     respond_to do |format|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line65">65</a>       format.atom { render :template =&gt; '/feeds/feed_template', :layout =&gt; false }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line66">66</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line67">67</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line68">68</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line69">69</a>   def feed_entry(hash)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line70">70</a>     entry = { :id =&gt; '', :title =&gt; '', :link =&gt; '', :content =&gt; '', :updated =&gt; '' }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line71">71</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line72">72</a>     link_type_id = :comment_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line73">73</a>     if hash['data_type_label'] == 'Image'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line74">74</a>       link_type_id = :image_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line75">75</a>     elsif hash['data_type_label'] == 'Text'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line76">76</a>       link_type_id = :text_id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line77">77</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line78">78</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line79">79</a>     entry[:title] = hash['scientific_name']</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line80">80</a>     entry[:link] = url_for(:controller =&gt; :taxa, :action =&gt; :show, :id =&gt; hash['taxon_concept_id'], link_type_id =&gt; hash['id'])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line81">81</a>     #entry[:id] = hash['guid']</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line82">82</a>     entry[:id] = entry[:link]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line83">83</a>     entry[:updated] = hash['created_at']</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line84">84</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line85">85</a>     content = hash['description'] + &quot;&lt;br/&gt;&lt;br/&gt;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line86">86</a>     if hash['data_type_label'] == 'Image'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line87">87</a>       content = &quot;&lt;img src='#{DataObject.image_cache_path(hash['object_cache_url'])}'/&gt;&lt;/a&gt;&lt;br/&gt;&quot; + content</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line88">88</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line89">89</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line90">90</a>     content += &quot;&lt;b&gt;License&lt;/b&gt;: #{hash['license_label']}&lt;br/&gt;&quot; unless hash['license_label'].blank?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line91">91</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line92">92</a>     # add attribution</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line93">93</a>     unless hash[&quot;agents&quot;].nil?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line94">94</a>       for agent in hash[&quot;agents&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line95">95</a>         content += &quot;&lt;b&gt;#{agent[&quot;role&quot;].capitalize}&lt;/b&gt;: #{agent[&quot;full_name&quot;]}&lt;br/&gt;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line96">96</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line97">97</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line98">98</a>     entry[:content] = content</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line99">99</a>     return entry</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line100">100</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line101">101</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line102">102</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line103">103</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line104">104</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line105">105</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line106">106</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line107">107</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line108">108</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line109">109</a>   def partner_curation()</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line110">110</a>     agent_id = params[:agent_id] || nil</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line111">111</a>     year = params[:year] || nil</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line112">112</a>     month = params[:month] || nil</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line113">113</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line114">114</a>     agent = Agent.find(agent_id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line115">115</a>     latest_harvest_event = agent.latest_harvest_event</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line116">116</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line117">117</a>     partner_curated_objects = latest_harvest_event.curated_data_objects(:year =&gt; year, :month =&gt; month)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line118">118</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line119">119</a>     feed_items = []</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line120">120</a>     partner_curated_objects.each do |row|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line121">121</a>       updated_time = Time.parse(row['updated_at'])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line122">122</a>       updated_at = updated_time.strftime(&quot;%d-%b-%Y&quot;) + &quot; at &quot; + updated_time.strftime(&quot;%I:%M%p&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line123">123</a>       </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line124">124</a>       action_comment = nil</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line125">125</a>       if ['inappropriate', 'untrusted'].include?(row['action_code'])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line126">126</a>         lower_time = (updated_time - 10.seconds).mysql_timestamp</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line127">127</a>         upper_time = (updated_time + 10.seconds).mysql_timestamp</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line128">128</a>         result = Comment.find_by_sql(&quot;SELECT c.* FROM comments c WHERE created_at BETWEEN '#{lower_time}' AND '#{upper_time}' AND parent_type='DataObject' AND user_id=#{row['curator_user_id']} LIMIT 1&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line129">129</a>         action_comment = result[0] unless result.empty?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line130">130</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line131">131</a>       </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line132">132</a>       feed_items &lt;&lt; {  &quot;curator&quot;          =&gt; (row['given_name'] + &quot; &quot; + row['family_name']).strip,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line133">133</a>                        &quot;curator_user_id&quot;  =&gt; row['curator_user_id'],</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line134">134</a>                        &quot;action_comment&quot;   =&gt; action_comment,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line135">135</a>                        &quot;activity&quot;         =&gt; row['action_code'],</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line136">136</a>                        &quot;do_type&quot;          =&gt; row['data_type_label'],</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line137">137</a>                        &quot;tc_id&quot;            =&gt; row['taxon_concept_id'],</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line138">138</a>                        &quot;do_id&quot;            =&gt; row['data_object_id'],</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line139">139</a>                        &quot;tc_name&quot;          =&gt; row['scientific_name'],</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line140">140</a>                        &quot;updated_at&quot;       =&gt; updated_at,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line141">141</a>                        &quot;object_cache_url&quot; =&gt; row['object_cache_url'] || nil,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line142">142</a>                        &quot;source_url&quot;       =&gt; row['source_url'] || nil }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line143">143</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line144">144</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line145">145</a>     @feed_url = url_for(:controller =&gt; 'feeds', :action =&gt; 'partner_curation', :agent_id =&gt; agent_id, :month =&gt; month, :year =&gt; year)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line146">146</a>     @feed_link = &quot;http://www.eol.org&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line147">147</a>     @feed_title = agent.full_name + &quot; curation activity&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line148">148</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line149">149</a>     @feed_entries = []</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line150">150</a>     feed_items.each do |hash|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line151">151</a>       @feed_entries &lt;&lt; partner_feed_entry(hash)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line152">152</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line153">153</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line154">154</a>     respond_to do |format|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line155">155</a>       format.atom { render :template =&gt; '/feeds/feed_template', :layout =&gt; false }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line156">156</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line157">157</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line158">158</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line159">159</a>   def partner_feed_entry(hash)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line160">160</a>     entry = { :id =&gt; '', :title =&gt; '', :link =&gt; '', :content =&gt; '', :updated =&gt; '' }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line161">161</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line162">162</a>     entry[:title] = hash['tc_name']</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line163">163</a>     entry[:updated] = hash['updated_at']</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line164">164</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line165">165</a>     if(hash['do_type']==&quot;Text&quot;) then</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line166">166</a>       entry[:link] = url_for(:controller =&gt; :taxa, :action =&gt; :show, :id =&gt; hash['tc_id'], :text_id =&gt; hash['do_id'])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line167">167</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line168">168</a>       entry[:link] = url_for(:controller =&gt; :taxa, :action =&gt; :show, :id =&gt; hash['tc_id'], :image_id =&gt; hash['do_id'])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line169">169</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line170">170</a>     entry[:id] = entry[:link]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line171">171</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line172">172</a>     curator_link = url_for(:controller =&gt; 'account', :action =&gt; 'show', :id =&gt; hash['curator_user_id'], :only_path =&gt; false)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line173">173</a>     content = hash['do_type'] + &quot; was changed to '&quot; + hash['activity'] + &quot;' by &lt;a href='#{curator_link}'&gt;&quot; + hash['curator'] + &quot;&lt;/a&gt; last &quot; + hash['updated_at'] + &quot; &lt;br/&gt;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line174">174</a>     if hash['action_comment']</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line175">175</a>       content += &quot;Comment: &quot; + hash['action_comment'].body + &quot;&lt;br/&gt;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line176">176</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line177">177</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line178">178</a>     if hash['do_type'] == 'Image'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line179">179</a>       content = &quot;&lt;img src='#{DataObject.image_cache_path(hash['object_cache_url'],'small')}'/&gt;&lt;br/&gt;&quot; + content</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line180">180</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line181">181</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line182">182</a>     # Will insert a link to a Wikipedia article</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line183">183</a>     # TODO - looking for oldid in the link isn't robust enough to determine the object is a Wikipedia article</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line184">184</a>     temp = hash['source_url']</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line185">185</a>     result = temp.split(/oldid=\s?/)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line186">186</a>     revision_id = result[1] </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line187">187</a>     if(revision_id) then</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line188">188</a>       content += &quot;Revision ID: &lt;a target='wikipedia' href='#{hash['source_url']}'/&gt;#{revision_id}&lt;/a&gt;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line189">189</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line190">190</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line191">191</a>     entry[:content] = content</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line192">192</a>     return entry</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line193">193</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line194">194</a> end</pre></td>
          </tr>
        
      </tbody>
    </table>

    <p>Generated on Fri Jan 28 08:26:42 -0800 2011 with <a href="http://github.com/relevance/rcov">rcov 0.9.8</a></p>

  </body>
</html>
