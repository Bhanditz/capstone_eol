<html><head><style>table { background: #fff; color: #000; }
.ruby .normal { color: #000; }
.ruby .comment { color: #005; font-style: italic; }
.ruby .keyword { color: #A44; font-weight: bold; }
.ruby .method { color: #44f; }
.ruby .class { color: #b1713d; }
.ruby .module { color: #050; }
.ruby .punct { color: #668; font-weight: bold; }
.ruby .symbol { color: #00f; }
.ruby .string { color: #4a4; }
.ruby .char { color: #F07; }
.ruby .ident { color: #000; }
.ruby .constant { color: #b1713d; }
.ruby .regex { color: #B66; background: #FEF; }
.ruby .number { color: #F99; }
.ruby .attribute { color: #f84; }
.ruby .global { color: #7FB; }
.ruby .expr { color: #227; }
.ruby .escape { color: #277; }</style></head><body><table cellpadding='0' cellspacing='0' class='ruby'><tr><td valign='top'><small>1</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1'><pre><span class="comment"># NOTE - there is a method called #stale? (toward the bottom) which needs to be kept up-to-date with any changes made</span>
</pre></a></td></tr><tr><td valign='top'><small>2</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line2'><pre><span class="comment"># to the user model.  We *could* achieve a similar result with method_missing, but I worry that it would cause other</span>
</pre></a></td></tr><tr><td valign='top'><small>3</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line3'><pre><span class="comment"># problems.</span>
</pre></a></td></tr><tr><td valign='top'><small>4</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line4'><pre><span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>5</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line5'><pre><span class="comment"># Note that email is NOT a unique field: one email address is allowed to have multiple accounts.</span>
</pre></a></td></tr><tr><td valign='top'><small>6</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line6'><pre><span class="comment"># NOTE this inherist from MASTER.  All queries against a user need to be up-to-date, since this contains config information</span>
</pre></a></td></tr><tr><td valign='top'><small>7</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line7'><pre><span class="comment"># which can change quickly.  There is a similar clause in the execute() method in the connection proxy for masochism.</span>
</pre></a></td></tr><tr><td valign='top'><small>8</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line8'><pre>
</pre></a></td></tr><tr><td valign='top'><small>9</small></td><td valign='top'><ul><li>Class "User" has 749 lines.  It should have 300 or less. &raquo; roodi</li></ul></td><td valign='top'><a name='line9'><pre><span class="keyword">class </span><span class="class">User</span> <span class="punct">&lt;</span> <span class="global">$PARENT_CLASS_MUST_USE_MASTER</span>
</pre></a></td></tr><tr><td valign='top'><small>10</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line10'><pre>
</pre></a></td></tr><tr><td valign='top'><small>11</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line11'><pre>  <span class="ident">include</span> <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Feedable</span>
</pre></a></td></tr><tr><td valign='top'><small>12</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line12'><pre>
</pre></a></td></tr><tr><td valign='top'><small>13</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line13'><pre>  <span class="ident">belongs_to</span> <span class="symbol">:curator_verdict_by</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">User</span><span class="punct">&quot;,</span> <span class="symbol">:foreign_key</span> <span class="punct">=&gt;</span> <span class="symbol">:curator_verdict_by_id</span>
</pre></a></td></tr><tr><td valign='top'><small>14</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line14'><pre>  <span class="ident">belongs_to</span> <span class="symbol">:language</span>
</pre></a></td></tr><tr><td valign='top'><small>15</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line15'><pre>  <span class="ident">belongs_to</span> <span class="symbol">:agent</span>
</pre></a></td></tr><tr><td valign='top'><small>16</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line16'><pre>
</pre></a></td></tr><tr><td valign='top'><small>17</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line17'><pre>  <span class="ident">has_many</span> <span class="symbol">:curators_evaluated</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">User</span><span class="punct">&quot;,</span> <span class="symbol">:foreign_key</span> <span class="punct">=&gt;</span> <span class="symbol">:curator_verdict_by_id</span>
</pre></a></td></tr><tr><td valign='top'><small>18</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line18'><pre>  <span class="ident">has_many</span> <span class="symbol">:users_data_objects_ratings</span>
</pre></a></td></tr><tr><td valign='top'><small>19</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line19'><pre>  <span class="ident">has_many</span> <span class="symbol">:members</span>
</pre></a></td></tr><tr><td valign='top'><small>20</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line20'><pre>  <span class="ident">has_many</span> <span class="symbol">:data_object_tags</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">DataObjectTags</span><span class="punct">.</span><span class="ident">to_s</span>
</pre></a></td></tr><tr><td valign='top'><small>21</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line21'><pre>  <span class="ident">has_many</span> <span class="symbol">:tags</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">DataObjectTag</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="symbol">:through</span> <span class="punct">=&gt;</span> <span class="symbol">:data_object_tags</span><span class="punct">,</span> <span class="symbol">:source</span> <span class="punct">=&gt;</span> <span class="symbol">:data_object_tag</span>
</pre></a></td></tr><tr><td valign='top'><small>22</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line22'><pre>  <span class="ident">has_many</span> <span class="symbol">:comments</span>
</pre></a></td></tr><tr><td valign='top'><small>23</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line23'><pre>  <span class="ident">has_many</span> <span class="symbol">:curator_activity_logs</span>
</pre></a></td></tr><tr><td valign='top'><small>24</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line24'><pre>  <span class="ident">has_many</span> <span class="symbol">:curator_activity_logs_on_data_objects</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">CuratorActivityLog</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>25</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line25'><pre>             <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">curator_activity_logs.changeable_object_type_id = <span class="expr">#{ChangeableObjectType.raw_data_object_id}</span></span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>26</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line26'><pre>  <span class="ident">has_many</span> <span class="symbol">:users_data_objects</span>
</pre></a></td></tr><tr><td valign='top'><small>27</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line27'><pre>  <span class="ident">has_many</span> <span class="symbol">:collection_items</span><span class="punct">,</span> <span class="symbol">:as</span> <span class="punct">=&gt;</span> <span class="symbol">:object</span>
</pre></a></td></tr><tr><td valign='top'><small>28</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line28'><pre>  <span class="ident">has_many</span> <span class="symbol">:collections</span>
</pre></a></td></tr><tr><td valign='top'><small>29</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line29'><pre>  <span class="ident">has_many</span> <span class="symbol">:google_analytics_partner_summaries</span>
</pre></a></td></tr><tr><td valign='top'><small>30</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line30'><pre>  <span class="ident">has_many</span> <span class="symbol">:google_analytics_partner_taxa</span>
</pre></a></td></tr><tr><td valign='top'><small>31</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line31'><pre>  <span class="ident">has_many</span> <span class="symbol">:resources</span><span class="punct">,</span> <span class="symbol">:through</span> <span class="punct">=&gt;</span> <span class="symbol">:content_partner</span>
</pre></a></td></tr><tr><td valign='top'><small>32</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line32'><pre>
</pre></a></td></tr><tr><td valign='top'><small>33</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line33'><pre>  <span class="ident">has_one</span> <span class="symbol">:content_partner</span>
</pre></a></td></tr><tr><td valign='top'><small>34</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line34'><pre>  <span class="ident">has_one</span> <span class="symbol">:user_info</span>
</pre></a></td></tr><tr><td valign='top'><small>35</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line35'><pre>  <span class="ident">belongs_to</span> <span class="symbol">:default_hierarchy</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="symbol">:foreign_key</span> <span class="punct">=&gt;</span> <span class="symbol">:default_hierarchy_id</span>
</pre></a></td></tr><tr><td valign='top'><small>36</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line36'><pre>  <span class="comment"># I wish these worked, but they need runtime evaluation.</span>
</pre></a></td></tr><tr><td valign='top'><small>37</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line37'><pre>  <span class="comment">#has_one :watch_collection, :class_name =&gt; 'Collection', :conditions =&gt; { :special_collection_id =&gt; SpecialCollection.watch.id }</span>
</pre></a></td></tr><tr><td valign='top'><small>38</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line38'><pre>  <span class="comment">#has_one :inbox_collection, :class_name =&gt; 'Collection', :conditions =&gt; { :special_collection_id =&gt; SpecialCollection.inbox.id }</span>
</pre></a></td></tr><tr><td valign='top'><small>39</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line39'><pre>
</pre></a></td></tr><tr><td valign='top'><small>40</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line40'><pre>  <span class="ident">before_save</span> <span class="symbol">:check_credentials</span>
</pre></a></td></tr><tr><td valign='top'><small>41</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line41'><pre>
</pre></a></td></tr><tr><td valign='top'><small>42</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line42'><pre>  <span class="ident">accepts_nested_attributes_for</span> <span class="symbol">:user_info</span>
</pre></a></td></tr><tr><td valign='top'><small>43</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line43'><pre>
</pre></a></td></tr><tr><td valign='top'><small>44</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line44'><pre>  <span class="attribute">@email_format_re</span> <span class="punct">=</span> <span class="punct">%r{</span><span class="regex">^(?:[_<span class="escape">\+</span>a-z0-9-]+)(<span class="escape">\.</span>[_<span class="escape">\+</span>a-z0-9-]+)*@([a-z0-9-]+)(<span class="escape">\.</span>[a-zA-Z0-9<span class="escape">\-\.</span>]+)*(<span class="escape">\.</span>[a-z]{2,4</span><span class="punct">})</span><span class="global">$}</span><span class="ident">i</span>
</pre></a></td></tr><tr><td valign='top'><small>45</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line45'><pre>
</pre></a></td></tr><tr><td valign='top'><small>46</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line46'><pre>  <span class="ident">validate</span> <span class="symbol">:ensure_unique_username_against_master</span><span class="punct">,</span> <span class="symbol">:on</span> <span class="punct">=&gt;</span> <span class="symbol">:create</span>
</pre></a></td></tr><tr><td valign='top'><small>47</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line47'><pre>
</pre></a></td></tr><tr><td valign='top'><small>48</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line48'><pre>  <span class="ident">validates_presence_of</span> <span class="symbol">:curator_verdict_by</span><span class="punct">,</span> <span class="symbol">:if</span> <span class="punct">=&gt;</span> <span class="constant">Proc</span><span class="punct">.</span><span class="ident">new</span> <span class="punct">{</span> <span class="punct">|</span><span class="ident">obj</span><span class="punct">|</span> <span class="punct">!</span><span class="ident">obj</span><span class="punct">.</span><span class="ident">curator_verdict_at</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>49</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line49'><pre>  <span class="ident">validates_presence_of</span> <span class="symbol">:curator_verdict_at</span><span class="punct">,</span> <span class="symbol">:if</span> <span class="punct">=&gt;</span> <span class="constant">Proc</span><span class="punct">.</span><span class="ident">new</span> <span class="punct">{</span> <span class="punct">|</span><span class="ident">obj</span><span class="punct">|</span> <span class="punct">!</span><span class="ident">obj</span><span class="punct">.</span><span class="ident">curator_verdict_by</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>50</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line50'><pre>  <span class="ident">validates_presence_of</span> <span class="symbol">:username</span>
</pre></a></td></tr><tr><td valign='top'><small>51</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line51'><pre>  <span class="ident">validates_presence_of</span> <span class="symbol">:given_name</span>
</pre></a></td></tr><tr><td valign='top'><small>52</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line52'><pre>
</pre></a></td></tr><tr><td valign='top'><small>53</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line53'><pre>  <span class="ident">validates_length_of</span> <span class="symbol">:username</span><span class="punct">,</span> <span class="symbol">:within</span> <span class="punct">=&gt;</span> <span class="number">4</span><span class="punct">..</span><span class="number">32</span>
</pre></a></td></tr><tr><td valign='top'><small>54</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line54'><pre>  <span class="ident">validates_length_of</span> <span class="symbol">:entered_password</span><span class="punct">,</span> <span class="symbol">:within</span> <span class="punct">=&gt;</span> <span class="number">4</span><span class="punct">..</span><span class="number">16</span><span class="punct">,</span> <span class="symbol">:on</span> <span class="punct">=&gt;</span> <span class="symbol">:create</span>
</pre></a></td></tr><tr><td valign='top'><small>55</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line55'><pre>
</pre></a></td></tr><tr><td valign='top'><small>56</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line56'><pre>  <span class="ident">validates_format_of</span> <span class="symbol">:email</span><span class="punct">,</span> <span class="symbol">:with</span> <span class="punct">=&gt;</span> <span class="attribute">@email_format_re</span>
</pre></a></td></tr><tr><td valign='top'><small>57</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line57'><pre>
</pre></a></td></tr><tr><td valign='top'><small>58</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line58'><pre>  <span class="ident">validates_confirmation_of</span> <span class="symbol">:entered_password</span>
</pre></a></td></tr><tr><td valign='top'><small>59</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line59'><pre>
</pre></a></td></tr><tr><td valign='top'><small>60</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line60'><pre>  <span class="ident">has_attached_file</span> <span class="symbol">:logo</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>61</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line61'><pre>    <span class="symbol">:path</span> <span class="punct">=&gt;</span> <span class="global">$LOGO_UPLOAD_DIRECTORY</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>62</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line62'><pre>    <span class="symbol">:url</span> <span class="punct">=&gt;</span> <span class="global">$LOGO_UPLOAD_PATH</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>63</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line63'><pre>    <span class="symbol">:default_url</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">/images/blank.gif</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>64</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line64'><pre>
</pre></a></td></tr><tr><td valign='top'><small>65</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line65'><pre>  <span class="ident">validates_attachment_content_type</span> <span class="symbol">:logo</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>66</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line66'><pre>    <span class="symbol">:content_type</span> <span class="punct">=&gt;</span> <span class="punct">['</span><span class="string">image/pjpeg</span><span class="punct">','</span><span class="string">image/jpeg</span><span class="punct">','</span><span class="string">image/png</span><span class="punct">','</span><span class="string">image/gif</span><span class="punct">',</span> <span class="punct">'</span><span class="string">image/x-png</span><span class="punct">'],</span>
</pre></a></td></tr><tr><td valign='top'><small>67</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line67'><pre>    <span class="symbol">:message</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">image is not a valid image type</span><span class="punct">&quot;,</span> <span class="symbol">:if</span> <span class="punct">=&gt;</span> <span class="symbol">:partner_step?</span>
</pre></a></td></tr><tr><td valign='top'><small>68</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line68'><pre>  <span class="ident">validates_attachment_size</span> <span class="symbol">:logo</span><span class="punct">,</span> <span class="symbol">:in</span> <span class="punct">=&gt;</span> <span class="number">0</span><span class="punct">..</span><span class="number">0.5</span><span class="punct">.</span><span class="ident">megabyte</span>
</pre></a></td></tr><tr><td valign='top'><small>69</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line69'><pre>  
</pre></a></td></tr><tr><td valign='top'><small>70</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line70'><pre>  <span class="ident">index_with_solr</span> <span class="symbol">:keywords</span> <span class="punct">=&gt;</span> <span class="punct">[</span><span class="symbol">:username</span><span class="punct">,</span> <span class="symbol">:full_name</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>71</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line71'><pre>
</pre></a></td></tr><tr><td valign='top'><small>72</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line72'><pre>  <span class="ident">attr_accessor</span> <span class="symbol">:entered_password</span><span class="punct">,</span> <span class="symbol">:entered_password_confirmation</span><span class="punct">,</span> <span class="symbol">:curator_request</span>
</pre></a></td></tr><tr><td valign='top'><small>73</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line73'><pre>
</pre></a></td></tr><tr><td valign='top'><small>74</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line74'><pre>  <span class="keyword">def </span><span class="method">self.sort_by_name</span><span class="punct">(</span><span class="ident">users</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>75</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line75'><pre>    <span class="ident">users</span><span class="punct">.</span><span class="ident">sort_by</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">u</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>76</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line76'><pre>      <span class="ident">given</span> <span class="punct">=</span> <span class="ident">u</span><span class="punct">.</span><span class="ident">given_name</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">?</span> <span class="ident">u</span><span class="punct">.</span><span class="ident">family_name</span> <span class="punct">:</span> <span class="ident">u</span><span class="punct">.</span><span class="ident">given_name</span><span class="punct">.</span><span class="ident">strip</span>
</pre></a></td></tr><tr><td valign='top'><small>77</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line77'><pre>      <span class="ident">family</span> <span class="punct">=</span> <span class="ident">u</span><span class="punct">.</span><span class="ident">family_name</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">?</span> <span class="ident">u</span><span class="punct">.</span><span class="ident">given_name</span> <span class="punct">:</span> <span class="ident">u</span><span class="punct">.</span><span class="ident">family_name</span><span class="punct">.</span><span class="ident">strip</span>
</pre></a></td></tr><tr><td valign='top'><small>78</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line78'><pre>      <span class="punct">[</span><span class="ident">family</span><span class="punct">.</span><span class="ident">downcase</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>79</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line79'><pre>       <span class="ident">given</span><span class="punct">.</span><span class="ident">downcase</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>80</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line80'><pre>       <span class="ident">u</span><span class="punct">.</span><span class="ident">username</span><span class="punct">.</span><span class="ident">downcase</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>81</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line81'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>82</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line82'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>83</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line83'><pre>
</pre></a></td></tr><tr><td valign='top'><small>84</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line84'><pre>  <span class="comment"># create a new user using default attributes and then update with supplied parameters</span>
</pre></a></td></tr><tr><td valign='top'><small>85</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line85'><pre>  <span class="keyword">def </span><span class="method">self.create_new</span> <span class="ident">options</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>86</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line86'><pre>    <span class="comment"># NOTE - the agent_id is assigned in account controller, not in the model</span>
</pre></a></td></tr><tr><td valign='top'><small>87</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line87'><pre>    <span class="ident">new_user</span> <span class="punct">=</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">new</span>
</pre></a></td></tr><tr><td valign='top'><small>88</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line88'><pre>    <span class="ident">new_user</span><span class="punct">.</span><span class="ident">send</span><span class="punct">(</span><span class="symbol">:set_defaults</span><span class="punct">)</span> <span class="comment"># It's a private method.  This is cheating, but we really DO want it private.</span>
</pre></a></td></tr><tr><td valign='top'><small>89</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line89'><pre>    <span class="ident">new_user</span><span class="punct">.</span><span class="ident">attributes</span> <span class="punct">=</span> <span class="ident">options</span>
</pre></a></td></tr><tr><td valign='top'><small>90</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line90'><pre>    <span class="ident">new_user</span>
</pre></a></td></tr><tr><td valign='top'><small>91</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line91'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>92</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line92'><pre>
</pre></a></td></tr><tr><td valign='top'><small>93</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line93'><pre>  <span class="keyword">def </span><span class="method">self.authenticate</span><span class="punct">(</span><span class="ident">username</span><span class="punct">,</span> <span class="ident">password</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>94</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line94'><pre>    <span class="ident">user</span> <span class="punct">=</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">find_by_username_and_active</span><span class="punct">(</span><span class="ident">username</span><span class="punct">,</span> <span class="constant">true</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>95</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line95'><pre>    <span class="keyword">if</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>96</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line96'><pre>      <span class="constant">self</span><span class="punct">.</span><span class="ident">authenticate_by_email</span><span class="punct">(</span><span class="ident">username</span><span class="punct">,</span> <span class="ident">password</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>97</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line97'><pre>    <span class="keyword">elsif</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">hashed_password</span> <span class="punct">==</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">hash_password</span><span class="punct">(</span><span class="ident">password</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>98</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line98'><pre>      <span class="ident">user</span><span class="punct">.</span><span class="ident">reset_login_attempts</span> <span class="comment"># found a matching username and password matched!</span>
</pre></a></td></tr><tr><td valign='top'><small>99</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line99'><pre>      <span class="keyword">return</span> <span class="constant">true</span><span class="punct">,</span> <span class="ident">user</span>
</pre></a></td></tr><tr><td valign='top'><small>100</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line100'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>101</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line101'><pre>      <span class="ident">user</span><span class="punct">.</span><span class="ident">invalid_login_attempt</span>
</pre></a></td></tr><tr><td valign='top'><small>102</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line102'><pre>      <span class="keyword">return</span> <span class="constant">false</span><span class="punct">,</span> <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(</span><span class="symbol">:invalid_login_or_password</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>103</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line103'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>104</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line104'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>105</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line105'><pre>
</pre></a></td></tr><tr><td valign='top'><small>106</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line106'><pre>  <span class="keyword">def </span><span class="method">self.authenticate_by_email</span><span class="punct">(</span><span class="ident">email</span><span class="punct">,</span> <span class="ident">password</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>107</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line107'><pre>    <span class="ident">users</span> <span class="punct">=</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">find_all_by_email_and_active</span><span class="punct">(</span><span class="ident">email</span><span class="punct">,</span> <span class="constant">true</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>108</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line108'><pre>    <span class="keyword">if</span> <span class="ident">users</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>109</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line109'><pre>      <span class="keyword">return</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">fail_authentication_with_master_check</span><span class="punct">(</span><span class="ident">email</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>110</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line110'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>111</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line111'><pre>    <span class="ident">users</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">u</span><span class="punct">|</span> <span class="comment"># check all users with matching email addresses to see if one of them matches the password</span>
</pre></a></td></tr><tr><td valign='top'><small>112</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line112'><pre>      <span class="keyword">if</span> <span class="ident">u</span><span class="punct">.</span><span class="ident">hashed_password</span> <span class="punct">==</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">hash_password</span><span class="punct">(</span><span class="ident">password</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>113</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line113'><pre>        <span class="ident">u</span><span class="punct">.</span><span class="ident">reset_login_attempts</span> <span class="comment"># found a match with email and password</span>
</pre></a></td></tr><tr><td valign='top'><small>114</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line114'><pre>        <span class="keyword">return</span> <span class="constant">true</span><span class="punct">,</span> <span class="ident">u</span>
</pre></a></td></tr><tr><td valign='top'><small>115</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line115'><pre>      <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>116</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line116'><pre>        <span class="ident">u</span><span class="punct">.</span><span class="ident">invalid_login_attempt</span> <span class="comment"># log the bad attempt for this user!</span>
</pre></a></td></tr><tr><td valign='top'><small>117</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line117'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>118</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line118'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>119</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line119'><pre>    <span class="keyword">if</span> <span class="ident">users</span><span class="punct">.</span><span class="ident">size</span> <span class="punct">&gt;</span> <span class="number">1</span> <span class="comment"># more than 1 email address with no matching passwords</span>
</pre></a></td></tr><tr><td valign='top'><small>120</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line120'><pre>      <span class="keyword">return</span> <span class="constant">false</span><span class="punct">,</span> <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(</span><span class="symbol">:the_email_address_is_not_unique_you_must_enter_a_username</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>121</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line121'><pre>    <span class="keyword">else</span>  <span class="comment"># no matches yet again :(</span>
</pre></a></td></tr><tr><td valign='top'><small>122</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line122'><pre>      <span class="keyword">return</span> <span class="constant">false</span><span class="punct">,</span> <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(</span><span class="symbol">:invalid_login_or_password</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>123</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line123'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>124</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line124'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>125</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line125'><pre>
</pre></a></td></tr><tr><td valign='top'><small>126</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line126'><pre>  <span class="keyword">def </span><span class="method">self.fail_authentication_with_master_check</span><span class="punct">(</span><span class="ident">user_identifier</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>127</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line127'><pre>    <span class="keyword">if</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">active_on_master?</span><span class="punct">(</span><span class="ident">user_identifier</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>128</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line128'><pre>      <span class="keyword">return</span> <span class="constant">false</span><span class="punct">,</span>  <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(</span><span class="symbol">:account_registered_but_not_ready_try_later</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>129</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line129'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>130</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line130'><pre>      <span class="keyword">return</span> <span class="constant">false</span><span class="punct">,</span> <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(</span><span class="symbol">:invalid_login_or_password</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>131</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line131'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>132</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line132'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>133</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line133'><pre>
</pre></a></td></tr><tr><td valign='top'><small>134</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line134'><pre>  <span class="keyword">def </span><span class="method">self.generate_key</span>
</pre></a></td></tr><tr><td valign='top'><small>135</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line135'><pre>    <span class="constant">Digest</span><span class="punct">::</span><span class="constant">SHA1</span><span class="punct">.</span><span class="ident">hexdigest</span><span class="punct">(</span><span class="ident">rand</span><span class="punct">(</span><span class="number">10</span><span class="punct">**</span><span class="number">16</span><span class="punct">).</span><span class="ident">to_s</span> <span class="punct">+</span> <span class="constant">Time</span><span class="punct">.</span><span class="ident">now</span><span class="punct">.</span><span class="ident">to_f</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>136</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line136'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>137</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line137'><pre>
</pre></a></td></tr><tr><td valign='top'><small>138</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line138'><pre>  <span class="keyword">def </span><span class="method">self.active_on_master?</span><span class="punct">(</span><span class="ident">username</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>139</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line139'><pre>    <span class="constant">User</span><span class="punct">.</span><span class="ident">with_master</span> <span class="keyword">do</span>
</pre></a></td></tr><tr><td valign='top'><small>140</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line140'><pre>      <span class="ident">user</span> <span class="punct">=</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">find_by_username_and_active</span><span class="punct">(</span><span class="ident">username</span><span class="punct">,</span> <span class="constant">true</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>141</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line141'><pre>      <span class="ident">user</span> <span class="punct">||=</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">find_by_email_and_active</span><span class="punct">(</span><span class="ident">username</span><span class="punct">,</span> <span class="constant">true</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>142</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line142'><pre>      <span class="ident">user</span><span class="punct">.</span><span class="ident">nil?</span> <span class="punct">?</span> <span class="constant">false</span> <span class="punct">:</span> <span class="constant">true</span>  <span class="comment"># Just cleaning up the nil, is all.  False is less likely to annoy.</span>
</pre></a></td></tr><tr><td valign='top'><small>143</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line143'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>144</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line144'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>145</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line145'><pre>
</pre></a></td></tr><tr><td valign='top'><small>146</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line146'><pre>  <span class="comment"># TODO - test</span>
</pre></a></td></tr><tr><td valign='top'><small>147</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line147'><pre>  <span class="keyword">def </span><span class="method">self.users_with_submitted_text</span>
</pre></a></td></tr><tr><td valign='top'><small>148</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line148'><pre>    <span class="ident">sql</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">SELECT DISTINCT users.id , users.given_name, users.family_name<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>149</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line149'><pre>      <span class="constant">FROM</span> <span class="ident">users</span> <span class="constant">Join</span> <span class="ident">users_data_objects</span> <span class="constant">ON</span> <span class="ident">users</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">=</span> <span class="ident">users_data_objects</span><span class="punct">.</span><span class="ident">user_id</span>
</pre></a></td></tr><tr><td valign='top'><small>150</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line150'><pre>      <span class="constant">ORDER</span> <span class="constant">BY</span> <span class="ident">users</span><span class="punct">.</span><span class="ident">family_name</span><span class="punct">,</span> <span class="ident">users</span><span class="punct">.</span><span class="ident">given_name</span><span class="punct">&quot;</span><span class="string"><span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>151</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line151'><pre>    <span class="ident">rset</span> <span class="punct">=</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">find_by_sql</span><span class="punct">([</span><span class="ident">sql</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>152</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line152'><pre>    <span class="keyword">return</span> <span class="ident">rset</span>
</pre></a></td></tr><tr><td valign='top'><small>153</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line153'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>154</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line154'><pre>
</pre></a></td></tr><tr><td valign='top'><small>155</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line155'><pre>  <span class="comment"># TODO - test</span>
</pre></a></td></tr><tr><td valign='top'><small>156</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line156'><pre>  <span class="keyword">def </span><span class="method">self.users_with_activity_log</span>
</pre></a></td></tr><tr><td valign='top'><small>157</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line157'><pre>    <span class="ident">sql</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">SELECT distinct u.id , u.given_name, u.family_name<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>158</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line158'><pre>      <span class="constant">FROM</span> <span class="ident">users</span> <span class="ident">u</span>
</pre></a></td></tr><tr><td valign='top'><small>159</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line159'><pre>        <span class="constant">JOIN</span> <span class="comment">#{ActivityLog.full_table_name} al ON u.id = al.user_id</span>
</pre></a></td></tr><tr><td valign='top'><small>160</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line160'><pre>      <span class="constant">ORDER</span> <span class="constant">BY</span> <span class="ident">u</span><span class="punct">.</span><span class="ident">family_name</span><span class="punct">,</span> <span class="ident">u</span><span class="punct">.</span><span class="ident">given_name</span><span class="punct">&quot;</span><span class="string"><span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>161</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line161'><pre>
</pre></a></td></tr><tr><td valign='top'><small>162</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line162'><pre>    <span class="constant">User</span><span class="punct">.</span><span class="ident">with_master</span> <span class="keyword">do</span>
</pre></a></td></tr><tr><td valign='top'><small>163</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line163'><pre>      <span class="constant">User</span><span class="punct">.</span><span class="ident">find_by_sql</span><span class="punct">([</span><span class="ident">sql</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>164</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line164'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>165</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line165'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>166</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line166'><pre>
</pre></a></td></tr><tr><td valign='top'><small>167</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line167'><pre>  <span class="comment"># TODO - test</span>
</pre></a></td></tr><tr><td valign='top'><small>168</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line168'><pre>  <span class="keyword">def </span><span class="method">self.curated_data_object_ids</span><span class="punct">(</span><span class="ident">arr_dataobject_ids</span><span class="punct">,</span> <span class="ident">year</span><span class="punct">,</span> <span class="ident">month</span><span class="punct">,</span> <span class="ident">agent_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>169</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line169'><pre>    <span class="ident">obj_ids</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>170</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line170'><pre>    <span class="ident">user_ids</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>171</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line171'><pre>    <span class="keyword">if</span><span class="punct">(</span><span class="ident">arr_dataobject_ids</span><span class="punct">.</span><span class="ident">length</span> <span class="punct">&gt;</span> <span class="number">0</span> <span class="keyword">or</span> <span class="ident">agent_id</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">All</span><span class="punct">')</span> <span class="keyword">then</span>
</pre></a></td></tr><tr><td valign='top'><small>172</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line172'><pre>      <span class="ident">sql</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">SELECT cal.object_id data_object_id, cal.user_id<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>173</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line173'><pre>        <span class="constant">FROM</span> <span class="comment">#{LoggingModel.database_name}.activities acts</span>
</pre></a></td></tr><tr><td valign='top'><small>174</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line174'><pre>          <span class="constant">JOIN</span> <span class="comment">#{LoggingModel.database_name}.curator_activity_logs cal ON cal.activity_id = acts.id</span>
</pre></a></td></tr><tr><td valign='top'><small>175</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line175'><pre>          <span class="constant">JOIN</span> <span class="ident">changeable_object_types</span> <span class="ident">cot</span> <span class="constant">ON</span> <span class="ident">cal</span><span class="punct">.</span><span class="ident">changeable_object_type_id</span> <span class="punct">=</span> <span class="ident">cot</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>176</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line176'><pre>          <span class="constant">JOIN</span> <span class="ident">users</span> <span class="ident">u</span> <span class="constant">ON</span> <span class="ident">cal</span><span class="punct">.</span><span class="ident">user_id</span> <span class="punct">=</span> <span class="ident">u</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>177</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line177'><pre>        <span class="constant">WHERE</span> <span class="ident">cot</span><span class="punct">.</span><span class="ident">ch_object_type</span> <span class="punct">=</span> <span class="punct">'</span><span class="string">data_object</span><span class="punct">'</span> <span class="punct">&quot;</span><span class="string"><span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>178</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line178'><pre>      <span class="keyword">if</span><span class="punct">(</span><span class="ident">agent_id</span> <span class="punct">!=</span> <span class="punct">'</span><span class="string">All</span><span class="punct">')</span> <span class="keyword">then</span>
</pre></a></td></tr><tr><td valign='top'><small>179</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line179'><pre>        <span class="ident">sql</span> <span class="punct">+=</span> <span class="punct">&quot;</span><span class="string"> AND cal.object_id IN (</span><span class="punct">&quot;</span> <span class="punct">+</span> <span class="ident">arr_dataobject_ids</span> <span class="punct">*</span> <span class="punct">&quot;</span><span class="string">,</span><span class="punct">&quot;</span> <span class="punct">+</span> <span class="punct">&quot;</span><span class="string">)</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>180</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line180'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>181</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line181'><pre>      <span class="keyword">if</span><span class="punct">(</span><span class="ident">year</span><span class="punct">.</span><span class="ident">to_i</span> <span class="punct">&gt;</span> <span class="number">0</span><span class="punct">)</span> <span class="keyword">then</span> <span class="ident">sql</span> <span class="punct">+=</span> <span class="punct">&quot;</span><span class="string"> AND year(cal.updated_at) = <span class="expr">#{year}</span> AND month(cal.updated_at) = <span class="expr">#{month}</span> </span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>182</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line182'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>183</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line183'><pre>      <span class="ident">rset</span> <span class="punct">=</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">find_by_sql</span><span class="punct">([</span><span class="ident">sql</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>184</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line184'><pre>      <span class="ident">rset</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">post</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>185</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line185'><pre>        <span class="ident">obj_ids</span> <span class="punct">&lt;&lt;</span> <span class="ident">post</span><span class="punct">.</span><span class="ident">data_object_id</span>
</pre></a></td></tr><tr><td valign='top'><small>186</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line186'><pre>        <span class="ident">user_ids</span> <span class="punct">&lt;&lt;</span> <span class="ident">post</span><span class="punct">.</span><span class="ident">user_id</span>
</pre></a></td></tr><tr><td valign='top'><small>187</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line187'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>188</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line188'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>189</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line189'><pre>    <span class="ident">arr</span> <span class="punct">=</span> <span class="punct">[</span><span class="ident">obj_ids</span><span class="punct">,</span> <span class="ident">user_ids</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>190</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line190'><pre>    <span class="keyword">return</span> <span class="ident">arr</span>
</pre></a></td></tr><tr><td valign='top'><small>191</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line191'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>192</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line192'><pre>
</pre></a></td></tr><tr><td valign='top'><small>193</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line193'><pre>  <span class="comment"># TODO - test</span>
</pre></a></td></tr><tr><td valign='top'><small>194</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line194'><pre>  <span class="keyword">def </span><span class="method">self.curated_data_objects</span><span class="punct">(</span><span class="ident">arr_dataobject_ids</span><span class="punct">,</span> <span class="ident">year</span><span class="punct">,</span> <span class="ident">month</span><span class="punct">,</span> <span class="ident">page</span><span class="punct">,</span> <span class="ident">report_type</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>195</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line195'><pre>    <span class="ident">page</span> <span class="punct">=</span> <span class="number">1</span> <span class="keyword">if</span> <span class="ident">page</span> <span class="punct">==</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>196</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line196'><pre>    <span class="ident">sql</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">SELECT cal.object_id data_object_id, cot.ch_object_type,<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>197</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line197'><pre>        <span class="ident">acts</span><span class="punct">.</span><span class="ident">id</span> <span class="ident">activity_id</span><span class="punct">,</span> <span class="ident">u</span><span class="punct">.</span><span class="ident">given_name</span><span class="punct">,</span> <span class="ident">u</span><span class="punct">.</span><span class="ident">family_name</span><span class="punct">,</span> <span class="ident">cal</span><span class="punct">.</span><span class="ident">updated_at</span><span class="punct">,</span> <span class="ident">cal</span><span class="punct">.</span><span class="ident">user_id</span>
</pre></a></td></tr><tr><td valign='top'><small>198</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line198'><pre>      <span class="constant">FROM</span> <span class="comment">#{LoggingModel.database_name}.activities acts</span>
</pre></a></td></tr><tr><td valign='top'><small>199</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line199'><pre>        <span class="constant">JOIN</span> <span class="comment">#{LoggingModel.database_name}.curator_activity_logs cal ON cal.activity_id = acts.id</span>
</pre></a></td></tr><tr><td valign='top'><small>200</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line200'><pre>        <span class="constant">JOIN</span> <span class="ident">changeable_object_types</span> <span class="ident">cot</span> <span class="constant">ON</span> <span class="ident">cal</span><span class="punct">.</span><span class="ident">changeable_object_type_id</span> <span class="punct">=</span> <span class="ident">cot</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>201</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line201'><pre>        <span class="constant">JOIN</span> <span class="ident">users</span> <span class="ident">u</span> <span class="constant">ON</span> <span class="ident">cal</span><span class="punct">.</span><span class="ident">user_id</span> <span class="punct">=</span> <span class="ident">u</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>202</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line202'><pre>      <span class="constant">WHERE</span> <span class="ident">cot</span><span class="punct">.</span><span class="ident">ch_object_type</span> <span class="punct">=</span> <span class="punct">'</span><span class="string">data_object</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>203</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line203'><pre>        <span class="constant">AND</span> <span class="ident">cal</span><span class="punct">.</span><span class="ident">object_id</span> <span class="constant">IN</span> <span class="punct">(&quot;</span><span class="string"> + arr_dataobject_ids * </span><span class="punct">&quot;,&quot;</span><span class="string"> + </span><span class="punct">&quot;)&quot;</span><span class="string"><span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>204</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line204'><pre>    <span class="keyword">if</span><span class="punct">(</span><span class="ident">year</span><span class="punct">.</span><span class="ident">to_i</span> <span class="punct">&gt;</span> <span class="number">0</span><span class="punct">)</span> <span class="keyword">then</span> <span class="ident">sql</span> <span class="punct">+=</span> <span class="punct">&quot;</span><span class="string"> AND year(cal.updated_at) = <span class="expr">#{year}</span> AND month(cal.updated_at) = <span class="expr">#{month}</span> </span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>205</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line205'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>206</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line206'><pre>    <span class="ident">sql</span> <span class="punct">+=</span> <span class="punct">&quot;</span><span class="string"> AND acts.id in (<span class="expr">#{Activity.trusted.id}</span>, <span class="expr">#{Activity.untrusted.id}</span>, <span class="expr">#{Activity.inappropriate.id}</span>, <span class="expr">#{Activity.delete.id}</span>) </span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>207</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line207'><pre>    <span class="ident">sql</span> <span class="punct">+=</span> <span class="punct">&quot;</span><span class="string"> ORDER BY cal.id Desc</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>208</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line208'><pre>    <span class="keyword">if</span><span class="punct">(</span><span class="ident">report_type</span> <span class="punct">==</span> <span class="punct">&quot;</span><span class="string">rss feed</span><span class="punct">&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>209</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line209'><pre>      <span class="constant">self</span><span class="punct">.</span><span class="ident">find_by_sql</span> <span class="punct">[</span><span class="ident">sql</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>210</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line210'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>211</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line211'><pre>      <span class="constant">self</span><span class="punct">.</span><span class="ident">paginate_by_sql</span> <span class="punct">[</span><span class="ident">sql</span><span class="punct">],</span> <span class="symbol">:per_page</span> <span class="punct">=&gt;</span> <span class="number">30</span><span class="punct">,</span> <span class="symbol">:page</span> <span class="punct">=&gt;</span> <span class="ident">page</span>
</pre></a></td></tr><tr><td valign='top'><small>212</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line212'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>213</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line213'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>214</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line214'><pre>
</pre></a></td></tr><tr><td valign='top'><small>215</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line215'><pre>  <span class="keyword">def </span><span class="method">self.hash_password</span><span class="punct">(</span><span class="ident">raw</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>216</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line216'><pre>    <span class="constant">Digest</span><span class="punct">::</span><span class="constant">MD5</span><span class="punct">.</span><span class="ident">hexdigest</span><span class="punct">(</span><span class="ident">raw</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>217</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line217'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>218</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line218'><pre>
</pre></a></td></tr><tr><td valign='top'><small>219</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line219'><pre>  <span class="comment"># returns true or false indicating if username is unique</span>
</pre></a></td></tr><tr><td valign='top'><small>220</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line220'><pre>  <span class="keyword">def </span><span class="method">self.unique_user?</span><span class="punct">(</span><span class="ident">username</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>221</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line221'><pre>    <span class="constant">User</span><span class="punct">.</span><span class="ident">with_master</span> <span class="keyword">do</span>
</pre></a></td></tr><tr><td valign='top'><small>222</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line222'><pre>      <span class="constant">User</span><span class="punct">.</span><span class="ident">count</span><span class="punct">(</span><span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">['</span><span class="string">username = ?</span><span class="punct">',</span> <span class="ident">username</span><span class="punct">])</span> <span class="punct">==</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>223</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line223'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>224</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line224'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>225</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line225'><pre>
</pre></a></td></tr><tr><td valign='top'><small>226</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line226'><pre>  <span class="comment"># returns true or false indicating if email is unique</span>
</pre></a></td></tr><tr><td valign='top'><small>227</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line227'><pre>  <span class="keyword">def </span><span class="method">self.unique_email?</span><span class="punct">(</span><span class="ident">email</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>228</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line228'><pre>    <span class="constant">User</span><span class="punct">.</span><span class="ident">with_master</span> <span class="keyword">do</span>
</pre></a></td></tr><tr><td valign='top'><small>229</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line229'><pre>      <span class="constant">User</span><span class="punct">.</span><span class="ident">count</span><span class="punct">(</span><span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">['</span><span class="string">email = ?</span><span class="punct">',</span> <span class="ident">email</span><span class="punct">])</span> <span class="punct">==</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>230</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line230'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>231</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line231'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>232</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line232'><pre>
</pre></a></td></tr><tr><td valign='top'><small>233</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line233'><pre>  <span class="keyword">def </span><span class="method">curator_request</span>
</pre></a></td></tr><tr><td valign='top'><small>234</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line234'><pre>    <span class="keyword">return</span> <span class="constant">true</span> <span class="keyword">unless</span> <span class="ident">curator_scope</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">&amp;&amp;</span> <span class="ident">credentials</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>235</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line235'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>236</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line236'><pre>
</pre></a></td></tr><tr><td valign='top'><small>237</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line237'><pre>  <span class="keyword">def </span><span class="method">activate</span>
</pre></a></td></tr><tr><td valign='top'><small>238</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line238'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">update_attributes</span><span class="punct">(</span><span class="symbol">:active</span> <span class="punct">=&gt;</span> <span class="constant">true</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>239</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line239'><pre>    <span class="constant">Notifier</span><span class="punct">.</span><span class="ident">deliver_welcome_registration</span><span class="punct">(</span><span class="constant">self</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>240</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line240'><pre>    <span class="ident">build_watch_collection</span>
</pre></a></td></tr><tr><td valign='top'><small>241</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line241'><pre>    <span class="ident">build_inbox_collection</span>
</pre></a></td></tr><tr><td valign='top'><small>242</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line242'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>243</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line243'><pre>
</pre></a></td></tr><tr><td valign='top'><small>244</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line244'><pre>  <span class="keyword">def </span><span class="method">build_watch_collection</span>
</pre></a></td></tr><tr><td valign='top'><small>245</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line245'><pre>    <span class="constant">Collection</span><span class="punct">.</span><span class="ident">create</span><span class="punct">(</span><span class="symbol">:name</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{self.username.titleize}</span>'s Watched Items</span><span class="punct">&quot;,</span> <span class="symbol">:special_collection_id</span> <span class="punct">=&gt;</span> <span class="constant">SpecialCollection</span><span class="punct">.</span><span class="ident">watch</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="symbol">:user_id</span> <span class="punct">=&gt;</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>246</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line246'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>247</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line247'><pre>
</pre></a></td></tr><tr><td valign='top'><small>248</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line248'><pre>  <span class="keyword">def </span><span class="method">build_inbox_collection</span>
</pre></a></td></tr><tr><td valign='top'><small>249</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line249'><pre>    <span class="constant">Collection</span><span class="punct">.</span><span class="ident">create</span><span class="punct">(</span><span class="symbol">:name</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{self.username.titleize}</span>'s Inbox Collection</span><span class="punct">&quot;,</span> <span class="symbol">:special_collection_id</span> <span class="punct">=&gt;</span> <span class="constant">SpecialCollection</span><span class="punct">.</span><span class="ident">inbox</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="symbol">:user_id</span> <span class="punct">=&gt;</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>250</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line250'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>251</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line251'><pre>
</pre></a></td></tr><tr><td valign='top'><small>252</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line252'><pre>  <span class="keyword">def </span><span class="method">password</span>
</pre></a></td></tr><tr><td valign='top'><small>253</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line253'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">entered_password</span>
</pre></a></td></tr><tr><td valign='top'><small>254</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line254'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>255</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line255'><pre>
</pre></a></td></tr><tr><td valign='top'><small>256</small></td><td valign='top'><ul><li>Duplication - calls errors 3 times &raquo; reek</li><li>Duplication - calls secondary_hierarchy_id twice &raquo; reek</li><li>Complexity 5 &raquo; saikuro</li></ul></td><td valign='top'><a name='line256'><pre>  <span class="keyword">def </span><span class="method">validate</span>
</pre></a></td></tr><tr><td valign='top'><small>257</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line257'><pre>    <span class="ident">errors</span><span class="punct">.</span><span class="ident">add_to_base</span> <span class="punct">&quot;</span><span class="string">Secondary hierarchy must be different than default</span><span class="punct">&quot;</span> <span class="keyword">if</span> <span class="punct">!</span><span class="ident">secondary_hierarchy_id</span><span class="punct">.</span><span class="ident">nil?</span> <span class="punct">&amp;&amp;</span> <span class="ident">secondary_hierarchy_id</span> <span class="punct">==</span> <span class="ident">default_hierarchy_id</span>
</pre></a></td></tr><tr><td valign='top'><small>258</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line258'><pre>    <span class="keyword">if</span> <span class="constant">EOLConvert</span><span class="punct">.</span><span class="ident">to_boolean</span><span class="punct">(</span><span class="ident">curator_request</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>259</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line259'><pre>      <span class="keyword">if</span><span class="punct">(</span><span class="ident">credentials</span><span class="punct">.</span><span class="ident">blank?</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>260</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line260'><pre>        <span class="ident">errors</span><span class="punct">.</span><span class="ident">add_to_base</span> <span class="punct">&quot;</span><span class="string">You must indicate your credentials and area of expertise to request curator privileges.</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>261</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line261'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>262</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line262'><pre>      <span class="keyword">if</span><span class="punct">(</span><span class="ident">curator_scope</span><span class="punct">.</span><span class="ident">blank?</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>263</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line263'><pre>        <span class="ident">errors</span><span class="punct">.</span><span class="ident">add_to_base</span> <span class="punct">&quot;</span><span class="string">You must indicate your scope to request curator privileges.</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>264</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line264'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>265</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line265'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>266</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line266'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>267</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line267'><pre>
</pre></a></td></tr><tr><td valign='top'><small>268</small></td><td valign='top'><ul><li>Duplication - calls family_name twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line268'><pre>  <span class="keyword">def </span><span class="method">full_name</span>
</pre></a></td></tr><tr><td valign='top'><small>269</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line269'><pre>    <span class="ident">return_value</span> <span class="punct">=</span> <span class="ident">given_name</span> <span class="punct">||</span> <span class="punct">&quot;</span><span class="string"></span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>270</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line270'><pre>    <span class="ident">return_value</span> <span class="punct">+=</span> <span class="punct">&quot;</span><span class="string"> </span><span class="punct">&quot;</span> <span class="punct">+</span> <span class="ident">family_name</span> <span class="keyword">unless</span> <span class="ident">family_name</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>271</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line271'><pre>    <span class="ident">return_value</span>
</pre></a></td></tr><tr><td valign='top'><small>272</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line272'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>273</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line273'><pre>
</pre></a></td></tr><tr><td valign='top'><small>274</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line274'><pre>  <span class="comment"># TODO</span>
</pre></a></td></tr><tr><td valign='top'><small>275</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line275'><pre>  <span class="comment"># NOTE - this is currently ONLY used in an exported (CSV) report for admins... so... LOW priority.</span>
</pre></a></td></tr><tr><td valign='top'><small>276</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line276'><pre>  <span class="comment"># get the total objects curated for a particular curator activity type</span>
</pre></a></td></tr><tr><td valign='top'><small>277</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line277'><pre>  <span class="keyword">def </span><span class="method">total_objects_curated_by_action</span><span class="punct">(</span><span class="ident">action</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>278</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line278'><pre>    <span class="ident">curator_activity_id</span> <span class="punct">=</span> <span class="constant">Activity</span><span class="punct">.</span><span class="ident">send</span> <span class="ident">action</span> <span class="comment"># approve may not work... looking into it TODO</span>
</pre></a></td></tr><tr><td valign='top'><small>279</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line279'><pre>    <span class="keyword">if</span> <span class="punct">!</span><span class="ident">curator_activity_id</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>280</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line280'><pre>      <span class="comment"># TODO</span>
</pre></a></td></tr><tr><td valign='top'><small>281</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line281'><pre>      <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Unimplemented</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>282</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line282'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>283</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line283'><pre>      <span class="keyword">return</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>284</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line284'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>285</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line285'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>286</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line286'><pre>
</pre></a></td></tr><tr><td valign='top'><small>287</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line287'><pre>  <span class="comment"># TODO - test</span>
</pre></a></td></tr><tr><td valign='top'><small>288</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line288'><pre>  <span class="keyword">def </span><span class="method">total_data_objects_curated</span>
</pre></a></td></tr><tr><td valign='top'><small>289</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line289'><pre>      <span class="keyword">return</span> <span class="ident">curator_activity_logs_on_data_objects</span><span class="punct">.</span><span class="ident">count</span><span class="punct">(</span>
</pre></a></td></tr><tr><td valign='top'><small>290</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line290'><pre>              <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">activity_id IN (<span class="expr">#{Activity.raw_curator_action_ids.join(&quot;,&quot;)}</span>)</span><span class="punct">&quot;,</span>
</pre></a></td></tr><tr><td valign='top'><small>291</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line291'><pre>              <span class="symbol">:group</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">curator_activity_logs.object_id</span><span class="punct">').</span><span class="ident">count</span>
</pre></a></td></tr><tr><td valign='top'><small>292</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line292'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>293</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line293'><pre>
</pre></a></td></tr><tr><td valign='top'><small>294</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line294'><pre>  <span class="comment"># TODO - test</span>
</pre></a></td></tr><tr><td valign='top'><small>295</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line295'><pre>  <span class="keyword">def </span><span class="method">comment_curation_actions</span>
</pre></a></td></tr><tr><td valign='top'><small>296</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line296'><pre>    <span class="constant">CuratorActivityLog</span><span class="punct">.</span><span class="ident">find_all_by_user_id_and_changeable_object_type_id</span><span class="punct">(</span><span class="ident">id</span><span class="punct">,</span> <span class="constant">ChangeableObjectType</span><span class="punct">.</span><span class="ident">comment</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>297</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line297'><pre>      <span class="symbol">:include</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:activity</span><span class="punct">,</span> <span class="symbol">:affected_comment</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>298</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line298'><pre>      <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:curator_activity_logs</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">',</span> <span class="symbol">:comments</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">'</span> <span class="punct">},</span>
</pre></a></td></tr><tr><td valign='top'><small>299</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line299'><pre>      <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">activity_id != <span class="expr">#{Activity.create.id}</span></span><span class="punct">&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>300</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line300'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>301</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line301'><pre>
</pre></a></td></tr><tr><td valign='top'><small>302</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line302'><pre>  <span class="comment"># TODO - test</span>
</pre></a></td></tr><tr><td valign='top'><small>303</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line303'><pre>  <span class="keyword">def </span><span class="method">total_comments_curated</span>
</pre></a></td></tr><tr><td valign='top'><small>304</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line304'><pre>    <span class="ident">comment_curation_actions</span><span class="punct">.</span><span class="ident">length</span>
</pre></a></td></tr><tr><td valign='top'><small>305</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line305'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>306</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line306'><pre>
</pre></a></td></tr><tr><td valign='top'><small>307</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line307'><pre>  <span class="comment"># TODO - test</span>
</pre></a></td></tr><tr><td valign='top'><small>308</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line308'><pre>  <span class="keyword">def </span><span class="method">taxon_concept_ids_curated</span>
</pre></a></td></tr><tr><td valign='top'><small>309</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line309'><pre>    <span class="ident">connection</span><span class="punct">.</span><span class="ident">select_values</span><span class="punct">(&quot;</span><span class="string"><span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>310</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line310'><pre>      <span class="constant">SELECT</span> <span class="ident">dotc</span><span class="punct">.</span><span class="ident">taxon_concept_id</span>
</pre></a></td></tr><tr><td valign='top'><small>311</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line311'><pre>      <span class="constant">FROM</span> <span class="comment">#{CuratorActivityLog.database_name}.curator_activity_logs cal</span>
</pre></a></td></tr><tr><td valign='top'><small>312</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line312'><pre>        <span class="constant">JOIN</span> <span class="comment">#{LoggingModel.database_name}.activities acts ON (cal.activity_id = acts.id)</span>
</pre></a></td></tr><tr><td valign='top'><small>313</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line313'><pre>        <span class="constant">JOIN</span> <span class="comment">#{DataObjectsTaxonConcept.full_table_name} dotc ON (cal.object_id = dotc.data_object_id)</span>
</pre></a></td></tr><tr><td valign='top'><small>314</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line314'><pre>      <span class="constant">WHERE</span> <span class="ident">cal</span><span class="punct">.</span><span class="ident">user_id</span><span class="punct">=</span><span class="comment">#{id}</span>
</pre></a></td></tr><tr><td valign='top'><small>315</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line315'><pre>        <span class="constant">AND</span> <span class="ident">cal</span><span class="punct">.</span><span class="ident">changeable_object_type_id</span><span class="punct">=</span><span class="comment">#{ChangeableObjectType.data_object.id}</span>
</pre></a></td></tr><tr><td valign='top'><small>316</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line316'><pre>        <span class="constant">AND</span> <span class="ident">acts</span><span class="punct">.</span><span class="ident">id!</span><span class="punct">=</span><span class="comment">#{Activity.rate.id}</span>
</pre></a></td></tr><tr><td valign='top'><small>317</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line317'><pre>      <span class="constant">GROUP</span> <span class="constant">BY</span> <span class="ident">cal</span><span class="punct">.</span><span class="ident">object_id</span>
</pre></a></td></tr><tr><td valign='top'><small>318</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line318'><pre>      <span class="constant">ORDER</span> <span class="constant">BY</span> <span class="ident">cal</span><span class="punct">.</span><span class="ident">updated_at</span> <span class="constant">DESC</span><span class="punct">&quot;</span><span class="string">).uniq<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>319</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line319'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>320</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line320'><pre>
</pre></a></td></tr><tr><td valign='top'><small>321</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line321'><pre>  <span class="comment"># TODO - test</span>
</pre></a></td></tr><tr><td valign='top'><small>322</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line322'><pre>  <span class="keyword">def </span><span class="method">total_species_curated</span>
</pre></a></td></tr><tr><td valign='top'><small>323</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line323'><pre>    <span class="ident">taxon_concept_ids_curated</span><span class="punct">.</span><span class="ident">length</span>
</pre></a></td></tr><tr><td valign='top'><small>324</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line324'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>325</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line325'><pre>
</pre></a></td></tr><tr><td valign='top'><small>326</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line326'><pre>  <span class="comment"># TODO - test all of these taggy things.  And move this to a module, I think.</span>
</pre></a></td></tr><tr><td valign='top'><small>327</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line327'><pre>  <span class="keyword">def </span><span class="method">data_object_tags_for</span> <span class="ident">data_object</span>
</pre></a></td></tr><tr><td valign='top'><small>328</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line328'><pre>    <span class="ident">data_object_tags</span><span class="punct">.</span><span class="ident">find_all_by_data_object_guid</span> <span class="ident">data_object</span><span class="punct">.</span><span class="ident">guid</span><span class="punct">,</span> <span class="symbol">:include</span> <span class="punct">=&gt;</span> <span class="symbol">:data_object_tag</span>
</pre></a></td></tr><tr><td valign='top'><small>329</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line329'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>330</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line330'><pre>  <span class="keyword">def </span><span class="method">tags_for</span><span class="punct">(</span><span class="ident">data_object</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>331</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line331'><pre>    <span class="ident">data_object_tags_for</span><span class="punct">(</span><span class="ident">data_object</span><span class="punct">).</span><span class="ident">map</span><span class="punct">(&amp;</span><span class="symbol">:tag</span><span class="punct">).</span><span class="ident">uniq</span>
</pre></a></td></tr><tr><td valign='top'><small>332</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line332'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>333</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line333'><pre>  <span class="keyword">def </span><span class="method">tagged_objects</span>
</pre></a></td></tr><tr><td valign='top'><small>334</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line334'><pre>    <span class="ident">data_object_tags</span><span class="punct">.</span><span class="ident">find_all</span><span class="punct">.</span><span class="ident">map</span><span class="punct">(&amp;</span><span class="symbol">:object</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>335</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line335'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>336</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line336'><pre>  <span class="keyword">def </span><span class="method">tag_keys</span>
</pre></a></td></tr><tr><td valign='top'><small>337</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line337'><pre>    <span class="ident">tags</span><span class="punct">.</span><span class="ident">map</span><span class="punct">(&amp;</span><span class="symbol">:key</span><span class="punct">).</span><span class="ident">uniq</span>
</pre></a></td></tr><tr><td valign='top'><small>338</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line338'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>339</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line339'><pre>
</pre></a></td></tr><tr><td valign='top'><small>340</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line340'><pre>  <span class="comment"># object might be a data object or taxon concept</span>
</pre></a></td></tr><tr><td valign='top'><small>341</small></td><td valign='top'><ul><li>ControlCouple - is controlled by argument object &raquo; reek</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line341'><pre>  <span class="keyword">def </span><span class="method">can_curate?</span> <span class="ident">object</span>
</pre></a></td></tr><tr><td valign='top'><small>342</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line342'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">unless</span> <span class="ident">curator_approved</span>
</pre></a></td></tr><tr><td valign='top'><small>343</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line343'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">unless</span> <span class="ident">object</span>
</pre></a></td></tr><tr><td valign='top'><small>344</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line344'><pre>    <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Don't know how to curate object of type <span class="expr">#{ object.class }</span></span><span class="punct">&quot;</span> <span class="keyword">unless</span> <span class="ident">object</span><span class="punct">.</span><span class="ident">respond_to?</span><span class="symbol">:is_curatable_by?</span>
</pre></a></td></tr><tr><td valign='top'><small>345</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line345'><pre>    <span class="comment"># object.is_curatable_by? self</span>
</pre></a></td></tr><tr><td valign='top'><small>346</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line346'><pre>    <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>347</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line347'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>348</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line348'><pre>  <span class="keyword">alias</span> <span class="ident">is_curator_for?</span> <span class="ident">can_curate?</span>
</pre></a></td></tr><tr><td valign='top'><small>349</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line349'><pre>
</pre></a></td></tr><tr><td valign='top'><small>350</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line350'><pre>  <span class="comment"># TODO - TEST (or remove... this seems silly.)</span>
</pre></a></td></tr><tr><td valign='top'><small>351</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line351'><pre>  <span class="keyword">def </span><span class="method">can_curate_taxon_concept_id?</span> <span class="ident">taxon_concept_id</span>
</pre></a></td></tr><tr><td valign='top'><small>352</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line352'><pre>    <span class="ident">can_curate?</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">taxon_concept_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>353</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line353'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>354</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line354'><pre>
</pre></a></td></tr><tr><td valign='top'><small>355</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line355'><pre>  <span class="keyword">def </span><span class="method">special</span>
</pre></a></td></tr><tr><td valign='top'><small>356</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line356'><pre>    <span class="attribute">@special</span> <span class="punct">||=</span> <span class="ident">member_of</span><span class="punct">(</span><span class="constant">Community</span><span class="punct">.</span><span class="ident">special</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>357</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line357'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>358</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line358'><pre>
</pre></a></td></tr><tr><td valign='top'><small>359</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line359'><pre>  <span class="keyword">def </span><span class="method">approve_to_administrate</span>
</pre></a></td></tr><tr><td valign='top'><small>360</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line360'><pre>    <span class="ident">grant_special_role</span><span class="punct">(</span><span class="constant">Role</span><span class="punct">.</span><span class="ident">administrator</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>361</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line361'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>362</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line362'><pre>
</pre></a></td></tr><tr><td valign='top'><small>363</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line363'><pre>  <span class="comment"># Grants rights to their currently-selected HE.</span>
</pre></a></td></tr><tr><td valign='top'><small>364</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line364'><pre>  <span class="keyword">def </span><span class="method">approve_to_curate</span>
</pre></a></td></tr><tr><td valign='top'><small>365</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line365'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">curator_approved</span> <span class="punct">=</span> <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>366</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line366'><pre>    <span class="ident">grant_special_role</span><span class="punct">(</span><span class="constant">Role</span><span class="punct">.</span><span class="ident">curator</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>367</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line367'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>368</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line368'><pre>
</pre></a></td></tr><tr><td valign='top'><small>369</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line369'><pre>  <span class="keyword">def </span><span class="method">grant_special_role</span><span class="punct">(</span><span class="ident">role</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>370</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line370'><pre>    <span class="ident">join_community</span><span class="punct">(</span><span class="constant">Community</span><span class="punct">.</span><span class="ident">special</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>371</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line371'><pre>    <span class="ident">special</span><span class="punct">.</span><span class="ident">add_role</span><span class="punct">(</span><span class="ident">role</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>372</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line372'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>373</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line373'><pre>
</pre></a></td></tr><tr><td valign='top'><small>374</small></td><td valign='top'><ul><li>Duplication - calls special twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line374'><pre>  <span class="keyword">def </span><span class="method">revoke_curatorship</span>
</pre></a></td></tr><tr><td valign='top'><small>375</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line375'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">curator_approved</span> <span class="punct">=</span> <span class="constant">false</span>
</pre></a></td></tr><tr><td valign='top'><small>376</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line376'><pre>    <span class="keyword">if</span> <span class="ident">special</span>
</pre></a></td></tr><tr><td valign='top'><small>377</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line377'><pre>      <span class="ident">special</span><span class="punct">.</span><span class="ident">remove_role</span><span class="punct">(</span><span class="constant">Role</span><span class="punct">.</span><span class="ident">curator</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>378</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line378'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>379</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line379'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>380</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line380'><pre>
</pre></a></td></tr><tr><td valign='top'><small>381</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line381'><pre>  <span class="comment"># Grants or revokes rights to their currently-selected HE *and* updates fields indicating who allowed this (and when).</span>
</pre></a></td></tr><tr><td valign='top'><small>382</small></td><td valign='top'><ul><li>Duplication - calls curator_approved twice &raquo; reek</li><li>LongMethod - has approx 7 statements &raquo; reek</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line382'><pre>  <span class="keyword">def </span><span class="method">approve_to_curate_by_user</span> <span class="ident">approved</span><span class="punct">,</span> <span class="ident">updated_by</span>
</pre></a></td></tr><tr><td valign='top'><small>383</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line383'><pre>    <span class="comment"># TODO - this will happen EVERY time the user's record is updated by an admin. So the name curator_verdict_at is</span>
</pre></a></td></tr><tr><td valign='top'><small>384</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line384'><pre>    <span class="comment"># now misleading because it will get updated even when nothing about the user is changed (the edit form is loaded and</span>
</pre></a></td></tr><tr><td valign='top'><small>385</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line385'><pre>    <span class="comment"># immediately saved).</span>
</pre></a></td></tr><tr><td valign='top'><small>386</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line386'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">curator_verdict_at</span> <span class="punct">=</span> <span class="constant">Time</span><span class="punct">.</span><span class="ident">now</span>
</pre></a></td></tr><tr><td valign='top'><small>387</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line387'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">curator_verdict_by</span> <span class="punct">=</span> <span class="ident">updated_by</span>
</pre></a></td></tr><tr><td valign='top'><small>388</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line388'><pre>    <span class="keyword">if</span> <span class="punct">(</span><span class="ident">approved</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span> <span class="ident">curator_approved</span><span class="punct">)</span> <span class="comment"># The user wasn't a curator and is now approved</span>
</pre></a></td></tr><tr><td valign='top'><small>389</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line389'><pre>      <span class="ident">approve_to_curate</span>
</pre></a></td></tr><tr><td valign='top'><small>390</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line390'><pre>      <span class="constant">Notifier</span><span class="punct">.</span><span class="ident">deliver_curator_approved</span><span class="punct">(</span><span class="constant">self</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>391</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line391'><pre>    <span class="keyword">elsif</span> <span class="punct">((!</span> <span class="ident">approved</span><span class="punct">)</span> <span class="punct">&amp;&amp;</span> <span class="ident">curator_approved</span><span class="punct">)</span> <span class="comment"># The user *was* a curator and is now rejected</span>
</pre></a></td></tr><tr><td valign='top'><small>392</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line392'><pre>      <span class="ident">revoke_curatorship</span>
</pre></a></td></tr><tr><td valign='top'><small>393</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line393'><pre>      <span class="constant">Notifier</span><span class="punct">.</span><span class="ident">deliver_curator_unapproved</span><span class="punct">(</span><span class="constant">self</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>394</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line394'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>395</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line395'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">save!</span> <span class="keyword">unless</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">validating</span>
</pre></a></td></tr><tr><td valign='top'><small>396</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line396'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>397</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line397'><pre>
</pre></a></td></tr><tr><td valign='top'><small>398</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line398'><pre>  <span class="keyword">def </span><span class="method">clear_cached_user</span>
</pre></a></td></tr><tr><td valign='top'><small>399</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line399'><pre>    <span class="global">$CACHE</span><span class="punct">.</span><span class="ident">delete</span><span class="punct">(&quot;</span><span class="string">users/<span class="expr">#{self.id}</span></span><span class="punct">&quot;)</span> <span class="keyword">if</span> <span class="global">$CACHE</span>
</pre></a></td></tr><tr><td valign='top'><small>400</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line400'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>401</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line401'><pre>
</pre></a></td></tr><tr><td valign='top'><small>402</small></td><td valign='top'><ul><li>Duplication - calls self.credentials = "" twice &raquo; reek</li><li>LongMethod - has approx 9 statements &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line402'><pre>  <span class="keyword">def </span><span class="method">clear_curatorship</span> <span class="ident">updated_by</span><span class="punct">,</span> <span class="ident">update_notes</span><span class="punct">=&quot;</span><span class="string"></span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>403</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line403'><pre>    <span class="ident">revoke_curatorship</span>
</pre></a></td></tr><tr><td valign='top'><small>404</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line404'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">credentials</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string"></span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>405</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line405'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">curator_scope</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string"></span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>406</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line406'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">credentials</span><span class="punct">=&quot;</span><span class="string"></span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>407</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line407'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">curator_verdict_at</span> <span class="punct">=</span> <span class="constant">Time</span><span class="punct">.</span><span class="ident">now</span>
</pre></a></td></tr><tr><td valign='top'><small>408</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line408'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">curator_verdict_by</span> <span class="punct">=</span> <span class="ident">updated_by</span>
</pre></a></td></tr><tr><td valign='top'><small>409</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line409'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">notes</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string"></span><span class="punct">&quot;</span> <span class="keyword">if</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">notes</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>410</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line410'><pre>    <span class="keyword">unless</span> <span class="ident">update_notes</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>411</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line411'><pre>      <span class="constant">self</span><span class="punct">.</span><span class="ident">notes</span> <span class="punct">+=</span> <span class="punct">'</span><span class="string"> ; (</span><span class="punct">'</span> <span class="punct">+</span> <span class="ident">updated_by</span><span class="punct">.</span><span class="ident">username</span> <span class="punct">+</span> <span class="punct">'</span><span class="string"> on </span><span class="punct">'</span> <span class="punct">+</span> <span class="constant">Date</span><span class="punct">.</span><span class="ident">today</span><span class="punct">.</span><span class="ident">to_s</span> <span class="punct">+</span> <span class="punct">'</span><span class="string">): </span><span class="punct">'</span> <span class="punct">+</span> <span class="ident">update_notes</span>
</pre></a></td></tr><tr><td valign='top'><small>412</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line412'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>413</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line413'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">save!</span>
</pre></a></td></tr><tr><td valign='top'><small>414</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line414'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>415</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line415'><pre>
</pre></a></td></tr><tr><td valign='top'><small>416</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line416'><pre>  <span class="keyword">def </span><span class="method">vet</span> <span class="ident">object</span>
</pre></a></td></tr><tr><td valign='top'><small>417</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line417'><pre>    <span class="ident">object</span><span class="punct">.</span><span class="ident">vet</span><span class="punct">(</span><span class="constant">self</span><span class="punct">)</span> <span class="keyword">if</span> <span class="ident">object</span> <span class="keyword">and</span> <span class="ident">object</span><span class="punct">.</span><span class="ident">respond_to?</span> <span class="symbol">:vet</span> <span class="keyword">and</span> <span class="ident">can_curate?</span> <span class="ident">object</span>
</pre></a></td></tr><tr><td valign='top'><small>418</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line418'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>419</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line419'><pre>
</pre></a></td></tr><tr><td valign='top'><small>420</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line420'><pre>  <span class="keyword">def </span><span class="method">unvet</span> <span class="ident">object</span>
</pre></a></td></tr><tr><td valign='top'><small>421</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line421'><pre>    <span class="ident">object</span><span class="punct">.</span><span class="ident">unvet</span><span class="punct">(</span><span class="constant">self</span><span class="punct">)</span> <span class="keyword">if</span> <span class="ident">object</span> <span class="keyword">and</span> <span class="ident">object</span><span class="punct">.</span><span class="ident">respond_to?</span> <span class="symbol">:unvet</span> <span class="keyword">and</span> <span class="ident">can_curate?</span> <span class="ident">object</span>
</pre></a></td></tr><tr><td valign='top'><small>422</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line422'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>423</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line423'><pre>
</pre></a></td></tr><tr><td valign='top'><small>424</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line424'><pre>  <span class="keyword">def </span><span class="method">reset_login_attempts</span>
</pre></a></td></tr><tr><td valign='top'><small>425</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line425'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">failed_login_attempts</span> <span class="punct">=</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>426</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line426'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>427</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line427'><pre>
</pre></a></td></tr><tr><td valign='top'><small>428</small></td><td valign='top'><ul><li>Duplication - calls self.failed_login_attempts twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line428'><pre>  <span class="keyword">def </span><span class="method">invalid_login_attempt</span>
</pre></a></td></tr><tr><td valign='top'><small>429</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line429'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">failed_login_attempts</span> <span class="punct">+=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>430</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line430'><pre>    <span class="ident">logger</span><span class="punct">.</span><span class="ident">error</span> <span class="punct">&quot;</span><span class="string">Possible dictionary attack on user <span class="expr">#{self.id}</span> - <span class="expr">#{self.failed_login_attempts}</span> failed login attempts</span><span class="punct">&quot;</span> <span class="keyword">if</span>
</pre></a></td></tr><tr><td valign='top'><small>431</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line431'><pre>      <span class="constant">self</span><span class="punct">.</span><span class="ident">failed_login_attempts</span> <span class="punct">&gt;</span> <span class="number">10</span> <span class="comment"># Smells like a dictionary attack!</span>
</pre></a></td></tr><tr><td valign='top'><small>432</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line432'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>433</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line433'><pre>
</pre></a></td></tr><tr><td valign='top'><small>434</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line434'><pre>  <span class="comment"># set the password</span>
</pre></a></td></tr><tr><td valign='top'><small>435</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line435'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>436</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line436'><pre>  <span class="comment"># this sets both the #entered_password (for temporary retrieval)</span>
</pre></a></td></tr><tr><td valign='top'><small>437</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line437'><pre>  <span class="comment"># and the #hashed_password</span>
</pre></a></td></tr><tr><td valign='top'><small>438</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line438'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>439</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line439'><pre>  <span class="keyword">def </span><span class="method">password=</span><span class="punct">(</span><span class="ident">value</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>440</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line440'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">entered_password</span> <span class="punct">=</span> <span class="ident">value</span>
</pre></a></td></tr><tr><td valign='top'><small>441</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line441'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">hashed_password</span> <span class="punct">=</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">hash_password</span><span class="punct">(</span><span class="ident">value</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>442</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line442'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>443</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line443'><pre>
</pre></a></td></tr><tr><td valign='top'><small>444</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line444'><pre>  <span class="keyword">def </span><span class="method">watch_collection</span>
</pre></a></td></tr><tr><td valign='top'><small>445</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line445'><pre>    <span class="ident">collection</span> <span class="punct">=</span> <span class="constant">Collection</span><span class="punct">.</span><span class="ident">find_by_user_id_and_special_collection_id</span><span class="punct">(</span><span class="constant">self</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="constant">SpecialCollection</span><span class="punct">.</span><span class="ident">watch</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>446</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line446'><pre>    <span class="ident">collection</span> <span class="punct">||=</span> <span class="ident">build_watch_collection</span>
</pre></a></td></tr><tr><td valign='top'><small>447</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line447'><pre>    <span class="ident">collection</span>
</pre></a></td></tr><tr><td valign='top'><small>448</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line448'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>449</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line449'><pre>
</pre></a></td></tr><tr><td valign='top'><small>450</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line450'><pre>  <span class="keyword">def </span><span class="method">inbox_collection</span>
</pre></a></td></tr><tr><td valign='top'><small>451</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line451'><pre>    <span class="ident">collection</span> <span class="punct">=</span> <span class="constant">Collection</span><span class="punct">.</span><span class="ident">find_by_user_id_and_special_collection_id</span><span class="punct">(</span><span class="constant">self</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="constant">SpecialCollection</span><span class="punct">.</span><span class="ident">inbox</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>452</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line452'><pre>    <span class="ident">collection</span> <span class="punct">||=</span> <span class="ident">build_inbox_collection</span>
</pre></a></td></tr><tr><td valign='top'><small>453</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line453'><pre>    <span class="ident">collection</span>
</pre></a></td></tr><tr><td valign='top'><small>454</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line454'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>455</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line455'><pre>
</pre></a></td></tr><tr><td valign='top'><small>456</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line456'><pre>  <span class="comment"># set the language from the abbreviation</span>
</pre></a></td></tr><tr><td valign='top'><small>457</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line457'><pre>  <span class="keyword">def </span><span class="method">language_abbr=</span><span class="punct">(</span><span class="ident">value</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>458</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line458'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">language</span> <span class="punct">=</span> <span class="constant">Language</span><span class="punct">.</span><span class="ident">find_by_iso_639_1</span><span class="punct">(</span><span class="ident">value</span><span class="punct">.</span><span class="ident">downcase</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>459</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line459'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>460</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line460'><pre>
</pre></a></td></tr><tr><td valign='top'><small>461</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line461'><pre>  <span class="comment"># grab the language abbreviation</span>
</pre></a></td></tr><tr><td valign='top'><small>462</small></td><td valign='top'><ul><li>Duplication - calls language twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line462'><pre>  <span class="keyword">def </span><span class="method">language_abbr</span>
</pre></a></td></tr><tr><td valign='top'><small>463</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line463'><pre>    <span class="keyword">return</span> <span class="ident">language</span><span class="punct">.</span><span class="ident">nil?</span> <span class="punct">?</span> <span class="constant">Language</span><span class="punct">.</span><span class="ident">english</span><span class="punct">.</span><span class="ident">iso_639_1</span> <span class="punct">:</span> <span class="ident">language</span><span class="punct">.</span><span class="ident">iso_639_1</span>
</pre></a></td></tr><tr><td valign='top'><small>464</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line464'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>465</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line465'><pre>
</pre></a></td></tr><tr><td valign='top'><small>466</small></td><td valign='top'><ul><li>Duplication - calls special twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line466'><pre>  <span class="keyword">def </span><span class="method">is_moderator?</span>
</pre></a></td></tr><tr><td valign='top'><small>467</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line467'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">if</span> <span class="ident">special</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>468</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line468'><pre>    <span class="ident">special</span><span class="punct">.</span><span class="ident">can?</span><span class="punct">(</span><span class="constant">Privilege</span><span class="punct">.</span><span class="ident">hide_comments</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>469</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line469'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>470</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line470'><pre>
</pre></a></td></tr><tr><td valign='top'><small>471</small></td><td valign='top'><ul><li>Duplication - calls special twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line471'><pre>  <span class="keyword">def </span><span class="method">has_special_role?</span><span class="punct">(</span><span class="ident">role</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>472</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line472'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">unless</span> <span class="ident">special</span>
</pre></a></td></tr><tr><td valign='top'><small>473</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line473'><pre>    <span class="ident">special</span><span class="punct">.</span><span class="ident">roles</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">role</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>474</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line474'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>475</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line475'><pre>
</pre></a></td></tr><tr><td valign='top'><small>476</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line476'><pre>  <span class="keyword">def </span><span class="method">is_admin?</span>
</pre></a></td></tr><tr><td valign='top'><small>477</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line477'><pre>    <span class="ident">has_special_role?</span><span class="punct">(</span><span class="constant">Role</span><span class="punct">.</span><span class="ident">administrator</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>478</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line478'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>479</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line479'><pre>
</pre></a></td></tr><tr><td valign='top'><small>480</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line480'><pre>  <span class="keyword">def </span><span class="method">is_content_partner?</span>
</pre></a></td></tr><tr><td valign='top'><small>481</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line481'><pre>    <span class="ident">content_partner</span> <span class="punct">?</span> <span class="constant">true</span> <span class="punct">:</span> <span class="constant">false</span>
</pre></a></td></tr><tr><td valign='top'><small>482</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line482'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>483</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line483'><pre>
</pre></a></td></tr><tr><td valign='top'><small>484</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line484'><pre>  <span class="keyword">def </span><span class="method">is_curator?</span>
</pre></a></td></tr><tr><td valign='top'><small>485</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line485'><pre>    <span class="ident">has_special_role?</span><span class="punct">(</span><span class="constant">Role</span><span class="punct">.</span><span class="ident">curator</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>486</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line486'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>487</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line487'><pre>
</pre></a></td></tr><tr><td valign='top'><small>488</small></td><td valign='top'><ul><li>LowCohesion - refers to hierarchy more than self &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line488'><pre>  <span class="keyword">def </span><span class="method">selected_default_hierarchy</span>
</pre></a></td></tr><tr><td valign='top'><small>489</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line489'><pre>    <span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">find_by_id</span><span class="punct">(</span><span class="ident">default_hierarchy_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>490</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line490'><pre>    <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">?</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span> <span class="punct">:</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">label</span>
</pre></a></td></tr><tr><td valign='top'><small>491</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line491'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>492</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line492'><pre>
</pre></a></td></tr><tr><td valign='top'><small>493</small></td><td valign='top'><ul><li>LowCohesion - refers to last more than self &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line493'><pre>  <span class="keyword">def </span><span class="method">last_curator_activity</span>
</pre></a></td></tr><tr><td valign='top'><small>494</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line494'><pre>    <span class="ident">last</span> <span class="punct">=</span> <span class="constant">CuratorActivityLog</span><span class="punct">.</span><span class="ident">find_by_user_id</span><span class="punct">(</span><span class="ident">id</span><span class="punct">,</span> <span class="symbol">:order</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">created_at DESC</span><span class="punct">',</span> <span class="symbol">:limit</span> <span class="punct">=&gt;</span> <span class="number">1</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>495</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line495'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">last</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>496</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line496'><pre>    <span class="keyword">return</span> <span class="ident">last</span><span class="punct">.</span><span class="ident">created_at</span>
</pre></a></td></tr><tr><td valign='top'><small>497</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line497'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>498</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line498'><pre>
</pre></a></td></tr><tr><td valign='top'><small>499</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line499'><pre>  <span class="keyword">def </span><span class="method">show_unvetted?</span>
</pre></a></td></tr><tr><td valign='top'><small>500</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line500'><pre>    <span class="keyword">return</span> <span class="punct">!</span><span class="ident">vetted</span>
</pre></a></td></tr><tr><td valign='top'><small>501</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line501'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>502</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line502'><pre>
</pre></a></td></tr><tr><td valign='top'><small>503</small></td><td valign='top'><ul><li>LowCohesion - refers to credentials more than self &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line503'><pre>  <span class="keyword">def </span><span class="method">check_credentials</span>
</pre></a></td></tr><tr><td valign='top'><small>504</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line504'><pre>    <span class="ident">credentials</span> <span class="punct">=</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span> <span class="keyword">if</span> <span class="ident">credentials</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>505</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line505'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>506</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line506'><pre>
</pre></a></td></tr><tr><td valign='top'><small>507</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line507'><pre>  <span class="keyword">def </span><span class="method">tags_are_public_for_data_object?</span><span class="punct">(</span><span class="ident">data_object</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>508</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line508'><pre>    <span class="keyword">return</span> <span class="ident">can_curate?</span><span class="punct">(</span><span class="ident">data_object</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>509</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line509'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>510</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line510'><pre>
</pre></a></td></tr><tr><td valign='top'><small>511</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line511'><pre>  <span class="comment"># Returns an array of data objects submitted by this user.  NOT USED ANYWHERE.  This is a convenience method for</span>
</pre></a></td></tr><tr><td valign='top'><small>512</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line512'><pre>  <span class="comment"># developers to use.</span>
</pre></a></td></tr><tr><td valign='top'><small>513</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line513'><pre>  <span class="keyword">def </span><span class="method">all_submitted_datos</span>
</pre></a></td></tr><tr><td valign='top'><small>514</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line514'><pre>    <span class="constant">UsersDataObject</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="symbol">:all</span><span class="punct">,</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">user_id = <span class="expr">#{self[:id]}</span></span><span class="punct">&quot;).</span><span class="ident">map</span> <span class="punct">{|</span><span class="ident">udo</span><span class="punct">|</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">udo</span><span class="punct">.</span><span class="ident">data_object_id</span><span class="punct">)</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>515</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line515'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>516</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line516'><pre>
</pre></a></td></tr><tr><td valign='top'><small>517</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line517'><pre>  <span class="comment"># Returns an array of descriptions from all of the data objects submitted by this user.  NOT USED ANYWHERE.  This</span>
</pre></a></td></tr><tr><td valign='top'><small>518</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line518'><pre>  <span class="comment"># is a convenience method for developers to use.</span>
</pre></a></td></tr><tr><td valign='top'><small>519</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line519'><pre>  <span class="keyword">def </span><span class="method">all_submitted_dato_descriptions</span>
</pre></a></td></tr><tr><td valign='top'><small>520</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line520'><pre>    <span class="ident">all_submitted_datos</span><span class="punct">.</span><span class="ident">map</span> <span class="punct">{|</span><span class="ident">dato</span><span class="punct">|</span> <span class="ident">dato</span><span class="punct">.</span><span class="ident">description</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>521</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line521'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>522</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line522'><pre>
</pre></a></td></tr><tr><td valign='top'><small>523</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line523'><pre>  <span class="comment"># Sets the visibility to invisible and the vetted to untrusted on all DataObjects submitted by this user.  NOT</span>
</pre></a></td></tr><tr><td valign='top'><small>524</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line524'><pre>  <span class="comment"># USED ANYWHERE.  This is a convenience method for developers to use.  ...particularly where they are submitting</span>
</pre></a></td></tr><tr><td valign='top'><small>525</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line525'><pre>  <span class="comment"># lots of text objects for testing, but don't want the rest of the world to see them when they are done.</span>
</pre></a></td></tr><tr><td valign='top'><small>526</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line526'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>527</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line527'><pre>  <span class="comment"># No return value; will raise exceptions if things fail.</span>
</pre></a></td></tr><tr><td valign='top'><small>528</small></td><td valign='top'><ul><li>LowCohesion - refers to dato more than self &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line528'><pre>  <span class="keyword">def </span><span class="method">hide_all_submitted_datos</span>
</pre></a></td></tr><tr><td valign='top'><small>529</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line529'><pre>    <span class="ident">all_submitted_datos</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">dato</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>530</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line530'><pre>      <span class="ident">dato</span><span class="punct">.</span><span class="ident">vetted</span> <span class="punct">=</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">untrusted</span>
</pre></a></td></tr><tr><td valign='top'><small>531</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line531'><pre>      <span class="ident">dato</span><span class="punct">.</span><span class="ident">visibility</span> <span class="punct">=</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">invisible</span>
</pre></a></td></tr><tr><td valign='top'><small>532</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line532'><pre>      <span class="ident">dato</span><span class="punct">.</span><span class="ident">save!</span>
</pre></a></td></tr><tr><td valign='top'><small>533</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line533'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>534</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line534'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>535</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line535'><pre>
</pre></a></td></tr><tr><td valign='top'><small>536</small></td><td valign='top'><ul><li>Duplication - calls self[:default_hierarchy_id] twice &raquo; reek</li><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line536'><pre>  <span class="keyword">def </span><span class="method">default_hierarchy_valid?</span>
</pre></a></td></tr><tr><td valign='top'><small>537</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line537'><pre>    <span class="keyword">return</span><span class="punct">(</span><span class="constant">self</span><span class="punct">[</span><span class="symbol">:default_hierarchy_id</span><span class="punct">]</span> <span class="keyword">and</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">exists?</span><span class="punct">(</span><span class="constant">self</span><span class="punct">[</span><span class="symbol">:default_hierarchy_id</span><span class="punct">]))</span>
</pre></a></td></tr><tr><td valign='top'><small>538</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line538'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>539</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line539'><pre>
</pre></a></td></tr><tr><td valign='top'><small>540</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line540'><pre>  <span class="comment"># These create and unset the fields required for remembering users between browser closes</span>
</pre></a></td></tr><tr><td valign='top'><small>541</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line541'><pre>  <span class="keyword">def </span><span class="method">remember_me</span>
</pre></a></td></tr><tr><td valign='top'><small>542</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line542'><pre>    <span class="ident">remember_me_for</span> <span class="number">2</span><span class="punct">.</span><span class="ident">weeks</span>
</pre></a></td></tr><tr><td valign='top'><small>543</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line543'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>544</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line544'><pre>
</pre></a></td></tr><tr><td valign='top'><small>545</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line545'><pre>  <span class="keyword">def </span><span class="method">remember_me_for</span><span class="punct">(</span><span class="ident">time</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>546</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line546'><pre>    <span class="ident">remember_me_until</span> <span class="ident">time</span><span class="punct">.</span><span class="ident">from_now</span><span class="punct">.</span><span class="ident">utc</span>
</pre></a></td></tr><tr><td valign='top'><small>547</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line547'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>548</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line548'><pre>
</pre></a></td></tr><tr><td valign='top'><small>549</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line549'><pre>  <span class="keyword">def </span><span class="method">remember_me_until</span><span class="punct">(</span><span class="ident">time</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>550</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line550'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">remember_token_expires_at</span> <span class="punct">=</span> <span class="ident">time</span>
</pre></a></td></tr><tr><td valign='top'><small>551</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line551'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">remember_token</span> <span class="punct">=</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">hash_password</span><span class="punct">(&quot;</span><span class="string"><span class="expr">#{email}</span>--<span class="expr">#{remember_token_expires_at}</span></span><span class="punct">&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>552</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line552'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">save</span><span class="punct">(</span><span class="constant">false</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>553</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line553'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>554</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line554'><pre>
</pre></a></td></tr><tr><td valign='top'><small>555</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line555'><pre>  <span class="keyword">def </span><span class="method">forget_me</span>
</pre></a></td></tr><tr><td valign='top'><small>556</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line556'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">remember_token_expires_at</span> <span class="punct">=</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>557</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line557'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">remember_token</span>            <span class="punct">=</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>558</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line558'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">save</span><span class="punct">(</span><span class="constant">false</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>559</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line559'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>560</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line560'><pre>
</pre></a></td></tr><tr><td valign='top'><small>561</small></td><td valign='top'><ul><li>Duplication - calls default_hierarchy_id twice &raquo; reek</li><li>Duplication - calls default_hierarchy_id.to_s twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line561'><pre>  <span class="keyword">def </span><span class="method">content_page_cache_str</span>
</pre></a></td></tr><tr><td valign='top'><small>562</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line562'><pre>    <span class="ident">str</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{language_abbr}</span></span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>563</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line563'><pre>    <span class="ident">str</span> <span class="punct">+=</span> <span class="punct">&quot;</span><span class="string">_<span class="expr">#{default_hierarchy_id.to_s}</span></span><span class="punct">&quot;</span> <span class="keyword">unless</span> <span class="ident">default_hierarchy_id</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>564</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line564'><pre>    <span class="ident">str</span>
</pre></a></td></tr><tr><td valign='top'><small>565</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line565'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>566</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line566'><pre>
</pre></a></td></tr><tr><td valign='top'><small>567</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line567'><pre>  <span class="keyword">def </span><span class="method">taxa_page_cache_str</span>
</pre></a></td></tr><tr><td valign='top'><small>568</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line568'><pre>    <span class="keyword">return</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{language_abbr}</span>_<span class="expr">#{expertise}</span>_<span class="expr">#{vetted}</span>_<span class="expr">#{default_taxonomic_browser}</span>_<span class="expr">#{default_hierarchy_id}</span></span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>569</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line569'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>570</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line570'><pre>
</pre></a></td></tr><tr><td valign='top'><small>571</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line571'><pre>  <span class="comment"># This is a method that checks if the user model pulled from a session is actually up-to-date:</span>
</pre></a></td></tr><tr><td valign='top'><small>572</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line572'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>573</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line573'><pre>  <span class="comment"># YOU SHOULD ADD NEW USER ATTRIBUTES TO THIS METHOD WHEN YOU TWEAK THE USER TABLE.</span>
</pre></a></td></tr><tr><td valign='top'><small>574</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line574'><pre>  <span class="keyword">def </span><span class="method">stale?</span>
</pre></a></td></tr><tr><td valign='top'><small>575</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line575'><pre>    <span class="comment"># if you add to this, use 'and'; KEEP ALL OLD METHOD CHECKS.</span>
</pre></a></td></tr><tr><td valign='top'><small>576</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line576'><pre>    <span class="keyword">return</span> <span class="constant">true</span> <span class="keyword">unless</span> <span class="ident">attributes</span><span class="punct">.</span><span class="ident">keys</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(&quot;</span><span class="string">filter_content_by_hierarchy</span><span class="punct">&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>577</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line577'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>578</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line578'><pre>
</pre></a></td></tr><tr><td valign='top'><small>579</small></td><td valign='top'><ul><li>LongMethod - has approx 8 statements &raquo; reek</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line579'><pre>  <span class="keyword">def </span><span class="method">password_reset_url</span><span class="punct">(</span><span class="ident">original_port</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>580</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line580'><pre>    <span class="ident">port</span> <span class="punct">=</span> <span class="punct">[&quot;</span><span class="string">80</span><span class="punct">&quot;,</span> <span class="punct">&quot;</span><span class="string">443</span><span class="punct">&quot;].</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">original_port</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">)</span> <span class="punct">?</span> <span class="punct">&quot;</span><span class="string"></span><span class="punct">&quot;</span> <span class="punct">:</span> <span class="punct">&quot;</span><span class="string">:<span class="expr">#{original_port}</span></span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>581</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line581'><pre>    <span class="ident">new_token</span> <span class="punct">=</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">generate_key</span>
</pre></a></td></tr><tr><td valign='top'><small>582</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line582'><pre>    <span class="ident">success</span> <span class="punct">=</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">update_attributes</span><span class="punct">(</span><span class="symbol">:password_reset_token</span> <span class="punct">=&gt;</span> <span class="ident">new_token</span><span class="punct">,</span> <span class="symbol">:password_reset_token_expires_at</span> <span class="punct">=&gt;</span> <span class="number">24</span><span class="punct">.</span><span class="ident">hours</span><span class="punct">.</span><span class="ident">from_now</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>583</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line583'><pre>    <span class="ident">http_string</span> <span class="punct">=</span> <span class="global">$USE_SSL_FOR_LOGIN</span> <span class="punct">?</span> <span class="punct">&quot;</span><span class="string">https</span><span class="punct">&quot;</span> <span class="punct">:</span> <span class="punct">&quot;</span><span class="string">http</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>584</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line584'><pre>    <span class="keyword">if</span> <span class="ident">success</span>
</pre></a></td></tr><tr><td valign='top'><small>585</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line585'><pre>      <span class="keyword">return</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{http_string}</span>://<span class="expr">#{$SITE_DOMAIN_OR_IP}#{port}</span>/account/reset_password/<span class="expr">#{new_token}</span></span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>586</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line586'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>587</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line587'><pre>      <span class="keyword">raise</span> <span class="constant">RuntimeError</span><span class="punct">(&quot;</span><span class="string">Cannot save reset password data to the database</span><span class="punct">&quot;)</span> <span class="comment">#TODO write it correctly</span>
</pre></a></td></tr><tr><td valign='top'><small>588</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line588'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>589</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line589'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>590</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line590'><pre>
</pre></a></td></tr><tr><td valign='top'><small>591</small></td><td valign='top'><ul><li>Duplication - calls username twice &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line591'><pre>  <span class="keyword">def </span><span class="method">ensure_unique_username_against_master</span>
</pre></a></td></tr><tr><td valign='top'><small>592</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line592'><pre>    <span class="comment"># NOTE - this weird id.blank? line was introduced because the :on =&gt; :create clause on the validation was not working.</span>
</pre></a></td></tr><tr><td valign='top'><small>593</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line593'><pre>    <span class="comment"># Very frustrating.  So, essentially, we make sure this user is newly created before proceeding.</span>
</pre></a></td></tr><tr><td valign='top'><small>594</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line594'><pre>    <span class="keyword">if</span> <span class="ident">id</span><span class="punct">.</span><span class="ident">blank?</span> <span class="comment"># We don't care if the username is unique if the user is already in the system...</span>
</pre></a></td></tr><tr><td valign='top'><small>595</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line595'><pre>      <span class="ident">errors</span><span class="punct">.</span><span class="ident">add</span><span class="punct">('</span><span class="string">username</span><span class="punct">',</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{username}</span> is already taken</span><span class="punct">&quot;)</span> <span class="keyword">unless</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">unique_user?</span><span class="punct">(</span><span class="ident">username</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>596</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line596'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>597</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line597'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>598</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line598'><pre>
</pre></a></td></tr><tr><td valign='top'><small>599</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line599'><pre>  <span class="keyword">def </span><span class="method">rating_for_object_guid</span><span class="punct">(</span><span class="ident">guid</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>600</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line600'><pre>    <span class="constant">UsersDataObjectsRating</span><span class="punct">.</span><span class="ident">find_by_data_object_guid_and_user_id</span><span class="punct">(</span><span class="ident">guid</span><span class="punct">,</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>601</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line601'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>602</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line602'><pre>
</pre></a></td></tr><tr><td valign='top'><small>603</small></td><td valign='top'><ul><li>Duplication - calls options[:content_partner_id] twice &raquo; reek</li><li>Duplication - calls options[:page] twice &raquo; reek</li><li>Duplication - calls options[:per_page] twice &raquo; reek</li><li>Duplication - calls options[:vetted_id] twice &raquo; reek</li><li>LongMethod - has approx 29 statements &raquo; reek</li><li>UncommunicativeName - has the variable name 'd' &raquo; reek</li><li>UncommunicativeName - has the variable name 'r' &raquo; reek</li><li>LowCohesion - refers to options more than self &raquo; reek</li><li>Method name "images_to_curate" cyclomatic complexity is 12.  It should be 8 or less. &raquo; roodi</li><li>Method "images_to_curate" has 50 lines.  It should have 20 or less. &raquo; roodi</li><li>Complexity 15 &raquo; saikuro</li></ul></td><td valign='top'><a name='line603'><pre>  <span class="keyword">def </span><span class="method">images_to_curate</span><span class="punct">(</span><span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>604</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line604'><pre>    <span class="ident">page</span> <span class="punct">=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:page</span><span class="punct">].</span><span class="ident">blank?</span> <span class="punct">?</span> <span class="number">1</span> <span class="punct">:</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:page</span><span class="punct">].</span><span class="ident">to_i</span>
</pre></a></td></tr><tr><td valign='top'><small>605</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line605'><pre>    <span class="ident">per_page</span> <span class="punct">=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:per_page</span><span class="punct">].</span><span class="ident">blank?</span> <span class="punct">?</span> <span class="number">30</span> <span class="punct">:</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:per_page</span><span class="punct">].</span><span class="ident">to_i</span>
</pre></a></td></tr><tr><td valign='top'><small>606</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line606'><pre>    <span class="ident">hierarchy_entry_id</span> <span class="punct">=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:hierarchy_entry_id</span><span class="punct">]</span> <span class="punct">||</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">default</span><span class="punct">.</span><span class="ident">kingdoms</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>607</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line607'><pre>    <span class="ident">hierarchy_entry</span> <span class="punct">=</span> <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">hierarchy_entry_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>608</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line608'><pre>    <span class="ident">vetted_id</span> <span class="punct">=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted_id</span><span class="punct">].</span><span class="ident">nil?</span> <span class="punct">?</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">unknown</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">:</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted_id</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>609</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line609'><pre>    <span class="ident">vetted_clause</span> <span class="punct">=</span> <span class="ident">vetted_id</span><span class="punct">.</span><span class="ident">nil?</span> <span class="punct">?</span> <span class="punct">&quot;</span><span class="string"></span><span class="punct">&quot;</span> <span class="punct">:</span> <span class="punct">&quot;</span><span class="string"> AND vetted_id:<span class="expr">#{vetted_id}</span></span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>610</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line610'><pre>    <span class="ident">vetted_clause</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string"></span><span class="punct">&quot;</span> <span class="keyword">if</span> <span class="punct">(</span><span class="ident">vetted_id</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">all</span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>611</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line611'><pre>
</pre></a></td></tr><tr><td valign='top'><small>612</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line612'><pre>    <span class="ident">solr_query</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">ancestor_id:<span class="expr">#{hierarchy_entry.taxon_concept_id}</span> AND published:1 AND data_type_id:<span class="expr">#{DataType.image.id}</span> AND visibility_id:<span class="expr">#{Visibility.visible.id}#{vetted_clause}</span></span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>613</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line613'><pre>
</pre></a></td></tr><tr><td valign='top'><small>614</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line614'><pre>    <span class="keyword">unless</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:content_partner_id</span><span class="punct">].</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>615</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line615'><pre>      <span class="ident">content_partner</span> <span class="punct">=</span> <span class="constant">ContentPartner</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:content_partner_id</span><span class="punct">].</span><span class="ident">to_i</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>616</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line616'><pre>      <span class="ident">resource_clause</span> <span class="punct">=</span> <span class="ident">content_partner</span><span class="punct">.</span><span class="ident">resources</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{|</span><span class="ident">r</span><span class="punct">|</span> <span class="ident">r</span><span class="punct">.</span><span class="ident">id</span><span class="punct">}.</span><span class="ident">join</span><span class="punct">(&quot;</span><span class="string"> OR resource_id:</span><span class="punct">&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>617</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line617'><pre>      <span class="keyword">if</span> <span class="ident">resource_clause</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>618</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line618'><pre>        <span class="ident">solr_query</span> <span class="punct">&lt;&lt;</span> <span class="punct">&quot;</span><span class="string"> AND resource_id:0</span><span class="punct">&quot;</span>  <span class="comment"># This will return nothing, when the content partner has no resources</span>
</pre></a></td></tr><tr><td valign='top'><small>619</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line619'><pre>      <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>620</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line620'><pre>        <span class="ident">solr_query</span> <span class="punct">&lt;&lt;</span> <span class="punct">&quot;</span><span class="string"> AND (resource_id:<span class="expr">#{resource_clause}</span>)</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>621</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line621'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>622</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line622'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>623</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line623'><pre>
</pre></a></td></tr><tr><td valign='top'><small>624</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line624'><pre>    <span class="ident">data_object_ids</span> <span class="punct">=</span> <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Solr</span><span class="punct">::</span><span class="constant">SolrSearchDataObjects</span><span class="punct">.</span><span class="ident">images_for_concept</span><span class="punct">(</span><span class="ident">solr_query</span><span class="punct">,</span> <span class="symbol">:fields</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">data_object_id</span><span class="punct">',</span> <span class="symbol">:rows</span> <span class="punct">=&gt;</span> <span class="number">1500</span><span class="punct">,</span> <span class="symbol">:sort</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">created_at desc</span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>625</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line625'><pre>
</pre></a></td></tr><tr><td valign='top'><small>626</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line626'><pre>    <span class="keyword">return</span> <span class="punct">[]</span> <span class="keyword">if</span> <span class="ident">data_object_ids</span><span class="punct">.</span><span class="ident">empty?</span>
</pre></a></td></tr><tr><td valign='top'><small>627</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line627'><pre>
</pre></a></td></tr><tr><td valign='top'><small>628</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line628'><pre>    <span class="ident">start</span> <span class="punct">=</span> <span class="ident">per_page</span> <span class="punct">*</span> <span class="punct">(</span><span class="ident">page</span> <span class="punct">-</span> <span class="number">1</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>629</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line629'><pre>    <span class="ident">last</span> <span class="punct">=</span> <span class="ident">start</span> <span class="punct">+</span> <span class="ident">per_page</span> <span class="punct">-</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>630</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line630'><pre>    <span class="ident">data_object_ids_to_lookup</span> <span class="punct">=</span> <span class="ident">data_object_ids</span><span class="punct">[</span><span class="ident">start</span><span class="punct">..</span><span class="ident">last</span><span class="punct">].</span><span class="ident">clone</span>
</pre></a></td></tr><tr><td valign='top'><small>631</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line631'><pre>    <span class="ident">data_object_ids_to_lookup</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">latest_published_version_ids_of_do_ids</span><span class="punct">(</span><span class="ident">data_object_ids_to_lookup</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>632</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line632'><pre>
</pre></a></td></tr><tr><td valign='top'><small>633</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line633'><pre>    <span class="ident">add_include</span> <span class="punct">=</span> <span class="punct">[</span>
</pre></a></td></tr><tr><td valign='top'><small>634</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line634'><pre>      <span class="symbol">:all_comments</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>635</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line635'><pre>      <span class="punct">{</span> <span class="symbol">:users_data_objects</span> <span class="punct">=&gt;</span> <span class="symbol">:user</span> <span class="punct">},</span>
</pre></a></td></tr><tr><td valign='top'><small>636</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line636'><pre>      <span class="symbol">:users_data_objects_ratings</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>637</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line637'><pre>      <span class="punct">{</span> <span class="symbol">:taxon_concepts</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:preferred_common_names</span> <span class="punct">=&gt;</span> <span class="symbol">:name</span> <span class="punct">}</span> <span class="punct">}</span> <span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>638</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line638'><pre>    <span class="ident">add_select</span> <span class="punct">=</span> <span class="punct">{</span>
</pre></a></td></tr><tr><td valign='top'><small>639</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line639'><pre>      <span class="symbol">:users</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>640</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line640'><pre>      <span class="symbol">:names</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:string</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>641</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line641'><pre>      <span class="symbol">:taxon_concept_names</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:language_id</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>642</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line642'><pre>      <span class="symbol">:comments</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:parent_id</span><span class="punct">,</span> <span class="symbol">:visible_at</span><span class="punct">,</span> <span class="symbol">:user_id</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>643</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line643'><pre>      <span class="symbol">:users_data_objects_ratings</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:user_id</span><span class="punct">,</span> <span class="symbol">:rating</span> <span class="punct">]</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>644</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line644'><pre>    <span class="ident">core_data</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">core_relationships</span><span class="punct">(</span><span class="symbol">:add_include</span> <span class="punct">=&gt;</span> <span class="ident">add_include</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>645</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line645'><pre>      <span class="symbol">:add_select</span> <span class="punct">=&gt;</span> <span class="ident">add_select</span><span class="punct">).</span><span class="ident">find_all_by_id</span><span class="punct">(</span><span class="ident">data_object_ids_to_lookup</span><span class="punct">).</span><span class="ident">sort_by</span><span class="punct">{|</span><span class="ident">d</span><span class="punct">|</span> <span class="constant">Invert</span><span class="punct">(</span><span class="ident">d</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)}</span>
</pre></a></td></tr><tr><td valign='top'><small>646</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line646'><pre>    <span class="ident">core_data</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">data_object</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>647</small></td><td valign='top'><ul><li>Found = in conditional.  It should probably be an == &raquo; roodi</li></ul></td><td valign='top'><a name='line647'><pre>      <span class="keyword">if</span> <span class="ident">index</span> <span class="punct">=</span> <span class="ident">data_object_ids</span><span class="punct">.</span><span class="ident">index</span><span class="punct">(</span><span class="ident">data_object</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>648</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line648'><pre>        <span class="ident">data_object_ids</span><span class="punct">[</span><span class="ident">index</span><span class="punct">]</span> <span class="punct">=</span> <span class="ident">data_object</span>
</pre></a></td></tr><tr><td valign='top'><small>649</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line649'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>650</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line650'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>651</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line651'><pre>    <span class="ident">data_object_ids</span><span class="punct">.</span><span class="ident">collect!</span><span class="punct">{|</span><span class="ident">do_or_id</span><span class="punct">|</span> <span class="punct">(</span><span class="ident">do_or_id</span><span class="punct">.</span><span class="keyword">class </span><span class="class">==</span> <span class="ident">DataObject</span><span class="punct">)</span> <span class="punct">?</span> <span class="ident">do_or_id</span> <span class="punct">:</span> <span class="constant">nil</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>652</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line652'><pre>
</pre></a></td></tr><tr><td valign='top'><small>653</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line653'><pre>    <span class="keyword">return</span> <span class="ident">data_object_ids</span>
</pre></a></td></tr><tr><td valign='top'><small>654</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line654'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>655</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line655'><pre>
</pre></a></td></tr><tr><td valign='top'><small>656</small></td><td valign='top'><ul><li>LongMethod - has approx 13 statements &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line656'><pre>  <span class="keyword">def </span><span class="method">uservoice_token</span>
</pre></a></td></tr><tr><td valign='top'><small>657</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line657'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="global">$USERVOICE_ACCOUNT_KEY</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>658</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line658'><pre>    <span class="ident">user_hash</span> <span class="punct">=</span> <span class="constant">Hash</span><span class="punct">.</span><span class="ident">new</span>
</pre></a></td></tr><tr><td valign='top'><small>659</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line659'><pre>    <span class="ident">user_hash</span><span class="punct">[</span><span class="symbol">:guid</span><span class="punct">]</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">eol_<span class="expr">#{self.id}</span></span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>660</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line660'><pre>    <span class="ident">user_hash</span><span class="punct">[</span><span class="symbol">:expires</span><span class="punct">]</span> <span class="punct">=</span> <span class="constant">Time</span><span class="punct">.</span><span class="ident">now</span> <span class="punct">+</span> <span class="number">5</span><span class="punct">.</span><span class="ident">hours</span>
</pre></a></td></tr><tr><td valign='top'><small>661</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line661'><pre>    <span class="ident">user_hash</span><span class="punct">[</span><span class="symbol">:email</span><span class="punct">]</span> <span class="punct">=</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">email</span>
</pre></a></td></tr><tr><td valign='top'><small>662</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line662'><pre>    <span class="ident">user_hash</span><span class="punct">[</span><span class="symbol">:display_name</span><span class="punct">]</span> <span class="punct">=</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">full_name</span>
</pre></a></td></tr><tr><td valign='top'><small>663</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line663'><pre>    <span class="ident">user_hash</span><span class="punct">[</span><span class="symbol">:locale</span><span class="punct">]</span> <span class="punct">=</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">language</span><span class="punct">.</span><span class="ident">iso_639_1</span>
</pre></a></td></tr><tr><td valign='top'><small>664</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line664'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">is_admin?</span> <span class="punct">?</span> <span class="ident">user_hash</span><span class="punct">[</span><span class="symbol">:admin</span><span class="punct">]='</span><span class="string">accept</span><span class="punct">'</span> <span class="punct">:</span> <span class="ident">user_hash</span><span class="punct">[</span><span class="symbol">:admin</span><span class="punct">]='</span><span class="string">deny</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>665</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line665'><pre>    <span class="ident">json_token</span> <span class="punct">=</span> <span class="ident">user_hash</span><span class="punct">.</span><span class="ident">to_json</span>
</pre></a></td></tr><tr><td valign='top'><small>666</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line666'><pre>
</pre></a></td></tr><tr><td valign='top'><small>667</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line667'><pre>    <span class="ident">key</span> <span class="punct">=</span> <span class="constant">EzCrypto</span><span class="punct">::</span><span class="constant">Key</span><span class="punct">.</span><span class="ident">with_password</span> <span class="global">$USERVOICE_ACCOUNT_KEY</span><span class="punct">,</span> <span class="global">$USERVOICE_API_KEY</span>
</pre></a></td></tr><tr><td valign='top'><small>668</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line668'><pre>    <span class="ident">encrypted</span> <span class="punct">=</span> <span class="ident">key</span><span class="punct">.</span><span class="ident">encrypt</span><span class="punct">(</span><span class="ident">json_token</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>669</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line669'><pre>    <span class="ident">token</span> <span class="punct">=</span> <span class="constant">CGI</span><span class="punct">.</span><span class="ident">escape</span><span class="punct">(</span><span class="constant">Base64</span><span class="punct">.</span><span class="ident">encode64</span><span class="punct">(</span><span class="ident">encrypted</span><span class="punct">)).</span><span class="ident">gsub</span><span class="punct">(/</span><span class="regex"><span class="escape">\n</span></span><span class="punct">/,</span> <span class="punct">'</span><span class="string"></span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>670</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line670'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>671</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line671'><pre>
</pre></a></td></tr><tr><td valign='top'><small>672</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line672'><pre>  <span class="comment"># This is *very* generalized and tracks nearly everything:</span>
</pre></a></td></tr><tr><td valign='top'><small>673</small></td><td valign='top'><ul><li>Duplication - calls self.id twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line673'><pre>  <span class="keyword">def </span><span class="method">log_activity</span><span class="punct">(</span><span class="ident">what</span><span class="punct">,</span> <span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>674</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line674'><pre>    <span class="constant">ActivityLog</span><span class="punct">.</span><span class="ident">log</span><span class="punct">(</span><span class="ident">what</span><span class="punct">,</span> <span class="ident">options</span><span class="punct">.</span><span class="ident">merge</span><span class="punct">(</span><span class="symbol">:user</span> <span class="punct">=&gt;</span> <span class="constant">self</span><span class="punct">))</span> <span class="keyword">if</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">&amp;&amp;</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">!=</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>675</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line675'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>676</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line676'><pre>
</pre></a></td></tr><tr><td valign='top'><small>677</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line677'><pre>  <span class="comment"># This is at the object level (and is specific to curators)</span>
</pre></a></td></tr><tr><td valign='top'><small>678</small></td><td valign='top'><ul><li>Duplication - calls Time.now twice &raquo; reek</li><li>Duplication - calls options[:comment] twice &raquo; reek</li><li>LongParameterList - has 4 parameters &raquo; reek</li><li>LongMethod - has approx 9 statements &raquo; reek</li><li>LowCohesion - refers to options more than self &raquo; reek</li><li>Method "track_curator_activity" has 21 lines.  It should have 20 or less. &raquo; roodi</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line678'><pre>  <span class="keyword">def </span><span class="method">track_curator_activity</span><span class="punct">(</span><span class="ident">object</span><span class="punct">,</span> <span class="ident">changeable_object_type</span><span class="punct">,</span> <span class="ident">action</span><span class="punct">,</span> <span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>679</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line679'><pre>    <span class="ident">comment_id</span> <span class="punct">=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:comment</span><span class="punct">]</span> <span class="punct">?</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:comment</span><span class="punct">].</span><span class="ident">id</span> <span class="punct">:</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>680</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line680'><pre>    <span class="ident">untrust_reasons</span> <span class="punct">=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:untrust_reasons</span><span class="punct">]</span> <span class="punct">||</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>681</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line681'><pre>    <span class="ident">taxon_concept_id</span> <span class="punct">=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:taxon_concept_id</span><span class="punct">]</span> <span class="punct">||</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>682</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line682'><pre>    <span class="ident">activity_id</span>     <span class="punct">=</span> <span class="constant">Activity</span><span class="punct">.</span><span class="ident">send</span><span class="punct">(</span><span class="ident">action</span><span class="punct">.</span><span class="ident">to_sym</span><span class="punct">).</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>683</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line683'><pre>    <span class="ident">changeable_object_type_id</span> <span class="punct">=</span> <span class="constant">ChangeableObjectType</span><span class="punct">.</span><span class="ident">find_by_ch_object_type</span><span class="punct">(</span><span class="ident">changeable_object_type</span><span class="punct">).</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>684</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line684'><pre>    <span class="ident">curator_activity_log</span> <span class="punct">=</span> <span class="constant">CuratorActivityLog</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span>
</pre></a></td></tr><tr><td valign='top'><small>685</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line685'><pre>      <span class="symbol">:user_id</span>                   <span class="punct">=&gt;</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>686</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line686'><pre>      <span class="symbol">:object_id</span>                 <span class="punct">=&gt;</span> <span class="ident">object</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>687</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line687'><pre>      <span class="symbol">:changeable_object_type_id</span> <span class="punct">=&gt;</span> <span class="ident">changeable_object_type_id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>688</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line688'><pre>      <span class="symbol">:activity_id</span>               <span class="punct">=&gt;</span> <span class="ident">activity_id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>689</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line689'><pre>      <span class="symbol">:comment_id</span>                <span class="punct">=&gt;</span> <span class="ident">comment_id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>690</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line690'><pre>      <span class="symbol">:taxon_concept_id</span>          <span class="punct">=&gt;</span> <span class="ident">taxon_concept_id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>691</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line691'><pre>      <span class="symbol">:created_at</span>                <span class="punct">=&gt;</span> <span class="constant">Time</span><span class="punct">.</span><span class="ident">now</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>692</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line692'><pre>      <span class="symbol">:updated_at</span>                <span class="punct">=&gt;</span> <span class="constant">Time</span><span class="punct">.</span><span class="ident">now</span>
</pre></a></td></tr><tr><td valign='top'><small>693</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line693'><pre>    <span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>694</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line694'><pre>    <span class="ident">curator_activity_log</span><span class="punct">.</span><span class="ident">save!</span>
</pre></a></td></tr><tr><td valign='top'><small>695</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line695'><pre>    <span class="keyword">if</span> <span class="ident">untrust_reasons</span>
</pre></a></td></tr><tr><td valign='top'><small>696</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line696'><pre>      <span class="ident">untrust_reasons</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">ur</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>697</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line697'><pre>        <span class="ident">curator_activity_log</span><span class="punct">.</span><span class="ident">untrust_reasons</span> <span class="punct">&lt;&lt;</span> <span class="ident">ur</span>
</pre></a></td></tr><tr><td valign='top'><small>698</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line698'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>699</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line699'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>700</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line700'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>701</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line701'><pre>
</pre></a></td></tr><tr><td valign='top'><small>702</small></td><td valign='top'><ul><li>Duplication - calls community.id twice &raquo; reek</li><li>Duplication - calls id twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line702'><pre>  <span class="keyword">def </span><span class="method">join_community</span><span class="punct">(</span><span class="ident">community</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>703</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line703'><pre>    <span class="ident">member</span> <span class="punct">=</span> <span class="constant">Member</span><span class="punct">.</span><span class="ident">find_by_community_id_and_user_id</span><span class="punct">(</span><span class="ident">community</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>704</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line704'><pre>    <span class="keyword">unless</span> <span class="ident">member</span>
</pre></a></td></tr><tr><td valign='top'><small>705</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line705'><pre>      <span class="ident">member</span> <span class="punct">=</span> <span class="constant">Member</span><span class="punct">.</span><span class="ident">create!</span><span class="punct">(</span><span class="symbol">:user_id</span> <span class="punct">=&gt;</span> <span class="ident">id</span><span class="punct">,</span> <span class="symbol">:community_id</span> <span class="punct">=&gt;</span> <span class="ident">community</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>706</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line706'><pre>      <span class="constant">self</span><span class="punct">.</span><span class="ident">members</span> <span class="punct">&lt;&lt;</span> <span class="ident">member</span>
</pre></a></td></tr><tr><td valign='top'><small>707</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line707'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>708</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line708'><pre>    <span class="ident">member</span>
</pre></a></td></tr><tr><td valign='top'><small>709</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line709'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>710</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line710'><pre>
</pre></a></td></tr><tr><td valign='top'><small>711</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line711'><pre>  <span class="keyword">def </span><span class="method">leave_community</span><span class="punct">(</span><span class="ident">community</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>712</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line712'><pre>    <span class="ident">member</span> <span class="punct">=</span> <span class="constant">Member</span><span class="punct">.</span><span class="ident">find_by_user_id_and_community_id</span><span class="punct">(</span><span class="ident">id</span><span class="punct">,</span> <span class="ident">community</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>713</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line713'><pre>    <span class="keyword">raise</span>  <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(</span><span class="symbol">:could_not_find_user</span><span class="punct">)</span>  <span class="keyword">unless</span> <span class="ident">member</span>
</pre></a></td></tr><tr><td valign='top'><small>714</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line714'><pre>    <span class="ident">member</span><span class="punct">.</span><span class="ident">destroy</span>
</pre></a></td></tr><tr><td valign='top'><small>715</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line715'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">reload</span>
</pre></a></td></tr><tr><td valign='top'><small>716</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line716'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>717</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line717'><pre>
</pre></a></td></tr><tr><td valign='top'><small>718</small></td><td valign='top'><ul><li>UncommunicativeName - has the variable name 'm' &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line718'><pre>  <span class="keyword">def </span><span class="method">member_of?</span><span class="punct">(</span><span class="ident">community</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>719</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line719'><pre>    <span class="ident">reload_if_stale</span>
</pre></a></td></tr><tr><td valign='top'><small>720</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line720'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">members</span><span class="punct">.</span><span class="ident">map</span> <span class="punct">{|</span><span class="ident">m</span><span class="punct">|</span> <span class="ident">m</span><span class="punct">.</span><span class="ident">community_id</span><span class="punct">}.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">community</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>721</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line721'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>722</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line722'><pre>
</pre></a></td></tr><tr><td valign='top'><small>723</small></td><td valign='top'><ul><li>UncommunicativeName - has the variable name 'm' &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line723'><pre>  <span class="keyword">def </span><span class="method">member_of</span><span class="punct">(</span><span class="ident">community</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>724</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line724'><pre>    <span class="ident">reload_if_stale</span>
</pre></a></td></tr><tr><td valign='top'><small>725</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line725'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">members</span><span class="punct">.</span><span class="ident">select</span> <span class="punct">{|</span><span class="ident">m</span><span class="punct">|</span> <span class="ident">m</span><span class="punct">.</span><span class="ident">community_id</span> <span class="punct">==</span> <span class="ident">community</span><span class="punct">.</span><span class="ident">id</span><span class="punct">}.</span><span class="ident">first</span>
</pre></a></td></tr><tr><td valign='top'><small>726</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line726'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>727</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line727'><pre>
</pre></a></td></tr><tr><td valign='top'><small>728</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line728'><pre>  <span class="comment"># override the logo_url column in the database to contruct the path on the content server</span>
</pre></a></td></tr><tr><td valign='top'><small>729</small></td><td valign='top'><ul><li>Duplication - calls logo_cache_url twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line729'><pre>  <span class="keyword">def </span><span class="method">logo_url</span><span class="punct">(</span><span class="ident">size</span> <span class="punct">=</span> <span class="punct">'</span><span class="string">large</span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>730</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line730'><pre>    <span class="ident">logo_cache_url</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">?</span> <span class="punct">&quot;</span><span class="string">v2/logos/user_default.png</span><span class="punct">&quot;</span> <span class="punct">:</span> <span class="constant">ContentServer</span><span class="punct">.</span><span class="ident">agent_logo_path</span><span class="punct">(</span><span class="ident">logo_cache_url</span><span class="punct">,</span> <span class="ident">size</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>731</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line731'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>732</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line732'><pre>
</pre></a></td></tr><tr><td valign='top'><small>733</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line733'><pre><span class="ident">private</span>
</pre></a></td></tr><tr><td valign='top'><small>734</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line734'><pre>
</pre></a></td></tr><tr><td valign='top'><small>735</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line735'><pre>  <span class="comment"># set the defaults on this user object</span>
</pre></a></td></tr><tr><td valign='top'><small>736</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line736'><pre>  <span class="comment"># TODO - move the defaults to the database (LOW PRIO)</span>
</pre></a></td></tr><tr><td valign='top'><small>737</small></td><td valign='top'><ul><li>LongMethod - has approx 10 statements &raquo; reek</li><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line737'><pre>  <span class="keyword">def </span><span class="method">set_defaults</span>
</pre></a></td></tr><tr><td valign='top'><small>738</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line738'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">default_taxonomic_browser</span> <span class="punct">=</span> <span class="global">$DEFAULT_TAXONOMIC_BROWSER</span>
</pre></a></td></tr><tr><td valign='top'><small>739</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line739'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">expertise</span>     <span class="punct">=</span> <span class="global">$DEFAULT_EXPERTISE</span><span class="punct">.</span><span class="ident">to_s</span>
</pre></a></td></tr><tr><td valign='top'><small>740</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line740'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">language</span>      <span class="punct">=</span> <span class="constant">Language</span><span class="punct">.</span><span class="ident">english</span>
</pre></a></td></tr><tr><td valign='top'><small>741</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line741'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">mailing_list</span>  <span class="punct">=</span> <span class="constant">false</span>
</pre></a></td></tr><tr><td valign='top'><small>742</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line742'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">content_level</span> <span class="punct">=</span> <span class="global">$DEFAULT_CONTENT_LEVEL</span>
</pre></a></td></tr><tr><td valign='top'><small>743</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line743'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">vetted</span>        <span class="punct">=</span> <span class="global">$DEFAULT_VETTED</span>
</pre></a></td></tr><tr><td valign='top'><small>744</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line744'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">credentials</span>   <span class="punct">=</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>745</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line745'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">curator_scope</span> <span class="punct">=</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>746</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line746'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">active</span>        <span class="punct">=</span> <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>747</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line747'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">flash_enabled</span> <span class="punct">=</span> <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>748</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line748'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>749</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line749'><pre>
</pre></a></td></tr><tr><td valign='top'><small>750</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line750'><pre>  <span class="keyword">def </span><span class="method">reload_if_stale</span>
</pre></a></td></tr><tr><td valign='top'><small>751</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line751'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">if</span> <span class="ident">new_record?</span> <span class="keyword">or</span> <span class="ident">changed?</span> <span class="keyword">or</span> <span class="ident">frozen?</span>
</pre></a></td></tr><tr><td valign='top'><small>752</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line752'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">reload</span>
</pre></a></td></tr><tr><td valign='top'><small>753</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line753'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>754</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line754'><pre>
</pre></a></td></tr><tr><td valign='top'><small>755</small></td><td valign='top'><ul><li>Duplication - calls hashed_password twice &raquo; reek</li><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line755'><pre>  <span class="keyword">def </span><span class="method">password_required?</span>
</pre></a></td></tr><tr><td valign='top'><small>756</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line756'><pre>    <span class="punct">(</span><span class="ident">hashed_password</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">||</span> <span class="ident">hashed_password</span><span class="punct">.</span><span class="ident">nil?</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>757</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line757'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>758</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line758'><pre>
</pre></a></td></tr><tr><td valign='top'><small>759</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line759'><pre><span class="keyword">end</span>
</pre></a></td></tr><table></body></html>
