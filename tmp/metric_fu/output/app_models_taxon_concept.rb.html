<html><head><style>table { background: #fff; color: #000; }
.ruby .normal { color: #000; }
.ruby .comment { color: #005; font-style: italic; }
.ruby .keyword { color: #A44; font-weight: bold; }
.ruby .method { color: #44f; }
.ruby .class { color: #b1713d; }
.ruby .module { color: #050; }
.ruby .punct { color: #668; font-weight: bold; }
.ruby .symbol { color: #00f; }
.ruby .string { color: #4a4; }
.ruby .char { color: #F07; }
.ruby .ident { color: #000; }
.ruby .constant { color: #b1713d; }
.ruby .regex { color: #B66; background: #FEF; }
.ruby .number { color: #F99; }
.ruby .attribute { color: #f84; }
.ruby .global { color: #7FB; }
.ruby .expr { color: #227; }
.ruby .escape { color: #277; }</style></head><body><table cellpadding='0' cellspacing='0' class='ruby'><tr><td valign='top'><small>1</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1'><pre><span class="comment"># Represents a group of HierearchyEntry instances that we consider &quot;the same&quot;.  This amounts to a vague idea</span>
</pre></a></td></tr><tr><td valign='top'><small>2</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line2'><pre><span class="comment"># of a taxon, which we serve as a single page.</span>
</pre></a></td></tr><tr><td valign='top'><small>3</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line3'><pre><span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>4</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line4'><pre><span class="comment"># We get different interpretations of taxa from our partners (ContentPartner), often differing slightly</span>
</pre></a></td></tr><tr><td valign='top'><small>5</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line5'><pre><span class="comment"># and referring to basically the same thing, so TaxonConcept was created as a means to reconcile the</span>
</pre></a></td></tr><tr><td valign='top'><small>6</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line6'><pre><span class="comment"># variant definitions of what are essentially the same Taxon. We currently store basic Taxon we receive</span>
</pre></a></td></tr><tr><td valign='top'><small>7</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line7'><pre><span class="comment"># from data imports in the +hierarchy_entries+ table and we also store taxonomic hierarchies (HierarchyEntry) in the</span>
</pre></a></td></tr><tr><td valign='top'><small>8</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line8'><pre><span class="comment"># +hierarchy_entries+ table. Currently TaxonConcept are groups of one or many HierarchyEntry. We will</span>
</pre></a></td></tr><tr><td valign='top'><small>9</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line9'><pre><span class="comment"># eventually create hierarchy_entries for each entry in the taxa table (Taxon).</span>
</pre></a></td></tr><tr><td valign='top'><small>10</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line10'><pre><span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>11</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line11'><pre><span class="comment"># It is worth mentioning that the &quot;eol.org/pages/nnnn&quot; route is a misnomer.  Those IDs are, for the</span>
</pre></a></td></tr><tr><td valign='top'><small>12</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line12'><pre><span class="comment"># time-being, pointing to TaxonConcept, not pages.</span>
</pre></a></td></tr><tr><td valign='top'><small>13</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line13'><pre><span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>14</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line14'><pre><span class="comment"># See the comments at the top of the Taxon for more information on this.</span>
</pre></a></td></tr><tr><td valign='top'><small>15</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line15'><pre><span class="comment"># I include there a basic biological definition of what a Taxon is.</span>
</pre></a></td></tr><tr><td valign='top'><small>16</small></td><td valign='top'><ul><li>Class "TaxonConcept" has 1291 lines.  It should have 300 or less. &raquo; roodi</li></ul></td><td valign='top'><a name='line16'><pre><span class="keyword">class </span><span class="class">TaxonConcept</span> <span class="punct">&lt;</span> <span class="constant">SpeciesSchemaModel</span>
</pre></a></td></tr><tr><td valign='top'><small>17</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line17'><pre>  <span class="ident">extend</span> <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Solr</span><span class="punct">::</span><span class="constant">Search</span>
</pre></a></td></tr><tr><td valign='top'><small>18</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line18'><pre>  <span class="ident">include</span> <span class="constant">ModelQueryHelper</span>
</pre></a></td></tr><tr><td valign='top'><small>19</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line19'><pre>  <span class="ident">include</span> <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Feedable</span>
</pre></a></td></tr><tr><td valign='top'><small>20</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line20'><pre>
</pre></a></td></tr><tr><td valign='top'><small>21</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line21'><pre>  <span class="comment">#TODO belongs_to :taxon_concept_content</span>
</pre></a></td></tr><tr><td valign='top'><small>22</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line22'><pre>  <span class="ident">belongs_to</span> <span class="symbol">:vetted</span>
</pre></a></td></tr><tr><td valign='top'><small>23</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line23'><pre>
</pre></a></td></tr><tr><td valign='top'><small>24</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line24'><pre>  <span class="ident">has_many</span> <span class="symbol">:feed_data_objects</span>
</pre></a></td></tr><tr><td valign='top'><small>25</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line25'><pre>  <span class="ident">has_many</span> <span class="symbol">:hierarchy_entries</span>
</pre></a></td></tr><tr><td valign='top'><small>26</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line26'><pre>  <span class="ident">has_many</span> <span class="symbol">:published_hierarchy_entries</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>27</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line27'><pre>    <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">hierarchy_entries.published=1 AND hierarchy_entries.visibility_id=#{Visibility.visible.id}</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>28</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line28'><pre>  <span class="ident">has_many</span> <span class="symbol">:top_concept_images</span>
</pre></a></td></tr><tr><td valign='top'><small>29</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line29'><pre>  <span class="ident">has_many</span> <span class="symbol">:top_unpublished_concept_images</span>
</pre></a></td></tr><tr><td valign='top'><small>30</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line30'><pre>  <span class="ident">has_many</span> <span class="symbol">:curator_activity_logs</span>
</pre></a></td></tr><tr><td valign='top'><small>31</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line31'><pre>  <span class="ident">has_many</span> <span class="symbol">:taxon_concept_names</span>
</pre></a></td></tr><tr><td valign='top'><small>32</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line32'><pre>  <span class="ident">has_many</span> <span class="symbol">:comments</span><span class="punct">,</span> <span class="symbol">:as</span> <span class="punct">=&gt;</span> <span class="symbol">:parent</span>
</pre></a></td></tr><tr><td valign='top'><small>33</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line33'><pre>  <span class="ident">has_many</span> <span class="symbol">:names</span><span class="punct">,</span> <span class="symbol">:through</span> <span class="punct">=&gt;</span> <span class="symbol">:taxon_concept_names</span>
</pre></a></td></tr><tr><td valign='top'><small>34</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line34'><pre>  <span class="ident">has_many</span> <span class="symbol">:ranks</span><span class="punct">,</span> <span class="symbol">:through</span> <span class="punct">=&gt;</span> <span class="symbol">:hierarchy_entries</span>
</pre></a></td></tr><tr><td valign='top'><small>35</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line35'><pre>  <span class="ident">has_many</span> <span class="symbol">:google_analytics_partner_taxa</span>
</pre></a></td></tr><tr><td valign='top'><small>36</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line36'><pre>  <span class="ident">has_many</span> <span class="symbol">:collection_items</span><span class="punct">,</span> <span class="symbol">:as</span> <span class="punct">=&gt;</span> <span class="symbol">:object</span>
</pre></a></td></tr><tr><td valign='top'><small>37</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line37'><pre>  <span class="ident">has_many</span> <span class="symbol">:preferred_names</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">TaxonConceptName</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">taxon_concept_names.vern=0 AND taxon_concept_names.preferred=1</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>38</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line38'><pre>  <span class="ident">has_many</span> <span class="symbol">:preferred_common_names</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">TaxonConceptName</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">taxon_concept_names.vern=1 AND taxon_concept_names.preferred=1</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>39</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line39'><pre>  <span class="ident">has_many</span> <span class="symbol">:synonyms</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">Synonym</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="symbol">:foreign_key</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">hierarchy_entry_id</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>40</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line40'><pre>    <span class="symbol">:finder_sql</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">SELECT s.* FROM #{Synonym.full_table_name} s JOIN #{HierarchyEntry.full_table_name} he ON (he.id = s.hierarchy_entry_id) WHERE he.taxon_concept_id=<span class="escape">\'</span>#{id}<span class="escape">\'</span> AND s.synonym_relation_id NOT IN (#{SynonymRelation.common_name_ids.join(&quot;,&quot;)})</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>41</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line41'><pre>  <span class="ident">has_many</span> <span class="symbol">:users_data_objects</span>
</pre></a></td></tr><tr><td valign='top'><small>42</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line42'><pre>  <span class="ident">has_many</span> <span class="symbol">:flattened_ancestors</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">TaxonConceptsFlattened</span><span class="punct">.</span><span class="ident">to_s</span>
</pre></a></td></tr><tr><td valign='top'><small>43</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line43'><pre>  <span class="ident">has_many</span> <span class="symbol">:all_data_objects</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="symbol">:finder_sql</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"><span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>44</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line44'><pre>      <span class="punct">(</span><span class="constant">SELECT</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">data_type_id</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">vetted_id</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">visibility_id</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">published</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">guid</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">data_rating</span>
</pre></a></td></tr><tr><td valign='top'><small>45</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line45'><pre>        <span class="constant">FROM</span> <span class="ident">data_objects_taxon_concepts</span> <span class="ident">dotc</span>
</pre></a></td></tr><tr><td valign='top'><small>46</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line46'><pre>        <span class="constant">JOIN</span> <span class="ident">data_objects</span> <span class="keyword">do</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">dotc</span><span class="punct">.</span><span class="ident">data_object_id</span><span class="punct">=</span><span class="keyword">do</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>47</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line47'><pre>          <span class="constant">WHERE</span> <span class="ident">dotc</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">=</span><span class="comment">#{id}</span>
</pre></a></td></tr><tr><td valign='top'><small>48</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line48'><pre>          <span class="constant">AND</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">data_type_id</span><span class="punct">=</span><span class="comment">#{DataType.image.id})</span>
</pre></a></td></tr><tr><td valign='top'><small>49</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line49'><pre>      <span class="constant">UNION</span>
</pre></a></td></tr><tr><td valign='top'><small>50</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line50'><pre>      <span class="punct">(</span><span class="constant">SELECT</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">data_type_id</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">vetted_id</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">visibility_id</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">published</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">guid</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">data_rating</span>
</pre></a></td></tr><tr><td valign='top'><small>51</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line51'><pre>        <span class="constant">FROM</span> <span class="ident">top_concept_images</span> <span class="ident">tci</span>
</pre></a></td></tr><tr><td valign='top'><small>52</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line52'><pre>        <span class="constant">JOIN</span> <span class="ident">data_objects</span> <span class="keyword">do</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">tci</span><span class="punct">.</span><span class="ident">data_object_id</span><span class="punct">=</span><span class="keyword">do</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>53</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line53'><pre>          <span class="constant">WHERE</span> <span class="ident">tci</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">=</span><span class="comment">#{id})</span>
</pre></a></td></tr><tr><td valign='top'><small>54</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line54'><pre>      <span class="constant">UNION</span>
</pre></a></td></tr><tr><td valign='top'><small>55</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line55'><pre>      <span class="punct">(</span><span class="constant">SELECT</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">data_type_id</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">vetted_id</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">visibility_id</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">published</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">guid</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">data_rating</span>
</pre></a></td></tr><tr><td valign='top'><small>56</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line56'><pre>        <span class="constant">FROM</span> <span class="comment">#{UsersDataObject.full_table_name} udo</span>
</pre></a></td></tr><tr><td valign='top'><small>57</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line57'><pre>        <span class="constant">JOIN</span> <span class="ident">data_objects</span> <span class="keyword">do</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">udo</span><span class="punct">.</span><span class="ident">data_object_id</span><span class="punct">=</span><span class="keyword">do</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>58</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line58'><pre>          <span class="constant">WHERE</span> <span class="ident">udo</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">=</span><span class="comment">#{id})'</span>
</pre></a></td></tr><tr><td valign='top'><small>59</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line59'><pre>
</pre></a></td></tr><tr><td valign='top'><small>60</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line60'><pre>  <span class="ident">has_one</span> <span class="symbol">:taxon_concept_content</span>
</pre></a></td></tr><tr><td valign='top'><small>61</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line61'><pre>  <span class="ident">has_one</span> <span class="symbol">:taxon_concept_metric</span>
</pre></a></td></tr><tr><td valign='top'><small>62</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line62'><pre>  <span class="ident">has_one</span> <span class="symbol">:taxon_concept_exemplar_image</span>
</pre></a></td></tr><tr><td valign='top'><small>63</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line63'><pre>
</pre></a></td></tr><tr><td valign='top'><small>64</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line64'><pre>  <span class="ident">has_and_belongs_to_many</span> <span class="symbol">:data_objects</span>
</pre></a></td></tr><tr><td valign='top'><small>65</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line65'><pre>
</pre></a></td></tr><tr><td valign='top'><small>66</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line66'><pre>  <span class="ident">has_many</span> <span class="symbol">:superceded_taxon_concepts</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="symbol">:foreign_key</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">supercedure_id</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>67</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line67'><pre>
</pre></a></td></tr><tr><td valign='top'><small>68</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line68'><pre>
</pre></a></td></tr><tr><td valign='top'><small>69</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line69'><pre>  <span class="ident">attr_accessor</span> <span class="symbol">:includes_unvetted</span> <span class="comment"># true or false indicating if this taxon concept has any unvetted/unknown data objects</span>
</pre></a></td></tr><tr><td valign='top'><small>70</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line70'><pre>
</pre></a></td></tr><tr><td valign='top'><small>71</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line71'><pre>  <span class="ident">attr_reader</span> <span class="symbol">:has_media</span><span class="punct">,</span> <span class="symbol">:length_of_images</span><span class="punct">,</span> <span class="symbol">:length_of_videos</span><span class="punct">,</span> <span class="symbol">:length_of_sounds</span>
</pre></a></td></tr><tr><td valign='top'><small>72</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line72'><pre>
</pre></a></td></tr><tr><td valign='top'><small>73</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line73'><pre>  <span class="ident">define_core_relationships</span> <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="punct">{</span>
</pre></a></td></tr><tr><td valign='top'><small>74</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line74'><pre>      <span class="symbol">:taxon_concepts</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>75</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line75'><pre>      <span class="symbol">:hierarchy_entries</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:id</span><span class="punct">,</span> <span class="symbol">:rank_id</span><span class="punct">,</span> <span class="symbol">:identifier</span><span class="punct">,</span> <span class="symbol">:hierarchy_id</span><span class="punct">,</span> <span class="symbol">:parent_id</span><span class="punct">,</span> <span class="symbol">:published</span><span class="punct">,</span> <span class="symbol">:visibility_id</span><span class="punct">,</span> <span class="symbol">:lft</span><span class="punct">,</span> <span class="symbol">:rgt</span><span class="punct">,</span> <span class="symbol">:taxon_concept_id</span><span class="punct">,</span> <span class="symbol">:source_url</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>76</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line76'><pre>      <span class="symbol">:hierarchies</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:agent_id</span><span class="punct">,</span> <span class="symbol">:browsable</span><span class="punct">,</span> <span class="symbol">:outlink_uri</span><span class="punct">,</span> <span class="symbol">:label</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>77</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line77'><pre>      <span class="symbol">:hierarchies_content</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:content_level</span><span class="punct">,</span> <span class="symbol">:image</span><span class="punct">,</span> <span class="symbol">:text</span><span class="punct">,</span> <span class="symbol">:child_image</span><span class="punct">,</span> <span class="symbol">:map</span><span class="punct">,</span> <span class="symbol">:youtube</span><span class="punct">,</span> <span class="symbol">:flash</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>78</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line78'><pre>      <span class="symbol">:names</span> <span class="punct">=&gt;</span> <span class="symbol">:string</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>79</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line79'><pre>      <span class="symbol">:vetted</span> <span class="punct">=&gt;</span> <span class="symbol">:view_order</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>80</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line80'><pre>      <span class="symbol">:canonical_forms</span> <span class="punct">=&gt;</span> <span class="symbol">:string</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>81</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line81'><pre>      <span class="symbol">:data_objects</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:id</span><span class="punct">,</span> <span class="symbol">:data_type_id</span><span class="punct">,</span> <span class="symbol">:vetted_id</span><span class="punct">,</span> <span class="symbol">:visibility_id</span><span class="punct">,</span> <span class="symbol">:published</span><span class="punct">,</span> <span class="symbol">:guid</span><span class="punct">,</span> <span class="symbol">:data_rating</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>82</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line82'><pre>      <span class="symbol">:licenses</span> <span class="punct">=&gt;</span> <span class="symbol">:title</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>83</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line83'><pre>      <span class="symbol">:table_of_contents</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">'</span> <span class="punct">},</span>
</pre></a></td></tr><tr><td valign='top'><small>84</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line84'><pre>    <span class="symbol">:include</span> <span class="punct">=&gt;</span> <span class="punct">[{</span> <span class="symbol">:published_hierarchy_entries</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:name</span> <span class="punct">,</span> <span class="symbol">:hierarchy</span><span class="punct">,</span> <span class="symbol">:hierarchies_content</span><span class="punct">,</span> <span class="symbol">:vetted</span> <span class="punct">]</span> <span class="punct">},</span> <span class="punct">{</span> <span class="symbol">:data_objects</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="punct">{</span> <span class="symbol">:toc_items</span> <span class="punct">=&gt;</span> <span class="symbol">:info_items</span> <span class="punct">},</span> <span class="symbol">:license</span><span class="punct">]</span> <span class="punct">},</span>
</pre></a></td></tr><tr><td valign='top'><small>85</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line85'><pre>      <span class="punct">{</span> <span class="symbol">:users_data_objects</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:data_object</span> <span class="punct">=&gt;</span> <span class="symbol">:toc_items</span> <span class="punct">}</span> <span class="punct">}]</span>
</pre></a></td></tr><tr><td valign='top'><small>86</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line86'><pre>
</pre></a></td></tr><tr><td valign='top'><small>87</small></td><td valign='top'><ul><li>Duplication - calls user.nil? twice &raquo; reek</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line87'><pre>  <span class="keyword">def </span><span class="method">show_curator_controls?</span><span class="punct">(</span><span class="ident">user</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>88</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line88'><pre>    <span class="keyword">return</span> <span class="attribute">@show_curator_controls</span> <span class="keyword">if</span> <span class="punct">!</span><span class="attribute">@show_curator_controls</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>89</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line89'><pre>    <span class="ident">user</span> <span class="punct">=</span> <span class="attribute">@current_user</span> <span class="keyword">if</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>90</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line90'><pre>    <span class="keyword">if</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>91</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line91'><pre>      <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">a user must be specified</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>92</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line92'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>93</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line93'><pre>    <span class="attribute">@show_curator_controls</span> <span class="punct">=</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">can_curate?</span><span class="punct">(</span><span class="constant">self</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>94</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line94'><pre>    <span class="attribute">@show_curator_controls</span>
</pre></a></td></tr><tr><td valign='top'><small>95</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line95'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>96</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line96'><pre>
</pre></a></td></tr><tr><td valign='top'><small>97</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line97'><pre>  <span class="comment"># The common name will defaut to the current user's language.</span>
</pre></a></td></tr><tr><td valign='top'><small>98</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line98'><pre>  <span class="keyword">def </span><span class="method">common_name</span><span class="punct">(</span><span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>99</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line99'><pre>    <span class="ident">quick_common_name</span><span class="punct">(</span><span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>100</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line100'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>101</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line101'><pre>
</pre></a></td></tr><tr><td valign='top'><small>102</small></td><td valign='top'><ul><li>LowCohesion - refers to common_names more than self &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line102'><pre>  <span class="keyword">def </span><span class="method">preferred_common_name_in_language</span><span class="punct">(</span><span class="ident">language</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>103</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line103'><pre>    <span class="ident">common_names</span> <span class="punct">=</span> <span class="ident">preferred_common_names</span><span class="punct">.</span><span class="ident">select</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">preferred_common_name</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>104</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line104'><pre>      <span class="ident">preferred_common_name</span><span class="punct">.</span><span class="ident">language_id</span> <span class="punct">==</span> <span class="ident">language</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>105</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line105'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>106</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line106'><pre>    <span class="keyword">return</span> <span class="ident">common_names</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">name</span><span class="punct">.</span><span class="ident">string</span> <span class="keyword">unless</span> <span class="ident">common_names</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>107</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line107'><pre>    <span class="keyword">return</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>108</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line108'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>109</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line109'><pre>
</pre></a></td></tr><tr><td valign='top'><small>110</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line110'><pre>  <span class="keyword">def </span><span class="method">self.common_names_for_concepts</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">,</span> <span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>111</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line111'><pre>    <span class="ident">quick_common_names</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">,</span> <span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>112</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line112'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>113</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line113'><pre>
</pre></a></td></tr><tr><td valign='top'><small>114</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line114'><pre>  <span class="comment"># TODO - this will now be called on ALL taxon pages.  Eep!  Make this more efficient:</span>
</pre></a></td></tr><tr><td valign='top'><small>115</small></td><td valign='top'><ul><li>Duplication - calls duplicate_check[lang] twice &raquo; reek</li><li>Duplication - calls sorted_names.each_with_index twice &raquo; reek</li><li>Duplication - calls sorted_names[index] = nil twice &raquo; reek</li><li>Duplication - calls tcn.language 4 times &raquo; reek</li><li>Duplication - calls tcn.language.blank? twice &raquo; reek</li><li>Duplication - calls tcn.language.iso_639_1 twice &raquo; reek</li><li>Duplication - calls tcn.name 4 times &raquo; reek</li><li>Duplication - calls tcn.name.string 4 times &raquo; reek</li><li>LongMethod - has approx 17 statements &raquo; reek</li><li>LowCohesion - refers to tcn more than self &raquo; reek</li><li>Method "common_names" has 22 lines.  It should have 20 or less. &raquo; roodi</li><li>Complexity 8 &raquo; saikuro</li></ul></td><td valign='top'><a name='line115'><pre>  <span class="keyword">def </span><span class="method">common_names</span>
</pre></a></td></tr><tr><td valign='top'><small>116</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line116'><pre>    <span class="ident">tcn</span> <span class="punct">=</span> <span class="constant">TaxonConceptName</span><span class="punct">.</span><span class="ident">find_all_by_taxon_concept_id_and_vern</span><span class="punct">(</span><span class="constant">self</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="number">1</span><span class="punct">,</span> <span class="symbol">:include</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:name</span><span class="punct">,</span> <span class="symbol">:language</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>117</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line117'><pre>      <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="punct">{</span><span class="symbol">:taxon_concept_names</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:preferred</span><span class="punct">,</span> <span class="symbol">:vetted_id</span> <span class="punct">],</span> <span class="symbol">:names</span> <span class="punct">=&gt;</span> <span class="symbol">:string</span><span class="punct">,</span> <span class="symbol">:languages</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">'})</span>
</pre></a></td></tr><tr><td valign='top'><small>118</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line118'><pre>    <span class="ident">sorted_names</span> <span class="punct">=</span> <span class="constant">TaxonConceptName</span><span class="punct">.</span><span class="ident">sort_by_language_and_name</span><span class="punct">(</span><span class="ident">tcn</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>119</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line119'><pre>    <span class="ident">duplicate_check</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>120</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line120'><pre>    <span class="ident">name_languages</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>121</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line121'><pre>    <span class="comment"># remove duplicate names in the same language</span>
</pre></a></td></tr><tr><td valign='top'><small>122</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line122'><pre>    <span class="ident">sorted_names</span><span class="punct">.</span><span class="ident">each_with_index</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">tcn</span><span class="punct">,</span> <span class="ident">index</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>123</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line123'><pre>      <span class="ident">lang</span> <span class="punct">=</span> <span class="ident">tcn</span><span class="punct">.</span><span class="ident">language</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">?</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span> <span class="punct">:</span> <span class="ident">tcn</span><span class="punct">.</span><span class="ident">language</span><span class="punct">.</span><span class="ident">iso_639_1</span>
</pre></a></td></tr><tr><td valign='top'><small>124</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line124'><pre>      <span class="ident">duplicate_check</span><span class="punct">[</span><span class="ident">lang</span><span class="punct">]</span> <span class="punct">||=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>125</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line125'><pre>      <span class="ident">sorted_names</span><span class="punct">[</span><span class="ident">index</span><span class="punct">]</span> <span class="punct">=</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">duplicate_check</span><span class="punct">[</span><span class="ident">lang</span><span class="punct">].</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">tcn</span><span class="punct">.</span><span class="ident">name</span><span class="punct">.</span><span class="ident">string</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>126</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line126'><pre>      <span class="ident">duplicate_check</span><span class="punct">[</span><span class="ident">lang</span><span class="punct">]</span> <span class="punct">&lt;&lt;</span> <span class="ident">tcn</span><span class="punct">.</span><span class="ident">name</span><span class="punct">.</span><span class="ident">string</span>
</pre></a></td></tr><tr><td valign='top'><small>127</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line127'><pre>      <span class="ident">name_languages</span><span class="punct">[</span><span class="ident">tcn</span><span class="punct">.</span><span class="ident">name</span><span class="punct">.</span><span class="ident">string</span><span class="punct">]</span> <span class="punct">=</span> <span class="ident">lang</span>
</pre></a></td></tr><tr><td valign='top'><small>128</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line128'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>129</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line129'><pre>
</pre></a></td></tr><tr><td valign='top'><small>130</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line130'><pre>    <span class="comment"># now removing anything without a language if it exists with a language</span>
</pre></a></td></tr><tr><td valign='top'><small>131</small></td><td valign='top'><ul><li>Block cyclomatic complexity is 5.  It should be 4 or less. &raquo; roodi</li></ul></td><td valign='top'><a name='line131'><pre>    <span class="ident">sorted_names</span><span class="punct">.</span><span class="ident">each_with_index</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">tcn</span><span class="punct">,</span> <span class="ident">index</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>132</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line132'><pre>      <span class="keyword">next</span> <span class="keyword">if</span> <span class="ident">tcn</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>133</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line133'><pre>      <span class="ident">lang</span> <span class="punct">=</span> <span class="ident">tcn</span><span class="punct">.</span><span class="ident">language</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">?</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span> <span class="punct">:</span> <span class="ident">tcn</span><span class="punct">.</span><span class="ident">language</span><span class="punct">.</span><span class="ident">iso_639_1</span>
</pre></a></td></tr><tr><td valign='top'><small>134</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line134'><pre>      <span class="ident">sorted_names</span><span class="punct">[</span><span class="ident">index</span><span class="punct">]</span> <span class="punct">=</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">lang</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span><span class="ident">name_languages</span><span class="punct">[</span><span class="ident">tcn</span><span class="punct">.</span><span class="ident">name</span><span class="punct">.</span><span class="ident">string</span><span class="punct">].</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>135</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line135'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>136</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line136'><pre>
</pre></a></td></tr><tr><td valign='top'><small>137</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line137'><pre>    <span class="ident">sorted_names</span><span class="punct">.</span><span class="ident">compact</span>
</pre></a></td></tr><tr><td valign='top'><small>138</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line138'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>139</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line139'><pre>
</pre></a></td></tr><tr><td valign='top'><small>140</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line140'><pre>  <span class="comment"># Curators are those users who have special permission to &quot;vet&quot; data objects associated with a TC, and thus get</span>
</pre></a></td></tr><tr><td valign='top'><small>141</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line141'><pre>  <span class="comment"># extra credit on their associated TC pages. This method returns an Array of those users.</span>
</pre></a></td></tr><tr><td valign='top'><small>142</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line142'><pre>  <span class="keyword">def </span><span class="method">curators</span><span class="punct">(</span><span class="ident">options</span><span class="punct">={})</span>
</pre></a></td></tr><tr><td valign='top'><small>143</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line143'><pre>    <span class="keyword">return</span> <span class="attribute">@curators</span> <span class="keyword">unless</span> <span class="attribute">@curators</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>144</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line144'><pre>    <span class="attribute">@curators</span> <span class="punct">=</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">find_all_by_curator_approved</span><span class="punct">(</span><span class="constant">true</span><span class="punct">,</span> <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:users</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:id</span><span class="punct">,</span> <span class="symbol">:username</span> <span class="punct">]</span> <span class="punct">})</span>
</pre></a></td></tr><tr><td valign='top'><small>145</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line145'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>146</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line146'><pre>
</pre></a></td></tr><tr><td valign='top'><small>147</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line147'><pre>  <span class="comment"># Return the curators who actually get credit for what they have done (for example, a new curator who hasn't done</span>
</pre></a></td></tr><tr><td valign='top'><small>148</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line148'><pre>  <span class="comment"># anything yet doesn't get a citation).  Also, curators should only get credit on the pages they actually edited,</span>
</pre></a></td></tr><tr><td valign='top'><small>149</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line149'><pre>  <span class="comment"># not all of it's children.  (For example.)</span>
</pre></a></td></tr><tr><td valign='top'><small>150</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line150'><pre>  <span class="keyword">def </span><span class="method">acting_curators</span>
</pre></a></td></tr><tr><td valign='top'><small>151</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line151'><pre>    <span class="ident">curator_activity_logs</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">lcd</span><span class="punct">|</span> <span class="ident">lcd</span><span class="punct">.</span><span class="ident">user</span> <span class="punct">}.</span><span class="ident">uniq</span>
</pre></a></td></tr><tr><td valign='top'><small>152</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line152'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>153</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line153'><pre>
</pre></a></td></tr><tr><td valign='top'><small>154</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line154'><pre>  <span class="keyword">def </span><span class="method">top_acting_curators</span>
</pre></a></td></tr><tr><td valign='top'><small>155</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line155'><pre>    <span class="ident">acting_curators</span><span class="punct">[</span><span class="number">0</span><span class="punct">..</span><span class="number">2</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>156</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line156'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>157</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line157'><pre>
</pre></a></td></tr><tr><td valign='top'><small>158</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line158'><pre>  <span class="comment"># The International Union for Conservation of Nature keeps a status for most known species, representing how endangered that</span>
</pre></a></td></tr><tr><td valign='top'><small>159</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line159'><pre>  <span class="comment"># species is.  This will default to &quot;unknown&quot; for species that are not being tracked.</span>
</pre></a></td></tr><tr><td valign='top'><small>160</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line160'><pre>  <span class="keyword">def </span><span class="method">iucn_conservation_status</span>
</pre></a></td></tr><tr><td valign='top'><small>161</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line161'><pre>    <span class="keyword">return</span> <span class="ident">iucn</span><span class="punct">.</span><span class="ident">description</span>
</pre></a></td></tr><tr><td valign='top'><small>162</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line162'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>163</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line163'><pre>
</pre></a></td></tr><tr><td valign='top'><small>164</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line164'><pre>  <span class="comment"># Returns true if the specified user has access to this TaxonConcept.</span>
</pre></a></td></tr><tr><td valign='top'><small>165</small></td><td valign='top'><ul><li>ControlCouple - is controlled by argument user &raquo; reek</li><li>LowCohesion - refers to user more than self &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line165'><pre>  <span class="keyword">def </span><span class="method">is_curatable_by?</span> <span class="ident">user</span>
</pre></a></td></tr><tr><td valign='top'><small>166</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line166'><pre>    <span class="keyword">if</span> <span class="ident">user</span>
</pre></a></td></tr><tr><td valign='top'><small>167</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line167'><pre>      <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">unless</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">curator_approved</span>
</pre></a></td></tr><tr><td valign='top'><small>168</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line168'><pre>      <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>169</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line169'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>170</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line170'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>171</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line171'><pre>
</pre></a></td></tr><tr><td valign='top'><small>172</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line172'><pre>  <span class="comment"># The scientific name for a TC will be italicized if it is a species (or below) and will include attribution and varieties, etc:</span>
</pre></a></td></tr><tr><td valign='top'><small>173</small></td><td valign='top'><ul><li>ControlCouple - has boolean parameter 'italicize' &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line173'><pre>  <span class="keyword">def </span><span class="method">scientific_name</span><span class="punct">(</span><span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">,</span> <span class="ident">italicize</span> <span class="punct">=</span> <span class="constant">true</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>174</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line174'><pre>    <span class="ident">hierarchy</span> <span class="punct">||=</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">default</span>
</pre></a></td></tr><tr><td valign='top'><small>175</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line175'><pre>    <span class="ident">quick_scientific_name</span><span class="punct">(</span><span class="ident">italicize</span> <span class="punct">&amp;&amp;</span> <span class="ident">species_or_below?</span> <span class="punct">?</span> <span class="symbol">:italicized</span> <span class="punct">:</span> <span class="symbol">:normal</span><span class="punct">,</span> <span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>176</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line176'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>177</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line177'><pre>
</pre></a></td></tr><tr><td valign='top'><small>178</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line178'><pre>  <span class="comment"># same as above but a static method expecting an array of IDs</span>
</pre></a></td></tr><tr><td valign='top'><small>179</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line179'><pre>  <span class="keyword">def </span><span class="method">self.scientific_names_for_concepts</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">,</span> <span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>180</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line180'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">if</span> <span class="ident">taxon_concept_ids</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>181</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line181'><pre>    <span class="ident">hierarchy</span> <span class="punct">||=</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">default</span>
</pre></a></td></tr><tr><td valign='top'><small>182</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line182'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">quick_scientific_names</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">,</span> <span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>183</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line183'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>184</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line184'><pre>
</pre></a></td></tr><tr><td valign='top'><small>185</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line185'><pre>  <span class="comment"># If you just call &quot;comments&quot;, you are actually getting comments that should really be invisible.  This method gets around this,</span>
</pre></a></td></tr><tr><td valign='top'><small>186</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line186'><pre>  <span class="comment"># and didn't see appropriate to do with a named_scpope:</span>
</pre></a></td></tr><tr><td valign='top'><small>187</small></td><td valign='top'><ul><li>Duplication - calls comments twice &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line187'><pre>  <span class="keyword">def </span><span class="method">visible_comments</span><span class="punct">(</span><span class="ident">user</span> <span class="punct">=</span> <span class="attribute">@current_user</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>188</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line188'><pre>    <span class="keyword">return</span> <span class="ident">comments</span> <span class="keyword">if</span> <span class="ident">user</span> <span class="keyword">and</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">is_moderator?</span>
</pre></a></td></tr><tr><td valign='top'><small>189</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line189'><pre>    <span class="ident">comments</span><span class="punct">.</span><span class="ident">find_all</span> <span class="punct">{|</span><span class="ident">comment</span><span class="punct">|</span> <span class="ident">comment</span><span class="punct">.</span><span class="ident">visible?</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>190</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line190'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>191</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line191'><pre>
</pre></a></td></tr><tr><td valign='top'><small>192</small></td><td valign='top'><ul><li>LowCohesion - refers to toc more than self &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line192'><pre>  <span class="keyword">def </span><span class="method">tocitem_for_new_text</span>
</pre></a></td></tr><tr><td valign='top'><small>193</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line193'><pre>    <span class="ident">table_of_contents</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">toc</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>194</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line194'><pre>      <span class="keyword">return</span> <span class="constant">TocItem</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">toc</span><span class="punct">.</span><span class="ident">category_id</span><span class="punct">)</span> <span class="keyword">if</span> <span class="ident">toc</span><span class="punct">.</span><span class="ident">allow_user_text?</span>
</pre></a></td></tr><tr><td valign='top'><small>195</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line195'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>196</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line196'><pre>    <span class="constant">TocItem</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="symbol">:first</span><span class="punct">,</span> <span class="symbol">:joins</span> <span class="punct">=&gt;</span> <span class="symbol">:info_items</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>197</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line197'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>198</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line198'><pre>
</pre></a></td></tr><tr><td valign='top'><small>199</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line199'><pre>  <span class="comment"># pull list of categories for given taxon_concept_id</span>
</pre></a></td></tr><tr><td valign='top'><small>200</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line200'><pre>  <span class="keyword">def </span><span class="method">table_of_contents</span><span class="punct">(</span><span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>201</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line201'><pre>    <span class="keyword">if</span> <span class="attribute">@table_of_contents</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>202</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line202'><pre>      <span class="ident">tb</span> <span class="punct">=</span> <span class="constant">TocBuilder</span><span class="punct">.</span><span class="ident">new</span>
</pre></a></td></tr><tr><td valign='top'><small>203</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line203'><pre>      <span class="attribute">@table_of_contents</span> <span class="punct">=</span> <span class="ident">tb</span><span class="punct">.</span><span class="ident">toc_for</span><span class="punct">(</span><span class="constant">self</span><span class="punct">,</span> <span class="symbol">:user</span> <span class="punct">=&gt;</span> <span class="ident">current_user</span><span class="punct">,</span> <span class="symbol">:agent_logged_in</span> <span class="punct">=&gt;</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:agent_logged_in</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>204</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line204'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>205</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line205'><pre>    <span class="attribute">@table_of_contents</span>
</pre></a></td></tr><tr><td valign='top'><small>206</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line206'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>207</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line207'><pre>  <span class="keyword">alias</span> <span class="symbol">:toc</span> <span class="symbol">:table_of_contents</span>
</pre></a></td></tr><tr><td valign='top'><small>208</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line208'><pre>
</pre></a></td></tr><tr><td valign='top'><small>209</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line209'><pre>  <span class="comment"># Extracts user filtered text objects from taxon concept data objects and user data objects</span>
</pre></a></td></tr><tr><td valign='top'><small>210</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line210'><pre>  <span class="comment"># Assumes current user if option[:user] is nil</span>
</pre></a></td></tr><tr><td valign='top'><small>211</small></td><td valign='top'><ul><li>Duplication - calls options[:user] 3 times &raquo; reek</li><li>Duplication - calls udo.data_object twice &raquo; reek</li><li>LongMethod - has approx 6 statements &raquo; reek</li><li>UncommunicativeName - has the variable name 'd' &raquo; reek</li><li>LowCohesion - refers to options more than self &raquo; reek</li><li>Complexity 5 &raquo; saikuro</li></ul></td><td valign='top'><a name='line211'><pre>  <span class="keyword">def </span><span class="method">text</span><span class="punct">(</span><span class="ident">options</span><span class="punct">={})</span>
</pre></a></td></tr><tr><td valign='top'><small>212</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line212'><pre>    <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">]</span> <span class="punct">||=</span> <span class="ident">current_user</span>
</pre></a></td></tr><tr><td valign='top'><small>213</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line213'><pre>    <span class="ident">text_datos</span> <span class="punct">=</span> <span class="ident">data_objects</span><span class="punct">.</span><span class="ident">select</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">is_text?</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>214</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line214'><pre>    <span class="ident">text_user_objects</span> <span class="punct">=</span> <span class="ident">users_data_objects</span><span class="punct">.</span><span class="ident">select</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">udo</span><span class="punct">|</span> <span class="ident">udo</span><span class="punct">.</span><span class="ident">data_object</span><span class="punct">.</span><span class="ident">is_text?</span> <span class="punct">}.</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">udo</span><span class="punct">|</span> <span class="ident">udo</span><span class="punct">.</span><span class="ident">data_object</span><span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>215</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line215'><pre>    <span class="ident">combined_objects</span> <span class="punct">=</span> <span class="ident">text_datos</span> <span class="punct">|</span> <span class="ident">text_user_objects</span>  <span class="comment"># get the union of the two sets</span>
</pre></a></td></tr><tr><td valign='top'><small>216</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line216'><pre>
</pre></a></td></tr><tr><td valign='top'><small>217</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line217'><pre>    <span class="comment"># if this is a content partner, we preload associations to prevent</span>
</pre></a></td></tr><tr><td valign='top'><small>218</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line218'><pre>    <span class="comment"># a bunch of queries later on in DataObject.filter_list_for_user</span>
</pre></a></td></tr><tr><td valign='top'><small>219</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line219'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">]</span> <span class="punct">&amp;&amp;</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">is_content_partner?</span>
</pre></a></td></tr><tr><td valign='top'><small>220</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line220'><pre>      <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">preload_associations</span><span class="punct">(</span><span class="ident">combined_objects</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>221</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line221'><pre>        <span class="punct">[</span> <span class="symbol">:hierarchy_entries</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:hierarchy</span> <span class="punct">=&gt;</span> <span class="symbol">:agent</span> <span class="punct">}</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>222</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line222'><pre>        <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="punct">{</span>
</pre></a></td></tr><tr><td valign='top'><small>223</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line223'><pre>          <span class="symbol">:hierarchy_entries</span> <span class="punct">=&gt;</span> <span class="symbol">:hierarchy_id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>224</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line224'><pre>          <span class="symbol">:agents</span> <span class="punct">=&gt;</span> <span class="symbol">:id</span> <span class="punct">}</span> <span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>225</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line225'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>226</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line226'><pre>    <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">filter_list_for_user</span><span class="punct">(</span><span class="ident">combined_objects</span><span class="punct">,</span> <span class="symbol">:user</span> <span class="punct">=&gt;</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>227</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line227'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>228</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line228'><pre>
</pre></a></td></tr><tr><td valign='top'><small>229</small></td><td valign='top'><ul><li>UncommunicativeName - has the variable name 'd' &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line229'><pre>  <span class="keyword">def </span><span class="method">text_toc_items_for_session</span><span class="punct">(</span><span class="ident">options</span><span class="punct">={})</span>
</pre></a></td></tr><tr><td valign='top'><small>230</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line230'><pre>    <span class="ident">text_objects</span> <span class="punct">=</span> <span class="ident">text</span><span class="punct">(</span><span class="ident">options</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>231</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line231'><pre>    <span class="keyword">return</span> <span class="ident">text_objects</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">toc_items</span> <span class="punct">}.</span><span class="ident">flatten</span><span class="punct">.</span><span class="ident">compact</span><span class="punct">.</span><span class="ident">uniq</span>
</pre></a></td></tr><tr><td valign='top'><small>232</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line232'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>233</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line233'><pre>
</pre></a></td></tr><tr><td valign='top'><small>234</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line234'><pre>  <span class="comment"># options</span>
</pre></a></td></tr><tr><td valign='top'><small>235</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line235'><pre>  <span class="comment">#   :required will return the next available text object if no text is returned by toc_items</span>
</pre></a></td></tr><tr><td valign='top'><small>236</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line236'><pre>  <span class="comment">#   :limit returns a subset of objects for each toc_item</span>
</pre></a></td></tr><tr><td valign='top'><small>237</small></td><td valign='top'><ul><li>Duplication - calls options[:limit] 5 times &raquo; reek</li><li>Duplication - calls options[:limit].to_i 4 times &raquo; reek</li><li>Duplication - calls options[:user] 4 times &raquo; reek</li><li>Duplication - calls t.toc_items twice &raquo; reek</li><li>NestedIterators - contains iterators nested 2 deep &raquo; reek</li><li>LongMethod - has approx 16 statements &raquo; reek</li><li>UncommunicativeName - has the variable name 'd' &raquo; reek</li><li>UncommunicativeName - has the variable name 't' &raquo; reek</li><li>LowCohesion - refers to options more than self &raquo; reek</li><li>Method name "text_objects_for_toc_items" cyclomatic complexity is 18.  It should be 8 or less. &raquo; roodi</li><li>Method "text_objects_for_toc_items" has 44 lines.  It should have 20 or less. &raquo; roodi</li><li>Complexity 14 &raquo; saikuro</li></ul></td><td valign='top'><a name='line237'><pre>  <span class="keyword">def </span><span class="method">text_objects_for_toc_items</span><span class="punct">(</span><span class="ident">toc_items</span><span class="punct">,</span> <span class="ident">options</span><span class="punct">={})</span>
</pre></a></td></tr><tr><td valign='top'><small>238</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line238'><pre>
</pre></a></td></tr><tr><td valign='top'><small>239</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line239'><pre>    <span class="ident">text_objects</span> <span class="punct">=</span> <span class="ident">text</span>
</pre></a></td></tr><tr><td valign='top'><small>240</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line240'><pre>
</pre></a></td></tr><tr><td valign='top'><small>241</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line241'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">text_objects</span><span class="punct">.</span><span class="ident">empty?</span> <span class="punct">||</span> <span class="ident">text_objects</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>242</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line242'><pre>    <span class="ident">toc_items</span> <span class="punct">=</span> <span class="punct">[</span><span class="ident">toc_items</span><span class="punct">]</span> <span class="keyword">unless</span> <span class="ident">toc_items</span><span class="punct">.</span><span class="ident">is_a?</span><span class="punct">(</span><span class="constant">Array</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>243</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line243'><pre>    <span class="ident">text_objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">sort_by_rating</span><span class="punct">(</span><span class="ident">text_objects</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>244</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line244'><pre>
</pre></a></td></tr><tr><td valign='top'><small>245</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line245'><pre>    <span class="ident">datos_to_load</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>246</small></td><td valign='top'><ul><li>Block cyclomatic complexity is 9.  It should be 4 or less. &raquo; roodi</li></ul></td><td valign='top'><a name='line246'><pre>    <span class="ident">toc_items</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">toc_item</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>247</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line247'><pre>      <span class="keyword">unless</span> <span class="ident">toc_item</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>248</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line248'><pre>        <span class="ident">items</span> <span class="punct">=</span> <span class="ident">text_objects</span><span class="punct">.</span><span class="ident">select</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">t</span><span class="punct">|</span> <span class="ident">t</span><span class="punct">.</span><span class="ident">toc_items</span> <span class="punct">&amp;&amp;</span> <span class="ident">t</span><span class="punct">.</span><span class="ident">toc_items</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">toc_item</span><span class="punct">)</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>249</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line249'><pre>        <span class="keyword">unless</span> <span class="ident">items</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">||</span> <span class="ident">items</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>250</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line250'><pre>          <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:limit</span><span class="punct">].</span><span class="ident">nil?</span> <span class="punct">||</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:limit</span><span class="punct">].</span><span class="ident">to_i</span> <span class="punct">==</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>251</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line251'><pre>            <span class="ident">datos_to_load</span> <span class="punct">+=</span> <span class="ident">items</span>
</pre></a></td></tr><tr><td valign='top'><small>252</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line252'><pre>          <span class="keyword">elsif</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:limit</span><span class="punct">].</span><span class="ident">to_i</span> <span class="punct">==</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>253</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line253'><pre>            <span class="ident">datos_to_load</span> <span class="punct">&lt;&lt;</span> <span class="ident">items</span><span class="punct">[</span><span class="number">0</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>254</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line254'><pre>          <span class="keyword">elsif</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:limit</span><span class="punct">].</span><span class="ident">to_i</span> <span class="punct">&gt;</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>255</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line255'><pre>            <span class="ident">datos_to_load</span> <span class="punct">+=</span> <span class="ident">items</span><span class="punct">[</span><span class="number">0</span><span class="punct">..</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:limit</span><span class="punct">].</span><span class="ident">to_i</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>256</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line256'><pre>          <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>257</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line257'><pre>        <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>258</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line258'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>259</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line259'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>260</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line260'><pre>    <span class="ident">datos_to_load</span> <span class="punct">&lt;&lt;</span> <span class="ident">text_objects</span><span class="punct">[</span><span class="number">0</span><span class="punct">]</span> <span class="keyword">if</span> <span class="ident">datos_to_load</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">&amp;&amp;</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:required</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>261</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line261'><pre>
</pre></a></td></tr><tr><td valign='top'><small>262</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line262'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">datos_to_load</span><span class="punct">.</span><span class="ident">empty?</span>
</pre></a></td></tr><tr><td valign='top'><small>263</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line263'><pre>
</pre></a></td></tr><tr><td valign='top'><small>264</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line264'><pre>    <span class="ident">add_include</span> <span class="punct">=</span> <span class="punct">[</span><span class="symbol">:users_data_objects_ratings</span><span class="punct">,</span> <span class="symbol">:comments</span><span class="punct">,</span> <span class="symbol">:agents_data_objects</span><span class="punct">,</span> <span class="symbol">:info_items</span><span class="punct">,</span> <span class="symbol">:toc_items</span><span class="punct">,</span> <span class="punct">{</span> <span class="symbol">:users_data_objects</span> <span class="punct">=&gt;</span> <span class="symbol">:user</span> <span class="punct">},</span>
</pre></a></td></tr><tr><td valign='top'><small>265</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line265'><pre>      <span class="punct">{</span> <span class="symbol">:published_refs</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:ref_identifiers</span> <span class="punct">=&gt;</span> <span class="symbol">:ref_identifier_type</span> <span class="punct">}</span> <span class="punct">},</span> <span class="symbol">:all_comments</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>266</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line266'><pre>    <span class="ident">add_select</span> <span class="punct">=</span> <span class="punct">{</span>
</pre></a></td></tr><tr><td valign='top'><small>267</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line267'><pre>      <span class="symbol">:users_data_objects_ratings</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>268</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line268'><pre>      <span class="symbol">:refs</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>269</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line269'><pre>      <span class="symbol">:ref_identifiers</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>270</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line270'><pre>      <span class="symbol">:ref_identifier_types</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>271</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line271'><pre>      <span class="symbol">:users</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>272</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line272'><pre>      <span class="symbol">:comments</span> <span class="punct">=&gt;</span> <span class="punct">[</span><span class="symbol">:parent_id</span><span class="punct">,</span> <span class="symbol">:visible_at</span><span class="punct">]</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>273</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line273'><pre>
</pre></a></td></tr><tr><td valign='top'><small>274</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line274'><pre>    <span class="ident">objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">core_relationships</span><span class="punct">(</span><span class="symbol">:add_include</span> <span class="punct">=&gt;</span> <span class="ident">add_include</span><span class="punct">,</span> <span class="symbol">:add_select</span> <span class="punct">=&gt;</span> <span class="ident">add_select</span><span class="punct">).</span>
</pre></a></td></tr><tr><td valign='top'><small>275</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line275'><pre>        <span class="ident">find_all_by_id</span><span class="punct">(</span><span class="ident">datos_to_load</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">})</span>
</pre></a></td></tr><tr><td valign='top'><small>276</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line276'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">]</span> <span class="punct">&amp;&amp;</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">is_curator?</span> <span class="punct">&amp;&amp;</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">can_curate?</span><span class="punct">(</span><span class="constant">self</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>277</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line277'><pre>      <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">preload_associations</span><span class="punct">(</span><span class="ident">objects</span><span class="punct">,</span> <span class="symbol">:users_data_objects_ratings</span><span class="punct">,</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">users_data_objects_ratings.user_id=<span class="expr">#{options[:user].id}</span></span><span class="punct">&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>278</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line278'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>279</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line279'><pre>
</pre></a></td></tr><tr><td valign='top'><small>280</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line280'><pre>    <span class="ident">objects</span>
</pre></a></td></tr><tr><td valign='top'><small>281</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line281'><pre>
</pre></a></td></tr><tr><td valign='top'><small>282</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line282'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>283</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line283'><pre>
</pre></a></td></tr><tr><td valign='top'><small>284</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line284'><pre>  <span class="comment"># Return a list of data objects associated with this TC's Overview toc (returns nil if it doesn't have one)</span>
</pre></a></td></tr><tr><td valign='top'><small>285</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line285'><pre>  <span class="keyword">def </span><span class="method">overview</span>
</pre></a></td></tr><tr><td valign='top'><small>286</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line286'><pre>    <span class="keyword">return</span> <span class="ident">text_objects_for_toc_items</span><span class="punct">(</span><span class="constant">TocItem</span><span class="punct">.</span><span class="ident">overview</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>287</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line287'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>288</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line288'><pre>
</pre></a></td></tr><tr><td valign='top'><small>289</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line289'><pre>  <span class="comment"># Returns special content, if exists, for given toc items</span>
</pre></a></td></tr><tr><td valign='top'><small>290</small></td><td valign='top'><ul><li>LongMethod - has approx 8 statements &raquo; reek</li><li>ControlCouple - is controlled by argument toc_items &raquo; reek</li><li>LowCohesion - refers to ccb more than self &raquo; reek</li><li>LowCohesion - refers to toc_items more than self &raquo; reek</li><li>Complexity 6 &raquo; saikuro</li></ul></td><td valign='top'><a name='line290'><pre>  <span class="keyword">def </span><span class="method">special_content_for_toc_items</span><span class="punct">(</span><span class="ident">toc_items</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>291</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line291'><pre>    <span class="keyword">return</span> <span class="keyword">unless</span> <span class="ident">toc_items</span>
</pre></a></td></tr><tr><td valign='top'><small>292</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line292'><pre>    <span class="ident">toc_items</span> <span class="punct">=</span> <span class="punct">[</span><span class="ident">toc_items</span><span class="punct">]</span> <span class="keyword">unless</span> <span class="ident">toc_items</span><span class="punct">.</span><span class="ident">is_a?</span><span class="punct">(</span><span class="constant">Array</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>293</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line293'><pre>    <span class="ident">special_content</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>294</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line294'><pre>    <span class="ident">toc_items</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">toc_item</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>295</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line295'><pre>      <span class="ident">ccb</span> <span class="punct">=</span> <span class="constant">CategoryContentBuilder</span><span class="punct">.</span><span class="ident">new</span>
</pre></a></td></tr><tr><td valign='top'><small>296</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line296'><pre>      <span class="keyword">if</span> <span class="ident">ccb</span><span class="punct">.</span><span class="ident">can_handle?</span><span class="punct">(</span><span class="ident">toc_item</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>297</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line297'><pre>        <span class="ident">content</span> <span class="punct">=</span> <span class="ident">ccb</span><span class="punct">.</span><span class="ident">content_for</span><span class="punct">(</span><span class="ident">toc_item</span><span class="punct">,</span> <span class="symbol">:taxon_concept</span> <span class="punct">=&gt;</span> <span class="constant">self</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>298</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line298'><pre>        <span class="ident">special_content</span> <span class="punct">&lt;&lt;</span> <span class="ident">content</span> <span class="keyword">unless</span> <span class="ident">content</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>299</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line299'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>300</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line300'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>301</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line301'><pre>    <span class="ident">special_content</span>
</pre></a></td></tr><tr><td valign='top'><small>302</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line302'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>303</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line303'><pre>
</pre></a></td></tr><tr><td valign='top'><small>304</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line304'><pre>  <span class="comment"># Returns harvested text objects, user submitted object and special content for given toc items</span>
</pre></a></td></tr><tr><td valign='top'><small>305</small></td><td valign='top'><ul><li>Duplication - calls d.toc_items twice &raquo; reek</li><li>Duplication - calls text_objects.collect twice &raquo; reek</li><li>NestedIterators - contains iterators nested 2 deep &raquo; reek</li><li>LongMethod - has approx 8 statements &raquo; reek</li><li>UncommunicativeName - has the variable name 'd' &raquo; reek</li><li>Complexity 7 &raquo; saikuro</li></ul></td><td valign='top'><a name='line305'><pre>  <span class="keyword">def </span><span class="method">details_for_toc_items</span><span class="punct">(</span><span class="ident">toc_items</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>306</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line306'><pre>    <span class="ident">details</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>307</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line307'><pre>    <span class="ident">text_objects</span> <span class="punct">=</span> <span class="ident">text_objects_for_toc_items</span><span class="punct">(</span><span class="ident">toc_items</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>308</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line308'><pre>    <span class="keyword">if</span> <span class="ident">text_objects</span>
</pre></a></td></tr><tr><td valign='top'><small>309</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line309'><pre>      <span class="ident">text_object_toc_items</span> <span class="punct">=</span> <span class="ident">text_objects</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">toc_items</span> <span class="punct">}.</span><span class="ident">flatten</span><span class="punct">.</span><span class="ident">compact</span><span class="punct">.</span><span class="ident">uniq</span>
</pre></a></td></tr><tr><td valign='top'><small>310</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line310'><pre>      <span class="ident">text_object_toc_items</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">toc_item</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>311</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line311'><pre>        <span class="ident">detail</span> <span class="punct">=</span> <span class="punct">{</span>
</pre></a></td></tr><tr><td valign='top'><small>312</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line312'><pre>          <span class="symbol">:content_type</span>  <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">text</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>313</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line313'><pre>          <span class="symbol">:toc_item</span> <span class="punct">=&gt;</span> <span class="ident">toc_item</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>314</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line314'><pre>          <span class="symbol">:data_objects</span>  <span class="punct">=&gt;</span> <span class="ident">text_objects</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span> <span class="ident">d</span> <span class="keyword">if</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">toc_items</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">toc_item</span><span class="punct">)</span> <span class="punct">}.</span><span class="ident">compact</span>
</pre></a></td></tr><tr><td valign='top'><small>315</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line315'><pre>        <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>316</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line316'><pre>        <span class="ident">details</span> <span class="punct">&lt;&lt;</span> <span class="ident">detail</span>
</pre></a></td></tr><tr><td valign='top'><small>317</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line317'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>318</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line318'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>319</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line319'><pre>    <span class="ident">special_content</span> <span class="punct">=</span> <span class="ident">special_content_for_toc_items</span><span class="punct">(</span><span class="ident">toc_items</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>320</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line320'><pre>    <span class="ident">details</span> <span class="punct">+=</span> <span class="ident">special_content</span> <span class="keyword">unless</span> <span class="ident">special_content</span><span class="punct">.</span><span class="ident">empty?</span>
</pre></a></td></tr><tr><td valign='top'><small>321</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line321'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>322</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line322'><pre>
</pre></a></td></tr><tr><td valign='top'><small>323</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line323'><pre>  <span class="comment"># This may throw an ActiveRecord::RecordNotFound exception if the TocItem's category_id doesn't exist.</span>
</pre></a></td></tr><tr><td valign='top'><small>324</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line324'><pre>  <span class="keyword">def </span><span class="method">content_by_category</span><span class="punct">(</span><span class="ident">category_id</span><span class="punct">,</span> <span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>325</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line325'><pre>    <span class="ident">toc_item</span> <span class="punct">=</span> <span class="constant">TocItem</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">category_id</span><span class="punct">)</span> <span class="comment"># Note: this &quot;just works&quot; even if category_id *is* a TocItem.</span>
</pre></a></td></tr><tr><td valign='top'><small>326</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line326'><pre>    <span class="ident">ccb</span> <span class="punct">=</span> <span class="constant">CategoryContentBuilder</span><span class="punct">.</span><span class="ident">new</span>
</pre></a></td></tr><tr><td valign='top'><small>327</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line327'><pre>    <span class="keyword">if</span> <span class="ident">ccb</span><span class="punct">.</span><span class="ident">can_handle?</span><span class="punct">(</span><span class="ident">toc_item</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>328</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line328'><pre>      <span class="ident">ccb</span><span class="punct">.</span><span class="ident">content_for</span><span class="punct">(</span><span class="ident">toc_item</span><span class="punct">,</span> <span class="symbol">:vetted</span> <span class="punct">=&gt;</span> <span class="ident">current_user</span><span class="punct">.</span><span class="ident">vetted</span><span class="punct">,</span> <span class="symbol">:taxon_concept</span> <span class="punct">=&gt;</span> <span class="constant">self</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>329</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line329'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>330</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line330'><pre>      <span class="ident">get_default_content</span><span class="punct">(</span><span class="ident">toc_item</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>331</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line331'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>332</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line332'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>333</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line333'><pre>
</pre></a></td></tr><tr><td valign='top'><small>334</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line334'><pre>  <span class="comment"># Get a list of TaxonConcept models that are ancestors to this one.</span>
</pre></a></td></tr><tr><td valign='top'><small>335</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line335'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>336</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line336'><pre>  <span class="comment"># Note that TCs have no notion of ancestry in and of themselves, so they must defer to the hierarchy</span>
</pre></a></td></tr><tr><td valign='top'><small>337</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line337'><pre>  <span class="comment"># entries to find ancestors. And, of course, that yields HierarchyEntry values, so we need to convert</span>
</pre></a></td></tr><tr><td valign='top'><small>338</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line338'><pre>  <span class="comment"># them back.</span>
</pre></a></td></tr><tr><td valign='top'><small>339</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line339'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>340</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line340'><pre>  <span class="comment"># Also (IMPORTANT): there is another method called &quot;ancestry&quot;, which, confusingly, returns HierarchyEntry</span>
</pre></a></td></tr><tr><td valign='top'><small>341</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line341'><pre>  <span class="comment"># models, not TaxonConcept models.  Hmmmn.</span>
</pre></a></td></tr><tr><td valign='top'><small>342</small></td><td valign='top'><ul><li>Duplication - calls entry twice &raquo; reek</li><li>UncommunicativeName - has the variable name 'a' &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line342'><pre>  <span class="keyword">def </span><span class="method">ancestors</span>
</pre></a></td></tr><tr><td valign='top'><small>343</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line343'><pre>    <span class="keyword">return</span> <span class="punct">[]</span> <span class="keyword">unless</span> <span class="ident">entry</span>
</pre></a></td></tr><tr><td valign='top'><small>344</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line344'><pre>    <span class="ident">entry</span><span class="punct">.</span><span class="ident">ancestors</span><span class="punct">.</span><span class="ident">map</span> <span class="punct">{|</span><span class="ident">a</span><span class="punct">|</span> <span class="ident">a</span><span class="punct">.</span><span class="ident">taxon_concept</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>345</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line345'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>346</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line346'><pre>
</pre></a></td></tr><tr><td valign='top'><small>347</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line347'><pre>  <span class="comment"># Get a list of TaxonConcept models that are children to this one.</span>
</pre></a></td></tr><tr><td valign='top'><small>348</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line348'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>349</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line349'><pre>  <span class="comment"># Same caveats as #ancestors (q.v.)</span>
</pre></a></td></tr><tr><td valign='top'><small>350</small></td><td valign='top'><ul><li>Duplication - calls entry twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line350'><pre>  <span class="keyword">def </span><span class="method">children</span>
</pre></a></td></tr><tr><td valign='top'><small>351</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line351'><pre>    <span class="keyword">return</span> <span class="punct">[]</span> <span class="keyword">unless</span> <span class="ident">entry</span>
</pre></a></td></tr><tr><td valign='top'><small>352</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line352'><pre>    <span class="ident">entry</span><span class="punct">.</span><span class="ident">children</span><span class="punct">.</span><span class="ident">map</span><span class="punct">(&amp;</span><span class="symbol">:taxon_concept</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>353</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line353'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>354</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line354'><pre>
</pre></a></td></tr><tr><td valign='top'><small>355</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line355'><pre>  <span class="comment"># Get a list of some of our best TaxonConcept examples.  Results will be sorted by scientific name.</span>
</pre></a></td></tr><tr><td valign='top'><small>356</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line356'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>357</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line357'><pre>  <span class="comment"># The sorting is actually a moderately expensive operation, so this is cached.</span>
</pre></a></td></tr><tr><td valign='top'><small>358</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line358'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>359</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line359'><pre>  <span class="comment"># Lastly, note that the TaxonConcept IDs are hard-coded to our production database. TODO - move those IDs to a</span>
</pre></a></td></tr><tr><td valign='top'><small>360</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line360'><pre>  <span class="comment"># table somewhere.</span>
</pre></a></td></tr><tr><td valign='top'><small>361</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line361'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>362</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line362'><pre>  <span class="comment"># EXEMPLARS THAT WE NO LONGER TRUST: 482935,</span>
</pre></a></td></tr><tr><td valign='top'><small>363</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line363'><pre>  <span class="keyword">def </span><span class="method">self.exemplars</span><span class="punct">(</span><span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>364</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line364'><pre>    <span class="ident">cached</span><span class="punct">('</span><span class="string">exemplars</span><span class="punct">')</span> <span class="keyword">do</span>
</pre></a></td></tr><tr><td valign='top'><small>365</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line365'><pre>      <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">lookup_exemplars</span><span class="punct">(</span><span class="ident">options</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>366</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line366'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>367</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line367'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>368</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line368'><pre>
</pre></a></td></tr><tr><td valign='top'><small>369</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line369'><pre>  <span class="keyword">def </span><span class="method">self.lookup_exemplars</span><span class="punct">(</span><span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>370</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line370'><pre>    <span class="ident">options</span><span class="punct">[</span><span class="symbol">:language</span><span class="punct">]</span> <span class="punct">||=</span> <span class="constant">Language</span><span class="punct">.</span><span class="ident">english</span>
</pre></a></td></tr><tr><td valign='top'><small>371</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line371'><pre>    <span class="ident">options</span><span class="punct">[</span><span class="symbol">:size</span><span class="punct">]</span> <span class="punct">||=</span> <span class="symbol">:medium</span>
</pre></a></td></tr><tr><td valign='top'><small>372</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line372'><pre>    <span class="ident">exemplar_taxon_concept_ids</span> <span class="punct">=</span> <span class="punct">[</span><span class="number">910093</span><span class="punct">,</span> <span class="number">1009706</span><span class="punct">,</span> <span class="number">912371</span><span class="punct">,</span> <span class="number">976559</span><span class="punct">,</span> <span class="number">597748</span><span class="punct">,</span> <span class="number">1061748</span><span class="punct">,</span> <span class="number">373667</span><span class="punct">,</span> <span class="number">392557</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>373</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line373'><pre>      <span class="number">484592</span><span class="punct">,</span> <span class="number">581125</span><span class="punct">,</span> <span class="number">467045</span><span class="punct">,</span> <span class="number">593213</span><span class="punct">,</span> <span class="number">209984</span><span class="punct">,</span> <span class="number">795869</span><span class="punct">,</span> <span class="number">1049164</span><span class="punct">,</span> <span class="number">604595</span><span class="punct">,</span> <span class="number">983558</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>374</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line374'><pre>      <span class="number">253397</span><span class="punct">,</span> <span class="number">740699</span><span class="punct">,</span> <span class="number">1044544</span><span class="punct">,</span> <span class="number">683359</span><span class="punct">,</span> <span class="number">1194666</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>375</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line375'><pre>    <span class="ident">exemplar_hashes</span> <span class="punct">=</span> <span class="constant">SpeciesSchemaModel</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">select_all</span><span class="punct">(&quot;</span><span class="string"><span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>376</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line376'><pre>      <span class="constant">SELECT</span> <span class="ident">rhi</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">,</span> <span class="ident">rhi</span><span class="punct">.</span><span class="ident">name</span> <span class="ident">scientific_name</span><span class="punct">,</span> <span class="ident">n</span><span class="punct">.</span><span class="ident">string</span> <span class="ident">common_name</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">object_cache_url</span>
</pre></a></td></tr><tr><td valign='top'><small>377</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line377'><pre>        <span class="constant">FROM</span> <span class="ident">random_hierarchy_images</span> <span class="ident">rhi</span>
</pre></a></td></tr><tr><td valign='top'><small>378</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line378'><pre>        <span class="constant">JOIN</span> <span class="ident">data_objects</span> <span class="keyword">do</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">rhi</span><span class="punct">.</span><span class="ident">data_object_id</span><span class="punct">=</span><span class="keyword">do</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>379</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line379'><pre>        <span class="constant">LEFT</span> <span class="constant">JOIN</span> <span class="punct">(</span>
</pre></a></td></tr><tr><td valign='top'><small>380</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line380'><pre>          <span class="ident">taxon_concept_names</span> <span class="ident">tcn</span>
</pre></a></td></tr><tr><td valign='top'><small>381</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line381'><pre>          <span class="constant">JOIN</span> <span class="ident">names</span> <span class="ident">n</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">tcn</span><span class="punct">.</span><span class="ident">name_id</span><span class="punct">=</span><span class="ident">n</span><span class="punct">.</span><span class="ident">id</span> <span class="constant">AND</span> <span class="ident">tcn</span><span class="punct">.</span><span class="ident">language_id</span><span class="punct">=</span><span class="comment">#{options[:language].id} AND tcn.preferred=1)</span>
</pre></a></td></tr><tr><td valign='top'><small>382</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line382'><pre>        <span class="punct">)</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">rhi</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">=</span><span class="ident">tcn</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>383</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line383'><pre>      <span class="constant">WHERE</span> <span class="ident">rhi</span><span class="punct">.</span><span class="ident">taxon_concept_id</span> <span class="constant">IN</span> <span class="punct">(</span><span class="comment">#{exemplar_taxon_concept_ids.join(',')})</span>
</pre></a></td></tr><tr><td valign='top'><small>384</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line384'><pre>      <span class="constant">AND</span> <span class="ident">rhi</span><span class="punct">.</span><span class="ident">hierarchy_id</span><span class="punct">=</span><span class="comment">#{Hierarchy.default.id}&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>385</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line385'><pre>
</pre></a></td></tr><tr><td valign='top'><small>386</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line386'><pre>    <span class="ident">used_concepts</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>387</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line387'><pre>    <span class="ident">exemplar_taxa</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>388</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line388'><pre>    <span class="ident">exemplar_hashes</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">ex</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>389</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line389'><pre>      <span class="keyword">next</span> <span class="keyword">if</span> <span class="punct">!</span><span class="ident">used_concepts</span><span class="punct">[</span><span class="ident">ex</span><span class="punct">['</span><span class="string">taxon_concept_id</span><span class="punct">']].</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>390</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line390'><pre>      <span class="ident">ex</span><span class="punct">['</span><span class="string">image_cache_path</span><span class="punct">']</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">image_cache_path</span><span class="punct">(</span><span class="ident">ex</span><span class="punct">['</span><span class="string">object_cache_url</span><span class="punct">'],</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:size</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>391</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line391'><pre>      <span class="ident">exemplar_taxa</span> <span class="punct">&lt;&lt;</span> <span class="ident">ex</span>
</pre></a></td></tr><tr><td valign='top'><small>392</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line392'><pre>      <span class="ident">used_concepts</span><span class="punct">[</span><span class="ident">ex</span><span class="punct">['</span><span class="string">taxon_concept_id</span><span class="punct">']]</span> <span class="punct">=</span> <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>393</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line393'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>394</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line394'><pre>    <span class="ident">exemplar_taxa</span><span class="punct">.</span><span class="ident">sort_by</span> <span class="punct">{|</span><span class="ident">ex</span><span class="punct">|</span> <span class="ident">ex</span><span class="punct">['</span><span class="string">scientific_name</span><span class="punct">']}</span>
</pre></a></td></tr><tr><td valign='top'><small>395</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line395'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>396</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line396'><pre>
</pre></a></td></tr><tr><td valign='top'><small>397</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line397'><pre>  <span class="comment"># Call this instead of @current_user, so that you will be given the appropriate (and DRY) defaults.</span>
</pre></a></td></tr><tr><td valign='top'><small>398</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line398'><pre>  <span class="keyword">def </span><span class="method">current_user</span>
</pre></a></td></tr><tr><td valign='top'><small>399</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line399'><pre>    <span class="attribute">@current_user</span> <span class="punct">||=</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">create_new</span>
</pre></a></td></tr><tr><td valign='top'><small>400</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line400'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>401</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line401'><pre>
</pre></a></td></tr><tr><td valign='top'><small>402</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line402'><pre>  <span class="keyword">def </span><span class="method">self.current_user_static</span>
</pre></a></td></tr><tr><td valign='top'><small>403</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line403'><pre>    <span class="attribute">@current_user</span> <span class="punct">||=</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">create_new</span>
</pre></a></td></tr><tr><td valign='top'><small>404</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line404'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>405</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line405'><pre>
</pre></a></td></tr><tr><td valign='top'><small>406</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line406'><pre>  <span class="comment"># Set the current user, so that methods will have defaults (language, etc) appropriate to that user.</span>
</pre></a></td></tr><tr><td valign='top'><small>407</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line407'><pre>  <span class="keyword">def </span><span class="method">current_user=</span><span class="punct">(</span><span class="ident">who</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>408</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line408'><pre>    <span class="attribute">@images</span> <span class="punct">=</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>409</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line409'><pre>    <span class="attribute">@current_user</span> <span class="punct">=</span> <span class="ident">who</span>
</pre></a></td></tr><tr><td valign='top'><small>410</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line410'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>411</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line411'><pre>
</pre></a></td></tr><tr><td valign='top'><small>412</small></td><td valign='top'><ul><li>Duplication - calls entry twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line412'><pre>  <span class="keyword">def </span><span class="method">canonical_form_object</span>
</pre></a></td></tr><tr><td valign='top'><small>413</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line413'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">unless</span> <span class="ident">entry</span>
</pre></a></td></tr><tr><td valign='top'><small>414</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line414'><pre>    <span class="keyword">return</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">canonical_form</span>
</pre></a></td></tr><tr><td valign='top'><small>415</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line415'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>416</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line416'><pre>
</pre></a></td></tr><tr><td valign='top'><small>417</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line417'><pre>  <span class="comment"># If *any* of the associated HEs are species or below, we consider this to be a species:</span>
</pre></a></td></tr><tr><td valign='top'><small>418</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line418'><pre>  <span class="keyword">def </span><span class="method">species_or_below?</span>
</pre></a></td></tr><tr><td valign='top'><small>419</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line419'><pre>    <span class="ident">published_hierarchy_entries</span><span class="punct">.</span><span class="ident">detect</span> <span class="punct">{|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">species_or_below?</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>420</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line420'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>421</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line421'><pre>
</pre></a></td></tr><tr><td valign='top'><small>422</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line422'><pre>  <span class="keyword">def </span><span class="method">has_outlinks?</span>
</pre></a></td></tr><tr><td valign='top'><small>423</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line423'><pre>    <span class="keyword">return</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">count_by_sql</span><span class="punct">(&quot;</span><span class="string">SELECT 1<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>424</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line424'><pre>      <span class="constant">FROM</span> <span class="ident">hierarchy_entries</span> <span class="ident">he</span>
</pre></a></td></tr><tr><td valign='top'><small>425</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line425'><pre>      <span class="constant">JOIN</span> <span class="ident">hierarchies</span> <span class="ident">h</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy_id</span> <span class="punct">=</span> <span class="ident">h</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>426</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line426'><pre>      <span class="constant">WHERE</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">taxon_concept_id</span> <span class="punct">=</span> <span class="comment">#{self.id}</span>
</pre></a></td></tr><tr><td valign='top'><small>427</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line427'><pre>      <span class="constant">AND</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">published</span> <span class="punct">=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>428</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line428'><pre>      <span class="constant">AND</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">visibility_id</span> <span class="punct">=</span> <span class="comment">#{Visibility.visible.id}</span>
</pre></a></td></tr><tr><td valign='top'><small>429</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line429'><pre>      <span class="constant">AND</span> <span class="ident">h</span><span class="punct">.</span><span class="ident">browsable</span> <span class="punct">=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>430</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line430'><pre>      <span class="constant">AND</span> <span class="punct">(</span>
</pre></a></td></tr><tr><td valign='top'><small>431</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line431'><pre>        <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">source_url</span> <span class="punct">!=</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span> <span class="constant">AND</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">source_url</span> <span class="constant">IS</span> <span class="constant">NOT</span> <span class="constant">NULL</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>432</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line432'><pre>        <span class="constant">OR</span> <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">identifier</span> <span class="punct">!=</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span> <span class="constant">AND</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">identifier</span> <span class="constant">IS</span> <span class="constant">NOT</span> <span class="constant">NULL</span> <span class="constant">AND</span> <span class="ident">h</span><span class="punct">.</span><span class="ident">outlink_uri</span> <span class="punct">!=</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span> <span class="constant">AND</span> <span class="ident">h</span><span class="punct">.</span><span class="ident">outlink_uri</span> <span class="constant">IS</span> <span class="constant">NOT</span> <span class="constant">NULL</span><span class="punct">))</span>
</pre></a></td></tr><tr><td valign='top'><small>433</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line433'><pre>      <span class="constant">LIMIT</span> <span class="number">1</span><span class="punct">&quot;</span><span class="string">) &gt; 0<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>434</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line434'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>435</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line435'><pre>
</pre></a></td></tr><tr><td valign='top'><small>436</small></td><td valign='top'><ul><li>Duplication - calls (used_hierarchies << he.hierarchy) 3 times &raquo; reek</li><li>Duplication - calls he.hierarchy 12 times &raquo; reek</li><li>Duplication - calls he.hierarchy.outlink_uri 4 times &raquo; reek</li><li>Duplication - calls he.identifier twice &raquo; reek</li><li>Duplication - calls he.source_url twice &raquo; reek</li><li>LongMethod - has approx 14 statements &raquo; reek</li><li>LowCohesion - refers to he more than self &raquo; reek</li><li>Method name "outlinks" cyclomatic complexity is 9.  It should be 8 or less. &raquo; roodi</li><li>Method "outlinks" has 38 lines.  It should have 20 or less. &raquo; roodi</li><li>Complexity 9 &raquo; saikuro</li></ul></td><td valign='top'><a name='line436'><pre>  <span class="keyword">def </span><span class="method">outlinks</span>
</pre></a></td></tr><tr><td valign='top'><small>437</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line437'><pre>    <span class="ident">all_outlinks</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>438</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line438'><pre>    <span class="ident">used_hierarchies</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>439</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line439'><pre>    <span class="ident">entries_for_this_concept</span> <span class="punct">=</span> <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">find_all_by_taxon_concept_id</span><span class="punct">(</span><span class="ident">id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>440</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line440'><pre>      <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="punct">{</span>
</pre></a></td></tr><tr><td valign='top'><small>441</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line441'><pre>        <span class="symbol">:hierarchy_entries</span> <span class="punct">=&gt;</span> <span class="punct">[</span><span class="symbol">:published</span><span class="punct">,</span> <span class="symbol">:visibility_id</span><span class="punct">,</span> <span class="symbol">:identifier</span><span class="punct">,</span> <span class="symbol">:source_url</span><span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>442</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line442'><pre>        <span class="symbol">:hierarchies</span> <span class="punct">=&gt;</span> <span class="punct">[</span><span class="symbol">:label</span><span class="punct">,</span> <span class="symbol">:outlink_uri</span><span class="punct">,</span> <span class="symbol">:url</span><span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>443</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line443'><pre>        <span class="symbol">:resources</span> <span class="punct">=&gt;</span> <span class="symbol">:title</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>444</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line444'><pre>        <span class="symbol">:agents</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:logo_cache_url</span><span class="punct">,</span> <span class="symbol">:full_name</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>445</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line445'><pre>        <span class="symbol">:collection_types</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:parent_id</span> <span class="punct">]</span> <span class="punct">},</span>
</pre></a></td></tr><tr><td valign='top'><small>446</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line446'><pre>      <span class="symbol">:include</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:hierarchy</span> <span class="punct">=&gt;</span> <span class="punct">[</span><span class="symbol">:resource</span><span class="punct">,</span> <span class="symbol">:agent</span><span class="punct">,</span> <span class="symbol">:collection_types</span><span class="punct">]</span> <span class="punct">})</span>
</pre></a></td></tr><tr><td valign='top'><small>447</small></td><td valign='top'><ul><li>Block cyclomatic complexity is 9.  It should be 4 or less. &raquo; roodi</li></ul></td><td valign='top'><a name='line447'><pre>    <span class="ident">entries_for_this_concept</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">he</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>448</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line448'><pre>      <span class="keyword">next</span> <span class="keyword">if</span> <span class="ident">used_hierarchies</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>449</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line449'><pre>      <span class="keyword">next</span> <span class="keyword">if</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">published</span> <span class="punct">!=</span> <span class="number">1</span> <span class="punct">&amp;&amp;</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">visibility_id</span> <span class="punct">!=</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">visible</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>450</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line450'><pre>      <span class="keyword">if</span> <span class="punct">!</span><span class="ident">he</span><span class="punct">.</span><span class="ident">source_url</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>451</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line451'><pre>        <span class="ident">all_outlinks</span> <span class="punct">&lt;&lt;</span> <span class="punct">{</span><span class="symbol">:hierarchy_entry</span> <span class="punct">=&gt;</span> <span class="ident">he</span><span class="punct">,</span> <span class="symbol">:hierarchy</span> <span class="punct">=&gt;</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span><span class="punct">,</span> <span class="symbol">:outlink_url</span> <span class="punct">=&gt;</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">source_url</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>452</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line452'><pre>        <span class="ident">used_hierarchies</span> <span class="punct">&lt;&lt;</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span>
</pre></a></td></tr><tr><td valign='top'><small>453</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line453'><pre>      <span class="keyword">elsif</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span><span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">outlink_uri</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>454</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line454'><pre>        <span class="comment"># if the hierarchy outlink_uri expects an ID</span>
</pre></a></td></tr><tr><td valign='top'><small>455</small></td><td valign='top'><ul><li>Found = in conditional.  It should probably be an == &raquo; roodi</li></ul></td><td valign='top'><a name='line455'><pre>        <span class="keyword">if</span> <span class="ident">matches</span> <span class="punct">=</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">outlink_uri</span><span class="punct">.</span><span class="ident">match</span><span class="punct">(/</span><span class="regex">%%ID%%</span><span class="punct">/)</span>
</pre></a></td></tr><tr><td valign='top'><small>456</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line456'><pre>          <span class="comment"># .. and the ID exists</span>
</pre></a></td></tr><tr><td valign='top'><small>457</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line457'><pre>          <span class="keyword">unless</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">identifier</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>458</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line458'><pre>            <span class="ident">all_outlinks</span> <span class="punct">&lt;&lt;</span> <span class="punct">{</span><span class="symbol">:hierarchy_entry</span> <span class="punct">=&gt;</span> <span class="ident">he</span><span class="punct">,</span> <span class="symbol">:hierarchy</span> <span class="punct">=&gt;</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span><span class="punct">,</span> <span class="symbol">:outlink_url</span> <span class="punct">=&gt;</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">outlink_uri</span><span class="punct">.</span><span class="ident">gsub</span><span class="punct">(/</span><span class="regex">%%ID%%</span><span class="punct">/,</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">identifier</span><span class="punct">)</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>459</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line459'><pre>            <span class="ident">used_hierarchies</span> <span class="punct">&lt;&lt;</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span>
</pre></a></td></tr><tr><td valign='top'><small>460</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line460'><pre>          <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>461</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line461'><pre>        <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>462</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line462'><pre>          <span class="comment"># there was no %%ID%% pattern in the outlink_uri, but its not blank so its a generic URL for all entries</span>
</pre></a></td></tr><tr><td valign='top'><small>463</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line463'><pre>          <span class="ident">all_outlinks</span> <span class="punct">&lt;&lt;</span> <span class="punct">{</span><span class="symbol">:hierarchy_entry</span> <span class="punct">=&gt;</span> <span class="ident">he</span><span class="punct">,</span> <span class="symbol">:hierarchy</span> <span class="punct">=&gt;</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span><span class="punct">,</span> <span class="symbol">:outlink_url</span> <span class="punct">=&gt;</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">outlink_uri</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>464</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line464'><pre>          <span class="ident">used_hierarchies</span> <span class="punct">&lt;&lt;</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span>
</pre></a></td></tr><tr><td valign='top'><small>465</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line465'><pre>        <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>466</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line466'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>467</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line467'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>468</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line468'><pre>
</pre></a></td></tr><tr><td valign='top'><small>469</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line469'><pre>    <span class="comment"># if the link is Wikipedia this will remove the revision ID</span>
</pre></a></td></tr><tr><td valign='top'><small>470</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line470'><pre>    <span class="ident">all_outlinks</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">ol</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>471</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line471'><pre>      <span class="ident">ol</span><span class="punct">[</span><span class="symbol">:outlink_url</span><span class="punct">].</span><span class="ident">gsub!</span><span class="punct">(/</span><span class="regex">&amp;oldid=[0-9]+$</span><span class="punct">/,</span> <span class="punct">'</span><span class="string"></span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>472</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line472'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>473</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line473'><pre>
</pre></a></td></tr><tr><td valign='top'><small>474</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line474'><pre>    <span class="keyword">return</span> <span class="ident">all_outlinks</span>
</pre></a></td></tr><tr><td valign='top'><small>475</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line475'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>476</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line476'><pre>
</pre></a></td></tr><tr><td valign='top'><small>477</small></td><td valign='top'><ul><li>Duplication - calls he.identifier twice &raquo; reek</li><li>UncommunicativeName - has the variable name 'h' &raquo; reek</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line477'><pre>  <span class="keyword">def </span><span class="method">gbif_map_id</span>
</pre></a></td></tr><tr><td valign='top'><small>478</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line478'><pre>    <span class="keyword">return</span> <span class="attribute">@gbif_map_id</span> <span class="keyword">if</span> <span class="attribute">@gbif_map_id</span>
</pre></a></td></tr><tr><td valign='top'><small>479</small></td><td valign='top'><ul><li>Found = in conditional.  It should probably be an == &raquo; roodi</li></ul></td><td valign='top'><a name='line479'><pre>    <span class="keyword">if</span> <span class="ident">h</span> <span class="punct">=</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">gbif</span>
</pre></a></td></tr><tr><td valign='top'><small>480</small></td><td valign='top'><ul><li>Found = in conditional.  It should probably be an == &raquo; roodi</li></ul></td><td valign='top'><a name='line480'><pre>      <span class="keyword">if</span> <span class="ident">he</span> <span class="punct">=</span> <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">find_by_hierarchy_id_and_taxon_concept_id</span><span class="punct">(</span><span class="ident">h</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>481</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line481'><pre>        <span class="attribute">@gbif_map_id</span> <span class="punct">=</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">identifier</span>
</pre></a></td></tr><tr><td valign='top'><small>482</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line482'><pre>        <span class="keyword">return</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">identifier</span>
</pre></a></td></tr><tr><td valign='top'><small>483</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line483'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>484</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line484'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>485</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line485'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>486</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line486'><pre>
</pre></a></td></tr><tr><td valign='top'><small>487</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line487'><pre>  <span class="keyword">def </span><span class="method">has_citation?</span>
</pre></a></td></tr><tr><td valign='top'><small>488</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line488'><pre>    <span class="keyword">return</span> <span class="constant">false</span>
</pre></a></td></tr><tr><td valign='top'><small>489</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line489'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>490</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line490'><pre>
</pre></a></td></tr><tr><td valign='top'><small>491</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line491'><pre>  <span class="comment"># Singleton method to fetch the Hierarchy Entry, used for taxonomic relationships</span>
</pre></a></td></tr><tr><td valign='top'><small>492</small></td><td valign='top'><ul><li>Duplication - calls (he.hierarchy_id == hierarchy.id) twice &raquo; reek</li><li>Duplication - calls @all_entries.detect twice &raquo; reek</li><li>Duplication - calls he.hierarchy_id twice &raquo; reek</li><li>Duplication - calls hierarchy.id twice &raquo; reek</li><li>LongMethod - has approx 7 statements &raquo; reek</li><li>ControlCouple - has boolean parameter 'strict_lookup' &raquo; reek</li><li>ControlCouple - is controlled by argument strict_lookup &raquo; reek</li><li>Complexity 7 &raquo; saikuro</li></ul></td><td valign='top'><a name='line492'><pre>  <span class="keyword">def </span><span class="method">entry</span><span class="punct">(</span><span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">,</span> <span class="ident">strict_lookup</span> <span class="punct">=</span> <span class="constant">false</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>493</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line493'><pre>    <span class="ident">hierarchy</span> <span class="punct">||=</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">default</span>
</pre></a></td></tr><tr><td valign='top'><small>494</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line494'><pre>    <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Error finding default hierarchy</span><span class="punct">&quot;</span> <span class="keyword">if</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">nil?</span> <span class="comment"># EOLINFRASTRUCTURE-848</span>
</pre></a></td></tr><tr><td valign='top'><small>495</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line495'><pre>    <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Cannot find a HierarchyEntry with anything but a Hierarchy</span><span class="punct">&quot;</span> <span class="keyword">unless</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">is_a?</span> <span class="constant">Hierarchy</span>
</pre></a></td></tr><tr><td valign='top'><small>496</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line496'><pre>
</pre></a></td></tr><tr><td valign='top'><small>497</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line497'><pre>    <span class="attribute">@all_entries</span> <span class="punct">||=</span> <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">sort_by_vetted</span><span class="punct">(</span><span class="ident">published_hierarchy_entries</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>498</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line498'><pre>    <span class="keyword">if</span> <span class="attribute">@all_entries</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>499</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line499'><pre>      <span class="attribute">@all_entries</span> <span class="punct">=</span> <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">sort_by_vetted</span><span class="punct">(</span><span class="ident">hierarchy_entries</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>500</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line500'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>501</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line501'><pre>
</pre></a></td></tr><tr><td valign='top'><small>502</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line502'><pre>    <span class="comment"># we want ONLY the entry in this hierarchy</span>
</pre></a></td></tr><tr><td valign='top'><small>503</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line503'><pre>    <span class="keyword">if</span> <span class="ident">strict_lookup</span>
</pre></a></td></tr><tr><td valign='top'><small>504</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line504'><pre>      <span class="keyword">return</span> <span class="attribute">@all_entries</span><span class="punct">.</span><span class="ident">detect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy_id</span> <span class="punct">==</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}</span> <span class="punct">||</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>505</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line505'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>506</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line506'><pre>
</pre></a></td></tr><tr><td valign='top'><small>507</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line507'><pre>    <span class="keyword">return</span> <span class="attribute">@all_entries</span><span class="punct">.</span><span class="ident">detect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy_id</span> <span class="punct">==</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}</span> <span class="punct">||</span>
</pre></a></td></tr><tr><td valign='top'><small>508</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line508'><pre>      <span class="attribute">@all_entries</span><span class="punct">[</span><span class="number">0</span><span class="punct">]</span> <span class="punct">||</span>
</pre></a></td></tr><tr><td valign='top'><small>509</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line509'><pre>      <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>510</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line510'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>511</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line511'><pre>
</pre></a></td></tr><tr><td valign='top'><small>512</small></td><td valign='top'><ul><li>Duplication - calls he.hierarchy twice &raquo; reek</li><li>LowCohesion - refers to agent_id more than self &raquo; reek</li><li>LowCohesion - refers to he more than self &raquo; reek</li><li>LowCohesion - refers to matches more than self &raquo; reek</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line512'><pre>  <span class="keyword">def </span><span class="method">entry_for_agent</span><span class="punct">(</span><span class="ident">agent_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>513</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line513'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">agent_id</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">||</span> <span class="ident">agent_id</span> <span class="punct">==</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>514</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line514'><pre>    <span class="ident">matches</span> <span class="punct">=</span> <span class="ident">hierarchy_entries</span><span class="punct">.</span><span class="ident">select</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span> <span class="punct">&amp;&amp;</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">agent_id</span> <span class="punct">==</span> <span class="ident">agent_id</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>515</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line515'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">matches</span><span class="punct">.</span><span class="ident">empty?</span>
</pre></a></td></tr><tr><td valign='top'><small>516</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line516'><pre>    <span class="ident">matches</span><span class="punct">[</span><span class="number">0</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>517</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line517'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>518</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line518'><pre>
</pre></a></td></tr><tr><td valign='top'><small>519</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line519'><pre>  <span class="keyword">def </span><span class="method">self.entries_for_concepts</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">,</span> <span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">,</span> <span class="ident">strict_lookup</span> <span class="punct">=</span> <span class="constant">false</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>520</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line520'><pre>    <span class="ident">hierarchy</span> <span class="punct">||=</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">default</span>
</pre></a></td></tr><tr><td valign='top'><small>521</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line521'><pre>    <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Error finding default hierarchy</span><span class="punct">&quot;</span> <span class="keyword">if</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">nil?</span> <span class="comment"># EOLINFRASTRUCTURE-848</span>
</pre></a></td></tr><tr><td valign='top'><small>522</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line522'><pre>    <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Cannot find a HierarchyEntry with anything but a Hierarchy</span><span class="punct">&quot;</span> <span class="keyword">unless</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">class</span><span class="punct">.</span><span class="ident">to_s</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">Hierarchy</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>523</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line523'><pre>    <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Must get an array of taxon_concept_ids</span><span class="punct">&quot;</span> <span class="keyword">unless</span> <span class="ident">taxon_concept_ids</span><span class="punct">.</span><span class="ident">is_a?</span> <span class="constant">Array</span>
</pre></a></td></tr><tr><td valign='top'><small>524</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line524'><pre>
</pre></a></td></tr><tr><td valign='top'><small>525</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line525'><pre>    <span class="comment"># get all hierarchy entries</span>
</pre></a></td></tr><tr><td valign='top'><small>526</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line526'><pre>    <span class="ident">select</span> <span class="punct">=</span> <span class="punct">{</span><span class="symbol">:hierarchy_entries</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">',</span> <span class="symbol">:vetted</span> <span class="punct">=&gt;</span> <span class="symbol">:view_order</span><span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>527</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line527'><pre>    <span class="ident">all_entries</span> <span class="punct">=</span> <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">find_all_by_taxon_concept_id</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">,</span> <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="ident">select</span><span class="punct">,</span> <span class="symbol">:include</span> <span class="punct">=&gt;</span> <span class="symbol">:vetted</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>528</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line528'><pre>    <span class="comment"># ..and order them by published DESC, vetted view_order ASC, id ASC - earliest entry first</span>
</pre></a></td></tr><tr><td valign='top'><small>529</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line529'><pre>    <span class="ident">all_entries</span> <span class="punct">=</span> <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">sort_by_vetted</span><span class="punct">(</span><span class="ident">all_entries</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>530</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line530'><pre>
</pre></a></td></tr><tr><td valign='top'><small>531</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line531'><pre>    <span class="ident">concept_entries</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>532</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line532'><pre>    <span class="ident">all_entries</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">he</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>533</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line533'><pre>      <span class="ident">concept_entries</span><span class="punct">[</span><span class="ident">he</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">]</span> <span class="punct">||=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>534</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line534'><pre>      <span class="ident">concept_entries</span><span class="punct">[</span><span class="ident">he</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">]</span> <span class="punct">&lt;&lt;</span> <span class="ident">he</span>
</pre></a></td></tr><tr><td valign='top'><small>535</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line535'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>536</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line536'><pre>
</pre></a></td></tr><tr><td valign='top'><small>537</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line537'><pre>    <span class="ident">final_concept_entries</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>538</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line538'><pre>    <span class="comment"># we want ONLY the entry in this hierarchy</span>
</pre></a></td></tr><tr><td valign='top'><small>539</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line539'><pre>    <span class="keyword">if</span> <span class="ident">strict_lookup</span>
</pre></a></td></tr><tr><td valign='top'><small>540</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line540'><pre>      <span class="ident">concept_entries</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">taxon_concept_id</span><span class="punct">,</span> <span class="ident">entries</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>541</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line541'><pre>        <span class="ident">final_concept_entries</span><span class="punct">[</span><span class="ident">taxon_concept_id</span><span class="punct">]</span> <span class="punct">=</span> <span class="ident">entries</span><span class="punct">.</span><span class="ident">detect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy_id</span> <span class="punct">==</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}</span> <span class="punct">||</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>542</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line542'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>543</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line543'><pre>      <span class="keyword">return</span> <span class="ident">final_concept_entries</span>
</pre></a></td></tr><tr><td valign='top'><small>544</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line544'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>545</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line545'><pre>
</pre></a></td></tr><tr><td valign='top'><small>546</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line546'><pre>    <span class="ident">concept_entries</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">taxon_concept_id</span><span class="punct">,</span> <span class="ident">entries</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>547</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line547'><pre>      <span class="ident">final_concept_entries</span><span class="punct">[</span><span class="ident">taxon_concept_id</span><span class="punct">]</span> <span class="punct">=</span> <span class="ident">entries</span><span class="punct">.</span><span class="ident">detect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy_id</span> <span class="punct">==</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}</span> <span class="punct">||</span> <span class="ident">entries</span><span class="punct">[</span><span class="number">0</span><span class="punct">]</span> <span class="punct">||</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>548</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line548'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>549</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line549'><pre>    <span class="keyword">return</span> <span class="ident">final_concept_entries</span>
</pre></a></td></tr><tr><td valign='top'><small>550</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line550'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>551</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line551'><pre>
</pre></a></td></tr><tr><td valign='top'><small>552</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line552'><pre>  <span class="keyword">def </span><span class="method">self.ancestries_for_concepts</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">,</span> <span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>553</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line553'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">if</span> <span class="ident">taxon_concept_ids</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>554</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line554'><pre>    <span class="ident">concept_entries</span> <span class="punct">=</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">entries_for_concepts</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">,</span> <span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>555</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line555'><pre>    <span class="ident">hierarchy_entry_ids</span> <span class="punct">=</span> <span class="ident">concept_entries</span><span class="punct">.</span><span class="ident">values</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">||</span> <span class="constant">nil</span><span class="punct">}.</span><span class="ident">compact</span>
</pre></a></td></tr><tr><td valign='top'><small>556</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line556'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">if</span> <span class="ident">hierarchy_entry_ids</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>557</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line557'><pre>
</pre></a></td></tr><tr><td valign='top'><small>558</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line558'><pre>    <span class="ident">results</span> <span class="punct">=</span> <span class="constant">SpeciesSchemaModel</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">execute</span><span class="punct">(&quot;</span><span class="string"><span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>559</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line559'><pre>        <span class="constant">SELECT</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">,</span> <span class="ident">n</span><span class="punct">.</span><span class="ident">string</span> <span class="ident">name_string</span><span class="punct">,</span> <span class="ident">n_parent1</span><span class="punct">.</span><span class="ident">string</span> <span class="ident">parent_name_string</span><span class="punct">,</span> <span class="ident">n_parent2</span><span class="punct">.</span><span class="ident">string</span> <span class="ident">grandparent_name_string</span>
</pre></a></td></tr><tr><td valign='top'><small>560</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line560'><pre>        <span class="constant">FROM</span> <span class="ident">hierarchy_entries</span> <span class="ident">he</span>
</pre></a></td></tr><tr><td valign='top'><small>561</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line561'><pre>        <span class="constant">JOIN</span> <span class="ident">names</span> <span class="ident">n</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">name_id</span><span class="punct">=</span><span class="ident">n</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>562</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line562'><pre>        <span class="constant">LEFT</span> <span class="constant">JOIN</span> <span class="punct">(</span>
</pre></a></td></tr><tr><td valign='top'><small>563</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line563'><pre>          <span class="ident">hierarchy_entries</span> <span class="ident">he_parent1</span> <span class="constant">JOIN</span> <span class="ident">names</span> <span class="ident">n_parent1</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he_parent1</span><span class="punct">.</span><span class="ident">name_id</span><span class="punct">=</span><span class="ident">n_parent1</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>564</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line564'><pre>          <span class="constant">LEFT</span> <span class="constant">JOIN</span> <span class="punct">(</span>
</pre></a></td></tr><tr><td valign='top'><small>565</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line565'><pre>            <span class="ident">hierarchy_entries</span> <span class="ident">he_parent2</span> <span class="constant">JOIN</span> <span class="ident">names</span> <span class="ident">n_parent2</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he_parent2</span><span class="punct">.</span><span class="ident">name_id</span><span class="punct">=</span><span class="ident">n_parent2</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>566</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line566'><pre>          <span class="punct">)</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he_parent1</span><span class="punct">.</span><span class="ident">parent_id</span><span class="punct">=</span><span class="ident">he_parent2</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>567</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line567'><pre>        <span class="punct">)</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">parent_id</span><span class="punct">=</span><span class="ident">he_parent1</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>568</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line568'><pre>        <span class="constant">WHERE</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">id</span> <span class="constant">IN</span> <span class="punct">(</span><span class="comment">#{hierarchy_entry_ids.join(',')})&quot;).all_hashes</span>
</pre></a></td></tr><tr><td valign='top'><small>569</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line569'><pre>
</pre></a></td></tr><tr><td valign='top'><small>570</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line570'><pre>    <span class="ident">ancestries</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>571</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line571'><pre>    <span class="ident">results</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">r</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>572</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line572'><pre>      <span class="ident">r</span><span class="punct">['</span><span class="string">name_string</span><span class="punct">']</span> <span class="punct">=</span> <span class="ident">r</span><span class="punct">['</span><span class="string">name_string</span><span class="punct">'].</span><span class="ident">firstcap</span> <span class="keyword">if</span> <span class="ident">r</span><span class="punct">['</span><span class="string">name_string</span><span class="punct">']</span>
</pre></a></td></tr><tr><td valign='top'><small>573</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line573'><pre>      <span class="ident">r</span><span class="punct">['</span><span class="string">parent_name_string</span><span class="punct">']</span> <span class="punct">=</span> <span class="ident">r</span><span class="punct">['</span><span class="string">parent_name_string</span><span class="punct">'].</span><span class="ident">firstcap</span> <span class="keyword">if</span> <span class="ident">r</span><span class="punct">['</span><span class="string">parent_name_string</span><span class="punct">']</span>
</pre></a></td></tr><tr><td valign='top'><small>574</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line574'><pre>      <span class="ident">r</span><span class="punct">['</span><span class="string">grandparent_name_string</span><span class="punct">']</span> <span class="punct">=</span> <span class="ident">r</span><span class="punct">['</span><span class="string">grandparent_name_string</span><span class="punct">'].</span><span class="ident">firstcap</span> <span class="keyword">if</span> <span class="ident">r</span><span class="punct">['</span><span class="string">grandparent_name_string</span><span class="punct">']</span>
</pre></a></td></tr><tr><td valign='top'><small>575</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line575'><pre>      <span class="ident">ancestries</span><span class="punct">[</span><span class="ident">r</span><span class="punct">['</span><span class="string">taxon_concept_id</span><span class="punct">'].</span><span class="ident">to_i</span><span class="punct">]</span> <span class="punct">=</span> <span class="ident">r</span>
</pre></a></td></tr><tr><td valign='top'><small>576</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line576'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>577</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line577'><pre>    <span class="keyword">return</span> <span class="ident">ancestries</span>
</pre></a></td></tr><tr><td valign='top'><small>578</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line578'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>579</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line579'><pre>
</pre></a></td></tr><tr><td valign='top'><small>580</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line580'><pre>  <span class="keyword">def </span><span class="method">self.hierarchies_for_concepts</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">,</span> <span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>581</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line581'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">if</span> <span class="ident">taxon_concept_ids</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>582</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line582'><pre>    <span class="ident">concept_entries</span> <span class="punct">=</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">entries_for_concepts</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">,</span> <span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>583</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line583'><pre>    <span class="ident">hierarchy_entry_ids</span> <span class="punct">=</span> <span class="ident">concept_entries</span><span class="punct">.</span><span class="ident">values</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">||</span> <span class="constant">nil</span><span class="punct">}.</span><span class="ident">compact</span>
</pre></a></td></tr><tr><td valign='top'><small>584</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line584'><pre>
</pre></a></td></tr><tr><td valign='top'><small>585</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line585'><pre>    <span class="ident">results</span> <span class="punct">=</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">find_by_sql</span><span class="punct">(&quot;</span><span class="string"><span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>586</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line586'><pre>        <span class="constant">SELECT</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">,</span> <span class="ident">h</span><span class="punct">.*</span>
</pre></a></td></tr><tr><td valign='top'><small>587</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line587'><pre>        <span class="constant">FROM</span> <span class="ident">hierarchy_entries</span> <span class="ident">he</span>
</pre></a></td></tr><tr><td valign='top'><small>588</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line588'><pre>        <span class="constant">JOIN</span> <span class="ident">hierarchies</span> <span class="ident">h</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy_id</span><span class="punct">=</span><span class="ident">h</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>589</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line589'><pre>        <span class="constant">WHERE</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">id</span> <span class="constant">IN</span> <span class="punct">(</span><span class="comment">#{hierarchy_entry_ids.join(',')})&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>590</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line590'><pre>
</pre></a></td></tr><tr><td valign='top'><small>591</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line591'><pre>    <span class="ident">hierarchies</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>592</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line592'><pre>    <span class="ident">results</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">r</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>593</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line593'><pre>      <span class="ident">hierarchies</span><span class="punct">[</span><span class="ident">r</span><span class="punct">['</span><span class="string">taxon_concept_id</span><span class="punct">'].</span><span class="ident">to_i</span><span class="punct">]</span> <span class="punct">=</span> <span class="ident">r</span>
</pre></a></td></tr><tr><td valign='top'><small>594</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line594'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>595</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line595'><pre>    <span class="keyword">return</span> <span class="ident">hierarchies</span>
</pre></a></td></tr><tr><td valign='top'><small>596</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line596'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>597</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line597'><pre>
</pre></a></td></tr><tr><td valign='top'><small>598</small></td><td valign='top'><ul><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line598'><pre>  <span class="keyword">def </span><span class="method">entry_in_hierarchy</span><span class="punct">(</span><span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>599</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line599'><pre>    <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Hierarchy does not exist</span><span class="punct">&quot;</span> <span class="keyword">if</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>600</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line600'><pre>    <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Cannot find a HierarchyEntry with anything but a Hierarchy</span><span class="punct">&quot;</span> <span class="keyword">unless</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">is_a?</span> <span class="constant">Hierarchy</span>
</pre></a></td></tr><tr><td valign='top'><small>601</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line601'><pre>    <span class="keyword">return</span> <span class="ident">hierarchy_entries</span><span class="punct">.</span><span class="ident">detect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy_id</span> <span class="punct">==</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}</span> <span class="punct">||</span>
</pre></a></td></tr><tr><td valign='top'><small>602</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line602'><pre>      <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>603</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line603'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>604</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line604'><pre>
</pre></a></td></tr><tr><td valign='top'><small>605</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line605'><pre>  <span class="comment"># These are methods that are specific to a hierarchy, so we have to handle them through entry:</span>
</pre></a></td></tr><tr><td valign='top'><small>606</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line606'><pre>  <span class="comment"># This was handled using delegate, before, but seemed to be causing problems, so I'm making it explicit:</span>
</pre></a></td></tr><tr><td valign='top'><small>607</small></td><td valign='top'><ul><li>LowCohesion - refers to h_entry more than self &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line607'><pre>  <span class="keyword">def </span><span class="method">kingdom</span><span class="punct">(</span><span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>608</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line608'><pre>    <span class="ident">h_entry</span> <span class="punct">=</span> <span class="ident">entry</span><span class="punct">(</span><span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>609</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line609'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">h_entry</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>610</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line610'><pre>    <span class="keyword">return</span> <span class="ident">h_entry</span><span class="punct">.</span><span class="ident">kingdom</span><span class="punct">(</span><span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>611</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line611'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>612</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line612'><pre>
</pre></a></td></tr><tr><td valign='top'><small>613</small></td><td valign='top'><ul><li>Duplication - calls id 3 times &raquo; reek</li><li>Duplication - calls tcf.ancestor_id twice &raquo; reek</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line613'><pre>  <span class="keyword">def </span><span class="method">all_ancestor_taxon_concept_ids</span>
</pre></a></td></tr><tr><td valign='top'><small>614</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line614'><pre>    <span class="keyword">return</span> <span class="attribute">@complete_ancestor_concept_ids</span> <span class="keyword">if</span> <span class="attribute">@complete_ancestor_concept_ids</span>
</pre></a></td></tr><tr><td valign='top'><small>615</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line615'><pre>    <span class="ident">ancestor_concept_ids</span> <span class="punct">=</span> <span class="constant">TaxonConceptsFlattened</span><span class="punct">.</span><span class="ident">find_all_by_taxon_concept_id</span><span class="punct">(</span><span class="ident">id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>616</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line616'><pre>      <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">ancestor_id</span><span class="punct">').</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">tcf</span><span class="punct">|</span> <span class="ident">tcf</span><span class="punct">.</span><span class="ident">ancestor_id</span> <span class="punct">}</span> <span class="punct">+</span> <span class="punct">[</span><span class="ident">id</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>617</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line617'><pre>    <span class="attribute">@complete_ancestor_concept_ids</span> <span class="punct">=</span> <span class="constant">TaxonConceptsFlattened</span><span class="punct">.</span><span class="ident">find_all_by_taxon_concept_id</span><span class="punct">(</span><span class="ident">ancestor_concept_ids</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>618</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line618'><pre>      <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">ancestor_id</span><span class="punct">').</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">tcf</span><span class="punct">|</span> <span class="ident">tcf</span><span class="punct">.</span><span class="ident">ancestor_id</span> <span class="punct">}</span> <span class="punct">+</span> <span class="punct">[</span><span class="ident">id</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>619</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line619'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>620</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line620'><pre>
</pre></a></td></tr><tr><td valign='top'><small>621</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line621'><pre>  <span class="comment"># # general versions of the above methods for any hierarchy</span>
</pre></a></td></tr><tr><td valign='top'><small>622</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line622'><pre>  <span class="comment"># def find_ancestor_in_hierarchy(hierarchy)</span>
</pre></a></td></tr><tr><td valign='top'><small>623</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line623'><pre>  <span class="comment">#   entry_in_hierarchy = HierarchyEntry.find_by_taxon_concept_id_and_hierarchy_id(all_ancestor_taxon_concept_ids, hierarchy.id, :order =&gt; 'lft desc')</span>
</pre></a></td></tr><tr><td valign='top'><small>624</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line624'><pre>  <span class="comment"># end</span>
</pre></a></td></tr><tr><td valign='top'><small>625</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line625'><pre>
</pre></a></td></tr><tr><td valign='top'><small>626</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line626'><pre>  <span class="comment"># general versions of the above methods for any hierarchy</span>
</pre></a></td></tr><tr><td valign='top'><small>627</small></td><td valign='top'><ul><li>Duplication - calls published_hierarchy_entries twice &raquo; reek</li><li>Complexity 5 &raquo; saikuro</li></ul></td><td valign='top'><a name='line627'><pre>  <span class="keyword">def </span><span class="method">find_ancestor_in_hierarchy</span><span class="punct">(</span><span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>628</small></td><td valign='top'><ul><li>Found = in conditional.  It should probably be an == &raquo; roodi</li></ul></td><td valign='top'><a name='line628'><pre>    <span class="keyword">if</span> <span class="ident">he</span> <span class="punct">=</span> <span class="ident">published_hierarchy_entries</span><span class="punct">.</span><span class="ident">detect</span> <span class="punct">{|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy_id</span> <span class="punct">==</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>629</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line629'><pre>      <span class="keyword">return</span> <span class="ident">he</span>
</pre></a></td></tr><tr><td valign='top'><small>630</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line630'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>631</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line631'><pre>    <span class="ident">published_hierarchy_entries</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">entry</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>632</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line632'><pre>      <span class="ident">this_entry_in</span> <span class="punct">=</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">find_ancestor_in_hierarchy</span><span class="punct">(</span><span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>633</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line633'><pre>      <span class="keyword">return</span> <span class="ident">this_entry_in</span> <span class="keyword">if</span> <span class="ident">this_entry_in</span>
</pre></a></td></tr><tr><td valign='top'><small>634</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line634'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>635</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line635'><pre>    <span class="keyword">return</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>636</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line636'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>637</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line637'><pre>
</pre></a></td></tr><tr><td valign='top'><small>638</small></td><td valign='top'><ul><li>ControlCouple - is controlled by argument search_hierarchy &raquo; reek</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line638'><pre>  <span class="keyword">def </span><span class="method">in_hierarchy?</span><span class="punct">(</span><span class="ident">search_hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>639</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line639'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">unless</span> <span class="ident">search_hierarchy</span>
</pre></a></td></tr><tr><td valign='top'><small>640</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line640'><pre>    <span class="ident">entries</span> <span class="punct">=</span> <span class="ident">published_hierarchy_entries</span><span class="punct">.</span><span class="ident">detect</span> <span class="punct">{|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy_id</span> <span class="punct">==</span> <span class="ident">search_hierarchy</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>641</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line641'><pre>    <span class="keyword">return</span> <span class="ident">entries</span><span class="punct">.</span><span class="ident">nil?</span> <span class="punct">?</span> <span class="constant">false</span> <span class="punct">:</span> <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>642</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line642'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>643</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line643'><pre>
</pre></a></td></tr><tr><td valign='top'><small>644</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line644'><pre>  <span class="keyword">def </span><span class="method">self.find_entry_in_hierarchy</span><span class="punct">(</span><span class="ident">taxon_concept_id</span><span class="punct">,</span> <span class="ident">hierarchy_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>645</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line645'><pre>    <span class="keyword">return</span> <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">find_by_sql</span><span class="punct">(&quot;</span><span class="string">SELECT he.* FROM hierarchy_entries he WHERE taxon_concept_id=<span class="expr">#{taxon_concept_id}</span> AND hierarchy_id=<span class="expr">#{hierarchy_id}</span> LIMIT 1</span><span class="punct">&quot;).</span><span class="ident">first</span>
</pre></a></td></tr><tr><td valign='top'><small>646</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line646'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>647</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line647'><pre>
</pre></a></td></tr><tr><td valign='top'><small>648</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line648'><pre>  <span class="comment"># We do have some content that is specific to COL, so we need a method that will ALWAYS reference it:</span>
</pre></a></td></tr><tr><td valign='top'><small>649</small></td><td valign='top'><ul><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line649'><pre>  <span class="keyword">def </span><span class="method">col_entry</span>
</pre></a></td></tr><tr><td valign='top'><small>650</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line650'><pre>    <span class="keyword">return</span> <span class="attribute">@col_entry</span> <span class="keyword">unless</span> <span class="attribute">@col_entry</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>651</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line651'><pre>    <span class="ident">hierarchy_id</span> <span class="punct">=</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">default</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>652</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line652'><pre>    <span class="keyword">return</span> <span class="attribute">@col_entry</span> <span class="punct">=</span> <span class="ident">published_hierarchy_entries</span><span class="punct">.</span><span class="ident">detect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy_id</span> <span class="punct">==</span> <span class="ident">hierarchy_id</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>653</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line653'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>654</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line654'><pre>
</pre></a></td></tr><tr><td valign='top'><small>655</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line655'><pre>  <span class="comment"># TODO - we won't need this, soon.  Delete it.  (ATM it's still used in an old videos partial)</span>
</pre></a></td></tr><tr><td valign='top'><small>656</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line656'><pre>  <span class="keyword">def </span><span class="method">has_video</span>
</pre></a></td></tr><tr><td valign='top'><small>657</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line657'><pre>    <span class="ident">available_media</span> <span class="keyword">if</span> <span class="attribute">@has_media</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>658</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line658'><pre>    <span class="attribute">@has_media</span><span class="punct">[</span><span class="symbol">:video</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>659</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line659'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>660</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line660'><pre>
</pre></a></td></tr><tr><td valign='top'><small>661</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line661'><pre>  <span class="comment"># TODO - we won't need this, soon.  Delete it.  (ATM it's still used in an old mediacenter partial)</span>
</pre></a></td></tr><tr><td valign='top'><small>662</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line662'><pre>  <span class="keyword">def </span><span class="method">show_video_tab</span>
</pre></a></td></tr><tr><td valign='top'><small>663</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line663'><pre>    <span class="comment"># checks logged-in user and/or logged-in content partner and also considers the existence of un-published videos, if Video tab is to be displayed</span>
</pre></a></td></tr><tr><td valign='top'><small>664</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line664'><pre>    <span class="keyword">return</span> <span class="punct">(</span><span class="ident">videos</span><span class="punct">.</span><span class="ident">length</span> <span class="punct">&gt;</span> <span class="number">0</span> <span class="punct">?</span> <span class="constant">true</span> <span class="punct">:</span> <span class="constant">false</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>665</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line665'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>666</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line666'><pre>
</pre></a></td></tr><tr><td valign='top'><small>667</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line667'><pre>  <span class="comment"># TODO - we won't need this, soon.  Delete it.  (ATM it's still used in an old mediacenter partial)</span>
</pre></a></td></tr><tr><td valign='top'><small>668</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line668'><pre>  <span class="keyword">def </span><span class="method">has_map</span>
</pre></a></td></tr><tr><td valign='top'><small>669</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line669'><pre>    <span class="ident">available_media</span> <span class="keyword">if</span> <span class="attribute">@has_media</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>670</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line670'><pre>    <span class="attribute">@has_media</span><span class="punct">[</span><span class="symbol">:map</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>671</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line671'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>672</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line672'><pre>
</pre></a></td></tr><tr><td valign='top'><small>673</small></td><td valign='top'><ul><li>Duplication - calls entry.hierarchies_content 5 times &raquo; reek</li><li>LongMethod - has approx 8 statements &raquo; reek</li><li>LowCohesion - refers to entry more than self &raquo; reek</li><li>Method name "available_media" cyclomatic complexity is 9.  It should be 8 or less. &raquo; roodi</li><li>Complexity 7 &raquo; saikuro</li></ul></td><td valign='top'><a name='line673'><pre>  <span class="keyword">def </span><span class="method">available_media</span>
</pre></a></td></tr><tr><td valign='top'><small>674</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line674'><pre>    <span class="comment"># This method disregards whether there is a logged-in user or none</span>
</pre></a></td></tr><tr><td valign='top'><small>675</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line675'><pre>    <span class="ident">images</span> <span class="punct">=</span> <span class="ident">video</span> <span class="punct">=</span> <span class="ident">map</span> <span class="punct">=</span> <span class="constant">false</span>
</pre></a></td></tr><tr><td valign='top'><small>676</small></td><td valign='top'><ul><li>Block cyclomatic complexity is 8.  It should be 4 or less. &raquo; roodi</li></ul></td><td valign='top'><a name='line676'><pre>    <span class="ident">published_hierarchy_entries</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">entry</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>677</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line677'><pre>        <span class="keyword">next</span> <span class="keyword">if</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">hierarchies_content</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>678</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line678'><pre>        <span class="ident">images</span> <span class="punct">=</span> <span class="constant">true</span> <span class="keyword">if</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">hierarchies_content</span><span class="punct">.</span><span class="ident">image</span> <span class="punct">!=</span> <span class="number">0</span> <span class="punct">||</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">hierarchies_content</span><span class="punct">.</span><span class="ident">child_image</span> <span class="punct">!=</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>679</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line679'><pre>        <span class="ident">video</span> <span class="punct">=</span> <span class="constant">true</span> <span class="keyword">if</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">hierarchies_content</span><span class="punct">.</span><span class="ident">flash</span> <span class="punct">!=</span> <span class="number">0</span> <span class="punct">||</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">hierarchies_content</span><span class="punct">.</span><span class="ident">youtube</span> <span class="punct">!=</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>680</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line680'><pre>        <span class="keyword">break</span> <span class="keyword">if</span> <span class="ident">images</span> <span class="punct">&amp;&amp;</span> <span class="ident">video</span>
</pre></a></td></tr><tr><td valign='top'><small>681</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line681'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>682</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line682'><pre>    <span class="ident">map</span> <span class="punct">=</span> <span class="constant">true</span> <span class="keyword">if</span> <span class="ident">gbif_map_id</span>
</pre></a></td></tr><tr><td valign='top'><small>683</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line683'><pre>    <span class="attribute">@has_media</span> <span class="punct">=</span> <span class="punct">{</span><span class="symbol">:images</span> <span class="punct">=&gt;</span> <span class="ident">images</span><span class="punct">,</span> <span class="symbol">:video</span> <span class="punct">=&gt;</span> <span class="ident">video</span><span class="punct">,</span> <span class="symbol">:map</span> <span class="punct">=&gt;</span> <span class="ident">map</span><span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>684</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line684'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>685</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line685'><pre>
</pre></a></td></tr><tr><td valign='top'><small>686</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line686'><pre>  <span class="keyword">def </span><span class="method">has_name?</span>
</pre></a></td></tr><tr><td valign='top'><small>687</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line687'><pre>    <span class="keyword">return</span> <span class="ident">content_level</span> <span class="punct">!=</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>688</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line688'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>689</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line689'><pre>
</pre></a></td></tr><tr><td valign='top'><small>690</small></td><td valign='top'><ul><li>LongMethod - has approx 6 statements &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line690'><pre>  <span class="keyword">def </span><span class="method">quick_common_name</span><span class="punct">(</span><span class="ident">language</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">,</span> <span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>691</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line691'><pre>    <span class="ident">language</span> <span class="punct">||=</span> <span class="ident">current_user</span><span class="punct">.</span><span class="ident">language</span>
</pre></a></td></tr><tr><td valign='top'><small>692</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line692'><pre>    <span class="ident">hierarchy</span> <span class="punct">||=</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">default</span>
</pre></a></td></tr><tr><td valign='top'><small>693</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line693'><pre>    <span class="ident">common_name_results</span> <span class="punct">=</span> <span class="constant">SpeciesSchemaModel</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">execute</span><span class="punct">(&quot;</span><span class="string">SELECT n.string name, he.hierarchy_id source_hierarchy_id FROM taxon_concept_names tcn JOIN names n ON (tcn.name_id = n.id) LEFT JOIN hierarchy_entries he ON (tcn.source_hierarchy_entry_id = he.id) WHERE tcn.taxon_concept_id=<span class="expr">#{id}</span> AND language_id=<span class="expr">#{language.id}</span> AND preferred=1</span><span class="punct">&quot;).</span><span class="ident">all_hashes</span>
</pre></a></td></tr><tr><td valign='top'><small>694</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line694'><pre>
</pre></a></td></tr><tr><td valign='top'><small>695</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line695'><pre>    <span class="ident">final_name</span> <span class="punct">=</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>696</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line696'><pre>
</pre></a></td></tr><tr><td valign='top'><small>697</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line697'><pre>    <span class="comment"># This loop is to check to make sure the default hierarchy's preferred name takes precedence over other hierarchy's preferred names</span>
</pre></a></td></tr><tr><td valign='top'><small>698</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line698'><pre>    <span class="ident">common_name_results</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">result</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>699</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line699'><pre>      <span class="keyword">if</span> <span class="ident">final_name</span> <span class="punct">==</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span> <span class="punct">||</span> <span class="ident">result</span><span class="punct">['</span><span class="string">source_hierarchy_id</span><span class="punct">'].</span><span class="ident">to_i</span> <span class="punct">==</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>700</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line700'><pre>        <span class="ident">final_name</span> <span class="punct">=</span> <span class="ident">result</span><span class="punct">['</span><span class="string">name</span><span class="punct">'].</span><span class="ident">firstcap</span>
</pre></a></td></tr><tr><td valign='top'><small>701</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line701'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>702</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line702'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>703</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line703'><pre>    <span class="keyword">return</span> <span class="ident">final_name</span>
</pre></a></td></tr><tr><td valign='top'><small>704</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line704'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>705</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line705'><pre>
</pre></a></td></tr><tr><td valign='top'><small>706</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line706'><pre>  <span class="keyword">def </span><span class="method">self.quick_common_names</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">,</span> <span class="ident">language</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">,</span> <span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>707</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line707'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">if</span> <span class="ident">taxon_concept_ids</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>708</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line708'><pre>    <span class="ident">language</span>  <span class="punct">||=</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">current_user_static</span><span class="punct">.</span><span class="ident">language</span>
</pre></a></td></tr><tr><td valign='top'><small>709</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line709'><pre>    <span class="ident">hierarchy</span> <span class="punct">||=</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">default</span>
</pre></a></td></tr><tr><td valign='top'><small>710</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line710'><pre>    <span class="ident">common_name_results</span> <span class="punct">=</span> <span class="constant">SpeciesSchemaModel</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">execute</span><span class="punct">(&quot;</span><span class="string">SELECT n.string name, he.hierarchy_id source_hierarchy_id, tcn.taxon_concept_id FROM taxon_concept_names tcn JOIN names n ON (tcn.name_id = n.id) LEFT JOIN hierarchy_entries he ON (tcn.source_hierarchy_entry_id = he.id) WHERE tcn.taxon_concept_id IN (<span class="expr">#{taxon_concept_ids.join(',')}</span>) AND language_id=<span class="expr">#{language.id}</span> AND preferred=1</span><span class="punct">&quot;).</span><span class="ident">all_hashes</span>
</pre></a></td></tr><tr><td valign='top'><small>711</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line711'><pre>
</pre></a></td></tr><tr><td valign='top'><small>712</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line712'><pre>    <span class="ident">concept_names</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>713</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line713'><pre>    <span class="ident">taxon_concept_ids</span><span class="punct">.</span><span class="ident">each</span><span class="punct">{|</span><span class="ident">id</span><span class="punct">|</span> <span class="ident">concept_names</span><span class="punct">[</span><span class="ident">id</span><span class="punct">.</span><span class="ident">to_i</span><span class="punct">]</span> <span class="punct">=</span> <span class="constant">nil</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>714</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line714'><pre>    <span class="ident">common_name_results</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">r</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>715</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line715'><pre>      <span class="keyword">if</span> <span class="ident">concept_names</span><span class="punct">[</span><span class="ident">r</span><span class="punct">['</span><span class="string">taxon_concept_id</span><span class="punct">'].</span><span class="ident">to_i</span><span class="punct">].</span><span class="ident">blank?</span> <span class="punct">||</span> <span class="ident">r</span><span class="punct">['</span><span class="string">source_hierarchy_id</span><span class="punct">'].</span><span class="ident">to_i</span> <span class="punct">==</span> <span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>716</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line716'><pre>        <span class="ident">concept_names</span><span class="punct">[</span><span class="ident">r</span><span class="punct">['</span><span class="string">taxon_concept_id</span><span class="punct">'].</span><span class="ident">to_i</span><span class="punct">]</span> <span class="punct">=</span> <span class="ident">r</span><span class="punct">['</span><span class="string">name</span><span class="punct">'].</span><span class="ident">firstcap</span>
</pre></a></td></tr><tr><td valign='top'><small>717</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line717'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>718</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line718'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>719</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line719'><pre>    <span class="keyword">return</span> <span class="ident">concept_names</span>
</pre></a></td></tr><tr><td valign='top'><small>720</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line720'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>721</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line721'><pre>
</pre></a></td></tr><tr><td valign='top'><small>722</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line722'><pre>
</pre></a></td></tr><tr><td valign='top'><small>723</small></td><td valign='top'><ul><li>LongMethod - has approx 7 statements &raquo; reek</li><li>LowCohesion - refers to hierarchy_entry more than self &raquo; reek</li><li>LowCohesion - refers to search_type more than self &raquo; reek</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line723'><pre>  <span class="keyword">def </span><span class="method">quick_scientific_name</span><span class="punct">(</span><span class="ident">type</span> <span class="punct">=</span> <span class="symbol">:normal</span><span class="punct">,</span> <span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>724</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line724'><pre>    <span class="ident">hierarchy_entry</span> <span class="punct">=</span> <span class="ident">entry</span><span class="punct">(</span><span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>725</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line725'><pre>    <span class="comment"># if hierarchy_entry is nil then this concept has no entries, and shouldn't be published</span>
</pre></a></td></tr><tr><td valign='top'><small>726</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line726'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">hierarchy_entry</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>727</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line727'><pre>
</pre></a></td></tr><tr><td valign='top'><small>728</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line728'><pre>    <span class="ident">search_type</span> <span class="punct">=</span> <span class="keyword">case</span> <span class="ident">type</span>
</pre></a></td></tr><tr><td valign='top'><small>729</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line729'><pre>      <span class="keyword">when</span> <span class="symbol">:italicized</span>  <span class="keyword">then</span> <span class="punct">{</span><span class="symbol">:name_field</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">n.italicized</span><span class="punct">',</span> <span class="symbol">:also_join</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">'}</span>
</pre></a></td></tr><tr><td valign='top'><small>730</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line730'><pre>      <span class="keyword">when</span> <span class="symbol">:canonical</span>   <span class="keyword">then</span> <span class="punct">{</span><span class="symbol">:name_field</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">cf.string</span><span class="punct">',</span>    <span class="symbol">:also_join</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">JOIN canonical_forms cf ON (n.canonical_form_id = cf.id)</span><span class="punct">'}</span>
</pre></a></td></tr><tr><td valign='top'><small>731</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line731'><pre>      <span class="keyword">else</span>                   <span class="punct">{</span><span class="symbol">:name_field</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">n.string</span><span class="punct">',</span>     <span class="symbol">:also_join</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">'}</span>
</pre></a></td></tr><tr><td valign='top'><small>732</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line732'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>733</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line733'><pre>
</pre></a></td></tr><tr><td valign='top'><small>734</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line734'><pre>    <span class="ident">scientific_name_results</span> <span class="punct">=</span> <span class="constant">SpeciesSchemaModel</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">execute</span><span class="punct">(</span>
</pre></a></td></tr><tr><td valign='top'><small>735</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line735'><pre>      <span class="punct">&quot;</span><span class="string">SELECT <span class="expr">#{search_type[:name_field]}</span> name, he.hierarchy_id source_hierarchy_id<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>736</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line736'><pre>       <span class="constant">FROM</span> <span class="ident">hierarchy_entries</span> <span class="ident">he</span> <span class="constant">JOIN</span> <span class="ident">names</span> <span class="ident">n</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">name_id</span> <span class="punct">=</span> <span class="ident">n</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span> <span class="comment">#{search_type[:also_join]}</span>
</pre></a></td></tr><tr><td valign='top'><small>737</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line737'><pre>       <span class="constant">WHERE</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">id</span><span class="punct">=</span><span class="comment">#{hierarchy_entry.id}&quot;).all_hashes</span>
</pre></a></td></tr><tr><td valign='top'><small>738</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line738'><pre>
</pre></a></td></tr><tr><td valign='top'><small>739</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line739'><pre>    <span class="ident">final_name</span> <span class="punct">=</span> <span class="ident">scientific_name_results</span><span class="punct">[</span><span class="number">0</span><span class="punct">]['</span><span class="string">name</span><span class="punct">'].</span><span class="ident">firstcap</span>
</pre></a></td></tr><tr><td valign='top'><small>740</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line740'><pre>    <span class="keyword">return</span> <span class="ident">final_name</span>
</pre></a></td></tr><tr><td valign='top'><small>741</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line741'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>742</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line742'><pre>
</pre></a></td></tr><tr><td valign='top'><small>743</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line743'><pre>  <span class="keyword">def </span><span class="method">self.quick_scientific_names</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">,</span> <span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>744</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line744'><pre>    <span class="ident">concept_entries</span> <span class="punct">=</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">entries_for_concepts</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">,</span> <span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>745</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line745'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">concept_entries</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>746</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line746'><pre>
</pre></a></td></tr><tr><td valign='top'><small>747</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line747'><pre>    <span class="ident">hierarchy_entry_ids</span> <span class="punct">=</span> <span class="ident">concept_entries</span><span class="punct">.</span><span class="ident">values</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">||</span> <span class="constant">nil</span><span class="punct">}.</span><span class="ident">compact</span>
</pre></a></td></tr><tr><td valign='top'><small>748</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line748'><pre>    <span class="ident">scientific_name_results</span> <span class="punct">=</span> <span class="constant">SpeciesSchemaModel</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">execute</span><span class="punct">(</span>
</pre></a></td></tr><tr><td valign='top'><small>749</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line749'><pre>      <span class="punct">&quot;</span><span class="string">SELECT n.string name_string, n.italicized, he.hierarchy_id source_hierarchy_id, he.taxon_concept_id, he.rank_id<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>750</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line750'><pre>       <span class="constant">FROM</span> <span class="ident">hierarchy_entries</span> <span class="ident">he</span> <span class="constant">LEFT</span> <span class="constant">JOIN</span> <span class="ident">names</span> <span class="ident">n</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">name_id</span> <span class="punct">=</span> <span class="ident">n</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>751</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line751'><pre>       <span class="constant">WHERE</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">id</span> <span class="constant">IN</span> <span class="punct">(</span><span class="comment">#{hierarchy_entry_ids.join(',')})&quot;).all_hashes</span>
</pre></a></td></tr><tr><td valign='top'><small>752</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line752'><pre>
</pre></a></td></tr><tr><td valign='top'><small>753</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line753'><pre>    <span class="ident">concept_names</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>754</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line754'><pre>    <span class="ident">scientific_name_results</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">r</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>755</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line755'><pre>      <span class="keyword">if</span> <span class="ident">concept_names</span><span class="punct">[</span><span class="ident">r</span><span class="punct">['</span><span class="string">taxon_concept_id</span><span class="punct">'].</span><span class="ident">to_i</span><span class="punct">].</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>756</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line756'><pre>        <span class="ident">name_string</span> <span class="punct">=</span> <span class="constant">Rank</span><span class="punct">.</span><span class="ident">italicized_ids</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">r</span><span class="punct">['</span><span class="string">rank_id</span><span class="punct">'].</span><span class="ident">to_i</span><span class="punct">)</span> <span class="punct">?</span> <span class="ident">r</span><span class="punct">['</span><span class="string">italicized</span><span class="punct">']</span> <span class="punct">:</span> <span class="ident">r</span><span class="punct">['</span><span class="string">name_string</span><span class="punct">']</span>
</pre></a></td></tr><tr><td valign='top'><small>757</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line757'><pre>        <span class="ident">concept_names</span><span class="punct">[</span><span class="ident">r</span><span class="punct">['</span><span class="string">taxon_concept_id</span><span class="punct">'].</span><span class="ident">to_i</span><span class="punct">]</span> <span class="punct">=</span> <span class="ident">name_string</span><span class="punct">.</span><span class="ident">firstcap</span>
</pre></a></td></tr><tr><td valign='top'><small>758</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line758'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>759</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line759'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>760</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line760'><pre>    <span class="keyword">return</span> <span class="ident">concept_names</span>
</pre></a></td></tr><tr><td valign='top'><small>761</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line761'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>762</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line762'><pre>
</pre></a></td></tr><tr><td valign='top'><small>763</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line763'><pre>
</pre></a></td></tr><tr><td valign='top'><small>764</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line764'><pre>  <span class="keyword">def </span><span class="method">superceded_the_requested_id?</span>
</pre></a></td></tr><tr><td valign='top'><small>765</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line765'><pre>    <span class="attribute">@superceded_the_requested_id</span>
</pre></a></td></tr><tr><td valign='top'><small>766</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line766'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>767</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line767'><pre>
</pre></a></td></tr><tr><td valign='top'><small>768</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line768'><pre>  <span class="keyword">def </span><span class="method">superceded_the_requested_id</span>
</pre></a></td></tr><tr><td valign='top'><small>769</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line769'><pre>    <span class="attribute">@superceded_the_requested_id</span> <span class="punct">=</span> <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>770</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line770'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>771</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line771'><pre>  <span class="comment"># # Some TaxonConcepts are &quot;superceded&quot; by others, and we need to follow the chain (up to a sane limit):</span>
</pre></a></td></tr><tr><td valign='top'><small>772</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line772'><pre>  <span class="comment"># def self.find_with_supercedure(taxon_concept_id, level = 0)</span>
</pre></a></td></tr><tr><td valign='top'><small>773</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line773'><pre>  <span class="comment">#   level += 1</span>
</pre></a></td></tr><tr><td valign='top'><small>774</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line774'><pre>  <span class="comment">#   raise &quot;Supercedure stack is 7 levels deep&quot; if level == 7</span>
</pre></a></td></tr><tr><td valign='top'><small>775</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line775'><pre>  <span class="comment">#   tc = TaxonConcept.find(taxon_concept_id)</span>
</pre></a></td></tr><tr><td valign='top'><small>776</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line776'><pre>  <span class="comment">#   return tc if (tc.supercedure_id == 0 || tc == nil)</span>
</pre></a></td></tr><tr><td valign='top'><small>777</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line777'><pre>  <span class="comment">#   self.find_with_supercedure(tc.supercedure_id, level)</span>
</pre></a></td></tr><tr><td valign='top'><small>778</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line778'><pre>  <span class="comment"># end</span>
</pre></a></td></tr><tr><td valign='top'><small>779</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line779'><pre>
</pre></a></td></tr><tr><td valign='top'><small>780</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line780'><pre>  <span class="comment"># Some TaxonConcepts are &quot;superceded&quot; by others, and we need to follow the chain (up to a sane limit):</span>
</pre></a></td></tr><tr><td valign='top'><small>781</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line781'><pre>  <span class="keyword">def </span><span class="method">self.find_with_supercedure</span><span class="punct">(*</span><span class="ident">args</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>782</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line782'><pre>    <span class="ident">concept</span> <span class="punct">=</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">find_without_supercedure</span><span class="punct">(*</span><span class="ident">args</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>783</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line783'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">concept</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>784</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line784'><pre>    <span class="keyword">return</span> <span class="ident">concept</span> <span class="keyword">unless</span> <span class="ident">concept</span><span class="punct">.</span><span class="ident">respond_to?</span> <span class="symbol">:supercedure_id</span> <span class="comment"># sometimes it's an array.</span>
</pre></a></td></tr><tr><td valign='top'><small>785</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line785'><pre>    <span class="keyword">return</span> <span class="ident">concept</span> <span class="keyword">if</span> <span class="ident">concept</span><span class="punct">.</span><span class="ident">supercedure_id</span> <span class="punct">==</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>786</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line786'><pre>    <span class="ident">attempts</span> <span class="punct">=</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>787</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line787'><pre>    <span class="keyword">while</span> <span class="ident">concept</span><span class="punct">.</span><span class="ident">supercedure_id</span> <span class="punct">!=</span> <span class="number">0</span> <span class="keyword">and</span> <span class="ident">attempts</span> <span class="punct">&lt;=</span> <span class="number">6</span>
</pre></a></td></tr><tr><td valign='top'><small>788</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line788'><pre>      <span class="ident">concept</span> <span class="punct">=</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">find_without_supercedure</span><span class="punct">(</span><span class="ident">concept</span><span class="punct">.</span><span class="ident">supercedure_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>789</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line789'><pre>      <span class="ident">attempts</span> <span class="punct">+=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>790</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line790'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>791</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line791'><pre>    <span class="ident">concept</span><span class="punct">.</span><span class="ident">superceded_the_requested_id</span> <span class="comment"># Sets a flag that we can check later.</span>
</pre></a></td></tr><tr><td valign='top'><small>792</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line792'><pre>    <span class="keyword">return</span> <span class="ident">concept</span>
</pre></a></td></tr><tr><td valign='top'><small>793</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line793'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>794</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line794'><pre>  <span class="keyword">class </span><span class="punct">&lt;&lt;</span> <span class="constant">self</span><span class="punct">;</span> <span class="ident">alias_method_chain</span> <span class="symbol">:find</span><span class="punct">,</span> <span class="symbol">:supercedure</span> <span class="punct">;</span> <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>795</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line795'><pre>
</pre></a></td></tr><tr><td valign='top'><small>796</small></td><td valign='top'><ul><li>LongMethod - has approx 9 statements &raquo; reek</li><li>UncommunicativeName - has the variable name 'd' &raquo; reek</li><li>Complexity 8 &raquo; saikuro</li></ul></td><td valign='top'><a name='line796'><pre>  <span class="keyword">def </span><span class="method">iucn</span>
</pre></a></td></tr><tr><td valign='top'><small>797</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line797'><pre>    <span class="keyword">return</span> <span class="attribute">@iucn</span> <span class="keyword">if</span> <span class="punct">!</span><span class="attribute">@iucn</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>798</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line798'><pre>    <span class="ident">iucn_objects</span> <span class="punct">=</span> <span class="ident">data_objects</span><span class="punct">.</span><span class="ident">select</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">is_iucn?</span> <span class="punct">&amp;&amp;</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">published?</span> <span class="punct">}.</span><span class="ident">sort_by</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span> <span class="constant">Invert</span><span class="punct">(</span><span class="ident">d</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>799</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line799'><pre>    <span class="ident">my_iucn</span> <span class="punct">=</span> <span class="ident">iucn_objects</span><span class="punct">.</span><span class="ident">empty?</span> <span class="punct">?</span> <span class="constant">nil</span> <span class="punct">:</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">iucn_objects</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">id</span><span class="punct">,</span> <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">description, source_url</span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>800</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line800'><pre>
</pre></a></td></tr><tr><td valign='top'><small>801</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line801'><pre>    <span class="ident">temp_iucn</span> <span class="punct">=</span> <span class="ident">my_iucn</span><span class="punct">.</span><span class="ident">nil?</span> <span class="punct">?</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="symbol">:source_url</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">http://www.iucnredlist.org/</span><span class="punct">',</span> <span class="symbol">:description</span> <span class="punct">=&gt;</span> <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(</span><span class="symbol">:not_evaluated</span><span class="punct">))</span> <span class="punct">:</span> <span class="ident">my_iucn</span>
</pre></a></td></tr><tr><td valign='top'><small>802</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line802'><pre>    <span class="ident">temp_iucn</span><span class="punct">.</span><span class="ident">instance_eval</span> <span class="punct">{</span> <span class="keyword">def </span><span class="method">agent_url</span><span class="punct">;</span> <span class="keyword">return</span> <span class="constant">Agent</span><span class="punct">.</span><span class="ident">iucn</span><span class="punct">.</span><span class="ident">homepage</span><span class="punct">;</span> <span class="keyword">end</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>803</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line803'><pre>    <span class="attribute">@iucn</span> <span class="punct">=</span> <span class="ident">temp_iucn</span>
</pre></a></td></tr><tr><td valign='top'><small>804</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line804'><pre>    <span class="keyword">return</span> <span class="attribute">@iucn</span>
</pre></a></td></tr><tr><td valign='top'><small>805</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line805'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>806</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line806'><pre>
</pre></a></td></tr><tr><td valign='top'><small>807</small></td><td valign='top'><ul><li>Duplication - calls iucn 3 times &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line807'><pre>  <span class="keyword">def </span><span class="method">iucn_conservation_status_url</span>
</pre></a></td></tr><tr><td valign='top'><small>808</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line808'><pre>    <span class="keyword">return</span> <span class="ident">iucn</span><span class="punct">.</span><span class="ident">respond_to?</span><span class="punct">(</span><span class="symbol">:agent_url</span><span class="punct">)</span> <span class="punct">?</span> <span class="ident">iucn</span><span class="punct">.</span><span class="ident">agent_url</span> <span class="punct">:</span> <span class="ident">iucn</span><span class="punct">.</span><span class="ident">source_url</span>
</pre></a></td></tr><tr><td valign='top'><small>809</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line809'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>810</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line810'><pre>
</pre></a></td></tr><tr><td valign='top'><small>811</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line811'><pre>  <span class="comment"># TODO - find refs to these and make them grab a hierarchy...</span>
</pre></a></td></tr><tr><td valign='top'><small>812</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line812'><pre>  <span class="keyword">def </span><span class="method">current_node</span><span class="punct">(</span><span class="ident">hierarchy_id</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>813</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line813'><pre>    <span class="keyword">return</span> <span class="ident">entry</span><span class="punct">(</span><span class="ident">hierarchy_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>814</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line814'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>815</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line815'><pre>
</pre></a></td></tr><tr><td valign='top'><small>816</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line816'><pre>  <span class="comment"># Returns an array of HierarchyEntry models (not TaxonConcept models), useful for building navigable</span>
</pre></a></td></tr><tr><td valign='top'><small>817</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line817'><pre>  <span class="comment"># trees.  If you really want TCs, refer to #ancestors (yes, TODO - these sould be better-named!)</span>
</pre></a></td></tr><tr><td valign='top'><small>818</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line818'><pre>  <span class="keyword">def </span><span class="method">ancestry</span><span class="punct">(</span><span class="ident">hierarchy_id</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>819</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line819'><pre>    <span class="ident">desired_entry</span> <span class="punct">=</span> <span class="ident">entry</span><span class="punct">(</span><span class="ident">hierarchy_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>820</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line820'><pre>    <span class="keyword">return</span> <span class="punct">[]</span> <span class="keyword">unless</span> <span class="ident">desired_entry</span>
</pre></a></td></tr><tr><td valign='top'><small>821</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line821'><pre>    <span class="keyword">return</span> <span class="ident">desired_entry</span><span class="punct">.</span><span class="ident">ancestors</span>
</pre></a></td></tr><tr><td valign='top'><small>822</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line822'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>823</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line823'><pre>
</pre></a></td></tr><tr><td valign='top'><small>824</small></td><td valign='top'><ul><li>UncommunicativeName - has the variable name 'e' &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line824'><pre>  <span class="keyword">def </span><span class="method">classification_attribution</span><span class="punct">(</span><span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>825</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line825'><pre>    <span class="ident">hierarchy</span> <span class="punct">||=</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">default</span>
</pre></a></td></tr><tr><td valign='top'><small>826</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line826'><pre>    <span class="ident">e</span> <span class="punct">=</span> <span class="ident">entry</span><span class="punct">(</span><span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>827</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line827'><pre>    <span class="keyword">return</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span> <span class="keyword">unless</span> <span class="ident">e</span>
</pre></a></td></tr><tr><td valign='top'><small>828</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line828'><pre>    <span class="keyword">return</span> <span class="ident">e</span><span class="punct">.</span><span class="ident">classification_attribution</span>
</pre></a></td></tr><tr><td valign='top'><small>829</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line829'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>830</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line830'><pre>
</pre></a></td></tr><tr><td valign='top'><small>831</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line831'><pre>  <span class="comment"># TODO - we only want PUBLISHED hierarchies, here:</span>
</pre></a></td></tr><tr><td valign='top'><small>832</small></td><td valign='top'><ul><li>LowCohesion - refers to entry more than self &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line832'><pre>  <span class="keyword">def </span><span class="method">classifications</span>
</pre></a></td></tr><tr><td valign='top'><small>833</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line833'><pre>    <span class="ident">hierarchy_entries</span><span class="punct">.</span><span class="ident">map</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">entry</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>834</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line834'><pre>      <span class="punct">{</span> <span class="symbol">:name</span> <span class="punct">=&gt;</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">agent</span><span class="punct">.</span><span class="ident">citable</span><span class="punct">.</span><span class="ident">display_string</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>835</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line835'><pre>        <span class="symbol">:kingdom</span> <span class="punct">=&gt;</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">kingdom</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>836</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line836'><pre>        <span class="symbol">:parent</span> <span class="punct">=&gt;</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">parent</span>
</pre></a></td></tr><tr><td valign='top'><small>837</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line837'><pre>      <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>838</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line838'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>839</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line839'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>840</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line840'><pre>
</pre></a></td></tr><tr><td valign='top'><small>841</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line841'><pre>  <span class="keyword">def </span><span class="method">media</span><span class="punct">(</span><span class="ident">opts</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>842</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line842'><pre>    <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">sort_by_rating</span><span class="punct">(</span><span class="ident">images</span> <span class="punct">+</span> <span class="ident">videos</span> <span class="punct">+</span> <span class="ident">sounds</span><span class="punct">,</span> <span class="ident">opts</span><span class="punct">).</span><span class="ident">compact</span>
</pre></a></td></tr><tr><td valign='top'><small>843</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line843'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>844</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line844'><pre>
</pre></a></td></tr><tr><td valign='top'><small>845</small></td><td valign='top'><ul><li>Duplication - calls self.current_user 4 times &raquo; reek</li><li>LongMethod - has approx 7 statements &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line845'><pre>  <span class="keyword">def </span><span class="method">images</span><span class="punct">(</span><span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>846</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line846'><pre>    <span class="comment"># set hierarchy to filter images by</span>
</pre></a></td></tr><tr><td valign='top'><small>847</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line847'><pre>    <span class="keyword">if</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">current_user</span><span class="punct">.</span><span class="ident">filter_content_by_hierarchy</span> <span class="punct">&amp;&amp;</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">current_user</span><span class="punct">.</span><span class="ident">default_hierarchy_valid?</span>
</pre></a></td></tr><tr><td valign='top'><small>848</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line848'><pre>      <span class="ident">filter_hierarchy</span> <span class="punct">=</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="constant">self</span><span class="punct">.</span><span class="ident">current_user</span><span class="punct">.</span><span class="ident">default_hierarchy_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>849</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line849'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>850</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line850'><pre>      <span class="ident">filter_hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>851</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line851'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>852</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line852'><pre>    <span class="ident">perform_filter</span> <span class="punct">=</span> <span class="punct">!</span><span class="ident">filter_hierarchy</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>853</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line853'><pre>
</pre></a></td></tr><tr><td valign='top'><small>854</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line854'><pre>    <span class="ident">image_page</span> <span class="punct">=</span> <span class="punct">(</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:image_page</span><span class="punct">]</span> <span class="punct">||=</span> <span class="number">1</span><span class="punct">).</span><span class="ident">to_i</span>
</pre></a></td></tr><tr><td valign='top'><small>855</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line855'><pre>    <span class="ident">images</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">images_for_taxon_concept</span><span class="punct">(</span><span class="constant">self</span><span class="punct">,</span> <span class="symbol">:user</span> <span class="punct">=&gt;</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">current_user</span><span class="punct">,</span> <span class="symbol">:filter_by_hierarchy</span> <span class="punct">=&gt;</span> <span class="ident">perform_filter</span><span class="punct">,</span> <span class="symbol">:hierarchy</span> <span class="punct">=&gt;</span> <span class="ident">filter_hierarchy</span><span class="punct">,</span> <span class="symbol">:image_page</span> <span class="punct">=&gt;</span> <span class="ident">image_page</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>856</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line856'><pre>    <span class="attribute">@length_of_images</span> <span class="punct">=</span> <span class="ident">images</span><span class="punct">.</span><span class="ident">length</span> <span class="comment"># Caching this because the call to #images is expensive and we don't want to do it twice.</span>
</pre></a></td></tr><tr><td valign='top'><small>857</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line857'><pre>
</pre></a></td></tr><tr><td valign='top'><small>858</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line858'><pre>    <span class="keyword">return</span> <span class="ident">images</span>
</pre></a></td></tr><tr><td valign='top'><small>859</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line859'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>860</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line860'><pre>
</pre></a></td></tr><tr><td valign='top'><small>861</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line861'><pre>  <span class="keyword">def </span><span class="method">image_count</span>
</pre></a></td></tr><tr><td valign='top'><small>862</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line862'><pre>    <span class="ident">count</span> <span class="punct">=</span> <span class="attribute">@length_of_images</span> <span class="punct">||</span> <span class="ident">images</span><span class="punct">.</span><span class="ident">length</span> <span class="comment"># Note, no options... we want to count ALL images that this user can see.</span>
</pre></a></td></tr><tr><td valign='top'><small>863</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line863'><pre>    <span class="ident">count</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{$IMAGE_LIMIT}</span>+</span><span class="punct">&quot;</span> <span class="keyword">if</span> <span class="ident">count</span> <span class="punct">&gt;=</span> <span class="global">$IMAGE_LIMIT</span>
</pre></a></td></tr><tr><td valign='top'><small>864</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line864'><pre>    <span class="keyword">return</span> <span class="ident">count</span>
</pre></a></td></tr><tr><td valign='top'><small>865</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line865'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>866</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line866'><pre>
</pre></a></td></tr><tr><td valign='top'><small>867</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line867'><pre>  <span class="comment"># title and sub-title depend on expertise level of the user that is passed in (default to novice if none specified)</span>
</pre></a></td></tr><tr><td valign='top'><small>868</small></td><td valign='top'><ul><li>Duplication - calls entry twice &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line868'><pre>  <span class="keyword">def </span><span class="method">title</span><span class="punct">(</span><span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>869</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line869'><pre>    <span class="keyword">return</span> <span class="attribute">@title</span> <span class="keyword">unless</span> <span class="attribute">@title</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>870</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line870'><pre>    <span class="keyword">return</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span> <span class="keyword">if</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>871</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line871'><pre>    <span class="attribute">@title</span> <span class="punct">=</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">italicized_name</span><span class="punct">.</span><span class="ident">firstcap</span>
</pre></a></td></tr><tr><td valign='top'><small>872</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line872'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>873</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line873'><pre>
</pre></a></td></tr><tr><td valign='top'><small>874</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line874'><pre>  <span class="comment"># title and sub-title depend on expertise level of the user that is passed in (default to novice if none specified)</span>
</pre></a></td></tr><tr><td valign='top'><small>875</small></td><td valign='top'><ul><li>Duplication - calls entry twice &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line875'><pre>  <span class="keyword">def </span><span class="method">title_canonical</span><span class="punct">(</span><span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>876</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line876'><pre>    <span class="keyword">return</span> <span class="attribute">@title_canonical</span> <span class="keyword">unless</span> <span class="attribute">@title_canonical</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>877</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line877'><pre>    <span class="keyword">return</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span> <span class="keyword">if</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>878</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line878'><pre>    <span class="attribute">@title_canonical</span> <span class="punct">=</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">canonical_form</span><span class="punct">.</span><span class="ident">string</span><span class="punct">.</span><span class="ident">firstcap</span>
</pre></a></td></tr><tr><td valign='top'><small>879</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line879'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>880</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line880'><pre>
</pre></a></td></tr><tr><td valign='top'><small>881</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line881'><pre>
</pre></a></td></tr><tr><td valign='top'><small>882</small></td><td valign='top'><ul><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line882'><pre>  <span class="keyword">def </span><span class="method">subtitle</span><span class="punct">(</span><span class="ident">hierarchy</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>883</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line883'><pre>    <span class="keyword">return</span> <span class="attribute">@subtitle</span> <span class="keyword">unless</span> <span class="attribute">@subtitle</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>884</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line884'><pre>    <span class="ident">hierarchy</span> <span class="punct">||=</span> <span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">default</span>
</pre></a></td></tr><tr><td valign='top'><small>885</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line885'><pre>    <span class="ident">subtitle</span> <span class="punct">=</span> <span class="ident">quick_common_name</span><span class="punct">(</span><span class="constant">nil</span><span class="punct">,</span> <span class="ident">hierarchy</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>886</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line886'><pre>    <span class="ident">subtitle</span> <span class="punct">=</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span> <span class="keyword">if</span> <span class="ident">subtitle</span><span class="punct">.</span><span class="ident">upcase</span> <span class="punct">==</span> <span class="punct">&quot;</span><span class="string">[DATA MISSING]</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>887</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line887'><pre>    <span class="attribute">@subtitle</span> <span class="punct">=</span> <span class="ident">subtitle</span>
</pre></a></td></tr><tr><td valign='top'><small>888</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line888'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>889</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line889'><pre>
</pre></a></td></tr><tr><td valign='top'><small>890</small></td><td valign='top'><ul><li>Duplication - calls images twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line890'><pre>  <span class="keyword">def </span><span class="method">smart_thumb</span>
</pre></a></td></tr><tr><td valign='top'><small>891</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line891'><pre>    <span class="keyword">return</span> <span class="ident">images</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">?</span> <span class="constant">nil</span> <span class="punct">:</span> <span class="ident">images</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">smart_thumb</span>
</pre></a></td></tr><tr><td valign='top'><small>892</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line892'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>893</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line893'><pre>
</pre></a></td></tr><tr><td valign='top'><small>894</small></td><td valign='top'><ul><li>Duplication - calls images twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line894'><pre>  <span class="keyword">def </span><span class="method">smart_medium_thumb</span>
</pre></a></td></tr><tr><td valign='top'><small>895</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line895'><pre>    <span class="keyword">return</span> <span class="ident">images</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">?</span> <span class="constant">nil</span> <span class="punct">:</span> <span class="ident">images</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">smart_medium_thumb</span>
</pre></a></td></tr><tr><td valign='top'><small>896</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line896'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>897</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line897'><pre>
</pre></a></td></tr><tr><td valign='top'><small>898</small></td><td valign='top'><ul><li>Duplication - calls images twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line898'><pre>  <span class="keyword">def </span><span class="method">smart_image</span>
</pre></a></td></tr><tr><td valign='top'><small>899</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line899'><pre>    <span class="keyword">return</span> <span class="ident">images</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">?</span> <span class="constant">nil</span> <span class="punct">:</span> <span class="ident">images</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">smart_image</span>
</pre></a></td></tr><tr><td valign='top'><small>900</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line900'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>901</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line901'><pre>
</pre></a></td></tr><tr><td valign='top'><small>902</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line902'><pre>  <span class="comment"># comment on this</span>
</pre></a></td></tr><tr><td valign='top'><small>903</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line903'><pre>  <span class="keyword">def </span><span class="method">comment</span> <span class="ident">user</span><span class="punct">,</span> <span class="ident">body</span>
</pre></a></td></tr><tr><td valign='top'><small>904</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line904'><pre>    <span class="ident">comment</span> <span class="punct">=</span> <span class="ident">comments</span><span class="punct">.</span><span class="ident">create</span> <span class="symbol">:user</span> <span class="punct">=&gt;</span> <span class="ident">user</span><span class="punct">,</span> <span class="symbol">:body</span> <span class="punct">=&gt;</span> <span class="ident">body</span>
</pre></a></td></tr><tr><td valign='top'><small>905</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line905'><pre>    <span class="ident">user</span><span class="punct">.</span><span class="ident">comments</span><span class="punct">.</span><span class="ident">reload</span> <span class="comment"># be friendly - update the user's comments automatically</span>
</pre></a></td></tr><tr><td valign='top'><small>906</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line906'><pre>    <span class="ident">comment</span>
</pre></a></td></tr><tr><td valign='top'><small>907</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line907'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>908</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line908'><pre>
</pre></a></td></tr><tr><td valign='top'><small>909</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line909'><pre>  <span class="keyword">def </span><span class="method">content_level</span>
</pre></a></td></tr><tr><td valign='top'><small>910</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line910'><pre>    <span class="ident">taxon_concept_content</span><span class="punct">.</span><span class="ident">content_level</span>
</pre></a></td></tr><tr><td valign='top'><small>911</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line911'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>912</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line912'><pre>
</pre></a></td></tr><tr><td valign='top'><small>913</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line913'><pre>  <span class="keyword">def </span><span class="method">self.from_taxon_concepts</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">,</span><span class="ident">page</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>914</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line914'><pre>    <span class="keyword">if</span><span class="punct">(</span><span class="ident">taxon_concept_ids</span><span class="punct">.</span><span class="ident">length</span> <span class="punct">&gt;</span> <span class="number">0</span><span class="punct">)</span> <span class="keyword">then</span>
</pre></a></td></tr><tr><td valign='top'><small>915</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line915'><pre>    <span class="ident">query</span><span class="punct">=&quot;</span><span class="string">Select taxon_concepts.id taxon_concept_id, taxon_concepts.supercedure_id, taxon_concepts.published, vetted.label vetted_label<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>916</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line916'><pre>    <span class="constant">From</span> <span class="ident">taxon_concepts</span>
</pre></a></td></tr><tr><td valign='top'><small>917</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line917'><pre>    <span class="constant">Inner</span> <span class="constant">Join</span> <span class="ident">vetted</span> <span class="constant">ON</span> <span class="ident">taxon_concepts</span><span class="punct">.</span><span class="ident">vetted_id</span> <span class="punct">=</span> <span class="ident">vetted</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>918</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line918'><pre>    <span class="constant">WHERE</span> <span class="ident">taxon_concepts</span><span class="punct">.</span><span class="ident">id</span> <span class="constant">IN</span> <span class="punct">(</span><span class="comment">#{ taxon_concept_ids.join(', ') })&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>919</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line919'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">paginate_by_sql</span> <span class="punct">[</span><span class="ident">query</span><span class="punct">,</span> <span class="ident">taxon_concept_ids</span><span class="punct">],</span> <span class="symbol">:page</span> <span class="punct">=&gt;</span> <span class="ident">page</span><span class="punct">,</span> <span class="symbol">:per_page</span> <span class="punct">=&gt;</span> <span class="number">20</span> <span class="punct">,</span> <span class="symbol">:order</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">id</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>920</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line920'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>921</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line921'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>922</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line922'><pre>
</pre></a></td></tr><tr><td valign='top'><small>923</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line923'><pre>  <span class="comment"># This could use name... but I only need it for searches, and ID is all that matters, there.</span>
</pre></a></td></tr><tr><td valign='top'><small>924</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line924'><pre>  <span class="keyword">def </span><span class="method">&lt;=&gt;</span><span class="punct">(</span><span class="ident">other</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>925</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line925'><pre>    <span class="keyword">return</span> <span class="ident">id</span> <span class="punct">&lt;=&gt;</span> <span class="ident">other</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>926</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line926'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>927</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line927'><pre>
</pre></a></td></tr><tr><td valign='top'><small>928</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line928'><pre>  <span class="keyword">def </span><span class="method">self.related_names</span><span class="punct">(</span><span class="ident">taxon_concept_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>929</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line929'><pre>    <span class="ident">parents</span> <span class="punct">=</span> <span class="constant">SpeciesSchemaModel</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">execute</span><span class="punct">(&quot;</span><span class="string"><span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>930</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line930'><pre>      <span class="constant">SELECT</span> <span class="ident">n</span><span class="punct">.</span><span class="ident">id</span> <span class="ident">name_id</span><span class="punct">,</span> <span class="ident">n</span><span class="punct">.</span><span class="ident">string</span> <span class="ident">name_string</span><span class="punct">,</span> <span class="ident">n</span><span class="punct">.</span><span class="ident">canonical_form_id</span><span class="punct">,</span> <span class="ident">he_parent</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">,</span> <span class="ident">h</span><span class="punct">.</span><span class="ident">label</span> <span class="ident">hierarchy_label</span>
</pre></a></td></tr><tr><td valign='top'><small>931</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line931'><pre>      <span class="constant">FROM</span> <span class="ident">hierarchy_entries</span> <span class="ident">he_parent</span>
</pre></a></td></tr><tr><td valign='top'><small>932</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line932'><pre>      <span class="constant">JOIN</span> <span class="ident">hierarchy_entries</span> <span class="ident">he_child</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he_parent</span><span class="punct">.</span><span class="ident">id</span><span class="punct">=</span><span class="ident">he_child</span><span class="punct">.</span><span class="ident">parent_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>933</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line933'><pre>      <span class="constant">JOIN</span> <span class="ident">names</span> <span class="ident">n</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he_parent</span><span class="punct">.</span><span class="ident">name_id</span><span class="punct">=</span><span class="ident">n</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>934</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line934'><pre>      <span class="constant">JOIN</span> <span class="ident">hierarchies</span> <span class="ident">h</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he_child</span><span class="punct">.</span><span class="ident">hierarchy_id</span><span class="punct">=</span><span class="ident">h</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>935</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line935'><pre>      <span class="constant">WHERE</span> <span class="ident">he_child</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">=</span><span class="comment">#{taxon_concept_id}</span>
</pre></a></td></tr><tr><td valign='top'><small>936</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line936'><pre>      <span class="constant">AND</span> <span class="ident">browsable</span><span class="punct">=</span><span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>937</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line937'><pre>    <span class="punct">&quot;</span><span class="string">).all_hashes.uniq<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>938</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line938'><pre>
</pre></a></td></tr><tr><td valign='top'><small>939</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line939'><pre>    <span class="ident">children</span> <span class="punct">=</span> <span class="constant">SpeciesSchemaModel</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">execute</span><span class="punct">(&quot;</span><span class="string"><span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>940</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line940'><pre>      <span class="constant">SELECT</span> <span class="ident">n</span><span class="punct">.</span><span class="ident">id</span> <span class="ident">name_id</span><span class="punct">,</span> <span class="ident">n</span><span class="punct">.</span><span class="ident">string</span> <span class="ident">name_string</span><span class="punct">,</span> <span class="ident">n</span><span class="punct">.</span><span class="ident">canonical_form_id</span><span class="punct">,</span> <span class="ident">he_child</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">,</span> <span class="ident">h</span><span class="punct">.</span><span class="ident">label</span> <span class="ident">hierarchy_label</span>
</pre></a></td></tr><tr><td valign='top'><small>941</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line941'><pre>      <span class="constant">FROM</span> <span class="ident">hierarchy_entries</span> <span class="ident">he_parent</span>
</pre></a></td></tr><tr><td valign='top'><small>942</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line942'><pre>      <span class="constant">JOIN</span> <span class="ident">hierarchy_entries</span> <span class="ident">he_child</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he_parent</span><span class="punct">.</span><span class="ident">id</span><span class="punct">=</span><span class="ident">he_child</span><span class="punct">.</span><span class="ident">parent_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>943</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line943'><pre>      <span class="constant">JOIN</span> <span class="ident">names</span> <span class="ident">n</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he_child</span><span class="punct">.</span><span class="ident">name_id</span><span class="punct">=</span><span class="ident">n</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>944</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line944'><pre>      <span class="constant">JOIN</span> <span class="ident">hierarchies</span> <span class="ident">h</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he_parent</span><span class="punct">.</span><span class="ident">hierarchy_id</span><span class="punct">=</span><span class="ident">h</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>945</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line945'><pre>      <span class="constant">WHERE</span> <span class="ident">he_parent</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">=</span><span class="comment">#{taxon_concept_id}</span>
</pre></a></td></tr><tr><td valign='top'><small>946</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line946'><pre>      <span class="constant">AND</span> <span class="ident">browsable</span><span class="punct">=</span><span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>947</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line947'><pre>    <span class="punct">&quot;</span><span class="string">).all_hashes.uniq<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>948</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line948'><pre>
</pre></a></td></tr><tr><td valign='top'><small>949</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line949'><pre>    <span class="ident">grouped_parents</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>950</small></td><td valign='top'><ul><li>Don't use 'for' loops. Use Enumerable.each instead. &raquo; roodi</li></ul></td><td valign='top'><a name='line950'><pre>    <span class="keyword">for</span> <span class="ident">parent</span> <span class="keyword">in</span> <span class="ident">parents</span>
</pre></a></td></tr><tr><td valign='top'><small>951</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line951'><pre>      <span class="ident">key</span> <span class="punct">=</span> <span class="ident">parent</span><span class="punct">['</span><span class="string">name_string</span><span class="punct">'].</span><span class="ident">downcase</span><span class="punct">+&quot;</span><span class="string">|</span><span class="punct">&quot;+</span><span class="ident">parent</span><span class="punct">['</span><span class="string">taxon_concept_id</span><span class="punct">']</span>
</pre></a></td></tr><tr><td valign='top'><small>952</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line952'><pre>      <span class="ident">grouped_parents</span><span class="punct">[</span><span class="ident">key</span><span class="punct">]</span> <span class="punct">||=</span> <span class="punct">{'</span><span class="string">taxon_concept_id</span><span class="punct">'</span> <span class="punct">=&gt;</span> <span class="ident">parent</span><span class="punct">['</span><span class="string">taxon_concept_id</span><span class="punct">'],</span> <span class="punct">'</span><span class="string">name_string</span><span class="punct">'</span> <span class="punct">=&gt;</span> <span class="ident">parent</span><span class="punct">['</span><span class="string">name_string</span><span class="punct">'],</span> <span class="punct">'</span><span class="string">sources</span><span class="punct">'</span> <span class="punct">=&gt;</span> <span class="punct">[]}</span>
</pre></a></td></tr><tr><td valign='top'><small>953</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line953'><pre>      <span class="ident">grouped_parents</span><span class="punct">[</span><span class="ident">key</span><span class="punct">]['</span><span class="string">sources</span><span class="punct">']</span> <span class="punct">&lt;&lt;</span> <span class="ident">parent</span>
</pre></a></td></tr><tr><td valign='top'><small>954</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line954'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>955</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line955'><pre>    <span class="ident">grouped_parents</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">key</span><span class="punct">,</span> <span class="ident">hash</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>956</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line956'><pre>      <span class="ident">hash</span><span class="punct">['</span><span class="string">sources</span><span class="punct">'].</span><span class="ident">sort!</span> <span class="punct">{|</span><span class="ident">a</span><span class="punct">,</span><span class="ident">b</span><span class="punct">|</span> <span class="ident">a</span><span class="punct">['</span><span class="string">hierarchy_label</span><span class="punct">']</span> <span class="punct">&lt;=&gt;</span> <span class="ident">b</span><span class="punct">['</span><span class="string">hierarchy_label</span><span class="punct">']}</span>
</pre></a></td></tr><tr><td valign='top'><small>957</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line957'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>958</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line958'><pre>    <span class="ident">grouped_parents</span> <span class="punct">=</span> <span class="ident">grouped_parents</span><span class="punct">.</span><span class="ident">sort</span> <span class="punct">{|</span><span class="ident">a</span><span class="punct">,</span><span class="ident">b</span><span class="punct">|</span> <span class="ident">a</span><span class="punct">[</span><span class="number">0</span><span class="punct">]</span> <span class="punct">&lt;=&gt;</span> <span class="ident">b</span><span class="punct">[</span><span class="number">0</span><span class="punct">]}</span>
</pre></a></td></tr><tr><td valign='top'><small>959</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line959'><pre>
</pre></a></td></tr><tr><td valign='top'><small>960</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line960'><pre>    <span class="ident">grouped_children</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>961</small></td><td valign='top'><ul><li>Don't use 'for' loops. Use Enumerable.each instead. &raquo; roodi</li></ul></td><td valign='top'><a name='line961'><pre>    <span class="keyword">for</span> <span class="ident">child</span> <span class="keyword">in</span> <span class="ident">children</span>
</pre></a></td></tr><tr><td valign='top'><small>962</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line962'><pre>      <span class="ident">key</span> <span class="punct">=</span> <span class="ident">child</span><span class="punct">['</span><span class="string">name_string</span><span class="punct">'].</span><span class="ident">downcase</span><span class="punct">+&quot;</span><span class="string">|</span><span class="punct">&quot;+</span><span class="ident">child</span><span class="punct">['</span><span class="string">taxon_concept_id</span><span class="punct">']</span>
</pre></a></td></tr><tr><td valign='top'><small>963</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line963'><pre>      <span class="ident">grouped_children</span><span class="punct">[</span><span class="ident">key</span><span class="punct">]</span> <span class="punct">||=</span> <span class="punct">{'</span><span class="string">taxon_concept_id</span><span class="punct">'</span> <span class="punct">=&gt;</span> <span class="ident">child</span><span class="punct">['</span><span class="string">taxon_concept_id</span><span class="punct">'],</span> <span class="punct">'</span><span class="string">name_string</span><span class="punct">'</span> <span class="punct">=&gt;</span> <span class="ident">child</span><span class="punct">['</span><span class="string">name_string</span><span class="punct">'],</span> <span class="punct">'</span><span class="string">sources</span><span class="punct">'</span> <span class="punct">=&gt;</span> <span class="punct">[]}</span>
</pre></a></td></tr><tr><td valign='top'><small>964</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line964'><pre>      <span class="ident">grouped_children</span><span class="punct">[</span><span class="ident">key</span><span class="punct">]['</span><span class="string">sources</span><span class="punct">']</span> <span class="punct">&lt;&lt;</span> <span class="ident">child</span>
</pre></a></td></tr><tr><td valign='top'><small>965</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line965'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>966</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line966'><pre>    <span class="ident">grouped_children</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">key</span><span class="punct">,</span> <span class="ident">hash</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>967</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line967'><pre>      <span class="ident">hash</span><span class="punct">['</span><span class="string">sources</span><span class="punct">'].</span><span class="ident">sort!</span> <span class="punct">{|</span><span class="ident">a</span><span class="punct">,</span><span class="ident">b</span><span class="punct">|</span> <span class="ident">a</span><span class="punct">['</span><span class="string">hierarchy_label</span><span class="punct">']</span> <span class="punct">&lt;=&gt;</span> <span class="ident">b</span><span class="punct">['</span><span class="string">hierarchy_label</span><span class="punct">']}</span>
</pre></a></td></tr><tr><td valign='top'><small>968</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line968'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>969</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line969'><pre>    <span class="ident">grouped_children</span> <span class="punct">=</span> <span class="ident">grouped_children</span><span class="punct">.</span><span class="ident">sort</span> <span class="punct">{|</span><span class="ident">a</span><span class="punct">,</span><span class="ident">b</span><span class="punct">|</span> <span class="ident">a</span><span class="punct">[</span><span class="number">0</span><span class="punct">]</span> <span class="punct">&lt;=&gt;</span> <span class="ident">b</span><span class="punct">[</span><span class="number">0</span><span class="punct">]}</span>
</pre></a></td></tr><tr><td valign='top'><small>970</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line970'><pre>
</pre></a></td></tr><tr><td valign='top'><small>971</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line971'><pre>    <span class="ident">combined</span> <span class="punct">=</span> <span class="punct">{'</span><span class="string">parents</span><span class="punct">'</span> <span class="punct">=&gt;</span> <span class="ident">grouped_parents</span><span class="punct">,</span> <span class="punct">'</span><span class="string">children</span><span class="punct">'</span> <span class="punct">=&gt;</span> <span class="ident">grouped_children</span><span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>972</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line972'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>973</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line973'><pre>
</pre></a></td></tr><tr><td valign='top'><small>974</small></td><td valign='top'><ul><li>Duplication - calls (return_data_objects << d) twice &raquo; reek</li><li>Duplication - calls Vetted.trusted twice &raquo; reek</li><li>Duplication - calls d.is_text? twice &raquo; reek</li><li>Duplication - calls d.is_video? twice &raquo; reek</li><li>Duplication - calls d.license twice &raquo; reek</li><li>Duplication - calls d.vetted twice &raquo; reek</li><li>Duplication - calls options[:images] twice &raquo; reek</li><li>Duplication - calls options[:images].to_i twice &raquo; reek</li><li>Duplication - calls options[:licenses] 7 times &raquo; reek</li><li>Duplication - calls options[:licenses].include?(d.license) twice &raquo; reek</li><li>Duplication - calls options[:subjects] twice &raquo; reek</li><li>Duplication - calls options[:text] twice &raquo; reek</li><li>Duplication - calls options[:text].to_i twice &raquo; reek</li><li>Duplication - calls options[:text_subjects] 6 times &raquo; reek</li><li>Duplication - calls options[:vetted] 6 times &raquo; reek</li><li>Duplication - calls options[:vetted].include?(d.vetted) twice &raquo; reek</li><li>Duplication - calls options[:videos] twice &raquo; reek</li><li>Duplication - calls options[:videos].to_i twice &raquo; reek</li><li>LongMethod - has approx 38 statements &raquo; reek</li><li>UncommunicativeName - has the variable name 'd' &raquo; reek</li><li>UncommunicativeName - has the variable name 'l' &raquo; reek</li><li>LowCohesion - refers to options more than self &raquo; reek</li><li>Method name "data_objects_for_api" cyclomatic complexity is 28.  It should be 8 or less. &raquo; roodi</li><li>Method "data_objects_for_api" has 85 lines.  It should have 20 or less. &raquo; roodi</li><li>Complexity 27 &raquo; saikuro</li></ul></td><td valign='top'><a name='line974'><pre>  <span class="keyword">def </span><span class="method">data_objects_for_api</span><span class="punct">(</span><span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>975</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line975'><pre>    <span class="ident">options</span><span class="punct">[</span><span class="symbol">:images</span><span class="punct">]</span> <span class="punct">||=</span> <span class="number">3</span>
</pre></a></td></tr><tr><td valign='top'><small>976</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line976'><pre>    <span class="ident">options</span><span class="punct">[</span><span class="symbol">:videos</span><span class="punct">]</span> <span class="punct">||=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>977</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line977'><pre>    <span class="comment"># TODO - sounds for API</span>
</pre></a></td></tr><tr><td valign='top'><small>978</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line978'><pre>    <span class="ident">options</span><span class="punct">[</span><span class="symbol">:text</span><span class="punct">]</span> <span class="punct">||=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>979</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line979'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:subjects</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>980</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line980'><pre>      <span class="ident">options</span><span class="punct">[</span><span class="symbol">:text_subjects</span><span class="punct">]</span> <span class="punct">=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:subjects</span><span class="punct">].</span><span class="ident">split</span><span class="punct">(&quot;</span><span class="string">|</span><span class="punct">&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>981</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line981'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>982</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line982'><pre>      <span class="ident">options</span><span class="punct">[</span><span class="symbol">:text_subjects</span><span class="punct">]</span> <span class="punct">=</span> <span class="punct">['</span><span class="string">TaxonBiology</span><span class="punct">',</span> <span class="punct">'</span><span class="string">GeneralDescription</span><span class="punct">',</span> <span class="punct">'</span><span class="string">Description</span><span class="punct">']</span>
</pre></a></td></tr><tr><td valign='top'><small>983</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line983'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>984</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line984'><pre>    <span class="comment"># create an alias Uses for Use (it was misspelled somewhere)</span>
</pre></a></td></tr><tr><td valign='top'><small>985</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line985'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:text_subjects</span><span class="punct">].</span><span class="ident">include?</span><span class="punct">('</span><span class="string">Use</span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>986</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line986'><pre>      <span class="ident">options</span><span class="punct">[</span><span class="symbol">:text_subjects</span><span class="punct">]</span> <span class="punct">&lt;&lt;</span> <span class="punct">'</span><span class="string">Uses</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>987</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line987'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>988</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line988'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:text_subjects</span><span class="punct">].</span><span class="ident">include?</span><span class="punct">('</span><span class="string">all</span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>989</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line989'><pre>      <span class="ident">options</span><span class="punct">[</span><span class="symbol">:text_subjects</span><span class="punct">]</span> <span class="punct">=</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>990</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line990'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>991</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line991'><pre>      <span class="ident">options</span><span class="punct">[</span><span class="symbol">:text_subjects</span><span class="punct">].</span><span class="ident">map!</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">l</span><span class="punct">|</span> <span class="constant">InfoItem</span><span class="punct">.</span><span class="ident">find_by_translated</span><span class="punct">(</span><span class="symbol">:label</span><span class="punct">,</span> <span class="ident">l</span><span class="punct">)</span> <span class="punct">}.</span><span class="ident">compact</span>
</pre></a></td></tr><tr><td valign='top'><small>992</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line992'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>993</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line993'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:licenses</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>994</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line994'><pre>      <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:licenses</span><span class="punct">].</span><span class="ident">include?</span><span class="punct">('</span><span class="string">all</span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>995</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line995'><pre>        <span class="ident">options</span><span class="punct">[</span><span class="symbol">:licenses</span><span class="punct">]</span> <span class="punct">=</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>996</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line996'><pre>      <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>997</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line997'><pre>        <span class="ident">options</span><span class="punct">[</span><span class="symbol">:licenses</span><span class="punct">]</span> <span class="punct">=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:licenses</span><span class="punct">].</span><span class="ident">split</span><span class="punct">(&quot;</span><span class="string">|</span><span class="punct">&quot;).</span><span class="ident">map</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">l</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>998</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line998'><pre>          <span class="ident">l</span> <span class="punct">=</span> <span class="punct">'</span><span class="string">public domain</span><span class="punct">'</span> <span class="keyword">if</span> <span class="ident">l</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">pd</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>999</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line999'><pre>          <span class="ident">l</span> <span class="punct">=</span> <span class="punct">'</span><span class="string">not applicable</span><span class="punct">'</span> <span class="keyword">if</span> <span class="ident">l</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">na</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>1000</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1000'><pre>          <span class="constant">License</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="symbol">:all</span><span class="punct">,</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">title like '<span class="expr">#{l}</span>%'</span><span class="punct">&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>1001</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1001'><pre>        <span class="keyword">end</span><span class="punct">.</span><span class="ident">flatten</span><span class="punct">.</span><span class="ident">compact</span>
</pre></a></td></tr><tr><td valign='top'><small>1002</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1002'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1003</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1003'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1004</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1004'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted</span><span class="punct">]</span> <span class="punct">==</span> <span class="punct">&quot;</span><span class="string">1</span><span class="punct">&quot;</span>  <span class="comment"># trusted</span>
</pre></a></td></tr><tr><td valign='top'><small>1005</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1005'><pre>      <span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted</span><span class="punct">]</span> <span class="punct">=</span> <span class="punct">[</span><span class="constant">Vetted</span><span class="punct">.</span><span class="ident">trusted</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1006</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1006'><pre>    <span class="keyword">elsif</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted</span><span class="punct">]</span> <span class="punct">==</span> <span class="punct">&quot;</span><span class="string">2</span><span class="punct">&quot;</span>  <span class="comment"># everything except untrusted</span>
</pre></a></td></tr><tr><td valign='top'><small>1007</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1007'><pre>      <span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted</span><span class="punct">]</span> <span class="punct">=</span> <span class="punct">[</span><span class="constant">Vetted</span><span class="punct">.</span><span class="ident">trusted</span><span class="punct">,</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">unknown</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1008</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1008'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>1009</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1009'><pre>      <span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted</span><span class="punct">]</span> <span class="punct">=</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>1010</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1010'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1011</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1011'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1012</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1012'><pre>    <span class="ident">return_data_objects</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>1013</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1013'><pre>    <span class="comment"># get the images</span>
</pre></a></td></tr><tr><td valign='top'><small>1014</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1014'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:images</span><span class="punct">].</span><span class="ident">to_i</span> <span class="punct">&gt;</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>1015</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1015'><pre>      <span class="ident">image_data_objects</span> <span class="punct">=</span> <span class="ident">top_concept_images</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">tci</span><span class="punct">|</span> <span class="ident">tci</span><span class="punct">.</span><span class="ident">data_object</span> <span class="punct">}.</span><span class="ident">compact</span>
</pre></a></td></tr><tr><td valign='top'><small>1016</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1016'><pre>      <span class="ident">image_data_objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">filter_list_for_user</span><span class="punct">(</span><span class="ident">image_data_objects</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1017</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1017'><pre>      <span class="comment"># remove non-matching vetted and license values</span>
</pre></a></td></tr><tr><td valign='top'><small>1018</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1018'><pre>      <span class="ident">image_data_objects</span><span class="punct">.</span><span class="ident">delete_if</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>1019</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1019'><pre>        <span class="punct">(</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted</span><span class="punct">]</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted</span><span class="punct">].</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">d</span><span class="punct">.</span><span class="ident">vetted</span><span class="punct">))</span> <span class="punct">||</span>
</pre></a></td></tr><tr><td valign='top'><small>1020</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1020'><pre>        <span class="punct">(</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:licenses</span><span class="punct">]</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:licenses</span><span class="punct">].</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">d</span><span class="punct">.</span><span class="ident">license</span><span class="punct">))</span>
</pre></a></td></tr><tr><td valign='top'><small>1021</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1021'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1022</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1022'><pre>      <span class="ident">image_data_objects</span> <span class="punct">=</span> <span class="ident">image_data_objects</span><span class="punct">.</span><span class="ident">group_objects_by</span><span class="punct">('</span><span class="string">guid</span><span class="punct">')</span>  <span class="comment"># group by guid</span>
</pre></a></td></tr><tr><td valign='top'><small>1023</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1023'><pre>      <span class="ident">image_data_objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">sort_by_rating</span><span class="punct">(</span><span class="ident">image_data_objects</span><span class="punct">)</span>  <span class="comment"># order by rating</span>
</pre></a></td></tr><tr><td valign='top'><small>1024</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1024'><pre>      <span class="ident">return_data_objects</span> <span class="punct">+=</span> <span class="ident">image_data_objects</span><span class="punct">[</span><span class="number">0</span><span class="punct">...</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:images</span><span class="punct">].</span><span class="ident">to_i</span><span class="punct">]</span>  <span class="comment"># get the # requested</span>
</pre></a></td></tr><tr><td valign='top'><small>1025</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1025'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1026</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1026'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1027</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1027'><pre>    <span class="comment"># get the rest</span>
</pre></a></td></tr><tr><td valign='top'><small>1028</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1028'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:text</span><span class="punct">].</span><span class="ident">to_i</span> <span class="punct">&gt;</span> <span class="number">0</span> <span class="punct">||</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:videos</span><span class="punct">].</span><span class="ident">to_i</span>
</pre></a></td></tr><tr><td valign='top'><small>1029</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1029'><pre>      <span class="ident">non_image_objects</span> <span class="punct">=</span> <span class="ident">data_objects</span><span class="punct">.</span><span class="ident">select</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span> <span class="punct">!</span><span class="ident">d</span><span class="punct">.</span><span class="ident">is_image?</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>1030</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1030'><pre>      <span class="ident">non_image_objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">filter_list_for_user</span><span class="punct">(</span><span class="ident">non_image_objects</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1031</small></td><td valign='top'><ul><li>Block cyclomatic complexity is 7.  It should be 4 or less. &raquo; roodi</li></ul></td><td valign='top'><a name='line1031'><pre>      <span class="ident">non_image_objects</span><span class="punct">.</span><span class="ident">delete_if</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>1032</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1032'><pre>        <span class="punct">(</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted</span><span class="punct">]</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted</span><span class="punct">].</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">d</span><span class="punct">.</span><span class="ident">vetted</span><span class="punct">))</span> <span class="punct">||</span>
</pre></a></td></tr><tr><td valign='top'><small>1033</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1033'><pre>        <span class="punct">(</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:licenses</span><span class="punct">]</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:licenses</span><span class="punct">].</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">d</span><span class="punct">.</span><span class="ident">license</span><span class="punct">))</span> <span class="punct">||</span>
</pre></a></td></tr><tr><td valign='top'><small>1034</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1034'><pre>        <span class="punct">(</span><span class="ident">d</span><span class="punct">.</span><span class="ident">is_text?</span> <span class="punct">&amp;&amp;</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:text_subjects</span><span class="punct">]</span> <span class="punct">&amp;&amp;</span> <span class="punct">(</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:text_subjects</span><span class="punct">]</span> <span class="punct">&amp;</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">info_items</span><span class="punct">).</span><span class="ident">empty?</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1035</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1035'><pre>        <span class="comment"># the use of &amp; above is the array set intersection operator</span>
</pre></a></td></tr><tr><td valign='top'><small>1036</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1036'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1037</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1037'><pre>      <span class="ident">non_image_objects</span> <span class="punct">=</span> <span class="ident">non_image_objects</span><span class="punct">.</span><span class="ident">group_objects_by</span><span class="punct">('</span><span class="string">guid</span><span class="punct">')</span>  <span class="comment"># group by guid</span>
</pre></a></td></tr><tr><td valign='top'><small>1038</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1038'><pre>      <span class="ident">non_image_objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">sort_by_rating</span><span class="punct">(</span><span class="ident">non_image_objects</span><span class="punct">)</span>  <span class="comment"># order by rating</span>
</pre></a></td></tr><tr><td valign='top'><small>1039</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1039'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1040</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1040'><pre>      <span class="comment"># remove items over the count limit</span>
</pre></a></td></tr><tr><td valign='top'><small>1041</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1041'><pre>      <span class="ident">types_count</span> <span class="punct">=</span> <span class="punct">{</span><span class="symbol">:text</span> <span class="punct">=&gt;</span> <span class="number">0</span><span class="punct">,</span> <span class="symbol">:video</span> <span class="punct">=&gt;</span> <span class="number">0</span><span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>1042</small></td><td valign='top'><ul><li>Block cyclomatic complexity is 5.  It should be 4 or less. &raquo; roodi</li></ul></td><td valign='top'><a name='line1042'><pre>      <span class="ident">non_image_objects</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>1043</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1043'><pre>        <span class="keyword">if</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">is_text?</span>
</pre></a></td></tr><tr><td valign='top'><small>1044</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1044'><pre>          <span class="ident">types_count</span><span class="punct">[</span><span class="symbol">:text</span><span class="punct">]</span> <span class="punct">+=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>1045</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1045'><pre>          <span class="ident">return_data_objects</span> <span class="punct">&lt;&lt;</span> <span class="ident">d</span> <span class="keyword">if</span> <span class="ident">types_count</span><span class="punct">[</span><span class="symbol">:text</span><span class="punct">]</span> <span class="punct">&lt;=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:text</span><span class="punct">].</span><span class="ident">to_i</span>
</pre></a></td></tr><tr><td valign='top'><small>1046</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1046'><pre>        <span class="keyword">elsif</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">is_video?</span>
</pre></a></td></tr><tr><td valign='top'><small>1047</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1047'><pre>          <span class="ident">types_count</span><span class="punct">[</span><span class="symbol">:video</span><span class="punct">]</span> <span class="punct">+=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>1048</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1048'><pre>          <span class="ident">return_data_objects</span> <span class="punct">&lt;&lt;</span> <span class="ident">d</span> <span class="keyword">if</span> <span class="ident">types_count</span><span class="punct">[</span><span class="symbol">:video</span><span class="punct">]</span> <span class="punct">&lt;=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:videos</span><span class="punct">].</span><span class="ident">to_i</span>
</pre></a></td></tr><tr><td valign='top'><small>1049</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1049'><pre>        <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1050</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1050'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1051</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1051'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1052</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1052'><pre>    <span class="ident">data_objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">core_relationships</span><span class="punct">(</span><span class="symbol">:add_include</span> <span class="punct">=&gt;</span> <span class="symbol">:published_refs</span><span class="punct">,</span> <span class="symbol">:add_select</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:refs</span> <span class="punct">=&gt;</span> <span class="symbol">:full_reference</span> <span class="punct">}).</span>
</pre></a></td></tr><tr><td valign='top'><small>1053</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1053'><pre>      <span class="ident">find_all_by_id</span><span class="punct">(</span><span class="ident">return_data_objects</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">})</span>
</pre></a></td></tr><tr><td valign='top'><small>1054</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1054'><pre>    <span class="comment"># set flash and youtube types to video, iucn to text</span>
</pre></a></td></tr><tr><td valign='top'><small>1055</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1055'><pre>    <span class="ident">data_objects</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>1056</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1056'><pre>      <span class="ident">d</span><span class="punct">.</span><span class="ident">data_type</span> <span class="punct">=</span> <span class="constant">DataType</span><span class="punct">.</span><span class="ident">video</span> <span class="keyword">if</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">is_video?</span>
</pre></a></td></tr><tr><td valign='top'><small>1057</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1057'><pre>      <span class="ident">d</span><span class="punct">.</span><span class="ident">data_type</span> <span class="punct">=</span> <span class="constant">DataType</span><span class="punct">.</span><span class="ident">text</span> <span class="keyword">if</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">is_iucn?</span>
</pre></a></td></tr><tr><td valign='top'><small>1058</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1058'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1059</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1059'><pre>    <span class="ident">data_objects</span>
</pre></a></td></tr><tr><td valign='top'><small>1060</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1060'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1061</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1061'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1062</small></td><td valign='top'><ul><li>LowCohesion - refers to tcn more than self &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1062'><pre>  <span class="keyword">def </span><span class="method">all_common_names</span>
</pre></a></td></tr><tr><td valign='top'><small>1063</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1063'><pre>    <span class="ident">common_names</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>1064</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1064'><pre>    <span class="ident">taxon_concept_names</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">tcn</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>1065</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1065'><pre>      <span class="keyword">if</span> <span class="ident">tcn</span><span class="punct">.</span><span class="ident">vern</span> <span class="punct">==</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>1066</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1066'><pre>        <span class="ident">common_names</span> <span class="punct">&lt;&lt;</span> <span class="ident">tcn</span><span class="punct">.</span><span class="ident">name</span>
</pre></a></td></tr><tr><td valign='top'><small>1067</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1067'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1068</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1068'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1069</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1069'><pre>    <span class="ident">common_names</span>
</pre></a></td></tr><tr><td valign='top'><small>1070</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1070'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1071</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1071'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1072</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1072'><pre>  <span class="comment"># Unlike all_common_names, this method doesn't return language information.  In theory, they are all &quot;scientific&quot;, anyway.</span>
</pre></a></td></tr><tr><td valign='top'><small>1073</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1073'><pre>  <span class="keyword">def </span><span class="method">all_scientific_names</span>
</pre></a></td></tr><tr><td valign='top'><small>1074</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1074'><pre>    <span class="constant">Name</span><span class="punct">.</span><span class="ident">find_by_sql</span><span class="punct">(['</span><span class="string">SELECT names.string<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>1075</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1075'><pre>                         <span class="constant">FROM</span> <span class="ident">taxon_concept_names</span> <span class="ident">tcn</span> <span class="constant">JOIN</span> <span class="ident">names</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">tcn</span><span class="punct">.</span><span class="ident">name_id</span> <span class="punct">=</span> <span class="ident">names</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1076</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1076'><pre>                         <span class="constant">WHERE</span> <span class="ident">tcn</span><span class="punct">.</span><span class="ident">taxon_concept_id</span> <span class="punct">=</span> <span class="punct">?</span> <span class="constant">AND</span> <span class="ident">vern</span> <span class="punct">=</span> <span class="number">0</span><span class="punct">'</span><span class="string">, id])<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>1077</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1077'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1078</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1078'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1079</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1079'><pre>  <span class="keyword">def </span><span class="method">has_stats?</span>
</pre></a></td></tr><tr><td valign='top'><small>1080</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1080'><pre>    <span class="constant">HierarchyEntryStat</span><span class="punct">.</span><span class="ident">count_by_sql</span><span class="punct">(&quot;</span><span class="string">SELECT 1<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>1081</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1081'><pre>      <span class="constant">FROM</span> <span class="ident">hierarchy_entries</span> <span class="ident">he</span>
</pre></a></td></tr><tr><td valign='top'><small>1082</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1082'><pre>      <span class="constant">JOIN</span> <span class="ident">hierarchies</span> <span class="ident">h</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy_id</span> <span class="punct">=</span> <span class="ident">h</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1083</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1083'><pre>      <span class="constant">JOIN</span> <span class="ident">hierarchy_entry_stats</span> <span class="ident">hes</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">=</span> <span class="ident">hes</span><span class="punct">.</span><span class="ident">hierarchy_entry_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1084</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1084'><pre>      <span class="constant">WHERE</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">taxon_concept_id</span> <span class="punct">=</span> <span class="comment">#{self.id}</span>
</pre></a></td></tr><tr><td valign='top'><small>1085</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1085'><pre>      <span class="constant">AND</span> <span class="ident">h</span><span class="punct">.</span><span class="ident">browsable</span> <span class="punct">=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>1086</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1086'><pre>      <span class="constant">AND</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">published</span> <span class="punct">=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>1087</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1087'><pre>      <span class="constant">AND</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">visibility_id</span> <span class="punct">=</span> <span class="comment">#{Visibility.visible.id}</span>
</pre></a></td></tr><tr><td valign='top'><small>1088</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1088'><pre>      <span class="constant">LIMIT</span> <span class="number">1</span><span class="punct">&quot;</span><span class="string">) &gt; 0<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>1089</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1089'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1090</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1090'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1091</small></td><td valign='top'><ul><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1091'><pre>  <span class="keyword">def </span><span class="method">has_related_names?</span>
</pre></a></td></tr><tr><td valign='top'><small>1092</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1092'><pre>    <span class="ident">entries_with_parents</span> <span class="punct">=</span> <span class="ident">published_hierarchy_entries</span><span class="punct">.</span><span class="ident">select</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">browsable</span> <span class="punct">&amp;&amp;</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">parent_id</span> <span class="punct">!=</span> <span class="number">0</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>1093</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1093'><pre>    <span class="keyword">return</span> <span class="constant">true</span> <span class="keyword">unless</span> <span class="ident">entries_with_parents</span><span class="punct">.</span><span class="ident">empty?</span>
</pre></a></td></tr><tr><td valign='top'><small>1094</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1094'><pre>    <span class="keyword">return</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">count_by_sql</span><span class="punct">(&quot;</span><span class="string">SELECT 1<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>1095</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1095'><pre>                                      <span class="constant">FROM</span> <span class="ident">hierarchy_entries</span> <span class="ident">he</span>
</pre></a></td></tr><tr><td valign='top'><small>1096</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1096'><pre>                                      <span class="constant">JOIN</span> <span class="ident">hierarchy_entries</span> <span class="ident">he_children</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">id</span><span class="punct">=</span><span class="ident">he_children</span><span class="punct">.</span><span class="ident">parent_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1097</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1097'><pre>                                      <span class="constant">JOIN</span> <span class="ident">hierarchies</span> <span class="ident">h</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he_children</span><span class="punct">.</span><span class="ident">hierarchy_id</span><span class="punct">=</span><span class="ident">h</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1098</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1098'><pre>                                      <span class="constant">WHERE</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">=</span><span class="comment">#{id}</span>
</pre></a></td></tr><tr><td valign='top'><small>1099</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1099'><pre>                                      <span class="constant">AND</span> <span class="ident">h</span><span class="punct">.</span><span class="ident">browsable</span><span class="punct">=</span><span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>1100</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1100'><pre>                                      <span class="constant">AND</span> <span class="ident">he_children</span><span class="punct">.</span><span class="ident">published</span><span class="punct">=</span><span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>1101</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1101'><pre>                                      <span class="constant">LIMIT</span> <span class="number">1</span><span class="punct">&quot;</span><span class="string">) &gt; 0<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>1102</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1102'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1103</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1103'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1104</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1104'><pre>  <span class="keyword">def </span><span class="method">has_synonyms?</span>
</pre></a></td></tr><tr><td valign='top'><small>1105</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1105'><pre>    <span class="keyword">return</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">count_by_sql</span><span class="punct">(&quot;</span><span class="string">SELECT 1<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>1106</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1106'><pre>      <span class="constant">FROM</span> <span class="ident">hierarchy_entries</span> <span class="ident">he</span>
</pre></a></td></tr><tr><td valign='top'><small>1107</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1107'><pre>      <span class="constant">JOIN</span> <span class="ident">hierarchies</span> <span class="ident">h</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy_id</span> <span class="punct">=</span> <span class="ident">h</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1108</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1108'><pre>      <span class="constant">JOIN</span> <span class="ident">synonyms</span> <span class="ident">s</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">=</span> <span class="ident">s</span><span class="punct">.</span><span class="ident">hierarchy_entry_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1109</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1109'><pre>      <span class="constant">WHERE</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">taxon_concept_id</span> <span class="punct">=</span> <span class="comment">#{self.id}</span>
</pre></a></td></tr><tr><td valign='top'><small>1110</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1110'><pre>      <span class="constant">AND</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">published</span> <span class="punct">=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>1111</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1111'><pre>      <span class="constant">AND</span> <span class="ident">h</span><span class="punct">.</span><span class="ident">browsable</span> <span class="punct">=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>1112</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1112'><pre>      <span class="constant">AND</span> <span class="ident">s</span><span class="punct">.</span><span class="ident">synonym_relation_id</span> <span class="constant">NOT</span> <span class="constant">IN</span> <span class="punct">(</span><span class="comment">#{SynonymRelation.common_name_ids.join(',')})</span>
</pre></a></td></tr><tr><td valign='top'><small>1113</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1113'><pre>      <span class="constant">LIMIT</span> <span class="number">1</span><span class="punct">&quot;</span><span class="string">) &gt; 0<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>1114</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1114'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1115</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1115'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1116</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1116'><pre>  <span class="keyword">def </span><span class="method">has_common_names?</span>
</pre></a></td></tr><tr><td valign='top'><small>1117</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1117'><pre>    <span class="keyword">return</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">count_by_sql</span><span class="punct">(&quot;</span><span class="string">SELECT 1<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>1118</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1118'><pre>      <span class="constant">FROM</span> <span class="ident">hierarchy_entries</span> <span class="ident">he</span>
</pre></a></td></tr><tr><td valign='top'><small>1119</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1119'><pre>      <span class="constant">JOIN</span> <span class="ident">hierarchies</span> <span class="ident">h</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy_id</span> <span class="punct">=</span> <span class="ident">h</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1120</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1120'><pre>      <span class="constant">JOIN</span> <span class="ident">synonyms</span> <span class="ident">s</span> <span class="constant">ON</span> <span class="punct">(</span><span class="ident">he</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">=</span> <span class="ident">s</span><span class="punct">.</span><span class="ident">hierarchy_entry_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1121</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1121'><pre>      <span class="constant">WHERE</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">taxon_concept_id</span> <span class="punct">=</span> <span class="comment">#{self.id}</span>
</pre></a></td></tr><tr><td valign='top'><small>1122</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1122'><pre>      <span class="constant">AND</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">published</span> <span class="punct">=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>1123</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1123'><pre>      <span class="constant">AND</span> <span class="ident">h</span><span class="punct">.</span><span class="ident">browsable</span> <span class="punct">=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>1124</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1124'><pre>      <span class="constant">AND</span> <span class="ident">s</span><span class="punct">.</span><span class="ident">synonym_relation_id</span> <span class="constant">IN</span> <span class="punct">(</span><span class="comment">#{SynonymRelation.common_name_ids.join(',')})</span>
</pre></a></td></tr><tr><td valign='top'><small>1125</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1125'><pre>      <span class="constant">LIMIT</span> <span class="number">1</span><span class="punct">&quot;</span><span class="string">) &gt; 0<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>1126</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1126'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1127</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1127'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1128</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1128'><pre>  <span class="keyword">def </span><span class="method">has_literature_references?</span>
</pre></a></td></tr><tr><td valign='top'><small>1129</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1129'><pre>    <span class="constant">Ref</span><span class="punct">.</span><span class="ident">literature_references_for?</span><span class="punct">(</span><span class="constant">self</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1130</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1130'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1131</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1131'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1132</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1132'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1133</small></td><td valign='top'><ul><li>LongMethod - has approx 7 statements &raquo; reek</li><li>LowCohesion - refers to options more than self &raquo; reek</li><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1133'><pre>  <span class="keyword">def </span><span class="method">add_common_name_synonym</span><span class="punct">(</span><span class="ident">name_string</span><span class="punct">,</span> <span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>1134</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1134'><pre>    <span class="ident">agent</span>     <span class="punct">=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:agent</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1135</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1135'><pre>    <span class="ident">preferred</span> <span class="punct">=</span> <span class="punct">!!</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:preferred</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1136</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1136'><pre>    <span class="ident">language</span>  <span class="punct">=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:language</span><span class="punct">]</span> <span class="punct">||</span> <span class="constant">Language</span><span class="punct">.</span><span class="ident">unknown</span>
</pre></a></td></tr><tr><td valign='top'><small>1137</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1137'><pre>    <span class="ident">vetted</span>    <span class="punct">=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted</span><span class="punct">]</span> <span class="punct">||</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">unknown</span>
</pre></a></td></tr><tr><td valign='top'><small>1138</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1138'><pre>    <span class="ident">relation</span>  <span class="punct">=</span> <span class="constant">SynonymRelation</span><span class="punct">.</span><span class="ident">find_by_translated</span><span class="punct">(</span><span class="symbol">:label</span><span class="punct">,</span> <span class="punct">'</span><span class="string">common name</span><span class="punct">')</span> <span class="comment"># TODO - i18n</span>
</pre></a></td></tr><tr><td valign='top'><small>1139</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1139'><pre>    <span class="ident">name_obj</span>  <span class="punct">=</span> <span class="constant">Name</span><span class="punct">.</span><span class="ident">create_common_name</span><span class="punct">(</span><span class="ident">name_string</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1140</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1140'><pre>    <span class="constant">Synonym</span><span class="punct">.</span><span class="ident">generate_from_name</span><span class="punct">(</span><span class="ident">name_obj</span><span class="punct">,</span> <span class="symbol">:agent</span> <span class="punct">=&gt;</span> <span class="ident">agent</span><span class="punct">,</span> <span class="symbol">:preferred</span> <span class="punct">=&gt;</span> <span class="ident">preferred</span><span class="punct">,</span> <span class="symbol">:language</span> <span class="punct">=&gt;</span> <span class="ident">language</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>1141</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1141'><pre>                               <span class="symbol">:entry</span> <span class="punct">=&gt;</span> <span class="ident">entry</span><span class="punct">,</span> <span class="symbol">:relation</span> <span class="punct">=&gt;</span> <span class="ident">relation</span><span class="punct">,</span> <span class="symbol">:vetted</span> <span class="punct">=&gt;</span> <span class="ident">vetted</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1142</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1142'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1143</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1143'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1144</small></td><td valign='top'><ul><li>LowCohesion - doesn't depend on instance state &raquo; reek</li><li>LowCohesion - refers to taxon_concept_name more than self &raquo; reek</li><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1144'><pre>  <span class="keyword">def </span><span class="method">delete_common_name</span><span class="punct">(</span><span class="ident">taxon_concept_name</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1145</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1145'><pre>    <span class="ident">language_id</span> <span class="punct">=</span> <span class="ident">taxon_concept_name</span><span class="punct">.</span><span class="ident">language</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>1146</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1146'><pre>    <span class="ident">syn_id</span> <span class="punct">=</span> <span class="ident">taxon_concept_name</span><span class="punct">.</span><span class="ident">synonym</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>1147</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1147'><pre>    <span class="constant">Synonym</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">syn_id</span><span class="punct">).</span><span class="ident">destroy</span>
</pre></a></td></tr><tr><td valign='top'><small>1148</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1148'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1149</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1149'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1150</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1150'><pre>  <span class="keyword">def </span><span class="method">has_feed?</span>
</pre></a></td></tr><tr><td valign='top'><small>1151</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1151'><pre>    <span class="ident">feed_object</span> <span class="punct">=</span> <span class="constant">FeedDataObject</span><span class="punct">.</span><span class="ident">find_by_taxon_concept_id</span><span class="punct">(</span><span class="constant">self</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="symbol">:limit</span> <span class="punct">=&gt;</span> <span class="number">1</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1152</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1152'><pre>    <span class="keyword">return</span> <span class="punct">!</span><span class="ident">feed_object</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>1153</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1153'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1154</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1154'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1155</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1155'><pre>  <span class="comment"># This needs to work on both TCNs and Synonyms.  Which, of course, smells like bad design, so.... TODO - review.</span>
</pre></a></td></tr><tr><td valign='top'><small>1156</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1156'><pre>  <span class="keyword">def </span><span class="method">vet_common_name</span><span class="punct">(</span><span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>1157</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1157'><pre>    <span class="ident">vet_taxon_concept_names</span><span class="punct">(</span><span class="ident">options</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1158</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1158'><pre>    <span class="ident">vet_synonyms</span><span class="punct">(</span><span class="ident">options</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1159</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1159'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1160</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1160'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1161</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1161'><pre>  <span class="keyword">def </span><span class="method">self.supercede_by_ids</span><span class="punct">(</span><span class="ident">id1</span><span class="punct">,</span> <span class="ident">id2</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1162</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1162'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">if</span> <span class="ident">id1</span> <span class="punct">==</span> <span class="ident">id2</span>
</pre></a></td></tr><tr><td valign='top'><small>1163</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1163'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">if</span> <span class="ident">id1</span><span class="punct">.</span><span class="keyword">class </span><span class="class">!=</span> <span class="ident">Fixnum</span> <span class="punct">||</span> <span class="ident">id1</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">||</span> <span class="ident">id1</span> <span class="punct">==</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>1164</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1164'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">if</span> <span class="ident">id2</span><span class="punct">.</span><span class="keyword">class </span><span class="class">!=</span> <span class="ident">Fixnum</span> <span class="punct">||</span> <span class="ident">id2</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">||</span> <span class="ident">id2</span> <span class="punct">==</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>1165</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1165'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1166</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1166'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1167</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1167'><pre>    <span class="comment"># always ensure ID1 is the smaller of the two</span>
</pre></a></td></tr><tr><td valign='top'><small>1168</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1168'><pre>    <span class="ident">id1</span><span class="punct">,</span> <span class="ident">id2</span> <span class="punct">=</span> <span class="ident">id2</span><span class="punct">,</span> <span class="ident">id1</span> <span class="keyword">if</span> <span class="ident">id2</span> <span class="punct">&lt;</span> <span class="ident">id1</span>
</pre></a></td></tr><tr><td valign='top'><small>1169</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1169'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1170</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1170'><pre>    <span class="keyword">begin</span>
</pre></a></td></tr><tr><td valign='top'><small>1171</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1171'><pre>      <span class="ident">tc1</span> <span class="punct">=</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">id1</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1172</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1172'><pre>      <span class="ident">tc2</span> <span class="punct">=</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">id2</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1173</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1173'><pre>    <span class="keyword">rescue</span>
</pre></a></td></tr><tr><td valign='top'><small>1174</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1174'><pre>      <span class="keyword">return</span> <span class="constant">false</span>
</pre></a></td></tr><tr><td valign='top'><small>1175</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1175'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1176</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1176'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1177</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1177'><pre>    <span class="comment"># at this point ID2 is the one going away</span>
</pre></a></td></tr><tr><td valign='top'><small>1178</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1178'><pre>    <span class="comment"># ID2 is being superceded by ID1</span>
</pre></a></td></tr><tr><td valign='top'><small>1179</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1179'><pre>    <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">execute</span><span class="punct">(&quot;</span><span class="string">UPDATE hierarchy_entries he JOIN taxon_concepts tc ON (he.taxon_concept_id=tc.id) SET he.taxon_concept_id=<span class="expr">#{id1}</span>, tc.supercedure_id=<span class="expr">#{id1}</span> WHERE taxon_concept_id=<span class="expr">#{id2}</span></span><span class="punct">&quot;);</span>
</pre></a></td></tr><tr><td valign='top'><small>1180</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1180'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1181</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1181'><pre>    <span class="comment"># all references to ID2 are getting changed to ID1</span>
</pre></a></td></tr><tr><td valign='top'><small>1182</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1182'><pre>    <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">execute</span><span class="punct">(&quot;</span><span class="string">UPDATE IGNORE taxon_concept_names SET taxon_concept_id=<span class="expr">#{id1}</span> WHERE taxon_concept_id=<span class="expr">#{id2}</span></span><span class="punct">&quot;);</span>
</pre></a></td></tr><tr><td valign='top'><small>1183</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1183'><pre>    <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">execute</span><span class="punct">(&quot;</span><span class="string">UPDATE IGNORE top_concept_images he SET taxon_concept_id=<span class="expr">#{id1}</span> WHERE taxon_concept_id=<span class="expr">#{id2}</span></span><span class="punct">&quot;);</span>
</pre></a></td></tr><tr><td valign='top'><small>1184</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1184'><pre>    <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">execute</span><span class="punct">(&quot;</span><span class="string">UPDATE IGNORE data_objects_taxon_concepts dotc SET taxon_concept_id=<span class="expr">#{id1}</span> WHERE taxon_concept_id=<span class="expr">#{id2}</span></span><span class="punct">&quot;);</span>
</pre></a></td></tr><tr><td valign='top'><small>1185</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1185'><pre>    <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">execute</span><span class="punct">(&quot;</span><span class="string">UPDATE IGNORE top_unpublished_concept_images he SET taxon_concept_id=<span class="expr">#{id1}</span> WHERE taxon_concept_id=<span class="expr">#{id2}</span></span><span class="punct">&quot;);</span>
</pre></a></td></tr><tr><td valign='top'><small>1186</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1186'><pre>    <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">execute</span><span class="punct">(&quot;</span><span class="string">UPDATE IGNORE hierarchy_entries he JOIN random_hierarchy_images rhi ON (he.id=rhi.hierarchy_entry_id) SET rhi.taxon_concept_id=he.taxon_concept_id WHERE he.taxon_concept_id=<span class="expr">#{id2}</span></span><span class="punct">&quot;);</span>
</pre></a></td></tr><tr><td valign='top'><small>1187</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1187'><pre>    <span class="keyword">return</span> <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>1188</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1188'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1189</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1189'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1190</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1190'><pre>  <span class="keyword">def </span><span class="method">videos</span><span class="punct">(</span><span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>1191</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1191'><pre>    <span class="ident">videos</span> <span class="punct">=</span> <span class="ident">filter_data_objects_by_type</span><span class="punct">(</span><span class="ident">options</span><span class="punct">.</span><span class="ident">merge</span><span class="punct">({</span><span class="symbol">:data_type_ids</span> <span class="punct">=&gt;</span> <span class="constant">DataType</span><span class="punct">.</span><span class="ident">video_type_ids</span><span class="punct">}))</span>
</pre></a></td></tr><tr><td valign='top'><small>1192</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1192'><pre>    <span class="attribute">@length_of_videos</span> <span class="punct">=</span> <span class="ident">videos</span><span class="punct">.</span><span class="ident">length</span> <span class="comment"># cached, so we don't have to query this again.</span>
</pre></a></td></tr><tr><td valign='top'><small>1193</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1193'><pre>    <span class="ident">videos</span>
</pre></a></td></tr><tr><td valign='top'><small>1194</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1194'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1195</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1195'><pre>  <span class="keyword">alias</span> <span class="symbol">:video_data_objects</span> <span class="symbol">:videos</span>
</pre></a></td></tr><tr><td valign='top'><small>1196</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1196'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1197</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1197'><pre>  <span class="keyword">def </span><span class="method">sounds</span><span class="punct">(</span><span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>1198</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1198'><pre>    <span class="ident">sounds</span> <span class="punct">=</span> <span class="ident">filter_data_objects_by_type</span><span class="punct">(</span><span class="ident">options</span><span class="punct">.</span><span class="ident">merge</span><span class="punct">({</span><span class="symbol">:data_type_ids</span> <span class="punct">=&gt;</span> <span class="constant">DataType</span><span class="punct">.</span><span class="ident">sound_type_ids</span><span class="punct">}))</span>
</pre></a></td></tr><tr><td valign='top'><small>1199</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1199'><pre>    <span class="attribute">@length_of_sounds</span> <span class="punct">=</span> <span class="ident">sounds</span><span class="punct">.</span><span class="ident">length</span> <span class="comment"># cached, so we don't have to query this again.</span>
</pre></a></td></tr><tr><td valign='top'><small>1200</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1200'><pre>    <span class="ident">sounds</span>
</pre></a></td></tr><tr><td valign='top'><small>1201</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1201'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1202</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1202'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1203</small></td><td valign='top'><ul><li>LowCohesion - refers to he more than self &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1203'><pre>  <span class="keyword">def </span><span class="method">curated_hierarchy_entries</span>
</pre></a></td></tr><tr><td valign='top'><small>1204</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1204'><pre>    <span class="ident">published_hierarchy_entries</span><span class="punct">.</span><span class="ident">select</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">he</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>1205</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1205'><pre>      <span class="ident">he</span><span class="punct">.</span><span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">browsable</span> <span class="punct">==</span> <span class="number">1</span> <span class="punct">&amp;&amp;</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">published</span> <span class="punct">==</span> <span class="number">1</span> <span class="punct">&amp;&amp;</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">visibility_id</span> <span class="punct">==</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">visible</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>1206</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1206'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1207</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1207'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1208</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1208'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1209</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1209'><pre>  <span class="keyword">def </span><span class="method">top_communities</span>
</pre></a></td></tr><tr><td valign='top'><small>1210</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1210'><pre>    <span class="ident">communities</span><span class="punct">[</span><span class="number">0</span><span class="punct">..</span><span class="number">2</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1211</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1211'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1212</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1212'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1213</small></td><td valign='top'><ul><li>Duplication - calls i.collection twice &raquo; reek</li><li>UncommunicativeName - has the variable name 'i' &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1213'><pre>  <span class="keyword">def </span><span class="method">communities</span>
</pre></a></td></tr><tr><td valign='top'><small>1214</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1214'><pre>    <span class="attribute">@communities</span> <span class="punct">||=</span> <span class="ident">collection_items</span><span class="punct">.</span><span class="ident">map</span> <span class="punct">{|</span><span class="ident">i</span><span class="punct">|</span> <span class="ident">i</span><span class="punct">.</span><span class="ident">collection</span><span class="punct">.</span><span class="ident">community_id</span><span class="punct">.</span><span class="ident">nil?</span> <span class="punct">?</span> <span class="constant">nil</span> <span class="punct">:</span> <span class="ident">i</span><span class="punct">.</span><span class="ident">collection</span><span class="punct">.</span><span class="ident">community</span> <span class="punct">}.</span><span class="ident">compact</span>
</pre></a></td></tr><tr><td valign='top'><small>1215</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1215'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1216</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1216'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1217</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1217'><pre>  <span class="comment"># TODO - This is terribly inefficient and shoud probably do most of the work via direct SQL or something...</span>
</pre></a></td></tr><tr><td valign='top'><small>1218</small></td><td valign='top'><ul><li>Duplication - calls a.community_id twice &raquo; reek</li><li>Duplication - calls b.community_id twice &raquo; reek</li><li>UncommunicativeName - has the variable name 'a' &raquo; reek</li><li>UncommunicativeName - has the variable name 'b' &raquo; reek</li><li>LowCohesion - refers to a more than self &raquo; reek</li><li>LowCohesion - refers to b more than self &raquo; reek</li><li>Complexity 5 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1218'><pre>  <span class="keyword">def </span><span class="method">top_collections</span>
</pre></a></td></tr><tr><td valign='top'><small>1219</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1219'><pre>    <span class="ident">collections</span> <span class="punct">=</span> <span class="ident">collection_items</span><span class="punct">.</span><span class="ident">map</span> <span class="punct">{|</span><span class="ident">ci</span><span class="punct">|</span> <span class="ident">ci</span><span class="punct">.</span><span class="ident">collection</span> <span class="punct">}.</span><span class="ident">compact</span><span class="punct">.</span><span class="ident">sort</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">a</span><span class="punct">,</span><span class="ident">b</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>1220</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1220'><pre>      <span class="keyword">if</span> <span class="ident">a</span><span class="punct">.</span><span class="ident">community_id</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>1221</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1221'><pre>        <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>1222</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1222'><pre>      <span class="keyword">elsif</span> <span class="ident">b</span><span class="punct">.</span><span class="ident">community_id</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>1223</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1223'><pre>        <span class="punct">-</span><span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>1224</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1224'><pre>      <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>1225</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1225'><pre>        <span class="ident">a</span><span class="punct">.</span><span class="ident">community_id</span> <span class="punct">&lt;=&gt;</span> <span class="ident">b</span><span class="punct">.</span><span class="ident">community_id</span>
</pre></a></td></tr><tr><td valign='top'><small>1226</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1226'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1227</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1227'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1228</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1228'><pre>    <span class="keyword">return</span> <span class="ident">collections</span><span class="punct">[</span><span class="number">0</span><span class="punct">..</span><span class="number">2</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1229</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1229'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1230</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1230'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1231</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1231'><pre><span class="ident">private</span>
</pre></a></td></tr><tr><td valign='top'><small>1232</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1232'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1233</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1233'><pre>  <span class="comment"># You must pass in the :data_type_ids option for this to work.  Use DataObject.FOO_type_ids for the value.  eg:</span>
</pre></a></td></tr><tr><td valign='top'><small>1234</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1234'><pre>  <span class="comment">#   videos = filter_data_objects_by_type(:data_type_ids =&gt; DataObject.video_type_ids)</span>
</pre></a></td></tr><tr><td valign='top'><small>1235</small></td><td valign='top'><ul><li>Duplication - calls current_user twice &raquo; reek</li><li>LongMethod - has approx 10 statements &raquo; reek</li><li>UncommunicativeName - has the variable name 'd' &raquo; reek</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1235'><pre>  <span class="keyword">def </span><span class="method">filter_data_objects_by_type</span><span class="punct">(</span><span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>1236</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1236'><pre>    <span class="ident">usr</span> <span class="punct">=</span> <span class="ident">current_user</span>
</pre></a></td></tr><tr><td valign='top'><small>1237</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1237'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:unvetted</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1238</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1238'><pre>      <span class="ident">usr</span> <span class="punct">=</span> <span class="ident">current_user</span><span class="punct">.</span><span class="ident">clone</span>
</pre></a></td></tr><tr><td valign='top'><small>1239</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1239'><pre>      <span class="ident">usr</span><span class="punct">.</span><span class="ident">vetted</span> <span class="punct">=</span> <span class="constant">false</span>
</pre></a></td></tr><tr><td valign='top'><small>1240</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1240'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1241</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1241'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1242</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1242'><pre>    <span class="ident">objects</span> <span class="punct">=</span> <span class="ident">data_objects</span><span class="punct">.</span><span class="ident">select</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:data_type_ids</span><span class="punct">].</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">d</span><span class="punct">.</span><span class="ident">data_type_id</span><span class="punct">)</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>1243</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1243'><pre>    <span class="ident">filtered_objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">filter_list_for_user</span><span class="punct">(</span><span class="ident">objects</span><span class="punct">,</span> <span class="symbol">:user</span> <span class="punct">=&gt;</span> <span class="ident">usr</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1244</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1244'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1245</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1245'><pre>    <span class="ident">add_include</span> <span class="punct">=</span> <span class="punct">[</span><span class="symbol">:agents_data_objects</span><span class="punct">,</span> <span class="symbol">:all_comments</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1246</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1246'><pre>    <span class="ident">add_select</span> <span class="punct">=</span> <span class="punct">{</span> <span class="symbol">:comments</span> <span class="punct">=&gt;</span> <span class="punct">[</span><span class="symbol">:parent_id</span><span class="punct">,</span> <span class="symbol">:visible_at</span><span class="punct">]</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>1247</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1247'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1248</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1248'><pre>    <span class="ident">objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">core_relationships</span><span class="punct">(</span><span class="symbol">:add_include</span> <span class="punct">=&gt;</span> <span class="ident">add_include</span><span class="punct">,</span> <span class="symbol">:add_select</span> <span class="punct">=&gt;</span> <span class="ident">add_select</span><span class="punct">).</span>
</pre></a></td></tr><tr><td valign='top'><small>1249</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1249'><pre>        <span class="ident">find_all_by_id</span><span class="punct">(</span><span class="ident">filtered_objects</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">})</span>
</pre></a></td></tr><tr><td valign='top'><small>1250</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1250'><pre>    <span class="ident">objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">sort_by_rating</span><span class="punct">(</span><span class="ident">objects</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1251</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1251'><pre>    <span class="keyword">return</span> <span class="ident">objects</span>
</pre></a></td></tr><tr><td valign='top'><small>1252</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1252'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1253</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1253'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1254</small></td><td valign='top'><ul><li>Duplication - calls options[:language_id] twice &raquo; reek</li><li>Duplication - calls options[:name_id] twice &raquo; reek</li><li>Duplication - calls options[:vetted] twice &raquo; reek</li><li>LowCohesion - refers to options more than self &raquo; reek</li><li>Complexity 5 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1254'><pre>  <span class="keyword">def </span><span class="method">vet_taxon_concept_names</span><span class="punct">(</span><span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>1255</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1255'><pre>    <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Missing :language_id</span><span class="punct">&quot;</span> <span class="keyword">unless</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:language_id</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1256</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1256'><pre>    <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Missing :name_id</span><span class="punct">&quot;</span> <span class="keyword">unless</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:name_id</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1257</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1257'><pre>    <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Missing :vetted</span><span class="punct">&quot;</span> <span class="keyword">unless</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1258</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1258'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1259</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1259'><pre>    <span class="ident">taxon_concept_names_by_lang_id_and_name_id</span><span class="punct">(</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:language_id</span><span class="punct">],</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:name_id</span><span class="punct">]).</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">tcn</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>1260</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1260'><pre>      <span class="ident">tcn</span><span class="punct">.</span><span class="ident">vet</span><span class="punct">(</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted</span><span class="punct">],</span> <span class="ident">current_user</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1261</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1261'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1262</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1262'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1263</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1263'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1264</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1264'><pre>  <span class="keyword">def </span><span class="method">taxon_concept_names_by_lang_id_and_name_id</span><span class="punct">(</span><span class="ident">id_for_lang</span><span class="punct">,</span> <span class="ident">id_for_name</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1265</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1265'><pre>    <span class="constant">TaxonConceptName</span><span class="punct">.</span><span class="ident">scoped</span><span class="punct">(</span>
</pre></a></td></tr><tr><td valign='top'><small>1266</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1266'><pre>      <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">['</span><span class="string">taxon_concept_id = ? AND language_id = ? AND name_id = ?</span><span class="punct">',</span> <span class="ident">id</span><span class="punct">,</span> <span class="ident">id_for_lang</span><span class="punct">,</span> <span class="ident">id_for_name</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1267</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1267'><pre>    <span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1268</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1268'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1269</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1269'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1270</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1270'><pre>  <span class="keyword">def </span><span class="method">vet_synonyms</span><span class="punct">(</span><span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>1271</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1271'><pre>    <span class="ident">hierarchy_entries</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">he</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>1272</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1272'><pre>      <span class="ident">he</span><span class="punct">.</span><span class="ident">vet_synonyms</span><span class="punct">(</span><span class="ident">options</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1273</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1273'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1274</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1274'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1275</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1275'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1276</small></td><td valign='top'><ul><li>Duplication - calls data_object.description_linked twice &raquo; reek</li><li>Duplication - calls entry twice &raquo; reek</li><li>NestedIterators - contains iterators nested 2 deep &raquo; reek</li><li>LongMethod - has approx 10 statements &raquo; reek</li><li>LowCohesion - refers to data_object more than self &raquo; reek</li><li>Method "get_default_content" has 29 lines.  It should have 20 or less. &raquo; roodi</li><li>Complexity 5 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1276'><pre>  <span class="keyword">def </span><span class="method">get_default_content</span><span class="punct">(</span><span class="ident">toc_item</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1277</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1277'><pre>    <span class="ident">result</span> <span class="punct">=</span> <span class="punct">{</span>
</pre></a></td></tr><tr><td valign='top'><small>1278</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1278'><pre>      <span class="symbol">:content_type</span>  <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">text</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>1279</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1279'><pre>      <span class="symbol">:category_name</span> <span class="punct">=&gt;</span> <span class="ident">toc_item</span><span class="punct">.</span><span class="ident">label</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>1280</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1280'><pre>      <span class="symbol">:data_objects</span>  <span class="punct">=&gt;</span> <span class="ident">text_objects_for_toc_items</span><span class="punct">(</span><span class="ident">toc_item</span><span class="punct">,</span> <span class="symbol">:user</span> <span class="punct">=&gt;</span> <span class="ident">current_user</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1281</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1281'><pre>    <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>1282</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1282'><pre>    <span class="comment"># TODO = this should not be hard-coded! IDEA = use partials.  Then we have variables and they can be dynamically changed.</span>
</pre></a></td></tr><tr><td valign='top'><small>1283</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1283'><pre>    <span class="comment"># NOTE: I tried to dynamically alter data_objects directly, below, but they didn't</span>
</pre></a></td></tr><tr><td valign='top'><small>1284</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1284'><pre>    <span class="comment"># &quot;stick&quot;.  Thus, I override the array:</span>
</pre></a></td></tr><tr><td valign='top'><small>1285</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1285'><pre>    <span class="ident">override_data_objects</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>1286</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1286'><pre>    <span class="ident">result</span><span class="punct">[</span><span class="symbol">:data_objects</span><span class="punct">].</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">data_object</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>1287</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1287'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1288</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1288'><pre>      <span class="comment"># override the object's description with the linked one if available</span>
</pre></a></td></tr><tr><td valign='top'><small>1289</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1289'><pre>      <span class="ident">data_object</span><span class="punct">.</span><span class="ident">description</span> <span class="punct">=</span> <span class="ident">data_object</span><span class="punct">.</span><span class="ident">description_linked</span> <span class="keyword">if</span> <span class="punct">!</span><span class="ident">data_object</span><span class="punct">.</span><span class="ident">description_linked</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>1290</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1290'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1291</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1291'><pre>      <span class="keyword">if</span> <span class="ident">entry</span> <span class="punct">&amp;&amp;</span> <span class="ident">data_object</span><span class="punct">.</span><span class="ident">sources</span><span class="punct">.</span><span class="ident">detect</span> <span class="punct">{</span> <span class="punct">|</span><span class="ident">src</span><span class="punct">|</span> <span class="ident">src</span><span class="punct">.</span><span class="ident">full_name</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">FishBase</span><span class="punct">'</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>1292</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1292'><pre>        <span class="comment"># TODO - We need a better way to choose which Agent to look at.  : \</span>
</pre></a></td></tr><tr><td valign='top'><small>1293</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1293'><pre>        <span class="comment"># TODO - We need a better way to choose which Collection to look at.  : \</span>
</pre></a></td></tr><tr><td valign='top'><small>1294</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1294'><pre>        <span class="comment"># TODO - We need a better way to choose which Mapping to look at.  : \</span>
</pre></a></td></tr><tr><td valign='top'><small>1295</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1295'><pre>        <span class="ident">foreign_key</span>      <span class="punct">=</span> <span class="ident">data_object</span><span class="punct">.</span><span class="ident">agents</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">collections</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">mappings</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">foreign_key</span>
</pre></a></td></tr><tr><td valign='top'><small>1296</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1296'><pre>        <span class="punct">(</span><span class="ident">genus</span><span class="punct">,</span> <span class="ident">species</span><span class="punct">)</span> <span class="punct">=</span> <span class="ident">entry</span><span class="punct">.</span><span class="ident">name</span><span class="punct">.</span><span class="ident">canonical_form</span><span class="punct">.</span><span class="ident">string</span><span class="punct">.</span><span class="ident">split</span><span class="punct">()</span>
</pre></a></td></tr><tr><td valign='top'><small>1297</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1297'><pre>        <span class="ident">data_object</span><span class="punct">.</span><span class="ident">fake_author</span><span class="punct">(</span>
</pre></a></td></tr><tr><td valign='top'><small>1298</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1298'><pre>          <span class="symbol">:full_name</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">See FishBase for additional references</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>1299</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1299'><pre>          <span class="symbol">:homepage</span>  <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">http://www.fishbase.org/References/SummaryRefList.cfm?ID=<span class="expr">#{foreign_key}</span>&amp;GenusName=<span class="expr">#{genus}</span>&amp;SpeciesName=<span class="expr">#{species}</span></span><span class="punct">&quot;,</span>
</pre></a></td></tr><tr><td valign='top'><small>1300</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1300'><pre>          <span class="symbol">:logo_cache_url</span>  <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>1301</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1301'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1302</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1302'><pre>      <span class="ident">override_data_objects</span> <span class="punct">&lt;&lt;</span> <span class="ident">data_object</span>
</pre></a></td></tr><tr><td valign='top'><small>1303</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1303'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1304</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1304'><pre>    <span class="ident">result</span><span class="punct">[</span><span class="symbol">:data_objects</span><span class="punct">]</span> <span class="punct">=</span> <span class="ident">override_data_objects</span>
</pre></a></td></tr><tr><td valign='top'><small>1305</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1305'><pre>    <span class="keyword">return</span> <span class="ident">result</span>
</pre></a></td></tr><tr><td valign='top'><small>1306</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1306'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1307</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1307'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1308</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1308'><pre><span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1309</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1309'><pre>
</pre></a></td></tr><table></body></html>
