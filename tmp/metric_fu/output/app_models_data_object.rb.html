<html><head><style>table { background: #fff; color: #000; }
.ruby .normal { color: #000; }
.ruby .comment { color: #005; font-style: italic; }
.ruby .keyword { color: #A44; font-weight: bold; }
.ruby .method { color: #44f; }
.ruby .class { color: #b1713d; }
.ruby .module { color: #050; }
.ruby .punct { color: #668; font-weight: bold; }
.ruby .symbol { color: #00f; }
.ruby .string { color: #4a4; }
.ruby .char { color: #F07; }
.ruby .ident { color: #000; }
.ruby .constant { color: #b1713d; }
.ruby .regex { color: #B66; background: #FEF; }
.ruby .number { color: #F99; }
.ruby .attribute { color: #f84; }
.ruby .global { color: #7FB; }
.ruby .expr { color: #227; }
.ruby .escape { color: #277; }</style></head><body><table cellpadding='0' cellspacing='0' class='ruby'><tr><td valign='top'><small>1</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1'><pre><span class="ident">require</span> <span class="punct">'</span><span class="string">set</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>2</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line2'><pre><span class="ident">require</span> <span class="punct">'</span><span class="string">uuid</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>3</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line3'><pre><span class="ident">require</span> <span class="punct">'</span><span class="string">erb</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>4</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line4'><pre>
</pre></a></td></tr><tr><td valign='top'><small>5</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line5'><pre><span class="comment"># Represents any kind of object imported from a ContentPartner, eg. an image, article, video, etc.  This is one</span>
</pre></a></td></tr><tr><td valign='top'><small>6</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line6'><pre><span class="comment"># of our primary models, and an awful lot of work occurs here.</span>
</pre></a></td></tr><tr><td valign='top'><small>7</small></td><td valign='top'><ul><li>Class "DataObject" has 1102 lines.  It should have 300 or less. &raquo; roodi</li></ul></td><td valign='top'><a name='line7'><pre><span class="keyword">class </span><span class="class">DataObject</span> <span class="punct">&lt;</span> <span class="constant">SpeciesSchemaModel</span>
</pre></a></td></tr><tr><td valign='top'><small>8</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line8'><pre>
</pre></a></td></tr><tr><td valign='top'><small>9</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line9'><pre>  <span class="ident">include</span> <span class="constant">ModelQueryHelper</span>
</pre></a></td></tr><tr><td valign='top'><small>10</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line10'><pre>  <span class="ident">include</span> <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Feedable</span>
</pre></a></td></tr><tr><td valign='top'><small>11</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line11'><pre>
</pre></a></td></tr><tr><td valign='top'><small>12</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line12'><pre>  <span class="ident">belongs_to</span> <span class="symbol">:data_type</span>
</pre></a></td></tr><tr><td valign='top'><small>13</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line13'><pre>  <span class="ident">belongs_to</span> <span class="symbol">:language</span>
</pre></a></td></tr><tr><td valign='top'><small>14</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line14'><pre>  <span class="ident">belongs_to</span> <span class="symbol">:license</span>
</pre></a></td></tr><tr><td valign='top'><small>15</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line15'><pre>  <span class="ident">belongs_to</span> <span class="symbol">:mime_type</span>
</pre></a></td></tr><tr><td valign='top'><small>16</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line16'><pre>  <span class="ident">belongs_to</span> <span class="symbol">:visibility</span>
</pre></a></td></tr><tr><td valign='top'><small>17</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line17'><pre>  <span class="ident">belongs_to</span> <span class="symbol">:vetted</span>
</pre></a></td></tr><tr><td valign='top'><small>18</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line18'><pre>
</pre></a></td></tr><tr><td valign='top'><small>19</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line19'><pre>  <span class="ident">has_many</span> <span class="symbol">:top_images</span>
</pre></a></td></tr><tr><td valign='top'><small>20</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line20'><pre>  <span class="ident">has_many</span> <span class="symbol">:feed_data_objects</span>
</pre></a></td></tr><tr><td valign='top'><small>21</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line21'><pre>  <span class="ident">has_many</span> <span class="symbol">:top_concept_images</span>
</pre></a></td></tr><tr><td valign='top'><small>22</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line22'><pre>  <span class="ident">has_many</span> <span class="symbol">:agents_data_objects</span>
</pre></a></td></tr><tr><td valign='top'><small>23</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line23'><pre>  <span class="ident">has_many</span> <span class="symbol">:data_objects_hierarchy_entries</span>
</pre></a></td></tr><tr><td valign='top'><small>24</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line24'><pre>  <span class="ident">has_many</span> <span class="symbol">:curated_data_objects_hierarchy_entries</span>
</pre></a></td></tr><tr><td valign='top'><small>25</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line25'><pre>  <span class="ident">has_many</span> <span class="symbol">:comments</span><span class="punct">,</span> <span class="symbol">:as</span> <span class="punct">=&gt;</span> <span class="symbol">:parent</span>
</pre></a></td></tr><tr><td valign='top'><small>26</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line26'><pre>  <span class="ident">has_many</span> <span class="symbol">:data_objects_harvest_events</span>
</pre></a></td></tr><tr><td valign='top'><small>27</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line27'><pre>  <span class="ident">has_many</span> <span class="symbol">:harvest_events</span><span class="punct">,</span> <span class="symbol">:through</span> <span class="punct">=&gt;</span> <span class="symbol">:data_objects_harvest_events</span>
</pre></a></td></tr><tr><td valign='top'><small>28</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line28'><pre>  <span class="ident">has_many</span> <span class="symbol">:data_object_tags</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">DataObjectTags</span><span class="punct">.</span><span class="ident">to_s</span>
</pre></a></td></tr><tr><td valign='top'><small>29</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line29'><pre>  <span class="ident">has_many</span> <span class="symbol">:tags</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">DataObjectTag</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="symbol">:through</span> <span class="punct">=&gt;</span> <span class="symbol">:data_object_tags</span><span class="punct">,</span> <span class="symbol">:source</span> <span class="punct">=&gt;</span> <span class="symbol">:data_object_tag</span>
</pre></a></td></tr><tr><td valign='top'><small>30</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line30'><pre>  <span class="ident">has_many</span> <span class="symbol">:data_objects_table_of_contents</span>
</pre></a></td></tr><tr><td valign='top'><small>31</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line31'><pre>  <span class="ident">has_many</span> <span class="symbol">:data_objects_info_items</span>
</pre></a></td></tr><tr><td valign='top'><small>32</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line32'><pre>  <span class="ident">has_many</span> <span class="symbol">:info_items</span><span class="punct">,</span> <span class="symbol">:through</span> <span class="punct">=&gt;</span> <span class="symbol">:data_objects_info_items</span>
</pre></a></td></tr><tr><td valign='top'><small>33</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line33'><pre>  <span class="ident">has_many</span> <span class="symbol">:taxon_concept_exemplar_images</span>
</pre></a></td></tr><tr><td valign='top'><small>34</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line34'><pre>  <span class="comment"># has_many :user_ignored_data_objects</span>
</pre></a></td></tr><tr><td valign='top'><small>35</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line35'><pre>  <span class="ident">has_many</span> <span class="symbol">:collection_items</span><span class="punct">,</span> <span class="symbol">:as</span> <span class="punct">=&gt;</span> <span class="symbol">:object</span>
</pre></a></td></tr><tr><td valign='top'><small>36</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line36'><pre>  <span class="ident">has_many</span> <span class="symbol">:users_data_objects</span>
</pre></a></td></tr><tr><td valign='top'><small>37</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line37'><pre>  <span class="ident">has_many</span> <span class="symbol">:users_data_objects_ratings</span><span class="punct">,</span> <span class="symbol">:foreign_key</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">data_object_guid</span><span class="punct">',</span> <span class="symbol">:primary_key</span> <span class="punct">=&gt;</span> <span class="symbol">:guid</span>
</pre></a></td></tr><tr><td valign='top'><small>38</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line38'><pre>  <span class="ident">has_many</span> <span class="symbol">:all_comments</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">Comment</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="symbol">:foreign_key</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">parent_id</span><span class="punct">',</span> <span class="symbol">:finder_sql</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">SELECT c.* FROM #{Comment.full_table_name} c JOIN #{DataObject.full_table_name} do ON (c.parent_id = do.id) WHERE do.guid=<span class="escape">\'</span>#{guid}<span class="escape">\'</span> AND c.parent_type = <span class="escape">\'</span>DataObject<span class="escape">\'</span></span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>39</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line39'><pre>  <span class="comment"># has_many :all_comments, :class_name =&gt; Comment.to_s, :through =&gt; :all_versions, :source =&gt; :comments, :primary_key =&gt; :guid</span>
</pre></a></td></tr><tr><td valign='top'><small>40</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line40'><pre>  <span class="comment"># # the select_with_include library doesn't allow to grab do.* one time, then do.id later on - but this would be a neat method,</span>
</pre></a></td></tr><tr><td valign='top'><small>41</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line41'><pre>  <span class="comment"># has_many :all_versions, :class_name =&gt; DataObject.to_s, :foreign_key =&gt; :guid, :primary_key =&gt; :guid, :select =&gt; 'id, guid'</span>
</pre></a></td></tr><tr><td valign='top'><small>42</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line42'><pre>
</pre></a></td></tr><tr><td valign='top'><small>43</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line43'><pre>  <span class="ident">has_and_belongs_to_many</span> <span class="symbol">:hierarchy_entries</span>
</pre></a></td></tr><tr><td valign='top'><small>44</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line44'><pre>  <span class="ident">has_and_belongs_to_many</span> <span class="symbol">:audiences</span>
</pre></a></td></tr><tr><td valign='top'><small>45</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line45'><pre>  <span class="ident">has_and_belongs_to_many</span> <span class="symbol">:refs</span>
</pre></a></td></tr><tr><td valign='top'><small>46</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line46'><pre>  <span class="ident">has_and_belongs_to_many</span> <span class="symbol">:published_refs</span><span class="punct">,</span> <span class="symbol">:class_name</span> <span class="punct">=&gt;</span> <span class="constant">Ref</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="symbol">:join_table</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">data_objects_refs</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>47</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line47'><pre>    <span class="symbol">:association_foreign_key</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">ref_id</span><span class="punct">',</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">published=1 AND visibility_id=#{Visibility.visible.id}</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>48</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line48'><pre>
</pre></a></td></tr><tr><td valign='top'><small>49</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line49'><pre>  <span class="ident">has_and_belongs_to_many</span> <span class="symbol">:agents</span>
</pre></a></td></tr><tr><td valign='top'><small>50</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line50'><pre>  <span class="ident">has_and_belongs_to_many</span> <span class="symbol">:toc_items</span><span class="punct">,</span> <span class="symbol">:join_table</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">data_objects_table_of_contents</span><span class="punct">',</span> <span class="symbol">:association_foreign_key</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">toc_id</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>51</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line51'><pre>  <span class="ident">has_and_belongs_to_many</span> <span class="symbol">:taxon_concepts</span>
</pre></a></td></tr><tr><td valign='top'><small>52</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line52'><pre>
</pre></a></td></tr><tr><td valign='top'><small>53</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line53'><pre>  <span class="ident">attr_accessor</span> <span class="symbol">:vetted_by</span> <span class="comment"># who changed the state of this object? (not persisted on DataObject but required by observer)</span>
</pre></a></td></tr><tr><td valign='top'><small>54</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line54'><pre>
</pre></a></td></tr><tr><td valign='top'><small>55</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line55'><pre>  <span class="ident">named_scope</span> <span class="symbol">:visible</span><span class="punct">,</span> <span class="ident">lambda</span> <span class="punct">{</span> <span class="punct">{</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:visibility_id</span> <span class="punct">=&gt;</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">visible</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}</span> <span class="punct">}}</span>
</pre></a></td></tr><tr><td valign='top'><small>56</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line56'><pre>  <span class="ident">named_scope</span> <span class="symbol">:preview</span><span class="punct">,</span> <span class="ident">lambda</span> <span class="punct">{</span> <span class="punct">{</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:visibility_id</span> <span class="punct">=&gt;</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">preview</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}</span> <span class="punct">}}</span>
</pre></a></td></tr><tr><td valign='top'><small>57</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line57'><pre>
</pre></a></td></tr><tr><td valign='top'><small>58</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line58'><pre>  <span class="ident">define_core_relationships</span> <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="punct">{</span>
</pre></a></td></tr><tr><td valign='top'><small>59</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line59'><pre>      <span class="symbol">:data_objects</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>60</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line60'><pre>      <span class="symbol">:agents</span> <span class="punct">=&gt;</span> <span class="punct">[</span><span class="symbol">:full_name</span><span class="punct">,</span> <span class="symbol">:homepage</span><span class="punct">,</span> <span class="symbol">:logo_cache_url</span><span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>61</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line61'><pre>      <span class="symbol">:agents_data_objects</span> <span class="punct">=&gt;</span> <span class="symbol">:view_order</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>62</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line62'><pre>      <span class="symbol">:names</span> <span class="punct">=&gt;</span> <span class="symbol">:string</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>63</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line63'><pre>      <span class="symbol">:hierarchy_entries</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:published</span><span class="punct">,</span> <span class="symbol">:visibility_id</span><span class="punct">,</span> <span class="symbol">:taxon_concept_id</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>64</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line64'><pre>      <span class="symbol">:languages</span> <span class="punct">=&gt;</span> <span class="symbol">:iso_639_1</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>65</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line65'><pre>      <span class="symbol">:info_items</span> <span class="punct">=&gt;</span> <span class="symbol">:schema_value</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>66</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line66'><pre>      <span class="symbol">:data_types</span> <span class="punct">=&gt;</span> <span class="symbol">:schema_value</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>67</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line67'><pre>      <span class="symbol">:vetted</span> <span class="punct">=&gt;</span> <span class="symbol">:view_order</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>68</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line68'><pre>      <span class="symbol">:table_of_contents</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>69</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line69'><pre>      <span class="symbol">:licenses</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">*</span><span class="punct">'</span> <span class="punct">},</span>
</pre></a></td></tr><tr><td valign='top'><small>70</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line70'><pre>    <span class="symbol">:include</span> <span class="punct">=&gt;</span> <span class="punct">[</span><span class="symbol">:data_type</span><span class="punct">,</span> <span class="symbol">:mime_type</span><span class="punct">,</span> <span class="symbol">:language</span><span class="punct">,</span> <span class="symbol">:license</span><span class="punct">,</span> <span class="symbol">:vetted</span><span class="punct">,</span> <span class="symbol">:visibility</span><span class="punct">,</span> <span class="punct">{</span><span class="symbol">:info_items</span> <span class="punct">=&gt;</span> <span class="symbol">:toc_item</span><span class="punct">},</span>
</pre></a></td></tr><tr><td valign='top'><small>71</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line71'><pre>      <span class="punct">{</span><span class="symbol">:hierarchy_entries</span> <span class="punct">=&gt;</span> <span class="punct">[</span><span class="symbol">:name</span><span class="punct">,</span> <span class="punct">{</span> <span class="symbol">:hierarchy</span> <span class="punct">=&gt;</span> <span class="symbol">:agent</span> <span class="punct">}]</span> <span class="punct">},</span> <span class="punct">{</span><span class="symbol">:agents_data_objects</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="punct">{</span> <span class="symbol">:agent</span> <span class="punct">=&gt;</span> <span class="symbol">:user</span> <span class="punct">},</span> <span class="symbol">:agent_role</span><span class="punct">]}]</span>
</pre></a></td></tr><tr><td valign='top'><small>72</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line72'><pre>
</pre></a></td></tr><tr><td valign='top'><small>73</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line73'><pre>  <span class="comment"># this method is not just sorting by rating</span>
</pre></a></td></tr><tr><td valign='top'><small>74</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line74'><pre>  <span class="keyword">def </span><span class="method">self.sort_by_rating</span><span class="punct">(</span><span class="ident">data_objects</span><span class="punct">,</span> <span class="ident">sort_order</span> <span class="punct">=</span> <span class="punct">[</span><span class="symbol">:type</span><span class="punct">,</span> <span class="symbol">:toc</span><span class="punct">,</span> <span class="symbol">:visibility</span><span class="punct">,</span> <span class="symbol">:vetted</span><span class="punct">,</span> <span class="symbol">:rating</span><span class="punct">,</span> <span class="symbol">:date</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>75</small></td><td valign='top'><ul><li>Block cyclomatic complexity is 12.  It should be 4 or less. &raquo; roodi</li></ul></td><td valign='top'><a name='line75'><pre>    <span class="ident">data_objects</span><span class="punct">.</span><span class="ident">sort_by</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">obj</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>76</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line76'><pre>      <span class="ident">type_order</span> <span class="punct">=</span> <span class="ident">obj</span><span class="punct">.</span><span class="ident">data_type_id</span>
</pre></a></td></tr><tr><td valign='top'><small>77</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line77'><pre>      <span class="ident">toc_view_order</span> <span class="punct">=</span> <span class="punct">(!</span><span class="ident">obj</span><span class="punct">.</span><span class="ident">is_text?</span> <span class="punct">||</span> <span class="ident">obj</span><span class="punct">.</span><span class="ident">info_items</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">||</span> <span class="ident">obj</span><span class="punct">.</span><span class="ident">info_items</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">toc_item</span><span class="punct">.</span><span class="ident">blank?</span><span class="punct">)</span> <span class="punct">?</span> <span class="number">0</span> <span class="punct">:</span> <span class="ident">obj</span><span class="punct">.</span><span class="ident">info_items</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">toc_item</span><span class="punct">.</span><span class="ident">view_order</span>
</pre></a></td></tr><tr><td valign='top'><small>78</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line78'><pre>      <span class="ident">vetted_view_order</span> <span class="punct">=</span> <span class="ident">obj</span><span class="punct">.</span><span class="ident">vetted</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">?</span> <span class="number">0</span> <span class="punct">:</span> <span class="ident">obj</span><span class="punct">.</span><span class="ident">vetted</span><span class="punct">.</span><span class="ident">view_order</span>
</pre></a></td></tr><tr><td valign='top'><small>79</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line79'><pre>      <span class="ident">visibility_view_order</span> <span class="punct">=</span> <span class="number">2</span>
</pre></a></td></tr><tr><td valign='top'><small>80</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line80'><pre>      <span class="ident">visibility_view_order</span> <span class="punct">=</span> <span class="number">1</span> <span class="keyword">if</span> <span class="ident">obj</span><span class="punct">.</span><span class="ident">visibility_id</span> <span class="punct">==</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">preview</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>81</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line81'><pre>      <span class="ident">inverted_rating</span> <span class="punct">=</span> <span class="ident">obj</span><span class="punct">.</span><span class="ident">data_rating</span> <span class="punct">*</span> <span class="punct">-</span><span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>82</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line82'><pre>      <span class="ident">inverted_id</span> <span class="punct">=</span> <span class="ident">obj</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">*</span> <span class="punct">-</span><span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>83</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line83'><pre>      <span class="ident">sort</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>84</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line84'><pre>      <span class="ident">sort_order</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">item</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>85</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line85'><pre>        <span class="ident">sort</span> <span class="punct">&lt;&lt;</span> <span class="ident">type_order</span> <span class="keyword">if</span> <span class="ident">item</span> <span class="punct">==</span> <span class="symbol">:type</span>
</pre></a></td></tr><tr><td valign='top'><small>86</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line86'><pre>        <span class="ident">sort</span> <span class="punct">&lt;&lt;</span> <span class="ident">toc_view_order</span> <span class="keyword">if</span> <span class="ident">item</span> <span class="punct">==</span> <span class="symbol">:toc</span>
</pre></a></td></tr><tr><td valign='top'><small>87</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line87'><pre>        <span class="ident">sort</span> <span class="punct">&lt;&lt;</span> <span class="ident">visibility_view_order</span> <span class="keyword">if</span> <span class="ident">item</span> <span class="punct">==</span> <span class="symbol">:visibility</span>
</pre></a></td></tr><tr><td valign='top'><small>88</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line88'><pre>        <span class="ident">sort</span> <span class="punct">&lt;&lt;</span> <span class="ident">vetted_view_order</span> <span class="keyword">if</span> <span class="ident">item</span> <span class="punct">==</span> <span class="symbol">:vetted</span>
</pre></a></td></tr><tr><td valign='top'><small>89</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line89'><pre>        <span class="ident">sort</span> <span class="punct">&lt;&lt;</span> <span class="ident">inverted_rating</span> <span class="keyword">if</span> <span class="ident">item</span> <span class="punct">==</span> <span class="symbol">:rating</span>
</pre></a></td></tr><tr><td valign='top'><small>90</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line90'><pre>        <span class="ident">sort</span> <span class="punct">&lt;&lt;</span> <span class="ident">inverted_id</span> <span class="keyword">if</span> <span class="ident">item</span> <span class="punct">==</span> <span class="symbol">:date</span>
</pre></a></td></tr><tr><td valign='top'><small>91</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line91'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>92</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line92'><pre>      <span class="ident">sort</span>
</pre></a></td></tr><tr><td valign='top'><small>93</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line93'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>94</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line94'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>95</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line95'><pre>
</pre></a></td></tr><tr><td valign='top'><small>96</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line96'><pre>  <span class="keyword">def </span><span class="method">self.custom_filter</span><span class="punct">(</span><span class="ident">data_objects</span><span class="punct">,</span> <span class="ident">type</span><span class="punct">,</span> <span class="ident">status</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>97</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line97'><pre>
</pre></a></td></tr><tr><td valign='top'><small>98</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line98'><pre>    <span class="keyword">return</span> <span class="ident">data_objects</span> <span class="keyword">if</span> <span class="ident">data_objects</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>99</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line99'><pre>
</pre></a></td></tr><tr><td valign='top'><small>100</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line100'><pre>    <span class="comment"># set types on which to filter or blank if no filter should be applied</span>
</pre></a></td></tr><tr><td valign='top'><small>101</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line101'><pre>    <span class="ident">allowed_data_types</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>102</small></td><td valign='top'><ul><li>Block cyclomatic complexity is 9.  It should be 4 or less. &raquo; roodi</li></ul></td><td valign='top'><a name='line102'><pre>    <span class="ident">type</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">typ</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>103</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line103'><pre>      <span class="keyword">if</span> <span class="ident">typ</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">all</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>104</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line104'><pre>        <span class="ident">allowed_data_types</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>105</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line105'><pre>        <span class="keyword">break</span>
</pre></a></td></tr><tr><td valign='top'><small>106</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line106'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>107</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line107'><pre>      <span class="ident">allowed_data_types</span><span class="punct">.</span><span class="ident">concat</span><span class="punct">(</span><span class="constant">DataType</span><span class="punct">.</span><span class="ident">video_type_ids</span><span class="punct">)</span> <span class="keyword">if</span> <span class="ident">typ</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">all</span><span class="punct">'</span> <span class="punct">||</span> <span class="ident">typ</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">video</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>108</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line108'><pre>      <span class="ident">allowed_data_types</span><span class="punct">.</span><span class="ident">concat</span><span class="punct">(</span><span class="constant">DataType</span><span class="punct">.</span><span class="ident">image_type_ids</span><span class="punct">)</span> <span class="keyword">if</span> <span class="ident">typ</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">all</span><span class="punct">'</span> <span class="punct">||</span> <span class="ident">typ</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">image</span><span class="punct">'</span> <span class="punct">||</span> <span class="ident">typ</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">photosynth</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>109</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line109'><pre>      <span class="ident">allowed_data_types</span><span class="punct">.</span><span class="ident">concat</span><span class="punct">(</span><span class="constant">DataType</span><span class="punct">.</span><span class="ident">sound_type_ids</span><span class="punct">)</span> <span class="keyword">if</span> <span class="ident">typ</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">all</span><span class="punct">'</span> <span class="punct">||</span> <span class="ident">typ</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">sound</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>110</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line110'><pre>    <span class="keyword">end</span> <span class="keyword">unless</span> <span class="ident">type</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>111</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line111'><pre>
</pre></a></td></tr><tr><td valign='top'><small>112</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line112'><pre>    <span class="comment"># set visibilities and vetted statuses on which to filter or blank if no filter should be applied</span>
</pre></a></td></tr><tr><td valign='top'><small>113</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line113'><pre>    <span class="ident">allowed_visibilities</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>114</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line114'><pre>    <span class="ident">allowed_vetted_status</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>115</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line115'><pre>    <span class="ident">status</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">sta</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>116</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line116'><pre>      <span class="keyword">if</span> <span class="ident">sta</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">all</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>117</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line117'><pre>        <span class="ident">allowed_vetted_status</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>118</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line118'><pre>        <span class="ident">allowed_visibilities</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>119</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line119'><pre>        <span class="keyword">break</span>
</pre></a></td></tr><tr><td valign='top'><small>120</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line120'><pre>      <span class="keyword">elsif</span> <span class="ident">sta</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">inappropriate</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>121</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line121'><pre>        <span class="ident">allowed_visibilities</span> <span class="punct">&lt;&lt;</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">inappropriate</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>122</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line122'><pre>      <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>123</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line123'><pre>        <span class="ident">allowed_vetted_status</span> <span class="punct">&lt;&lt;</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">send</span><span class="punct">(</span><span class="ident">sta</span><span class="punct">.</span><span class="ident">to_sym</span><span class="punct">).</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>124</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line124'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>125</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line125'><pre>    <span class="keyword">end</span> <span class="keyword">unless</span> <span class="ident">status</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>126</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line126'><pre>
</pre></a></td></tr><tr><td valign='top'><small>127</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line127'><pre>    <span class="comment"># we only delete objects by type, visibility or vetted respectively if allowed parameters exist</span>
</pre></a></td></tr><tr><td valign='top'><small>128</small></td><td valign='top'><ul><li>Block cyclomatic complexity is 16.  It should be 4 or less. &raquo; roodi</li></ul></td><td valign='top'><a name='line128'><pre>    <span class="ident">data_objects</span><span class="punct">.</span><span class="ident">delete_if</span> <span class="punct">{</span> <span class="punct">|</span><span class="ident">object</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>129</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line129'><pre>      <span class="comment"># filter by type: delete object if type is not allowed</span>
</pre></a></td></tr><tr><td valign='top'><small>130</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line130'><pre>      <span class="punct">(!</span> <span class="ident">allowed_data_types</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span> <span class="ident">allowed_data_types</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">object</span><span class="punct">.</span><span class="ident">data_type_id</span><span class="punct">))</span> <span class="punct">||</span>
</pre></a></td></tr><tr><td valign='top'><small>131</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line131'><pre>      <span class="comment"># photosynth: delete non-photosynth images if type does not also include images or all</span>
</pre></a></td></tr><tr><td valign='top'><small>132</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line132'><pre>      <span class="punct">(!</span> <span class="ident">type</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span> <span class="ident">object</span><span class="punct">.</span><span class="ident">source_url</span><span class="punct">.</span><span class="ident">match</span><span class="punct">(/</span><span class="regex">http:<span class="escape">\/\/</span>photosynth.net</span><span class="punct">/</span><span class="ident">i</span><span class="punct">)</span> <span class="punct">&amp;&amp;</span>
</pre></a></td></tr><tr><td valign='top'><small>133</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line133'><pre>        <span class="ident">object</span><span class="punct">.</span><span class="ident">is_image?</span> <span class="punct">&amp;&amp;</span> <span class="ident">type</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">('</span><span class="string">photosynth</span><span class="punct">')</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span> <span class="ident">type</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">('</span><span class="string">image</span><span class="punct">')</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span> <span class="ident">type</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">('</span><span class="string">all</span><span class="punct">'))</span> <span class="punct">||</span>
</pre></a></td></tr><tr><td valign='top'><small>134</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line134'><pre>      <span class="comment"># filter by visibility: only delete by visibility if vetted status is blank or also not allowed</span>
</pre></a></td></tr><tr><td valign='top'><small>135</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line135'><pre>      <span class="punct">(!</span> <span class="ident">allowed_visibilities</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span> <span class="ident">allowed_visibilities</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">object</span><span class="punct">.</span><span class="ident">visibility_id</span><span class="punct">)</span> <span class="punct">&amp;&amp;</span>
</pre></a></td></tr><tr><td valign='top'><small>136</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line136'><pre>        <span class="punct">(</span><span class="ident">allowed_vetted_status</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">||</span> <span class="punct">!</span> <span class="ident">allowed_vetted_status</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">object</span><span class="punct">.</span><span class="ident">vetted_id</span><span class="punct">)))</span> <span class="punct">||</span>
</pre></a></td></tr><tr><td valign='top'><small>137</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line137'><pre>      <span class="comment"># filter by vetted status: only delete by vetted if visibility is blank or also not allowed</span>
</pre></a></td></tr><tr><td valign='top'><small>138</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line138'><pre>      <span class="punct">(!</span> <span class="ident">allowed_vetted_status</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span> <span class="ident">allowed_vetted_status</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">object</span><span class="punct">.</span><span class="ident">vetted_id</span><span class="punct">)</span> <span class="punct">&amp;&amp;</span>
</pre></a></td></tr><tr><td valign='top'><small>139</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line139'><pre>        <span class="punct">(</span><span class="ident">allowed_visibilities</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">||</span> <span class="punct">!</span> <span class="ident">allowed_visibilities</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">object</span><span class="punct">.</span><span class="ident">visibility_id</span><span class="punct">)))</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>140</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line140'><pre>
</pre></a></td></tr><tr><td valign='top'><small>141</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line141'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>142</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line142'><pre>
</pre></a></td></tr><tr><td valign='top'><small>143</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line143'><pre>
</pre></a></td></tr><tr><td valign='top'><small>144</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line144'><pre>  <span class="comment"># TODO - this smells like a good place to use a Strategy pattern.  The user can have certain behaviour based</span>
</pre></a></td></tr><tr><td valign='top'><small>145</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line145'><pre>  <span class="comment"># on their access.</span>
</pre></a></td></tr><tr><td valign='top'><small>146</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line146'><pre>  <span class="keyword">def </span><span class="method">self.filter_list_for_user</span><span class="punct">(</span><span class="ident">data_objects</span><span class="punct">,</span> <span class="ident">options</span><span class="punct">={})</span>
</pre></a></td></tr><tr><td valign='top'><small>147</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line147'><pre>    <span class="keyword">return</span> <span class="punct">[]</span> <span class="keyword">if</span> <span class="ident">data_objects</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>148</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line148'><pre>    <span class="ident">visibility_ids</span> <span class="punct">=</span> <span class="punct">[</span><span class="constant">Visibility</span><span class="punct">.</span><span class="ident">visible</span><span class="punct">.</span><span class="ident">id</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>149</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line149'><pre>    <span class="ident">vetted_ids</span> <span class="punct">=</span> <span class="punct">[</span><span class="constant">Vetted</span><span class="punct">.</span><span class="ident">trusted</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">unknown</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">untrusted</span><span class="punct">.</span><span class="ident">id</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>150</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line150'><pre>    <span class="ident">show_preview</span> <span class="punct">=</span> <span class="constant">false</span>
</pre></a></td></tr><tr><td valign='top'><small>151</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line151'><pre>
</pre></a></td></tr><tr><td valign='top'><small>152</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line152'><pre>    <span class="comment"># Show all vetted states unless there is a user that DOES NOT want to see vetted content</span>
</pre></a></td></tr><tr><td valign='top'><small>153</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line153'><pre>    <span class="comment"># AND is not a curator of this clade (curators always see all content in their clade)</span>
</pre></a></td></tr><tr><td valign='top'><small>154</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line154'><pre>    <span class="comment"># AND is not an admin (admins always see all content)</span>
</pre></a></td></tr><tr><td valign='top'><small>155</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line155'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>156</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line156'><pre>      <span class="comment"># admins see everything</span>
</pre></a></td></tr><tr><td valign='top'><small>157</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line157'><pre>      <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">is_admin?</span>
</pre></a></td></tr><tr><td valign='top'><small>158</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line158'><pre>        <span class="ident">vetted_ids</span> <span class="punct">+=</span> <span class="punct">[</span><span class="constant">Vetted</span><span class="punct">.</span><span class="ident">untrusted</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">unknown</span><span class="punct">.</span><span class="ident">id</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>159</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line159'><pre>        <span class="ident">visibility_ids</span> <span class="punct">=</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">all_ids</span><span class="punct">.</span><span class="ident">dup</span>
</pre></a></td></tr><tr><td valign='top'><small>160</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line160'><pre>        <span class="ident">show_preview</span> <span class="punct">=</span> <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>161</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line161'><pre>      <span class="comment"># curators see invisible objects</span>
</pre></a></td></tr><tr><td valign='top'><small>162</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line162'><pre>      <span class="keyword">elsif</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">is_curator?</span> <span class="punct">&amp;&amp;</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">can_curate?</span><span class="punct">(</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:taxon</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>163</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line163'><pre>        <span class="ident">visibility_ids</span> <span class="punct">&lt;&lt;</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">invisible</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>164</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line164'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>165</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line165'><pre>      <span class="comment"># the only scenario to see ONLY TRUSTED objects</span>
</pre></a></td></tr><tr><td valign='top'><small>166</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line166'><pre>      <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">vetted</span> <span class="punct">==</span> <span class="constant">true</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">is_admin?</span>
</pre></a></td></tr><tr><td valign='top'><small>167</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line167'><pre>        <span class="ident">vetted_ids</span> <span class="punct">=</span> <span class="punct">[</span><span class="constant">Vetted</span><span class="punct">.</span><span class="ident">trusted</span><span class="punct">.</span><span class="ident">id</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>168</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line168'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>169</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line169'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>170</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line170'><pre>
</pre></a></td></tr><tr><td valign='top'><small>171</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line171'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:toc_id</span><span class="punct">]</span> <span class="punct">==</span> <span class="constant">TocItem</span><span class="punct">.</span><span class="ident">wikipedia</span>
</pre></a></td></tr><tr><td valign='top'><small>172</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line172'><pre>      <span class="ident">show_preview</span> <span class="punct">=</span> <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>173</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line173'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>174</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line174'><pre>
</pre></a></td></tr><tr><td valign='top'><small>175</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line175'><pre>    <span class="comment"># removing from the array the ones not mathching our criteria</span>
</pre></a></td></tr><tr><td valign='top'><small>176</small></td><td valign='top'><ul><li>Block cyclomatic complexity is 11.  It should be 4 or less. &raquo; roodi</li></ul></td><td valign='top'><a name='line176'><pre>    <span class="ident">data_objects</span><span class="punct">.</span><span class="ident">compact</span><span class="punct">.</span><span class="ident">select</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>177</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line177'><pre>      <span class="comment"># partners see all their PREVIEW or PUBLISHED objects</span>
</pre></a></td></tr><tr><td valign='top'><small>178</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line178'><pre>      <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">]</span> <span class="punct">&amp;&amp;</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">is_content_partner?</span> <span class="punct">&amp;&amp;</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">data_supplier_agent</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">==</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">agent</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>179</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line179'><pre>        <span class="keyword">if</span> <span class="punct">(</span><span class="ident">d</span><span class="punct">.</span><span class="ident">visibility_id</span> <span class="punct">==</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">preview</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span> <span class="punct">||</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">published</span> <span class="punct">==</span> <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>180</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line180'><pre>          <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>181</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line181'><pre>        <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>182</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line182'><pre>      <span class="comment"># user can see preview objects</span>
</pre></a></td></tr><tr><td valign='top'><small>183</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line183'><pre>      <span class="keyword">elsif</span> <span class="ident">show_preview</span> <span class="punct">&amp;&amp;</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">visibility_id</span> <span class="punct">==</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">preview</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>184</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line184'><pre>        <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>185</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line185'><pre>      <span class="comment"># otherwise object must be PUBLISHED and in the vetted and visibility selection</span>
</pre></a></td></tr><tr><td valign='top'><small>186</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line186'><pre>      <span class="keyword">elsif</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">published</span> <span class="punct">==</span> <span class="constant">true</span> <span class="punct">&amp;&amp;</span> <span class="ident">vetted_ids</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">d</span><span class="punct">.</span><span class="ident">vetted_id</span><span class="punct">)</span> <span class="punct">&amp;&amp;</span>
</pre></a></td></tr><tr><td valign='top'><small>187</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line187'><pre>        <span class="ident">visibility_ids</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">d</span><span class="punct">.</span><span class="ident">visibility_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>188</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line188'><pre>        <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>189</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line189'><pre>      <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>190</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line190'><pre>        <span class="constant">false</span>
</pre></a></td></tr><tr><td valign='top'><small>191</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line191'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>192</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line192'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>193</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line193'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>194</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line194'><pre>
</pre></a></td></tr><tr><td valign='top'><small>195</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line195'><pre>  <span class="comment"># for RSS feeds</span>
</pre></a></td></tr><tr><td valign='top'><small>196</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line196'><pre>  <span class="keyword">def </span><span class="method">self.for_feeds</span><span class="punct">(</span><span class="ident">type</span> <span class="punct">=</span> <span class="symbol">:all</span><span class="punct">,</span> <span class="ident">taxon_concept_id</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">,</span> <span class="ident">max_results</span> <span class="punct">=</span> <span class="number">100</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>197</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line197'><pre>    <span class="keyword">if</span> <span class="ident">type</span> <span class="punct">==</span> <span class="symbol">:text</span>
</pre></a></td></tr><tr><td valign='top'><small>198</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line198'><pre>      <span class="ident">data_type_ids</span> <span class="punct">=</span> <span class="punct">[</span><span class="constant">DataType</span><span class="punct">.</span><span class="ident">text_type_ids</span><span class="punct">[</span><span class="number">0</span><span class="punct">]]</span>
</pre></a></td></tr><tr><td valign='top'><small>199</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line199'><pre>    <span class="keyword">elsif</span> <span class="ident">type</span> <span class="punct">==</span> <span class="symbol">:images</span>
</pre></a></td></tr><tr><td valign='top'><small>200</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line200'><pre>      <span class="ident">data_type_ids</span> <span class="punct">=</span> <span class="punct">[</span><span class="constant">DataType</span><span class="punct">.</span><span class="ident">image_type_ids</span><span class="punct">[</span><span class="number">0</span><span class="punct">]]</span>
</pre></a></td></tr><tr><td valign='top'><small>201</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line201'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>202</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line202'><pre>      <span class="ident">data_type_ids</span> <span class="punct">=</span> <span class="punct">[</span><span class="constant">DataType</span><span class="punct">.</span><span class="ident">image_type_ids</span><span class="punct">[</span><span class="number">0</span><span class="punct">],</span> <span class="constant">DataType</span><span class="punct">.</span><span class="ident">text_type_ids</span><span class="punct">[</span><span class="number">0</span><span class="punct">]]</span>
</pre></a></td></tr><tr><td valign='top'><small>203</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line203'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>204</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line204'><pre>
</pre></a></td></tr><tr><td valign='top'><small>205</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line205'><pre>    <span class="keyword">if</span> <span class="ident">taxon_concept_id</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>206</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line206'><pre>      <span class="ident">lookup_ids</span> <span class="punct">=</span> <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">find_all_by_hierarchy_id_and_parent_id</span><span class="punct">(</span><span class="constant">Hierarchy</span><span class="punct">.</span><span class="ident">default</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="number">0</span><span class="punct">).</span><span class="ident">collect</span><span class="punct">{|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>207</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line207'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>208</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line208'><pre>      <span class="ident">lookup_ids</span> <span class="punct">=</span> <span class="punct">[</span><span class="ident">taxon_concept_id</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>209</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line209'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>210</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line210'><pre>
</pre></a></td></tr><tr><td valign='top'><small>211</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line211'><pre>    <span class="ident">data_objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">find_by_sql</span><span class="punct">(&quot;</span><span class="string"><span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>212</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line212'><pre>      <span class="constant">SELECT</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">guid</span><span class="punct">,</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">created_at</span>
</pre></a></td></tr><tr><td valign='top'><small>213</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line213'><pre>      <span class="constant">FROM</span> <span class="ident">feed_data_objects</span> <span class="ident">fdo</span>
</pre></a></td></tr><tr><td valign='top'><small>214</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line214'><pre>      <span class="constant">JOIN</span> <span class="comment">#{DataObject.full_table_name} do ON (fdo.data_object_id=do.id)</span>
</pre></a></td></tr><tr><td valign='top'><small>215</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line215'><pre>      <span class="constant">WHERE</span> <span class="ident">fdo</span><span class="punct">.</span><span class="ident">taxon_concept_id</span> <span class="constant">IN</span> <span class="punct">(</span><span class="comment">#{lookup_ids.join(',')})</span>
</pre></a></td></tr><tr><td valign='top'><small>216</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line216'><pre>      <span class="constant">AND</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">published</span><span class="punct">=</span><span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>217</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line217'><pre>      <span class="constant">AND</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">data_type_id</span> <span class="constant">IN</span> <span class="punct">(</span><span class="comment">#{data_type_ids.join(',')})</span>
</pre></a></td></tr><tr><td valign='top'><small>218</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line218'><pre>      <span class="constant">AND</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">created_at</span> <span class="constant">IS</span> <span class="constant">NOT</span> <span class="constant">NULL</span>
</pre></a></td></tr><tr><td valign='top'><small>219</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line219'><pre>      <span class="constant">AND</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">created_at</span> <span class="punct">!=</span> <span class="punct">'</span><span class="string">0000-00-00 00:00:00</span><span class="punct">'&quot;</span><span class="string">).uniq<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>220</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line220'><pre>    <span class="ident">data_objects</span><span class="punct">.</span><span class="ident">sort_by</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">created_at</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>221</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line221'><pre>    <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">core_relationships</span><span class="punct">.</span><span class="ident">find_all_by_id</span><span class="punct">(</span><span class="ident">data_objects</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">d</span><span class="punct">|</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">})</span>
</pre></a></td></tr><tr><td valign='top'><small>222</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line222'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>223</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line223'><pre>
</pre></a></td></tr><tr><td valign='top'><small>224</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line224'><pre>  <span class="comment">#----- user submitted text --------</span>
</pre></a></td></tr><tr><td valign='top'><small>225</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line225'><pre>  <span class="keyword">def </span><span class="method">self.update_user_text</span><span class="punct">(</span><span class="ident">all_params</span><span class="punct">,</span> <span class="ident">user</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>226</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line226'><pre>    <span class="ident">dato</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:id</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>227</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line227'><pre>    <span class="keyword">if</span> <span class="ident">dato</span><span class="punct">.</span><span class="ident">user</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">!=</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>228</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line228'><pre>      <span class="keyword">raise</span> <span class="punct">'</span><span class="string">Not original author</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>229</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line229'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>230</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line230'><pre>    <span class="ident">taxon_concept</span> <span class="punct">=</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:taxon_concept_id</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>231</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line231'><pre>    <span class="ident">do_params</span> <span class="punct">=</span> <span class="punct">{</span>
</pre></a></td></tr><tr><td valign='top'><small>232</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line232'><pre>      <span class="symbol">:guid</span> <span class="punct">=&gt;</span> <span class="ident">dato</span><span class="punct">.</span><span class="ident">guid</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>233</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line233'><pre>      <span class="symbol">:identifier</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>234</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line234'><pre>      <span class="symbol">:data_type</span> <span class="punct">=&gt;</span> <span class="constant">DataType</span><span class="punct">.</span><span class="ident">find_by_translated</span><span class="punct">(</span><span class="symbol">:label</span><span class="punct">,</span> <span class="punct">'</span><span class="string">Text</span><span class="punct">'),</span>
</pre></a></td></tr><tr><td valign='top'><small>235</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line235'><pre>      <span class="symbol">:rights_statement</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>236</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line236'><pre>      <span class="symbol">:rights_holder</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>237</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line237'><pre>      <span class="symbol">:mime_type_id</span> <span class="punct">=&gt;</span> <span class="constant">MimeType</span><span class="punct">.</span><span class="ident">find_by_translated</span><span class="punct">(</span><span class="symbol">:label</span><span class="punct">,</span> <span class="punct">'</span><span class="string">text/plain</span><span class="punct">').</span><span class="ident">id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>238</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line238'><pre>      <span class="symbol">:location</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>239</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line239'><pre>      <span class="symbol">:latitude</span> <span class="punct">=&gt;</span> <span class="number">0</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>240</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line240'><pre>      <span class="symbol">:longitude</span> <span class="punct">=&gt;</span> <span class="number">0</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>241</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line241'><pre>      <span class="symbol">:bibliographic_citation</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>242</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line242'><pre>      <span class="symbol">:source_url</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>243</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line243'><pre>      <span class="symbol">:altitude</span> <span class="punct">=&gt;</span> <span class="number">0</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>244</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line244'><pre>      <span class="symbol">:object_url</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>245</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line245'><pre>      <span class="symbol">:thumbnail_url</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>246</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line246'><pre>      <span class="symbol">:object_title</span> <span class="punct">=&gt;</span> <span class="constant">ERB</span><span class="punct">::</span><span class="constant">Util</span><span class="punct">.</span><span class="ident">h</span><span class="punct">(</span><span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_object</span><span class="punct">][</span><span class="symbol">:object_title</span><span class="punct">]),</span> <span class="comment"># No HTML allowed</span>
</pre></a></td></tr><tr><td valign='top'><small>247</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line247'><pre>      <span class="symbol">:description</span> <span class="punct">=&gt;</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_object</span><span class="punct">][</span><span class="symbol">:description</span><span class="punct">].</span><span class="ident">allow_some_html</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>248</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line248'><pre>      <span class="symbol">:language_id</span> <span class="punct">=&gt;</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_object</span><span class="punct">][</span><span class="symbol">:language_id</span><span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>249</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line249'><pre>      <span class="symbol">:license_id</span> <span class="punct">=&gt;</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_object</span><span class="punct">][</span><span class="symbol">:license_id</span><span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>250</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line250'><pre>      <span class="symbol">:vetted_id</span> <span class="punct">=&gt;</span> <span class="punct">(</span><span class="ident">user</span><span class="punct">.</span><span class="ident">can_curate?</span><span class="punct">(</span><span class="ident">taxon_concept</span><span class="punct">)</span> <span class="punct">?</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">trusted</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">:</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">unknown</span><span class="punct">.</span><span class="ident">id</span><span class="punct">),</span>
</pre></a></td></tr><tr><td valign='top'><small>251</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line251'><pre>      <span class="symbol">:published</span> <span class="punct">=&gt;</span> <span class="number">1</span><span class="punct">,</span> <span class="comment">#not sure if this is right</span>
</pre></a></td></tr><tr><td valign='top'><small>252</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line252'><pre>      <span class="symbol">:visibility_id</span> <span class="punct">=&gt;</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">visible</span><span class="punct">.</span><span class="ident">id</span> <span class="comment">#not sure if this is right either</span>
</pre></a></td></tr><tr><td valign='top'><small>253</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line253'><pre>    <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>254</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line254'><pre>
</pre></a></td></tr><tr><td valign='top'><small>255</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line255'><pre>    <span class="ident">d</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="ident">do_params</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>256</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line256'><pre>    <span class="ident">d</span><span class="punct">.</span><span class="ident">toc_items</span> <span class="punct">&lt;&lt;</span> <span class="constant">TocItem</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_objects_toc_category</span><span class="punct">][</span><span class="symbol">:toc_id</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>257</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line257'><pre>
</pre></a></td></tr><tr><td valign='top'><small>258</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line258'><pre>    <span class="keyword">unless</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:references</span><span class="punct">].</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>259</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line259'><pre>      <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:references</span><span class="punct">].</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">reference</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>260</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line260'><pre>        <span class="keyword">if</span> <span class="ident">reference</span><span class="punct">.</span><span class="ident">strip</span> <span class="punct">!=</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>261</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line261'><pre>          <span class="ident">d</span><span class="punct">.</span><span class="ident">refs</span> <span class="punct">&lt;&lt;</span> <span class="constant">Ref</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="symbol">:full_reference</span> <span class="punct">=&gt;</span> <span class="ident">reference</span><span class="punct">,</span> <span class="symbol">:user_submitted</span> <span class="punct">=&gt;</span> <span class="constant">true</span><span class="punct">,</span> <span class="symbol">:published</span> <span class="punct">=&gt;</span> <span class="number">1</span><span class="punct">,</span> <span class="symbol">:visibility</span> <span class="punct">=&gt;</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">visible</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>262</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line262'><pre>        <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>263</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line263'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>264</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line264'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>265</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line265'><pre>
</pre></a></td></tr><tr><td valign='top'><small>266</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line266'><pre>    <span class="ident">d</span><span class="punct">.</span><span class="ident">save!</span>
</pre></a></td></tr><tr><td valign='top'><small>267</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line267'><pre>    <span class="ident">dato</span><span class="punct">.</span><span class="ident">published</span> <span class="punct">=</span> <span class="constant">false</span>
</pre></a></td></tr><tr><td valign='top'><small>268</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line268'><pre>    <span class="ident">dato</span><span class="punct">.</span><span class="ident">save!</span>
</pre></a></td></tr><tr><td valign='top'><small>269</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line269'><pre>
</pre></a></td></tr><tr><td valign='top'><small>270</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line270'><pre>    <span class="ident">comments_from_old_dato</span> <span class="punct">=</span> <span class="constant">Comment</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="symbol">:all</span><span class="punct">,</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">{</span><span class="symbol">:parent_id</span> <span class="punct">=&gt;</span> <span class="ident">dato</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="symbol">:parent_type</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">DataObject</span><span class="punct">'})</span>
</pre></a></td></tr><tr><td valign='top'><small>271</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line271'><pre>    <span class="ident">comments_from_old_dato</span><span class="punct">.</span><span class="ident">map</span> <span class="punct">{</span> <span class="punct">|</span><span class="ident">c</span><span class="punct">|</span> <span class="ident">c</span><span class="punct">.</span><span class="ident">update_attribute</span> <span class="symbol">:parent_id</span><span class="punct">,</span> <span class="ident">d</span><span class="punct">.</span><span class="ident">id</span>  <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>272</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line272'><pre>
</pre></a></td></tr><tr><td valign='top'><small>273</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line273'><pre>    <span class="ident">tc</span> <span class="punct">=</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:taxon_concept_id</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>274</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line274'><pre>    <span class="ident">udo</span> <span class="punct">=</span> <span class="constant">UsersDataObject</span><span class="punct">.</span><span class="ident">create</span><span class="punct">(</span><span class="symbol">:user</span> <span class="punct">=&gt;</span> <span class="ident">user</span><span class="punct">,</span> <span class="symbol">:data_object</span> <span class="punct">=&gt;</span> <span class="ident">d</span><span class="punct">,</span> <span class="symbol">:taxon_concept</span> <span class="punct">=&gt;</span> <span class="ident">tc</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>275</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line275'><pre>    <span class="ident">d</span><span class="punct">.</span><span class="ident">users_data_objects</span> <span class="punct">&lt;&lt;</span> <span class="ident">udo</span>
</pre></a></td></tr><tr><td valign='top'><small>276</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line276'><pre>    <span class="ident">user</span><span class="punct">.</span><span class="ident">track_curator_activity</span><span class="punct">(</span><span class="ident">udo</span><span class="punct">,</span> <span class="punct">'</span><span class="string">users_submitted_text</span><span class="punct">',</span> <span class="punct">'</span><span class="string">update</span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>277</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line277'><pre>    <span class="ident">d</span>
</pre></a></td></tr><tr><td valign='top'><small>278</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line278'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>279</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line279'><pre>
</pre></a></td></tr><tr><td valign='top'><small>280</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line280'><pre>  <span class="keyword">def </span><span class="method">self.preview_user_text</span><span class="punct">(</span><span class="ident">all_params</span><span class="punct">,</span> <span class="ident">user</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>281</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line281'><pre>    <span class="ident">taxon_concept</span> <span class="punct">=</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:taxon_concept_id</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>282</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line282'><pre>
</pre></a></td></tr><tr><td valign='top'><small>283</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line283'><pre>    <span class="ident">do_params</span> <span class="punct">=</span> <span class="punct">{</span>
</pre></a></td></tr><tr><td valign='top'><small>284</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line284'><pre>      <span class="symbol">:guid</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>285</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line285'><pre>      <span class="symbol">:identifier</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>286</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line286'><pre>      <span class="symbol">:data_type</span> <span class="punct">=&gt;</span> <span class="constant">DataType</span><span class="punct">.</span><span class="ident">text</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>287</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line287'><pre>      <span class="symbol">:rights_statement</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>288</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line288'><pre>      <span class="symbol">:rights_holder</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>289</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line289'><pre>      <span class="symbol">:mime_type_id</span> <span class="punct">=&gt;</span> <span class="constant">MimeType</span><span class="punct">.</span><span class="ident">find_by_translated</span><span class="punct">(</span><span class="symbol">:label</span><span class="punct">,</span> <span class="punct">'</span><span class="string">text/plain</span><span class="punct">').</span><span class="ident">id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>290</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line290'><pre>      <span class="symbol">:location</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>291</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line291'><pre>      <span class="symbol">:latitude</span> <span class="punct">=&gt;</span> <span class="number">0</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>292</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line292'><pre>      <span class="symbol">:longitude</span> <span class="punct">=&gt;</span> <span class="number">0</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>293</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line293'><pre>      <span class="symbol">:object_title</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>294</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line294'><pre>      <span class="symbol">:bibliographic_citation</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>295</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line295'><pre>      <span class="symbol">:source_url</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>296</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line296'><pre>      <span class="symbol">:altitude</span> <span class="punct">=&gt;</span> <span class="number">0</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>297</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line297'><pre>      <span class="symbol">:object_url</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>298</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line298'><pre>      <span class="symbol">:thumbnail_url</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>299</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line299'><pre>      <span class="symbol">:object_title</span> <span class="punct">=&gt;</span> <span class="constant">ERB</span><span class="punct">::</span><span class="constant">Util</span><span class="punct">.</span><span class="ident">h</span><span class="punct">(</span><span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_object</span><span class="punct">][</span><span class="symbol">:object_title</span><span class="punct">]),</span> <span class="comment"># No HTML allowed</span>
</pre></a></td></tr><tr><td valign='top'><small>300</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line300'><pre>      <span class="symbol">:description</span> <span class="punct">=&gt;</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_object</span><span class="punct">][</span><span class="symbol">:description</span><span class="punct">].</span><span class="ident">allow_some_html</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>301</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line301'><pre>      <span class="symbol">:language_id</span> <span class="punct">=&gt;</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_object</span><span class="punct">][</span><span class="symbol">:language_id</span><span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>302</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line302'><pre>      <span class="symbol">:license_id</span> <span class="punct">=&gt;</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_object</span><span class="punct">][</span><span class="symbol">:license_id</span><span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>303</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line303'><pre>      <span class="symbol">:vetted_id</span> <span class="punct">=&gt;</span> <span class="punct">(</span><span class="ident">user</span><span class="punct">.</span><span class="ident">can_curate?</span><span class="punct">(</span><span class="ident">taxon_concept</span><span class="punct">)</span> <span class="punct">?</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">trusted</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">:</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">unknown</span><span class="punct">.</span><span class="ident">id</span><span class="punct">),</span>
</pre></a></td></tr><tr><td valign='top'><small>304</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line304'><pre>      <span class="symbol">:published</span> <span class="punct">=&gt;</span> <span class="number">1</span><span class="punct">,</span> <span class="comment">#not sure if this is right</span>
</pre></a></td></tr><tr><td valign='top'><small>305</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line305'><pre>      <span class="symbol">:visibility_id</span> <span class="punct">=&gt;</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">visible</span><span class="punct">.</span><span class="ident">id</span> <span class="comment">#not sure if this is right either</span>
</pre></a></td></tr><tr><td valign='top'><small>306</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line306'><pre>    <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>307</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line307'><pre>
</pre></a></td></tr><tr><td valign='top'><small>308</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line308'><pre>    <span class="ident">d</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="ident">do_params</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>309</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line309'><pre>    <span class="ident">d</span><span class="punct">.</span><span class="ident">toc_items</span> <span class="punct">&lt;&lt;</span> <span class="constant">TocItem</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_objects_toc_category</span><span class="punct">][</span><span class="symbol">:toc_id</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>310</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line310'><pre>
</pre></a></td></tr><tr><td valign='top'><small>311</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line311'><pre>    <span class="keyword">unless</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:references</span><span class="punct">].</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>312</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line312'><pre>      <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:references</span><span class="punct">].</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">reference</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>313</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line313'><pre>        <span class="keyword">if</span> <span class="ident">reference</span><span class="punct">.</span><span class="ident">strip</span> <span class="punct">!=</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>314</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line314'><pre>          <span class="ident">d</span><span class="punct">.</span><span class="ident">published_refs</span> <span class="punct">&lt;&lt;</span> <span class="constant">Ref</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="symbol">:full_reference</span> <span class="punct">=&gt;</span> <span class="ident">reference</span><span class="punct">,</span> <span class="symbol">:user_submitted</span> <span class="punct">=&gt;</span> <span class="constant">true</span><span class="punct">,</span> <span class="symbol">:published</span> <span class="punct">=&gt;</span> <span class="number">1</span><span class="punct">,</span> <span class="symbol">:visibility</span> <span class="punct">=&gt;</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">visible</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>315</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line315'><pre>        <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>316</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line316'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>317</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line317'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>318</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line318'><pre>
</pre></a></td></tr><tr><td valign='top'><small>319</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line319'><pre>    <span class="comment"># TODO - references aren't shown in the preview, because we would have to &quot;fake&quot; them, and we can't effectively.</span>
</pre></a></td></tr><tr><td valign='top'><small>320</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line320'><pre>    <span class="ident">d</span><span class="punct">.</span><span class="ident">users_data_objects</span> <span class="punct">=</span> <span class="punct">[</span><span class="constant">UsersDataObject</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="symbol">:data_object</span> <span class="punct">=&gt;</span> <span class="ident">d</span><span class="punct">,</span> <span class="symbol">:taxon_concept</span> <span class="punct">=&gt;</span> <span class="ident">taxon_concept</span><span class="punct">,</span> <span class="symbol">:user</span> <span class="punct">=&gt;</span> <span class="ident">user</span><span class="punct">)]</span>
</pre></a></td></tr><tr><td valign='top'><small>321</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line321'><pre>    <span class="ident">d</span>
</pre></a></td></tr><tr><td valign='top'><small>322</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line322'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>323</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line323'><pre>
</pre></a></td></tr><tr><td valign='top'><small>324</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line324'><pre>  <span class="keyword">def </span><span class="method">self.create_user_text</span><span class="punct">(</span><span class="ident">all_params</span><span class="punct">,</span><span class="ident">user</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>325</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line325'><pre>    <span class="ident">taxon_concept</span> <span class="punct">=</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:taxon_concept_id</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>326</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line326'><pre>
</pre></a></td></tr><tr><td valign='top'><small>327</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line327'><pre>    <span class="keyword">if</span> <span class="keyword">defined?</span><span class="punct">(</span><span class="constant">PhusionPassenger</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>328</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line328'><pre>      <span class="constant">UUID</span><span class="punct">.</span><span class="ident">state_file</span><span class="punct">(</span><span class="number">0664</span><span class="punct">)</span> <span class="comment"># Makes the file writable, which we seem to need to do with Passenger...</span>
</pre></a></td></tr><tr><td valign='top'><small>329</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line329'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>330</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line330'><pre>
</pre></a></td></tr><tr><td valign='top'><small>331</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line331'><pre>    <span class="ident">do_params</span> <span class="punct">=</span> <span class="punct">{</span>
</pre></a></td></tr><tr><td valign='top'><small>332</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line332'><pre>      <span class="symbol">:guid</span> <span class="punct">=&gt;</span> <span class="constant">UUID</span><span class="punct">.</span><span class="ident">generate</span><span class="punct">.</span><span class="ident">gsub</span><span class="punct">('</span><span class="string">-</span><span class="punct">','</span><span class="string"></span><span class="punct">'),</span>
</pre></a></td></tr><tr><td valign='top'><small>333</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line333'><pre>      <span class="symbol">:identifier</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>334</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line334'><pre>      <span class="symbol">:data_type</span> <span class="punct">=&gt;</span> <span class="constant">DataType</span><span class="punct">.</span><span class="ident">text</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>335</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line335'><pre>      <span class="symbol">:rights_statement</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>336</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line336'><pre>      <span class="symbol">:rights_holder</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>337</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line337'><pre>      <span class="symbol">:mime_type_id</span> <span class="punct">=&gt;</span> <span class="constant">MimeType</span><span class="punct">.</span><span class="ident">find_by_translated</span><span class="punct">(</span><span class="symbol">:label</span><span class="punct">,</span> <span class="punct">'</span><span class="string">text/plain</span><span class="punct">').</span><span class="ident">id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>338</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line338'><pre>      <span class="symbol">:location</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>339</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line339'><pre>      <span class="symbol">:latitude</span> <span class="punct">=&gt;</span> <span class="number">0</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>340</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line340'><pre>      <span class="symbol">:longitude</span> <span class="punct">=&gt;</span> <span class="number">0</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>341</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line341'><pre>      <span class="symbol">:object_title</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>342</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line342'><pre>      <span class="symbol">:bibliographic_citation</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>343</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line343'><pre>      <span class="symbol">:source_url</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>344</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line344'><pre>      <span class="symbol">:altitude</span> <span class="punct">=&gt;</span> <span class="number">0</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>345</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line345'><pre>      <span class="symbol">:object_url</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>346</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line346'><pre>      <span class="symbol">:thumbnail_url</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string"></span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>347</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line347'><pre>      <span class="symbol">:object_title</span> <span class="punct">=&gt;</span> <span class="constant">ERB</span><span class="punct">::</span><span class="constant">Util</span><span class="punct">.</span><span class="ident">h</span><span class="punct">(</span><span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_object</span><span class="punct">][</span><span class="symbol">:object_title</span><span class="punct">]),</span> <span class="comment"># No HTML allowed</span>
</pre></a></td></tr><tr><td valign='top'><small>348</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line348'><pre>      <span class="symbol">:description</span> <span class="punct">=&gt;</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_object</span><span class="punct">][</span><span class="symbol">:description</span><span class="punct">].</span><span class="ident">allow_some_html</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>349</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line349'><pre>      <span class="symbol">:language_id</span> <span class="punct">=&gt;</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_object</span><span class="punct">][</span><span class="symbol">:language_id</span><span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>350</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line350'><pre>      <span class="symbol">:license_id</span> <span class="punct">=&gt;</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_object</span><span class="punct">][</span><span class="symbol">:license_id</span><span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>351</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line351'><pre>      <span class="symbol">:vetted_id</span> <span class="punct">=&gt;</span> <span class="punct">(</span><span class="ident">user</span><span class="punct">.</span><span class="ident">can_curate?</span><span class="punct">(</span><span class="ident">taxon_concept</span><span class="punct">)</span> <span class="punct">?</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">trusted</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">:</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">unknown</span><span class="punct">.</span><span class="ident">id</span><span class="punct">),</span>
</pre></a></td></tr><tr><td valign='top'><small>352</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line352'><pre>      <span class="symbol">:published</span> <span class="punct">=&gt;</span> <span class="number">1</span><span class="punct">,</span> <span class="comment">#not sure if this is right</span>
</pre></a></td></tr><tr><td valign='top'><small>353</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line353'><pre>      <span class="symbol">:visibility_id</span> <span class="punct">=&gt;</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">visible</span><span class="punct">.</span><span class="ident">id</span> <span class="comment">#not sure if this is right either</span>
</pre></a></td></tr><tr><td valign='top'><small>354</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line354'><pre>    <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>355</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line355'><pre>
</pre></a></td></tr><tr><td valign='top'><small>356</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line356'><pre>    <span class="ident">dato</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="ident">do_params</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>357</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line357'><pre>    <span class="ident">dato</span><span class="punct">.</span><span class="ident">toc_items</span> <span class="punct">&lt;&lt;</span> <span class="constant">TocItem</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:data_objects_toc_category</span><span class="punct">][</span><span class="symbol">:toc_id</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>358</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line358'><pre>
</pre></a></td></tr><tr><td valign='top'><small>359</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line359'><pre>    <span class="keyword">unless</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:references</span><span class="punct">].</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>360</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line360'><pre>      <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:references</span><span class="punct">].</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">reference</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>361</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line361'><pre>        <span class="keyword">if</span> <span class="ident">reference</span><span class="punct">.</span><span class="ident">strip</span> <span class="punct">!=</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>362</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line362'><pre>          <span class="ident">dato</span><span class="punct">.</span><span class="ident">refs</span> <span class="punct">&lt;&lt;</span> <span class="constant">Ref</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="symbol">:full_reference</span> <span class="punct">=&gt;</span> <span class="ident">reference</span><span class="punct">,</span> <span class="symbol">:user_submitted</span> <span class="punct">=&gt;</span> <span class="constant">true</span><span class="punct">,</span> <span class="symbol">:published</span> <span class="punct">=&gt;</span> <span class="number">1</span><span class="punct">,</span> <span class="symbol">:visibility</span> <span class="punct">=&gt;</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">visible</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>363</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line363'><pre>        <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>364</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line364'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>365</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line365'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>366</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line366'><pre>
</pre></a></td></tr><tr><td valign='top'><small>367</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line367'><pre>    <span class="ident">dato</span><span class="punct">.</span><span class="ident">save!</span>
</pre></a></td></tr><tr><td valign='top'><small>368</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line368'><pre>    <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Unable to build a UsersDataObject if user is nil</span><span class="punct">&quot;</span> <span class="keyword">if</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>369</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line369'><pre>    <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Unable to build a UsersDataObject if DataObject is nil</span><span class="punct">&quot;</span> <span class="keyword">if</span> <span class="ident">dato</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>370</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line370'><pre>    <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Unable to build a UsersDataObject if taxon_concept_id is missing</span><span class="punct">&quot;</span> <span class="keyword">if</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:taxon_concept_id</span><span class="punct">].</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>371</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line371'><pre>    <span class="ident">udo</span> <span class="punct">=</span> <span class="constant">UsersDataObject</span><span class="punct">.</span><span class="ident">create</span><span class="punct">(</span><span class="symbol">:user</span> <span class="punct">=&gt;</span> <span class="ident">user</span><span class="punct">,</span> <span class="symbol">:data_object</span> <span class="punct">=&gt;</span> <span class="ident">dato</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>372</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line372'><pre>                              <span class="symbol">:taxon_concept</span> <span class="punct">=&gt;</span> <span class="ident">taxon_concept</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>373</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line373'><pre>    <span class="ident">dato</span><span class="punct">.</span><span class="ident">users_data_objects</span> <span class="punct">&lt;&lt;</span> <span class="ident">udo</span>
</pre></a></td></tr><tr><td valign='top'><small>374</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line374'><pre>    <span class="ident">user</span><span class="punct">.</span><span class="ident">track_curator_activity</span><span class="punct">(</span><span class="ident">udo</span><span class="punct">,</span> <span class="punct">'</span><span class="string">users_submitted_text</span><span class="punct">',</span> <span class="punct">'</span><span class="string">create</span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>375</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line375'><pre>
</pre></a></td></tr><tr><td valign='top'><small>376</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line376'><pre>    <span class="comment"># this will give it the hash elements it needs for attributions</span>
</pre></a></td></tr><tr><td valign='top'><small>377</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line377'><pre>    <span class="ident">dato</span>
</pre></a></td></tr><tr><td valign='top'><small>378</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line378'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>379</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line379'><pre>
</pre></a></td></tr><tr><td valign='top'><small>380</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line380'><pre>  <span class="keyword">def </span><span class="method">created_by_user?</span>
</pre></a></td></tr><tr><td valign='top'><small>381</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line381'><pre>    <span class="ident">user</span> <span class="punct">!=</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>382</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line382'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>383</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line383'><pre>
</pre></a></td></tr><tr><td valign='top'><small>384</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line384'><pre>  <span class="keyword">def </span><span class="method">user</span>
</pre></a></td></tr><tr><td valign='top'><small>385</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line385'><pre>    <span class="attribute">@udo</span> <span class="punct">||=</span> <span class="constant">UsersDataObject</span><span class="punct">.</span><span class="ident">find_by_data_object_id</span><span class="punct">(</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>386</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line386'><pre>    <span class="attribute">@udo_user</span> <span class="punct">||=</span> <span class="attribute">@udo</span><span class="punct">.</span><span class="ident">nil?</span> <span class="punct">?</span> <span class="constant">nil</span> <span class="punct">:</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="attribute">@udo</span><span class="punct">.</span><span class="ident">user_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>387</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line387'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>388</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line388'><pre>
</pre></a></td></tr><tr><td valign='top'><small>389</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line389'><pre>  <span class="keyword">def </span><span class="method">taxon_concept_for_users_text</span>
</pre></a></td></tr><tr><td valign='top'><small>390</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line390'><pre>    <span class="keyword">unless</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>391</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line391'><pre>      <span class="ident">udo</span> <span class="punct">=</span> <span class="constant">UsersDataObject</span><span class="punct">.</span><span class="ident">find_by_data_object_id</span><span class="punct">(</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>392</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line392'><pre>      <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">udo</span><span class="punct">.</span><span class="ident">taxon_concept_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>393</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line393'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>394</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line394'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>395</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line395'><pre>
</pre></a></td></tr><tr><td valign='top'><small>396</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line396'><pre>  <span class="comment">#----- end of user submitted text --------</span>
</pre></a></td></tr><tr><td valign='top'><small>397</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line397'><pre>
</pre></a></td></tr><tr><td valign='top'><small>398</small></td><td valign='top'><ul><li>Duplication - calls object_title twice &raquo; reek</li><li>Duplication - calls taxon_concepts.first twice &raquo; reek</li><li>Duplication - calls toc_items twice &raquo; reek</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line398'><pre>  <span class="keyword">def </span><span class="method">best_title</span>
</pre></a></td></tr><tr><td valign='top'><small>399</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line399'><pre>    <span class="keyword">return</span> <span class="ident">object_title</span> <span class="keyword">unless</span> <span class="ident">object_title</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>400</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line400'><pre>    <span class="keyword">return</span> <span class="ident">toc_items</span><span class="punct">.</span><span class="ident">first</span><span class="punct">.</span><span class="ident">label</span> <span class="keyword">unless</span> <span class="ident">toc_items</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>401</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line401'><pre>    <span class="ident">taxon_concepts</span> <span class="punct">=</span> <span class="ident">get_taxon_concepts</span><span class="punct">(</span><span class="symbol">:published</span> <span class="punct">=&gt;</span> <span class="symbol">:preferred</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>402</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line402'><pre>    <span class="keyword">return</span> <span class="ident">taxon_concepts</span><span class="punct">.</span><span class="ident">first</span><span class="punct">.</span><span class="ident">title_canonical</span><span class="punct">(</span><span class="attribute">@session_hierarchy</span><span class="punct">)</span> <span class="keyword">unless</span> <span class="ident">taxon_concepts</span><span class="punct">.</span><span class="ident">first</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>403</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line403'><pre>    <span class="keyword">return</span> <span class="ident">data_type</span><span class="punct">.</span><span class="ident">label</span>
</pre></a></td></tr><tr><td valign='top'><small>404</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line404'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>405</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line405'><pre>
</pre></a></td></tr><tr><td valign='top'><small>406</small></td><td valign='top'><ul><li>Duplication - calls guid twice &raquo; reek</li><li>Duplication - calls user.id 3 times &raquo; reek</li><li>Duplication - calls users_current_ratings[0] 3 times &raquo; reek</li><li>LongMethod - has approx 8 statements &raquo; reek</li><li>UncommunicativeName - has the variable name 'r' &raquo; reek</li><li>Complexity 5 &raquo; saikuro</li></ul></td><td valign='top'><a name='line406'><pre>  <span class="keyword">def </span><span class="method">rate</span><span class="punct">(</span><span class="ident">user</span><span class="punct">,</span> <span class="ident">new_rating</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>407</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line407'><pre>    <span class="ident">existing_ratings</span> <span class="punct">=</span> <span class="constant">UsersDataObjectsRating</span><span class="punct">.</span><span class="ident">find_all_by_data_object_guid</span><span class="punct">(</span><span class="ident">guid</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>408</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line408'><pre>    <span class="ident">users_current_ratings</span><span class="punct">,</span> <span class="ident">other_ratings</span> <span class="punct">=</span> <span class="ident">existing_ratings</span><span class="punct">.</span><span class="ident">partition</span> <span class="punct">{</span> <span class="punct">|</span><span class="ident">r</span><span class="punct">|</span> <span class="ident">r</span><span class="punct">.</span><span class="ident">user_id</span> <span class="punct">==</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>409</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line409'><pre>
</pre></a></td></tr><tr><td valign='top'><small>410</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line410'><pre>    <span class="keyword">if</span> <span class="ident">users_current_ratings</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>411</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line411'><pre>      <span class="constant">UsersDataObjectsRating</span><span class="punct">.</span><span class="ident">create</span><span class="punct">(</span><span class="symbol">:data_object_guid</span> <span class="punct">=&gt;</span> <span class="ident">guid</span><span class="punct">,</span> <span class="symbol">:user_id</span> <span class="punct">=&gt;</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="symbol">:rating</span> <span class="punct">=&gt;</span> <span class="ident">new_rating</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>412</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line412'><pre>    <span class="keyword">elsif</span> <span class="ident">users_current_ratings</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">rating</span> <span class="punct">!=</span> <span class="ident">new_rating</span>
</pre></a></td></tr><tr><td valign='top'><small>413</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line413'><pre>      <span class="ident">users_current_ratings</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">rating</span> <span class="punct">=</span> <span class="ident">new_rating</span>
</pre></a></td></tr><tr><td valign='top'><small>414</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line414'><pre>      <span class="ident">users_current_ratings</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">save!</span>
</pre></a></td></tr><tr><td valign='top'><small>415</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line415'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>416</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line416'><pre>
</pre></a></td></tr><tr><td valign='top'><small>417</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line417'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">data_rating</span> <span class="punct">=</span> <span class="punct">(</span><span class="ident">other_ratings</span><span class="punct">.</span><span class="ident">inject</span><span class="punct">(</span><span class="number">0</span><span class="punct">)</span> <span class="punct">{</span> <span class="punct">|</span><span class="ident">sum</span><span class="punct">,</span> <span class="ident">r</span><span class="punct">|</span> <span class="ident">sum</span> <span class="punct">+</span> <span class="ident">r</span><span class="punct">.</span><span class="ident">rating</span> <span class="punct">}</span> <span class="punct">+</span> <span class="ident">new_rating</span><span class="punct">).</span><span class="ident">to_f</span> <span class="punct">/</span> <span class="punct">(</span><span class="ident">other_ratings</span><span class="punct">.</span><span class="ident">size</span> <span class="punct">+</span> <span class="number">1</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>418</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line418'><pre>    <span class="ident">feed</span><span class="punct">.</span><span class="ident">post</span><span class="punct">(</span><span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(&quot;</span><span class="string">dato_rating_note</span><span class="punct">&quot;,</span> <span class="symbol">:username</span> <span class="punct">=&gt;</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">username</span><span class="punct">,</span> <span class="symbol">:rating</span> <span class="punct">=&gt;</span> <span class="ident">new_rating</span><span class="punct">),</span> <span class="symbol">:feed_item_type_id</span> <span class="punct">=&gt;</span> <span class="constant">FeedItemType</span><span class="punct">.</span><span class="ident">curator_activity</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="symbol">:user_id</span> <span class="punct">=&gt;</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>419</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line419'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">save!</span>
</pre></a></td></tr><tr><td valign='top'><small>420</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line420'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>421</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line421'><pre>
</pre></a></td></tr><tr><td valign='top'><small>422</small></td><td valign='top'><ul><li>UncommunicativeName - has the variable name 'r' &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line422'><pre>  <span class="keyword">def </span><span class="method">recalculate_rating</span>
</pre></a></td></tr><tr><td valign='top'><small>423</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line423'><pre>    <span class="ident">ratings</span> <span class="punct">=</span> <span class="constant">UsersDataObjectsRating</span><span class="punct">.</span><span class="ident">find_all_by_data_object_guid</span><span class="punct">(</span><span class="ident">guid</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>424</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line424'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">data_rating</span> <span class="punct">=</span> <span class="ident">ratings</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">?</span> <span class="number">2.5</span> <span class="punct">:</span> <span class="ident">ratings</span><span class="punct">.</span><span class="ident">inject</span><span class="punct">(</span><span class="number">0</span><span class="punct">)</span> <span class="punct">{</span> <span class="punct">|</span><span class="ident">sum</span><span class="punct">,</span> <span class="ident">r</span><span class="punct">|</span> <span class="ident">sum</span> <span class="punct">+</span> <span class="ident">r</span><span class="punct">.</span><span class="ident">rating</span> <span class="punct">}.</span><span class="ident">to_f</span> <span class="punct">/</span> <span class="ident">ratings</span><span class="punct">.</span><span class="ident">size</span>
</pre></a></td></tr><tr><td valign='top'><small>425</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line425'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">save!</span>
</pre></a></td></tr><tr><td valign='top'><small>426</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line426'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>427</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line427'><pre>
</pre></a></td></tr><tr><td valign='top'><small>428</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line428'><pre>  <span class="keyword">def </span><span class="method">rating_for_user</span><span class="punct">(</span><span class="ident">user</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>429</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line429'><pre>    <span class="ident">users_data_objects_ratings</span><span class="punct">.</span><span class="ident">detect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">udor</span><span class="punct">|</span> <span class="ident">udor</span><span class="punct">.</span><span class="ident">user_id</span> <span class="punct">==</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>430</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line430'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>431</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line431'><pre>
</pre></a></td></tr><tr><td valign='top'><small>432</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line432'><pre>  <span class="comment"># Add a comment to this data object</span>
</pre></a></td></tr><tr><td valign='top'><small>433</small></td><td valign='top'><ul><li>LowCohesion - refers to user more than self &raquo; reek</li><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line433'><pre>  <span class="keyword">def </span><span class="method">comment</span><span class="punct">(</span><span class="ident">user</span><span class="punct">,</span> <span class="ident">body</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>434</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line434'><pre>    <span class="ident">comment</span> <span class="punct">=</span> <span class="ident">comments</span><span class="punct">.</span><span class="ident">create</span> <span class="symbol">:user_id</span> <span class="punct">=&gt;</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="symbol">:body</span> <span class="punct">=&gt;</span> <span class="ident">body</span>
</pre></a></td></tr><tr><td valign='top'><small>435</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line435'><pre>    <span class="ident">user</span><span class="punct">.</span><span class="ident">comments</span><span class="punct">.</span><span class="ident">reload</span> <span class="comment"># be friendly - update the user's comments automatically</span>
</pre></a></td></tr><tr><td valign='top'><small>436</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line436'><pre>    <span class="keyword">return</span> <span class="ident">comment</span>
</pre></a></td></tr><tr><td valign='top'><small>437</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line437'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>438</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line438'><pre>
</pre></a></td></tr><tr><td valign='top'><small>439</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line439'><pre>  <span class="comment"># Test whether a user has curator rights on this object</span>
</pre></a></td></tr><tr><td valign='top'><small>440</small></td><td valign='top'><ul><li>Duplication - calls taxon_concepts twice &raquo; reek</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line440'><pre>  <span class="keyword">def </span><span class="method">is_curatable_by?</span> <span class="ident">user</span>
</pre></a></td></tr><tr><td valign='top'><small>441</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line441'><pre>    <span class="comment"># normally at this point, taxon_concepts shouldn't be blank</span>
</pre></a></td></tr><tr><td valign='top'><small>442</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line442'><pre>    <span class="comment"># caused by some data problem, this hack is needed to curate object(s) like: e.g. http://www.eol.org/pages/913235?text_id=7655133</span>
</pre></a></td></tr><tr><td valign='top'><small>443</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line443'><pre>    <span class="keyword">if</span> <span class="punct">!</span><span class="ident">taxon_concepts</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>444</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line444'><pre>      <span class="ident">taxon_concepts</span><span class="punct">.</span><span class="ident">collect</span> <span class="punct">{|</span><span class="ident">tc</span><span class="punct">|</span> <span class="ident">tc</span><span class="punct">.</span><span class="ident">is_curatable_by?</span><span class="punct">(</span><span class="ident">user</span><span class="punct">)</span> <span class="punct">}.</span><span class="ident">include?</span><span class="punct">(</span><span class="constant">true</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>445</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line445'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>446</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line446'><pre>      <span class="keyword">return</span> <span class="punct">(</span><span class="ident">user</span><span class="punct">.</span><span class="ident">nil?</span> <span class="punct">?</span> <span class="constant">false</span> <span class="punct">:</span> <span class="constant">true</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>447</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line447'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>448</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line448'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>449</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line449'><pre>
</pre></a></td></tr><tr><td valign='top'><small>450</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line450'><pre>  <span class="comment"># Find the Agent (only one) that supplied this data object to EOL.</span>
</pre></a></td></tr><tr><td valign='top'><small>451</small></td><td valign='top'><ul><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line451'><pre>  <span class="keyword">def </span><span class="method">data_supplier_agent</span>
</pre></a></td></tr><tr><td valign='top'><small>452</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line452'><pre>    <span class="comment"># this is a bit of a shortcut = the hierarchy's agent should be the same as the agent</span>
</pre></a></td></tr><tr><td valign='top'><small>453</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line453'><pre>    <span class="comment"># that contributed the resource. DataObject should only live in a single hierarchy</span>
</pre></a></td></tr><tr><td valign='top'><small>454</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line454'><pre>    <span class="attribute">@data_supplier_agent</span> <span class="punct">||=</span> <span class="ident">hierarchy_entries</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">hierarchy</span><span class="punct">.</span><span class="ident">agent</span> <span class="keyword">rescue</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>455</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line455'><pre>    <span class="keyword">if</span> <span class="punct">!</span><span class="attribute">@data_supplier_agent</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>456</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line456'><pre>      <span class="keyword">if</span> <span class="punct">(!</span><span class="attribute">@data_supplier_agent</span><span class="punct">.</span><span class="ident">homepage?</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>457</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line457'><pre>        <span class="attribute">@data_supplier_agent</span> <span class="punct">=</span> <span class="constant">Agent</span><span class="punct">.</span><span class="ident">find_by_id</span><span class="punct">(</span><span class="attribute">@data_supplier_agent</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>458</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line458'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>459</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line459'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>460</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line460'><pre>    <span class="keyword">return</span> <span class="attribute">@data_supplier_agent</span>
</pre></a></td></tr><tr><td valign='top'><small>461</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line461'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>462</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line462'><pre>
</pre></a></td></tr><tr><td valign='top'><small>463</small></td><td valign='top'><ul><li>Duplication - calls data_supplier_agent 5 times &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line463'><pre>  <span class="keyword">def </span><span class="method">citable_data_supplier</span>
</pre></a></td></tr><tr><td valign='top'><small>464</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line464'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">data_supplier_agent</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>465</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line465'><pre>    <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Citable</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span> <span class="symbol">:agent_id</span> <span class="punct">=&gt;</span> <span class="ident">data_supplier_agent</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>466</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line466'><pre>                                  <span class="symbol">:link_to_url</span> <span class="punct">=&gt;</span> <span class="ident">data_supplier_agent</span><span class="punct">.</span><span class="ident">homepage</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>467</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line467'><pre>                                  <span class="symbol">:display_string</span> <span class="punct">=&gt;</span> <span class="ident">data_supplier_agent</span><span class="punct">.</span><span class="ident">full_name</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>468</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line468'><pre>                                  <span class="symbol">:logo_cache_url</span> <span class="punct">=&gt;</span> <span class="ident">data_supplier_agent</span><span class="punct">.</span><span class="ident">logo_cache_url</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>469</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line469'><pre>                                  <span class="symbol">:type</span> <span class="punct">=&gt;</span><span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(</span><span class="symbol">:supplier</span><span class="punct">))</span>
</pre></a></td></tr><tr><td valign='top'><small>470</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line470'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>471</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line471'><pre>
</pre></a></td></tr><tr><td valign='top'><small>472</small></td><td valign='top'><ul><li>Duplication - calls rights_holder twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line472'><pre>  <span class="keyword">def </span><span class="method">citable_rights_holder</span>
</pre></a></td></tr><tr><td valign='top'><small>473</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line473'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">rights_holder</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>474</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line474'><pre>    <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Citable</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span> <span class="symbol">:display_string</span> <span class="punct">=&gt;</span> <span class="ident">rights_holder</span><span class="punct">,</span> <span class="symbol">:type</span> <span class="punct">=&gt;</span> <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(&quot;</span><span class="string">rights_holder</span><span class="punct">&quot;))</span>
</pre></a></td></tr><tr><td valign='top'><small>475</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line475'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>476</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line476'><pre>
</pre></a></td></tr><tr><td valign='top'><small>477</small></td><td valign='top'><ul><li>Duplication - calls ado.agent twice &raquo; reek</li><li>Duplication - calls ado.agent_role twice &raquo; reek</li><li>Duplication - calls bibliographic_citation twice &raquo; reek</li><li>Duplication - calls created_at 3 times &raquo; reek</li><li>Duplication - calls license 4 times &raquo; reek</li><li>Duplication - calls location twice &raquo; reek</li><li>Duplication - calls rights_statement twice &raquo; reek</li><li>Duplication - calls source_url twice &raquo; reek</li><li>LongMethod - has approx 11 statements &raquo; reek</li><li>Method name "citable_entities" cyclomatic complexity is 12.  It should be 8 or less. &raquo; roodi</li><li>Method "citable_entities" has 50 lines.  It should have 20 or less. &raquo; roodi</li><li>Complexity 11 &raquo; saikuro</li></ul></td><td valign='top'><a name='line477'><pre>  <span class="keyword">def </span><span class="method">citable_entities</span>
</pre></a></td></tr><tr><td valign='top'><small>478</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line478'><pre>    <span class="ident">citables</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>479</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line479'><pre>
</pre></a></td></tr><tr><td valign='top'><small>480</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line480'><pre>    <span class="keyword">unless</span> <span class="ident">license</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>481</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line481'><pre>      <span class="ident">citables</span> <span class="punct">&lt;&lt;</span> <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Citable</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span> <span class="symbol">:link_to_url</span> <span class="punct">=&gt;</span> <span class="ident">license</span><span class="punct">.</span><span class="ident">source_url</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>482</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line482'><pre>                                    <span class="symbol">:display_string</span> <span class="punct">=&gt;</span> <span class="ident">license</span><span class="punct">.</span><span class="ident">description</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>483</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line483'><pre>                                    <span class="symbol">:logo_path</span> <span class="punct">=&gt;</span> <span class="ident">license</span><span class="punct">.</span><span class="ident">logo_url</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>484</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line484'><pre>                                    <span class="symbol">:type</span> <span class="punct">=&gt;</span> <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(&quot;</span><span class="string">license</span><span class="punct">&quot;))</span>
</pre></a></td></tr><tr><td valign='top'><small>485</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line485'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>486</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line486'><pre>
</pre></a></td></tr><tr><td valign='top'><small>487</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line487'><pre>    <span class="ident">agents_data_objects</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">ado</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>488</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line488'><pre>      <span class="keyword">if</span> <span class="ident">ado</span><span class="punct">.</span><span class="ident">agent_role</span> <span class="punct">&amp;&amp;</span> <span class="ident">ado</span><span class="punct">.</span><span class="ident">agent</span>
</pre></a></td></tr><tr><td valign='top'><small>489</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line489'><pre>        <span class="ident">citables</span> <span class="punct">&lt;&lt;</span> <span class="ident">ado</span><span class="punct">.</span><span class="ident">agent</span><span class="punct">.</span><span class="ident">citable</span><span class="punct">(</span><span class="ident">ado</span><span class="punct">.</span><span class="ident">agent_role</span><span class="punct">.</span><span class="ident">label</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>490</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line490'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>491</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line491'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>492</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line492'><pre>
</pre></a></td></tr><tr><td valign='top'><small>493</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line493'><pre>    <span class="keyword">unless</span> <span class="ident">data_supplier_agent</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>494</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line494'><pre>      <span class="ident">citables</span> <span class="punct">&lt;&lt;</span> <span class="ident">citable_data_supplier</span>
</pre></a></td></tr><tr><td valign='top'><small>495</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line495'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>496</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line496'><pre>
</pre></a></td></tr><tr><td valign='top'><small>497</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line497'><pre>    <span class="keyword">unless</span> <span class="ident">rights_statement</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>498</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line498'><pre>      <span class="ident">citables</span> <span class="punct">&lt;&lt;</span> <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Citable</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span> <span class="symbol">:display_string</span> <span class="punct">=&gt;</span> <span class="ident">rights_statement</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>499</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line499'><pre>                                    <span class="symbol">:type</span> <span class="punct">=&gt;</span> <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(&quot;</span><span class="string">rights</span><span class="punct">&quot;))</span>
</pre></a></td></tr><tr><td valign='top'><small>500</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line500'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>501</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line501'><pre>
</pre></a></td></tr><tr><td valign='top'><small>502</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line502'><pre>    <span class="keyword">unless</span> <span class="ident">rights_holder</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>503</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line503'><pre>      <span class="ident">citables</span> <span class="punct">&lt;&lt;</span> <span class="ident">citable_rights_holder</span>
</pre></a></td></tr><tr><td valign='top'><small>504</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line504'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>505</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line505'><pre>
</pre></a></td></tr><tr><td valign='top'><small>506</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line506'><pre>    <span class="keyword">unless</span> <span class="ident">location</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>507</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line507'><pre>      <span class="ident">citables</span> <span class="punct">&lt;&lt;</span> <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Citable</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span> <span class="symbol">:display_string</span> <span class="punct">=&gt;</span> <span class="ident">location</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>508</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line508'><pre>                                    <span class="symbol">:type</span> <span class="punct">=&gt;</span> <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(</span><span class="symbol">:location</span><span class="punct">))</span>
</pre></a></td></tr><tr><td valign='top'><small>509</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line509'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>510</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line510'><pre>
</pre></a></td></tr><tr><td valign='top'><small>511</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line511'><pre>    <span class="keyword">unless</span> <span class="ident">source_url</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>512</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line512'><pre>      <span class="ident">citables</span> <span class="punct">&lt;&lt;</span> <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Citable</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span> <span class="symbol">:link_to_url</span> <span class="punct">=&gt;</span> <span class="ident">source_url</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>513</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line513'><pre>                                    <span class="symbol">:display_string</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">View original data object</span><span class="punct">',</span>
</pre></a></td></tr><tr><td valign='top'><small>514</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line514'><pre>                                    <span class="symbol">:type</span> <span class="punct">=&gt;</span> <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(&quot;</span><span class="string">source_url</span><span class="punct">&quot;))</span>
</pre></a></td></tr><tr><td valign='top'><small>515</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line515'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>516</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line516'><pre>
</pre></a></td></tr><tr><td valign='top'><small>517</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line517'><pre>    <span class="keyword">unless</span> <span class="ident">created_at</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">||</span> <span class="ident">created_at</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">0000-00-00 00:00:00</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>518</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line518'><pre>      <span class="ident">citables</span> <span class="punct">&lt;&lt;</span> <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Citable</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span> <span class="symbol">:display_string</span> <span class="punct">=&gt;</span> <span class="ident">created_at</span><span class="punct">.</span><span class="ident">strftime</span><span class="punct">(&quot;</span><span class="string">%B %d, %Y</span><span class="punct">&quot;),</span>
</pre></a></td></tr><tr><td valign='top'><small>519</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line519'><pre>                                    <span class="symbol">:type</span> <span class="punct">=&gt;</span> <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(&quot;</span><span class="string">indexed</span><span class="punct">&quot;))</span>
</pre></a></td></tr><tr><td valign='top'><small>520</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line520'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>521</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line521'><pre>
</pre></a></td></tr><tr><td valign='top'><small>522</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line522'><pre>    <span class="keyword">unless</span> <span class="ident">bibliographic_citation</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>523</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line523'><pre>      <span class="ident">citables</span> <span class="punct">&lt;&lt;</span> <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Citable</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span> <span class="symbol">:display_string</span> <span class="punct">=&gt;</span> <span class="ident">bibliographic_citation</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>524</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line524'><pre>                                    <span class="symbol">:type</span> <span class="punct">=&gt;</span> <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(&quot;</span><span class="string">citation</span><span class="punct">&quot;))</span>
</pre></a></td></tr><tr><td valign='top'><small>525</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line525'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>526</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line526'><pre>
</pre></a></td></tr><tr><td valign='top'><small>527</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line527'><pre>    <span class="ident">citables</span>
</pre></a></td></tr><tr><td valign='top'><small>528</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line528'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>529</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line529'><pre>
</pre></a></td></tr><tr><td valign='top'><small>530</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line530'><pre>  <span class="comment"># 'owner' chooses someone responsible for this data object in order of preference</span>
</pre></a></td></tr><tr><td valign='top'><small>531</small></td><td valign='top'><ul><li>Duplication - calls ado.agent twice &raquo; reek</li><li>Duplication - calls agents_data_objects twice &raquo; reek</li><li>Duplication - calls agents_data_objects.find_all twice &raquo; reek</li><li>Duplication - calls best_ado.first twice &raquo; reek</li><li>Duplication - calls best_ado.first.agent twice &raquo; reek</li><li>Duplication - calls rights_holder twice &raquo; reek</li><li>NestedIterators - contains iterators nested 2 deep &raquo; reek</li><li>LongMethod - has approx 7 statements &raquo; reek</li><li>Complexity 6 &raquo; saikuro</li></ul></td><td valign='top'><a name='line531'><pre>  <span class="keyword">def </span><span class="method">owner</span>
</pre></a></td></tr><tr><td valign='top'><small>532</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line532'><pre>    <span class="comment"># rights holder is preferred</span>
</pre></a></td></tr><tr><td valign='top'><small>533</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line533'><pre>    <span class="keyword">return</span> <span class="ident">rights_holder</span><span class="punct">,</span> <span class="constant">nil</span> <span class="keyword">unless</span> <span class="ident">rights_holder</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>534</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line534'><pre>
</pre></a></td></tr><tr><td valign='top'><small>535</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line535'><pre>    <span class="comment"># otherwise choose agents ordered by preferred role</span>
</pre></a></td></tr><tr><td valign='top'><small>536</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line536'><pre>    <span class="ident">role_order</span> <span class="punct">=</span> <span class="punct">[</span> <span class="constant">AgentRole</span><span class="punct">.</span><span class="ident">author</span><span class="punct">,</span> <span class="constant">AgentRole</span><span class="punct">.</span><span class="ident">photographer</span><span class="punct">,</span> <span class="constant">AgentRole</span><span class="punct">.</span><span class="ident">source</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>537</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line537'><pre>                   <span class="constant">AgentRole</span><span class="punct">.</span><span class="ident">editor</span><span class="punct">,</span> <span class="constant">AgentRole</span><span class="punct">.</span><span class="ident">contributor</span> <span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>538</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line538'><pre>    <span class="ident">role_order</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">role</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>539</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line539'><pre>      <span class="ident">best_ado</span> <span class="punct">=</span> <span class="ident">agents_data_objects</span><span class="punct">.</span><span class="ident">find_all</span><span class="punct">{|</span><span class="ident">ado</span><span class="punct">|</span> <span class="ident">ado</span><span class="punct">.</span><span class="ident">agent_role_id</span> <span class="punct">==</span> <span class="ident">role</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">&amp;&amp;</span> <span class="ident">ado</span><span class="punct">.</span><span class="ident">agent</span><span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>540</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line540'><pre>      <span class="keyword">break</span> <span class="keyword">unless</span> <span class="ident">best_ado</span><span class="punct">.</span><span class="ident">empty?</span>
</pre></a></td></tr><tr><td valign='top'><small>541</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line541'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>542</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line542'><pre>
</pre></a></td></tr><tr><td valign='top'><small>543</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line543'><pre>    <span class="comment"># if we don't have any agents with the preferred roles then just pick one</span>
</pre></a></td></tr><tr><td valign='top'><small>544</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line544'><pre>    <span class="ident">best_ado</span> <span class="punct">=</span> <span class="ident">agents_data_objects</span><span class="punct">.</span><span class="ident">find_all</span><span class="punct">{|</span><span class="ident">ado</span><span class="punct">|</span> <span class="ident">ado</span><span class="punct">.</span><span class="ident">agent_role</span> <span class="punct">&amp;&amp;</span> <span class="ident">ado</span><span class="punct">.</span><span class="ident">agent</span><span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>545</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line545'><pre>
</pre></a></td></tr><tr><td valign='top'><small>546</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line546'><pre>    <span class="keyword">return</span> <span class="ident">best_ado</span><span class="punct">.</span><span class="ident">first</span><span class="punct">.</span><span class="ident">agent</span><span class="punct">.</span><span class="ident">full_name</span><span class="punct">,</span> <span class="ident">best_ado</span><span class="punct">.</span><span class="ident">first</span><span class="punct">.</span><span class="ident">agent</span><span class="punct">.</span><span class="ident">user</span>
</pre></a></td></tr><tr><td valign='top'><small>547</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line547'><pre>
</pre></a></td></tr><tr><td valign='top'><small>548</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line548'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>549</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line549'><pre>
</pre></a></td></tr><tr><td valign='top'><small>550</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line550'><pre>  <span class="comment"># Find all of the authors associated with this data object, including those that we dynamically add elsewhere</span>
</pre></a></td></tr><tr><td valign='top'><small>551</small></td><td valign='top'><ul><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line551'><pre>  <span class="keyword">def </span><span class="method">authors</span>
</pre></a></td></tr><tr><td valign='top'><small>552</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line552'><pre>    <span class="ident">default_authors</span> <span class="punct">=</span> <span class="ident">agents_data_objects</span><span class="punct">.</span><span class="ident">select</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">ado</span><span class="punct">|</span> <span class="ident">ado</span><span class="punct">.</span><span class="ident">agent_role_id</span> <span class="punct">==</span> <span class="constant">AgentRole</span><span class="punct">.</span><span class="ident">author</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}.</span><span class="ident">collect</span> <span class="punct">{|</span><span class="ident">ado</span><span class="punct">|</span> <span class="ident">ado</span><span class="punct">.</span><span class="ident">agent</span> <span class="punct">}.</span><span class="ident">compact</span>
</pre></a></td></tr><tr><td valign='top'><small>553</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line553'><pre>    <span class="attribute">@fake_authors</span><span class="punct">.</span><span class="ident">nil?</span> <span class="punct">?</span> <span class="ident">default_authors</span> <span class="punct">:</span> <span class="ident">default_authors</span> <span class="punct">+</span> <span class="attribute">@fake_authors</span>
</pre></a></td></tr><tr><td valign='top'><small>554</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line554'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>555</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line555'><pre>
</pre></a></td></tr><tr><td valign='top'><small>556</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line556'><pre>  <span class="comment"># Find all of the photographers associated with this data object, including those that we dynamically add elsewhere</span>
</pre></a></td></tr><tr><td valign='top'><small>557</small></td><td valign='top'><ul><li>LowCohesion - refers to ado more than self &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line557'><pre>  <span class="keyword">def </span><span class="method">photographers</span>
</pre></a></td></tr><tr><td valign='top'><small>558</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line558'><pre>    <span class="ident">agents_data_objects</span><span class="punct">.</span><span class="ident">agents_data_objects</span><span class="punct">.</span><span class="ident">select</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">ado</span><span class="punct">|</span> <span class="ident">ado</span><span class="punct">.</span><span class="ident">agent_role_id</span> <span class="punct">==</span> <span class="constant">AgentRole</span><span class="punct">.</span><span class="ident">photographer</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}.</span><span class="ident">collect</span> <span class="punct">{|</span><span class="ident">ado</span><span class="punct">|</span> <span class="ident">ado</span><span class="punct">.</span><span class="ident">agent</span> <span class="punct">}.</span><span class="ident">compact</span>
</pre></a></td></tr><tr><td valign='top'><small>559</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line559'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>560</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line560'><pre>
</pre></a></td></tr><tr><td valign='top'><small>561</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line561'><pre>  <span class="comment"># Add an author to this data object that isn't in the database.</span>
</pre></a></td></tr><tr><td valign='top'><small>562</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line562'><pre>  <span class="keyword">def </span><span class="method">fake_author</span><span class="punct">(</span><span class="ident">author_options</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>563</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line563'><pre>    <span class="attribute">@fake_authors</span> <span class="punct">||=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>564</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line564'><pre>    <span class="attribute">@fake_authors</span> <span class="punct">&lt;&lt;</span> <span class="constant">Agent</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="ident">author_options</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>565</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line565'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>566</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line566'><pre>
</pre></a></td></tr><tr><td valign='top'><small>567</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line567'><pre>  <span class="comment"># Find Agents associated with this data object as sources.  If there are none, find authors.</span>
</pre></a></td></tr><tr><td valign='top'><small>568</small></td><td valign='top'><ul><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line568'><pre>  <span class="keyword">def </span><span class="method">sources</span>
</pre></a></td></tr><tr><td valign='top'><small>569</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line569'><pre>    <span class="ident">list</span> <span class="punct">=</span> <span class="ident">agents_data_objects</span><span class="punct">.</span><span class="ident">select</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">ado</span><span class="punct">|</span> <span class="ident">ado</span><span class="punct">.</span><span class="ident">agent_role_id</span> <span class="punct">==</span> <span class="constant">AgentRole</span><span class="punct">.</span><span class="ident">source</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}.</span><span class="ident">collect</span> <span class="punct">{|</span><span class="ident">ado</span><span class="punct">|</span> <span class="ident">ado</span><span class="punct">.</span><span class="ident">agent</span> <span class="punct">}.</span><span class="ident">compact</span>
</pre></a></td></tr><tr><td valign='top'><small>570</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line570'><pre>    <span class="keyword">return</span> <span class="ident">list</span> <span class="keyword">unless</span> <span class="ident">list</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>571</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line571'><pre>    <span class="comment"># I ended up with empty lists in cases where I thought I shouldn't, so tried to defer to authors for those:</span>
</pre></a></td></tr><tr><td valign='top'><small>572</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line572'><pre>    <span class="keyword">return</span> <span class="ident">authors</span>
</pre></a></td></tr><tr><td valign='top'><small>573</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line573'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>574</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line574'><pre>
</pre></a></td></tr><tr><td valign='top'><small>575</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line575'><pre>  <span class="keyword">def </span><span class="method">revisions</span>
</pre></a></td></tr><tr><td valign='top'><small>576</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line576'><pre>    <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">find_all_by_guid</span><span class="punct">(</span><span class="ident">guid</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>577</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line577'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>578</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line578'><pre>
</pre></a></td></tr><tr><td valign='top'><small>579</small></td><td valign='top'><ul><li>Duplication - calls all_comments twice &raquo; reek</li><li>UncommunicativeName - has the variable name 'c' &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line579'><pre>  <span class="keyword">def </span><span class="method">visible_comments</span><span class="punct">(</span><span class="ident">user</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>580</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line580'><pre>    <span class="keyword">return</span> <span class="ident">all_comments</span> <span class="keyword">if</span> <span class="punct">(</span><span class="keyword">not</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">nil?</span><span class="punct">)</span> <span class="keyword">and</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">is_moderator?</span>
</pre></a></td></tr><tr><td valign='top'><small>581</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line581'><pre>    <span class="ident">all_comments</span><span class="punct">.</span><span class="ident">find_all</span> <span class="punct">{|</span><span class="ident">c</span><span class="punct">|</span> <span class="ident">c</span><span class="punct">.</span><span class="ident">visible?</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>582</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line582'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>583</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line583'><pre>
</pre></a></td></tr><tr><td valign='top'><small>584</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line584'><pre>  <span class="keyword">def </span><span class="method">image?</span>
</pre></a></td></tr><tr><td valign='top'><small>585</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line585'><pre>    <span class="keyword">return</span> <span class="constant">DataType</span><span class="punct">.</span><span class="ident">image_type_ids</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">data_type_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>586</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line586'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>587</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line587'><pre>  <span class="keyword">alias</span> <span class="ident">is_image?</span> <span class="ident">image?</span>
</pre></a></td></tr><tr><td valign='top'><small>588</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line588'><pre>
</pre></a></td></tr><tr><td valign='top'><small>589</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line589'><pre>  <span class="keyword">def </span><span class="method">map?</span>
</pre></a></td></tr><tr><td valign='top'><small>590</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line590'><pre>    <span class="keyword">return</span> <span class="constant">DataType</span><span class="punct">.</span><span class="ident">map_type_ids</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">data_type_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>591</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line591'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>592</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line592'><pre>
</pre></a></td></tr><tr><td valign='top'><small>593</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line593'><pre>  <span class="keyword">def </span><span class="method">text?</span>
</pre></a></td></tr><tr><td valign='top'><small>594</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line594'><pre>    <span class="keyword">return</span> <span class="constant">DataType</span><span class="punct">.</span><span class="ident">text_type_ids</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">data_type_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>595</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line595'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>596</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line596'><pre>  <span class="keyword">alias</span> <span class="ident">is_text?</span> <span class="ident">text?</span>
</pre></a></td></tr><tr><td valign='top'><small>597</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line597'><pre>
</pre></a></td></tr><tr><td valign='top'><small>598</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line598'><pre>  <span class="keyword">def </span><span class="method">sound?</span>
</pre></a></td></tr><tr><td valign='top'><small>599</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line599'><pre>    <span class="keyword">return</span> <span class="constant">DataType</span><span class="punct">.</span><span class="ident">sound_type_ids</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">data_type_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>600</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line600'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>601</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line601'><pre>  <span class="keyword">alias</span> <span class="ident">is_sound?</span> <span class="ident">sound?</span>
</pre></a></td></tr><tr><td valign='top'><small>602</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line602'><pre>
</pre></a></td></tr><tr><td valign='top'><small>603</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line603'><pre>  <span class="keyword">def </span><span class="method">video?</span>
</pre></a></td></tr><tr><td valign='top'><small>604</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line604'><pre>    <span class="keyword">return</span> <span class="constant">DataType</span><span class="punct">.</span><span class="ident">video_type_ids</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">data_type_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>605</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line605'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>606</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line606'><pre>  <span class="keyword">alias</span> <span class="ident">is_video?</span> <span class="ident">video?</span>
</pre></a></td></tr><tr><td valign='top'><small>607</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line607'><pre>
</pre></a></td></tr><tr><td valign='top'><small>608</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line608'><pre>  <span class="keyword">def </span><span class="method">iucn?</span>
</pre></a></td></tr><tr><td valign='top'><small>609</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line609'><pre>    <span class="keyword">return</span> <span class="ident">data_type_id</span> <span class="punct">==</span> <span class="constant">DataType</span><span class="punct">.</span><span class="ident">iucn</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>610</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line610'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>611</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line611'><pre>  <span class="keyword">alias</span> <span class="ident">is_iucn?</span> <span class="ident">iucn?</span>
</pre></a></td></tr><tr><td valign='top'><small>612</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line612'><pre>
</pre></a></td></tr><tr><td valign='top'><small>613</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line613'><pre>
</pre></a></td></tr><tr><td valign='top'><small>614</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line614'><pre>  <span class="comment"># Convenience.  TODO - Stop calling this.  Use ContentServer directly.</span>
</pre></a></td></tr><tr><td valign='top'><small>615</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line615'><pre>  <span class="keyword">def </span><span class="method">self.cache_path</span><span class="punct">(</span><span class="ident">cache_url</span><span class="punct">,</span> <span class="ident">subdir</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>616</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line616'><pre>    <span class="constant">ContentServer</span><span class="punct">.</span><span class="ident">cache_path</span><span class="punct">(</span><span class="ident">cache_url</span><span class="punct">,</span> <span class="ident">subdir</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>617</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line617'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>618</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line618'><pre>
</pre></a></td></tr><tr><td valign='top'><small>619</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line619'><pre>  <span class="keyword">def </span><span class="method">self.image_cache_path</span><span class="punct">(</span><span class="ident">cache_url</span><span class="punct">,</span> <span class="ident">size</span> <span class="punct">=</span> <span class="symbol">:large</span><span class="punct">,</span> <span class="ident">subdir</span> <span class="punct">=</span> <span class="global">$CONTENT_SERVER_CONTENT_PATH</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>620</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line620'><pre>    <span class="ident">size</span> <span class="punct">=</span> <span class="ident">size</span> <span class="punct">?</span> <span class="punct">&quot;</span><span class="string">_</span><span class="punct">&quot;</span> <span class="punct">+</span> <span class="ident">size</span><span class="punct">.</span><span class="ident">to_s</span> <span class="punct">:</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>621</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line621'><pre>    <span class="ident">cache_path</span><span class="punct">(</span><span class="ident">cache_url</span><span class="punct">,</span> <span class="ident">subdir</span><span class="punct">)</span> <span class="punct">+</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{size}</span>.<span class="expr">#{$SPECIES_IMAGE_FORMAT}</span></span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>622</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line622'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>623</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line623'><pre>
</pre></a></td></tr><tr><td valign='top'><small>624</small></td><td valign='top'><ul><li>Duplication - calls thumbnail_cache_url twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line624'><pre>  <span class="keyword">def </span><span class="method">has_thumbnail_cache?</span>
</pre></a></td></tr><tr><td valign='top'><small>625</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line625'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">if</span> <span class="ident">thumbnail_cache_url</span><span class="punct">.</span><span class="ident">blank?</span> <span class="keyword">or</span> <span class="ident">thumbnail_cache_url</span> <span class="punct">==</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>626</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line626'><pre>    <span class="keyword">return</span> <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>627</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line627'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>628</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line628'><pre>
</pre></a></td></tr><tr><td valign='top'><small>629</small></td><td valign='top'><ul><li>Duplication - calls object_cache_url twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line629'><pre>  <span class="keyword">def </span><span class="method">has_object_cache_url?</span>
</pre></a></td></tr><tr><td valign='top'><small>630</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line630'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">if</span> <span class="ident">object_cache_url</span><span class="punct">.</span><span class="ident">blank?</span> <span class="keyword">or</span> <span class="ident">object_cache_url</span> <span class="punct">==</span> <span class="number">0</span>
</pre></a></td></tr><tr><td valign='top'><small>631</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line631'><pre>    <span class="keyword">return</span> <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>632</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line632'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>633</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line633'><pre>
</pre></a></td></tr><tr><td valign='top'><small>634</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line634'><pre>  <span class="keyword">def </span><span class="method">thumb_or_object</span><span class="punct">(</span><span class="ident">size</span> <span class="punct">=</span> <span class="symbol">:large</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>635</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line635'><pre>    <span class="keyword">return</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">image_cache_path</span><span class="punct">(</span><span class="ident">object_cache_url</span><span class="punct">,</span> <span class="ident">size</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>636</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line636'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>637</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line637'><pre>
</pre></a></td></tr><tr><td valign='top'><small>638</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line638'><pre>  <span class="comment"># Returns the src when you want an image tag containing a thumbnail.</span>
</pre></a></td></tr><tr><td valign='top'><small>639</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line639'><pre>  <span class="keyword">def </span><span class="method">smart_thumb</span>
</pre></a></td></tr><tr><td valign='top'><small>640</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line640'><pre>    <span class="ident">thumb_or_object</span><span class="punct">(</span><span class="symbol">:small</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>641</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line641'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>642</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line642'><pre>
</pre></a></td></tr><tr><td valign='top'><small>643</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line643'><pre>  <span class="comment"># Returns the src when you want an image tag containing a &quot;larger&quot; thumbnail (a'la main page).</span>
</pre></a></td></tr><tr><td valign='top'><small>644</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line644'><pre>  <span class="keyword">def </span><span class="method">smart_medium_thumb</span>
</pre></a></td></tr><tr><td valign='top'><small>645</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line645'><pre>    <span class="ident">thumb_or_object</span><span class="punct">(</span><span class="symbol">:medium</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>646</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line646'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>647</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line647'><pre>
</pre></a></td></tr><tr><td valign='top'><small>648</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line648'><pre>  <span class="comment"># Returns the src when you want an image tag containing the *full* image.</span>
</pre></a></td></tr><tr><td valign='top'><small>649</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line649'><pre>  <span class="keyword">def </span><span class="method">smart_image</span>
</pre></a></td></tr><tr><td valign='top'><small>650</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line650'><pre>    <span class="ident">thumb_or_object</span>
</pre></a></td></tr><tr><td valign='top'><small>651</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line651'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>652</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line652'><pre>
</pre></a></td></tr><tr><td valign='top'><small>653</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line653'><pre>  <span class="keyword">def </span><span class="method">original_image</span>
</pre></a></td></tr><tr><td valign='top'><small>654</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line654'><pre>    <span class="ident">thumb_or_object</span><span class="punct">(</span><span class="constant">nil</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>655</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line655'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>656</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line656'><pre>
</pre></a></td></tr><tr><td valign='top'><small>657</small></td><td valign='top'><ul><li>Duplication - calls ContentServer.cache_path(object_cache_url) twice &raquo; reek</li><li>Duplication - calls object_cache_url 3 times &raquo; reek</li><li>Duplication - calls object_url 3 times &raquo; reek</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line657'><pre>  <span class="keyword">def </span><span class="method">sound_url</span>
</pre></a></td></tr><tr><td valign='top'><small>658</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line658'><pre>    <span class="keyword">if</span> <span class="punct">!</span><span class="ident">object_cache_url</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span><span class="ident">object_url</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>659</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line659'><pre>      <span class="ident">filename_extension</span> <span class="punct">=</span> <span class="constant">File</span><span class="punct">.</span><span class="ident">extname</span><span class="punct">(</span><span class="ident">object_url</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>660</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line660'><pre>      <span class="keyword">return</span> <span class="constant">ContentServer</span><span class="punct">.</span><span class="ident">cache_path</span><span class="punct">(</span><span class="ident">object_cache_url</span><span class="punct">)</span> <span class="punct">+</span> <span class="ident">filename_extension</span>
</pre></a></td></tr><tr><td valign='top'><small>661</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line661'><pre>    <span class="keyword">elsif</span> <span class="ident">mime_type</span><span class="punct">.</span><span class="ident">label</span><span class="punct">('</span><span class="string">en</span><span class="punct">')</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">audio/mpeg</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>662</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line662'><pre>      <span class="keyword">return</span> <span class="ident">has_object_cache_url?</span> <span class="punct">?</span> <span class="constant">ContentServer</span><span class="punct">.</span><span class="ident">cache_path</span><span class="punct">(</span><span class="ident">object_cache_url</span><span class="punct">)</span> <span class="punct">+</span> <span class="punct">'</span><span class="string">.mp3</span><span class="punct">'</span> <span class="punct">:</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>663</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line663'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>664</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line664'><pre>      <span class="keyword">return</span> <span class="ident">object_url</span>
</pre></a></td></tr><tr><td valign='top'><small>665</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line665'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>666</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line666'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>667</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line667'><pre>
</pre></a></td></tr><tr><td valign='top'><small>668</small></td><td valign='top'><ul><li>Duplication - calls ContentServer.cache_path(object_cache_url) twice &raquo; reek</li><li>Duplication - calls object_cache_url 3 times &raquo; reek</li><li>Duplication - calls object_url 3 times &raquo; reek</li><li>Complexity 4 &raquo; saikuro</li></ul></td><td valign='top'><a name='line668'><pre>  <span class="keyword">def </span><span class="method">video_url</span>
</pre></a></td></tr><tr><td valign='top'><small>669</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line669'><pre>    <span class="keyword">if</span> <span class="punct">!</span><span class="ident">object_cache_url</span><span class="punct">.</span><span class="ident">blank?</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span><span class="ident">object_url</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>670</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line670'><pre>      <span class="ident">filename_extension</span> <span class="punct">=</span> <span class="constant">File</span><span class="punct">.</span><span class="ident">extname</span><span class="punct">(</span><span class="ident">object_url</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>671</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line671'><pre>      <span class="keyword">return</span> <span class="constant">ContentServer</span><span class="punct">.</span><span class="ident">cache_path</span><span class="punct">(</span><span class="ident">object_cache_url</span><span class="punct">)</span> <span class="punct">+</span> <span class="ident">filename_extension</span>
</pre></a></td></tr><tr><td valign='top'><small>672</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line672'><pre>    <span class="keyword">elsif</span> <span class="ident">data_type</span><span class="punct">.</span><span class="ident">label</span><span class="punct">('</span><span class="string">en</span><span class="punct">')</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">Flash</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>673</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line673'><pre>      <span class="keyword">return</span> <span class="ident">has_object_cache_url?</span> <span class="punct">?</span> <span class="constant">ContentServer</span><span class="punct">.</span><span class="ident">cache_path</span><span class="punct">(</span><span class="ident">object_cache_url</span><span class="punct">)</span> <span class="punct">+</span> <span class="punct">'</span><span class="string">.flv</span><span class="punct">'</span> <span class="punct">:</span> <span class="punct">'</span><span class="string"></span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>674</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line674'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>675</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line675'><pre>      <span class="keyword">return</span> <span class="ident">object_url</span>
</pre></a></td></tr><tr><td valign='top'><small>676</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line676'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>677</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line677'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>678</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line678'><pre>
</pre></a></td></tr><tr><td valign='top'><small>679</small></td><td valign='top'><ul><li>Duplication - calls object_cache_url twice &raquo; reek</li><li>Duplication - calls object_url twice &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line679'><pre>  <span class="keyword">def </span><span class="method">map_image</span>
</pre></a></td></tr><tr><td valign='top'><small>680</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line680'><pre>    <span class="comment"># Sometimes, we want to serve map images right from the source:</span>
</pre></a></td></tr><tr><td valign='top'><small>681</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line681'><pre>    <span class="keyword">if</span> <span class="punct">(</span><span class="global">$PREFER_REMOTE_IMAGES</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="ident">object_url</span><span class="punct">.</span><span class="ident">blank?</span><span class="punct">)</span> <span class="keyword">or</span> <span class="punct">(</span><span class="ident">object_cache_url</span><span class="punct">.</span><span class="ident">blank?</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>682</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line682'><pre>      <span class="keyword">return</span> <span class="ident">object_url</span>
</pre></a></td></tr><tr><td valign='top'><small>683</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line683'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>684</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line684'><pre>      <span class="keyword">return</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">cache_path</span><span class="punct">(</span><span class="ident">object_cache_url</span><span class="punct">)</span> <span class="punct">+</span> <span class="punct">&quot;</span><span class="string">_orig.jpg</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>685</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line685'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>686</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line686'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>687</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line687'><pre>
</pre></a></td></tr><tr><td valign='top'><small>688</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line688'><pre>  <span class="comment"># This allows multiple values, eg: 'red, blue' or 'red blue'</span>
</pre></a></td></tr><tr><td valign='top'><small>689</small></td><td valign='top'><ul><li>LongMethod - has approx 11 statements &raquo; reek</li><li>ControlCouple - is controlled by argument user &raquo; reek</li><li>ControlCouple - is controlled by argument values &raquo; reek</li><li>Complexity 7 &raquo; saikuro</li></ul></td><td valign='top'><a name='line689'><pre>  <span class="keyword">def </span><span class="method">tag</span><span class="punct">(</span><span class="ident">key</span><span class="punct">,</span> <span class="ident">values</span><span class="punct">,</span> <span class="ident">user</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>690</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line690'><pre>    <span class="keyword">raise</span> <span class="constant">I18n</span><span class="punct">.</span><span class="ident">t</span><span class="punct">(</span><span class="symbol">:you_must_be_logged_in_to_add_tags</span><span class="punct">)</span>  <span class="keyword">unless</span> <span class="ident">user</span>
</pre></a></td></tr><tr><td valign='top'><small>691</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line691'><pre>    <span class="ident">key</span> <span class="punct">=</span> <span class="punct">'</span><span class="string">none</span><span class="punct">'</span> <span class="keyword">if</span> <span class="ident">key</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>692</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line692'><pre>    <span class="keyword">return</span> <span class="keyword">unless</span> <span class="ident">values</span>
</pre></a></td></tr><tr><td valign='top'><small>693</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line693'><pre>    <span class="ident">values</span> <span class="punct">=</span> <span class="constant">DataObjectTag</span><span class="punct">.</span><span class="ident">clean_values</span><span class="punct">(</span><span class="ident">values</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>694</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line694'><pre>    <span class="ident">values</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">value</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>695</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line695'><pre>      <span class="ident">tag</span> <span class="punct">=</span> <span class="constant">DataObjectTag</span><span class="punct">.</span><span class="ident">find_or_create_by_key_and_value</span> <span class="ident">key</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="ident">value</span><span class="punct">.</span><span class="ident">to_s</span>
</pre></a></td></tr><tr><td valign='top'><small>696</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line696'><pre>      <span class="keyword">if</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">tags_are_public_for_data_object?</span><span class="punct">(</span><span class="constant">self</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>697</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line697'><pre>        <span class="ident">tag</span><span class="punct">.</span><span class="ident">update_attributes!</span><span class="punct">(</span><span class="symbol">:is_public</span> <span class="punct">=&gt;</span> <span class="constant">true</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>698</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line698'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>699</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line699'><pre>      <span class="keyword">begin</span>
</pre></a></td></tr><tr><td valign='top'><small>700</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line700'><pre>        <span class="constant">DataObjectTags</span><span class="punct">.</span><span class="ident">create</span> <span class="symbol">:data_object</span> <span class="punct">=&gt;</span> <span class="constant">self</span><span class="punct">,</span> <span class="symbol">:data_object_guid</span> <span class="punct">=&gt;</span> <span class="ident">guid</span><span class="punct">,</span> <span class="symbol">:data_object_tag</span> <span class="punct">=&gt;</span> <span class="ident">tag</span><span class="punct">,</span> <span class="symbol">:user</span> <span class="punct">=&gt;</span> <span class="ident">user</span>
</pre></a></td></tr><tr><td valign='top'><small>701</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line701'><pre>      <span class="keyword">rescue</span>
</pre></a></td></tr><tr><td valign='top'><small>702</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line702'><pre>        <span class="keyword">raise</span> <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Exceptions</span><span class="punct">::</span><span class="constant">FailedToCreateTag</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(&quot;</span><span class="string">Failed to add <span class="expr">#{key}</span>:<span class="expr">#{value}</span> tag</span><span class="punct">&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>703</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line703'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>704</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line704'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>705</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line705'><pre>    <span class="ident">tags</span><span class="punct">.</span><span class="ident">reset</span>
</pre></a></td></tr><tr><td valign='top'><small>706</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line706'><pre>    <span class="ident">user</span><span class="punct">.</span><span class="ident">tags</span><span class="punct">.</span><span class="ident">reset</span>
</pre></a></td></tr><tr><td valign='top'><small>707</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line707'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>708</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line708'><pre>
</pre></a></td></tr><tr><td valign='top'><small>709</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line709'><pre>  <span class="keyword">def </span><span class="method">public_tags</span>
</pre></a></td></tr><tr><td valign='top'><small>710</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line710'><pre>    <span class="constant">DataObjectTags</span><span class="punct">.</span><span class="ident">public_tags_for_data_object</span> <span class="constant">self</span>
</pre></a></td></tr><tr><td valign='top'><small>711</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line711'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>712</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line712'><pre>
</pre></a></td></tr><tr><td valign='top'><small>713</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line713'><pre>  <span class="comment"># returns a hash in the format { 'tag_key' =&gt; ['value1','value2'] }</span>
</pre></a></td></tr><tr><td valign='top'><small>714</small></td><td valign='top'><ul><li>Duplication - calls this.key twice &raquo; reek</li><li>LowCohesion - refers to this more than self &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line714'><pre>  <span class="keyword">def </span><span class="method">tags_hash</span>
</pre></a></td></tr><tr><td valign='top'><small>715</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line715'><pre>    <span class="ident">tags</span><span class="punct">.</span><span class="ident">inject</span><span class="punct">({})</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">all</span><span class="punct">,</span><span class="ident">this</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>716</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line716'><pre>      <span class="ident">all</span><span class="punct">[</span><span class="ident">this</span><span class="punct">.</span><span class="ident">key</span><span class="punct">]</span> <span class="punct">=</span> <span class="punct">(</span><span class="ident">all</span><span class="punct">[</span><span class="ident">this</span><span class="punct">.</span><span class="ident">key</span><span class="punct">]</span> <span class="punct">||</span> <span class="punct">[])</span> <span class="punct">+</span> <span class="punct">[</span><span class="ident">this</span><span class="punct">.</span><span class="ident">value</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>717</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line717'><pre>      <span class="ident">all</span>
</pre></a></td></tr><tr><td valign='top'><small>718</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line718'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>719</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line719'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>720</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line720'><pre>
</pre></a></td></tr><tr><td valign='top'><small>721</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line721'><pre>  <span class="comment"># returns an array of all of the keys an object is tagged with</span>
</pre></a></td></tr><tr><td valign='top'><small>722</small></td><td valign='top'><ul><li>UncommunicativeName - has the variable name 't' &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line722'><pre>  <span class="keyword">def </span><span class="method">tag_keys</span>
</pre></a></td></tr><tr><td valign='top'><small>723</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line723'><pre>    <span class="ident">tags</span><span class="punct">.</span><span class="ident">map</span> <span class="punct">{|</span><span class="ident">t</span><span class="punct">|</span> <span class="ident">t</span><span class="punct">.</span><span class="ident">key</span> <span class="punct">}.</span><span class="ident">uniq</span>
</pre></a></td></tr><tr><td valign='top'><small>724</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line724'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>725</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line725'><pre>
</pre></a></td></tr><tr><td valign='top'><small>726</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line726'><pre>  <span class="comment"># TODO - wow, this is expensive (IFF you pass in :published) ... we should really consider optimizing this, since</span>
</pre></a></td></tr><tr><td valign='top'><small>727</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line727'><pre>  <span class="comment"># it's actually used quite often. ...and in some cases, just to get the ID of the first one.  Ouch.</span>
</pre></a></td></tr><tr><td valign='top'><small>728</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line728'><pre>  <span class="comment"># :published -&gt; :strict - return only published taxon concepts</span>
</pre></a></td></tr><tr><td valign='top'><small>729</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line729'><pre>  <span class="comment"># :published -&gt; :preferred - same as above, but returns unpublished taxon concepts if no published ones are found</span>
</pre></a></td></tr><tr><td valign='top'><small>730</small></td><td valign='top'><ul><li>Duplication - calls opts[:published] twice &raquo; reek</li><li>LongMethod - has approx 7 statements &raquo; reek</li><li>Complexity 6 &raquo; saikuro</li></ul></td><td valign='top'><a name='line730'><pre>  <span class="keyword">def </span><span class="method">get_taxon_concepts</span><span class="punct">(</span><span class="ident">opts</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>731</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line731'><pre>    <span class="keyword">return</span> <span class="attribute">@taxon_concepts</span> <span class="keyword">if</span> <span class="attribute">@taxon_concepts</span>
</pre></a></td></tr><tr><td valign='top'><small>732</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line732'><pre>    <span class="keyword">if</span> <span class="ident">created_by_user?</span>
</pre></a></td></tr><tr><td valign='top'><small>733</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line733'><pre>      <span class="attribute">@taxon_concepts</span> <span class="punct">=</span> <span class="punct">[</span><span class="ident">taxon_concept_for_users_text</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>734</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line734'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>735</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line735'><pre>      <span class="attribute">@taxon_concepts</span> <span class="punct">=</span> <span class="ident">taxon_concepts</span>
</pre></a></td></tr><tr><td valign='top'><small>736</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line736'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>737</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line737'><pre>    <span class="keyword">if</span> <span class="ident">opts</span><span class="punct">[</span><span class="symbol">:published</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>738</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line738'><pre>      <span class="ident">published</span><span class="punct">,</span> <span class="ident">unpublished</span> <span class="punct">=</span> <span class="attribute">@taxon_concepts</span><span class="punct">.</span><span class="ident">partition</span> <span class="punct">{|</span><span class="ident">item</span><span class="punct">|</span> <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">item</span><span class="punct">.</span><span class="ident">id</span><span class="punct">).</span><span class="ident">published?</span><span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>739</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line739'><pre>      <span class="attribute">@taxon_concepts</span> <span class="punct">=</span> <span class="punct">(!</span><span class="ident">published</span><span class="punct">.</span><span class="ident">empty?</span> <span class="punct">||</span> <span class="ident">opts</span><span class="punct">[</span><span class="symbol">:published</span><span class="punct">]</span> <span class="punct">==</span> <span class="symbol">:strict</span><span class="punct">)</span> <span class="punct">?</span> <span class="ident">published</span> <span class="punct">:</span> <span class="ident">unpublished</span>
</pre></a></td></tr><tr><td valign='top'><small>740</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line740'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>741</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line741'><pre>    <span class="attribute">@taxon_concepts</span>
</pre></a></td></tr><tr><td valign='top'><small>742</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line742'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>743</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line743'><pre>
</pre></a></td></tr><tr><td valign='top'><small>744</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line744'><pre>  <span class="keyword">def </span><span class="method">linked_taxon_concept</span>
</pre></a></td></tr><tr><td valign='top'><small>745</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line745'><pre>    <span class="ident">get_taxon_concepts</span><span class="punct">.</span><span class="ident">first</span>
</pre></a></td></tr><tr><td valign='top'><small>746</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line746'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>747</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line747'><pre>
</pre></a></td></tr><tr><td valign='top'><small>748</small></td><td valign='top'><ul><li>Duplication - calls options[:vetted_id] 3 times &raquo; reek</li><li>Duplication - calls options[:vetted_id].blank? twice &raquo; reek</li><li>Duplication - calls options[:visibility_id] 3 times &raquo; reek</li><li>Duplication - calls options[:visibility_id].blank? twice &raquo; reek</li><li>LongMethod - has approx 9 statements &raquo; reek</li><li>LowCohesion - refers to options more than self &raquo; reek</li><li>Complexity 7 &raquo; saikuro</li></ul></td><td valign='top'><a name='line748'><pre>  <span class="keyword">def </span><span class="method">update_solr_index</span><span class="punct">(</span><span class="ident">options</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>749</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line749'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted_id</span><span class="punct">].</span><span class="ident">blank?</span> <span class="punct">&amp;&amp;</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:visibility_id</span><span class="punct">].</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>750</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line750'><pre>    <span class="ident">solr_connection</span> <span class="punct">=</span> <span class="constant">SolrAPI</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="global">$SOLR_SERVER</span><span class="punct">,</span> <span class="global">$SOLR_DATA_OBJECTS_CORE</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>751</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line751'><pre>    <span class="keyword">begin</span>
</pre></a></td></tr><tr><td valign='top'><small>752</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line752'><pre>      <span class="comment"># query Solr for the index record for this data object</span>
</pre></a></td></tr><tr><td valign='top'><small>753</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line753'><pre>      <span class="ident">response</span> <span class="punct">=</span> <span class="ident">solr_connection</span><span class="punct">.</span><span class="ident">query_lucene</span><span class="punct">(&quot;</span><span class="string">data_object_id:<span class="expr">#{id}</span></span><span class="punct">&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>754</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line754'><pre>      <span class="ident">data_object_hash</span> <span class="punct">=</span> <span class="ident">response</span><span class="punct">['</span><span class="string">response</span><span class="punct">']['</span><span class="string">docs</span><span class="punct">'][</span><span class="number">0</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>755</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line755'><pre>      <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">unless</span> <span class="ident">data_object_hash</span>
</pre></a></td></tr><tr><td valign='top'><small>756</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line756'><pre>      <span class="ident">modified_object_hash</span> <span class="punct">=</span> <span class="ident">data_object_hash</span><span class="punct">.</span><span class="ident">dup</span>
</pre></a></td></tr><tr><td valign='top'><small>757</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line757'><pre>      <span class="ident">modified_object_hash</span><span class="punct">['</span><span class="string">vetted_id</span><span class="punct">']</span> <span class="punct">=</span> <span class="punct">[</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted_id</span><span class="punct">]]</span> <span class="keyword">unless</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:vetted_id</span><span class="punct">].</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>758</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line758'><pre>      <span class="ident">modified_object_hash</span><span class="punct">['</span><span class="string">visibility_id</span><span class="punct">']</span> <span class="punct">=</span> <span class="punct">[</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:visibility_id</span><span class="punct">]]</span> <span class="keyword">unless</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:visibility_id</span><span class="punct">].</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>759</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line759'><pre>      <span class="comment"># if some of the values have changed, post the updated record to Solr</span>
</pre></a></td></tr><tr><td valign='top'><small>760</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line760'><pre>      <span class="keyword">if</span> <span class="ident">data_object_hash</span> <span class="punct">!=</span> <span class="ident">modified_object_hash</span>
</pre></a></td></tr><tr><td valign='top'><small>761</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line761'><pre>        <span class="ident">solr_connection</span><span class="punct">.</span><span class="ident">create</span><span class="punct">(</span><span class="ident">modified_object_hash</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>762</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line762'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>763</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line763'><pre>    <span class="keyword">rescue</span>
</pre></a></td></tr><tr><td valign='top'><small>764</small></td><td valign='top'><ul><li>Rescue block should not be empty. &raquo; roodi</li></ul></td><td valign='top'><a name='line764'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>765</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line765'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>766</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line766'><pre>
</pre></a></td></tr><tr><td valign='top'><small>767</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line767'><pre>  <span class="keyword">def </span><span class="method">in_wikipedia?</span>
</pre></a></td></tr><tr><td valign='top'><small>768</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line768'><pre>    <span class="ident">toc_items</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="constant">TocItem</span><span class="punct">.</span><span class="ident">wikipedia</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>769</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line769'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>770</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line770'><pre>
</pre></a></td></tr><tr><td valign='top'><small>771</small></td><td valign='top'><ul><li>LongMethod - has approx 8 statements &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line771'><pre>  <span class="keyword">def </span><span class="method">publish_wikipedia_article</span>
</pre></a></td></tr><tr><td valign='top'><small>772</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line772'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">unless</span> <span class="ident">in_wikipedia?</span>
</pre></a></td></tr><tr><td valign='top'><small>773</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line773'><pre>    <span class="keyword">return</span> <span class="constant">false</span> <span class="keyword">unless</span> <span class="ident">visibility_id</span> <span class="punct">==</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">preview</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>774</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line774'><pre>
</pre></a></td></tr><tr><td valign='top'><small>775</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line775'><pre>    <span class="constant">SpeciesSchemaModel</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="ident">execute</span><span class="punct">(&quot;</span><span class="string">UPDATE data_objects SET published=0 WHERE guid='<span class="expr">#{guid}</span>'</span><span class="punct">&quot;);</span>
</pre></a></td></tr><tr><td valign='top'><small>776</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line776'><pre>    <span class="ident">reload</span>
</pre></a></td></tr><tr><td valign='top'><small>777</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line777'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">visibility_id</span> <span class="punct">=</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">visible</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>778</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line778'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">vetted_id</span> <span class="punct">=</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">trusted</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>779</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line779'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">published</span> <span class="punct">=</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>780</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line780'><pre>    <span class="constant">self</span><span class="punct">.</span><span class="ident">save!</span>
</pre></a></td></tr><tr><td valign='top'><small>781</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line781'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>782</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line782'><pre>
</pre></a></td></tr><tr><td valign='top'><small>783</small></td><td valign='top'><ul><li>UncommunicativeName - has the variable name 'r' &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line783'><pre>  <span class="keyword">def </span><span class="method">visible_references</span><span class="punct">(</span><span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>784</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line784'><pre>    <span class="attribute">@all_refs</span> <span class="punct">||=</span> <span class="ident">refs</span><span class="punct">.</span><span class="ident">delete_if</span> <span class="punct">{|</span><span class="ident">r</span><span class="punct">|</span> <span class="ident">r</span><span class="punct">.</span><span class="ident">published</span> <span class="punct">!=</span> <span class="number">1</span> <span class="punct">||</span> <span class="ident">r</span><span class="punct">.</span><span class="ident">visibility_id</span> <span class="punct">!=</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">visible</span><span class="punct">.</span><span class="ident">id</span><span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>785</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line785'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>786</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line786'><pre>
</pre></a></td></tr><tr><td valign='top'><small>787</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line787'><pre>  <span class="keyword">def </span><span class="method">to_s</span>
</pre></a></td></tr><tr><td valign='top'><small>788</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line788'><pre>    <span class="punct">&quot;</span><span class="string">[DataObject id:<span class="expr">#{id}</span>]</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>789</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line789'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>790</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line790'><pre>
</pre></a></td></tr><tr><td valign='top'><small>791</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line791'><pre>  <span class="comment"># Find data objects tagged with a particular tag</span>
</pre></a></td></tr><tr><td valign='top'><small>792</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line792'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>793</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line793'><pre>  <span class="comment"># If no 'value' is provided for the tag, it will find all data objects</span>
</pre></a></td></tr><tr><td valign='top'><small>794</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line794'><pre>  <span class="comment"># tagged with *any* value of the given key (category)</span>
</pre></a></td></tr><tr><td valign='top'><small>795</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line795'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>796</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line796'><pre>  <span class="comment"># Usage:</span>
</pre></a></td></tr><tr><td valign='top'><small>797</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line797'><pre>  <span class="comment">#   DataObject.search_by_tag :color, 'blue'</span>
</pre></a></td></tr><tr><td valign='top'><small>798</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line798'><pre>  <span class="comment">#   DataObject.search_by_tag :color, :blue</span>
</pre></a></td></tr><tr><td valign='top'><small>799</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line799'><pre>  <span class="comment">#   DataObject.search_by_tag &lt;DataObjecTag&gt;</span>
</pre></a></td></tr><tr><td valign='top'><small>800</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line800'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>801</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line801'><pre>  <span class="comment"># TODO this is starting to get really messy ... extract some of this outta here into objects ...</span>
</pre></a></td></tr><tr><td valign='top'><small>802</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line802'><pre>  <span class="comment">#      try a named_scope on TopImage and things like that ... move to other models or to other</span>
</pre></a></td></tr><tr><td valign='top'><small>803</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line803'><pre>  <span class="comment">#      DataObject methods</span>
</pre></a></td></tr><tr><td valign='top'><small>804</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line804'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>805</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line805'><pre>  <span class="keyword">def </span><span class="method">self.search_by_tag</span> <span class="ident">key_or_tag</span><span class="punct">,</span> <span class="ident">value_or_nil</span> <span class="punct">=</span> <span class="constant">nil</span><span class="punct">,</span> <span class="ident">options</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>806</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line806'><pre>    <span class="ident">tag</span> <span class="punct">=</span> <span class="punct">(</span><span class="ident">key_or_tag</span><span class="punct">.</span><span class="ident">is_a?</span><span class="constant">DataObjectTag</span><span class="punct">)</span> <span class="punct">?</span> <span class="ident">key_or_tag</span> <span class="punct">:</span> <span class="constant">DataObjectTag</span><span class="punct">[</span><span class="ident">key_or_tag</span><span class="punct">,</span> <span class="ident">value_or_nil</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>807</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line807'><pre>    <span class="ident">data_object_tags</span> <span class="punct">=</span> <span class="punct">(</span><span class="ident">tag</span><span class="punct">)</span> <span class="punct">?</span> <span class="constant">DataObjectTags</span><span class="punct">.</span><span class="ident">search_by_tag</span><span class="punct">(</span> <span class="ident">tag</span> <span class="punct">)</span> <span class="punct">:</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>808</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line808'><pre>    <span class="keyword">return</span> <span class="punct">[]</span> <span class="keyword">if</span> <span class="ident">data_object_tags</span><span class="punct">.</span><span class="ident">empty?</span>
</pre></a></td></tr><tr><td valign='top'><small>809</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line809'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:clade</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>810</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line810'><pre>      <span class="ident">options</span><span class="punct">[</span><span class="symbol">:clade</span><span class="punct">]</span> <span class="punct">=</span> <span class="punct">[</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:clade</span><span class="punct">]</span> <span class="punct">]</span> <span class="keyword">unless</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:clade</span><span class="punct">].</span><span class="ident">is_a?</span><span class="constant">Array</span>
</pre></a></td></tr><tr><td valign='top'><small>811</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line811'><pre>      <span class="ident">data_object_ids</span> <span class="punct">=</span> <span class="ident">data_object_tags</span><span class="punct">.</span><span class="ident">map</span><span class="punct">(&amp;</span><span class="symbol">:data_object_id</span><span class="punct">).</span><span class="ident">uniq</span>
</pre></a></td></tr><tr><td valign='top'><small>812</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line812'><pre>      <span class="ident">clades</span> <span class="punct">=</span> <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">find</span> <span class="symbol">:all</span><span class="punct">,</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:clade</span><span class="punct">].</span><span class="ident">map</span> <span class="punct">{|</span><span class="ident">id</span><span class="punct">|</span> <span class="punct">&quot;</span><span class="string">id = <span class="expr">#{id}</span></span><span class="punct">&quot;</span> <span class="punct">}.</span><span class="ident">join</span><span class="punct">('</span><span class="string"> OR </span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>813</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line813'><pre>      <span class="keyword">return</span> <span class="punct">[]</span> <span class="keyword">if</span> <span class="ident">clades</span><span class="punct">.</span><span class="ident">empty?</span>
</pre></a></td></tr><tr><td valign='top'><small>814</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line814'><pre>      <span class="ident">sql</span> <span class="punct">=</span> <span class="punct">%[</span><span class="string"><span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>815</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line815'><pre>        <span class="constant">SELECT</span> <span class="constant">DISTINCT</span> <span class="ident">top_images</span><span class="punct">.</span><span class="ident">data_object_id</span>
</pre></a></td></tr><tr><td valign='top'><small>816</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line816'><pre>        <span class="constant">FROM</span> <span class="ident">top_images</span>
</pre></a></td></tr><tr><td valign='top'><small>817</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line817'><pre>        <span class="constant">JOIN</span> <span class="ident">hierarchy_entries</span> <span class="constant">ON</span> <span class="ident">top_images</span><span class="punct">.</span><span class="ident">hierarchy_entry_id</span> <span class="punct">=</span> <span class="ident">hierarchy_entries</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>818</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line818'><pre>        <span class="constant">WHERE</span> <span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>819</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line819'><pre>      <span class="ident">sql</span> <span class="punct">+=</span> <span class="ident">clades</span><span class="punct">.</span><span class="ident">map</span> <span class="punct">{|</span><span class="ident">clade</span><span class="punct">|</span> <span class="punct">&quot;</span><span class="string">(hierarchy_entries.lft &gt;= <span class="expr">#{clade.lft}</span> AND hierarchy_entries.lft &lt;= <span class="expr">#{clade.rgt}</span>)</span><span class="punct">&quot;</span> <span class="punct">}.</span><span class="ident">join</span><span class="punct">('</span><span class="string"> OR </span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>820</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line820'><pre>      <span class="ident">sql</span> <span class="punct">+=</span> <span class="punct">%[</span><span class="string"> AND data_object_id IN (<span class="expr">#{data_object_ids.join(',')}</span>)</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>821</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line821'><pre>      <span class="ident">tagged_images_in_clade</span> <span class="punct">=</span> <span class="constant">TopImage</span><span class="punct">.</span><span class="ident">find_by_sql</span> <span class="ident">sql</span>
</pre></a></td></tr><tr><td valign='top'><small>822</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line822'><pre>      <span class="ident">tagged_images_in_clade</span><span class="punct">.</span><span class="ident">map</span> <span class="punct">{|</span><span class="ident">img</span><span class="punct">|</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">img</span><span class="punct">.</span><span class="ident">data_object_id</span><span class="punct">)</span> <span class="punct">}.</span><span class="ident">uniq</span>
</pre></a></td></tr><tr><td valign='top'><small>823</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line823'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>824</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line824'><pre>      <span class="ident">data_object_tags</span><span class="punct">.</span><span class="ident">map</span><span class="punct">(&amp;</span><span class="symbol">:object</span><span class="punct">).</span><span class="ident">uniq</span>
</pre></a></td></tr><tr><td valign='top'><small>825</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line825'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>826</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line826'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>827</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line827'><pre>
</pre></a></td></tr><tr><td valign='top'><small>828</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line828'><pre>  <span class="comment"># Find data objects tagged with certain tags</span>
</pre></a></td></tr><tr><td valign='top'><small>829</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line829'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>830</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line830'><pre>  <span class="comment"># Usage:</span>
</pre></a></td></tr><tr><td valign='top'><small>831</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line831'><pre>  <span class="comment">#   DataObject.search_by_tags [ [&lt;DataObjecTag&gt;], [&lt;DataObjectTag&gt;, &lt;DataObjectTag] ]</span>
</pre></a></td></tr><tr><td valign='top'><small>832</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line832'><pre>  <span class="comment">#   DataObject.search_by_tags [ [[:key1,'value1']], [[:key2,:value2],['key3',:value3]] ]</span>
</pre></a></td></tr><tr><td valign='top'><small>833</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line833'><pre>  <span class="comment">#</span>
</pre></a></td></tr><tr><td valign='top'><small>834</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line834'><pre>  <span class="comment"># TODO: Optimization is necessary, the way it is now is quite resource hungry</span>
</pre></a></td></tr><tr><td valign='top'><small>835</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line835'><pre>  <span class="keyword">def </span><span class="method">self.search_by_tags</span> <span class="ident">tags</span><span class="punct">,</span> <span class="ident">options</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>836</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line836'><pre>    <span class="ident">t</span> <span class="punct">=</span> <span class="ident">tags</span><span class="punct">.</span><span class="ident">inject</span><span class="punct">([])</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">res</span><span class="punct">,</span><span class="ident">tags_group</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>837</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line837'><pre>      <span class="keyword">if</span> <span class="ident">tags_group</span><span class="punct">.</span><span class="ident">first</span><span class="punct">.</span><span class="ident">is_a?</span><span class="punct">(</span><span class="constant">DataObjectTag</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>838</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line838'><pre>        <span class="ident">res</span> <span class="punct">&lt;&lt;</span> <span class="ident">tags_group</span>
</pre></a></td></tr><tr><td valign='top'><small>839</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line839'><pre>      <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>840</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line840'><pre>        <span class="ident">res</span> <span class="punct">&lt;&lt;</span> <span class="ident">tags_group</span><span class="punct">.</span><span class="ident">map</span> <span class="punct">{|</span><span class="ident">k</span><span class="punct">,</span><span class="ident">v</span><span class="punct">|</span> <span class="constant">DataObjectTag</span><span class="punct">[</span><span class="ident">k</span><span class="punct">,</span><span class="ident">v</span><span class="punct">]}</span>
</pre></a></td></tr><tr><td valign='top'><small>841</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line841'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>842</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line842'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>843</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line843'><pre>    <span class="ident">result</span> <span class="punct">=</span> <span class="ident">t</span><span class="punct">.</span><span class="ident">inject</span><span class="punct">(</span><span class="constant">Set</span><span class="punct">.</span><span class="ident">new</span><span class="punct">)</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">res</span><span class="punct">,</span> <span class="ident">tags_group</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>844</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line844'><pre>      <span class="ident">search</span> <span class="punct">=</span> <span class="punct">(</span><span class="constant">DataObject</span><span class="punct">.</span><span class="ident">search_tags_group</span><span class="punct">(</span><span class="ident">tags_group</span><span class="punct">,</span> <span class="ident">options</span><span class="punct">).</span><span class="ident">to_set</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>845</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line845'><pre>      <span class="ident">res</span> <span class="punct">=</span> <span class="ident">res</span> <span class="punct">?</span> <span class="ident">search</span> <span class="punct">:</span> <span class="ident">res</span><span class="punct">.</span><span class="ident">intersection</span><span class="punct">(</span><span class="ident">search</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>846</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line846'><pre>    <span class="keyword">end</span><span class="punct">.</span><span class="ident">to_a</span>
</pre></a></td></tr><tr><td valign='top'><small>847</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line847'><pre>    <span class="ident">result</span>
</pre></a></td></tr><tr><td valign='top'><small>848</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line848'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>849</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line849'><pre>
</pre></a></td></tr><tr><td valign='top'><small>850</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line850'><pre>  <span class="keyword">def </span><span class="method">self.search_tags_group</span> <span class="ident">tags</span><span class="punct">,</span> <span class="ident">options</span>
</pre></a></td></tr><tr><td valign='top'><small>851</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line851'><pre>    <span class="ident">tags</span><span class="punct">.</span><span class="ident">compact!</span>
</pre></a></td></tr><tr><td valign='top'><small>852</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line852'><pre>    <span class="keyword">return</span> <span class="punct">[]</span> <span class="keyword">if</span> <span class="ident">tags</span><span class="punct">.</span><span class="ident">empty?</span>
</pre></a></td></tr><tr><td valign='top'><small>853</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line853'><pre>    <span class="ident">data_object_tags</span> <span class="punct">=</span> <span class="constant">DataObjectTags</span><span class="punct">.</span><span class="ident">search_by_tags_or</span> <span class="ident">tags</span><span class="punct">,</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user_id</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>854</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line854'><pre>    <span class="keyword">return</span> <span class="punct">[]</span> <span class="keyword">if</span> <span class="ident">data_object_tags</span><span class="punct">.</span><span class="ident">empty?</span>
</pre></a></td></tr><tr><td valign='top'><small>855</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line855'><pre>
</pre></a></td></tr><tr><td valign='top'><small>856</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line856'><pre>    <span class="ident">return_objects</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>857</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line857'><pre>    <span class="ident">data_object_tags</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">dot</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>858</small></td><td valign='top'><ul><li>Found = in conditional.  It should probably be an == &raquo; roodi</li></ul></td><td valign='top'><a name='line858'><pre>      <span class="keyword">if</span> <span class="ident">obj</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">find_by_guid_and_published_and_visibility_id</span><span class="punct">(</span><span class="ident">dot</span><span class="punct">.</span><span class="ident">data_object_guid</span><span class="punct">,</span> <span class="number">1</span><span class="punct">,</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">visible</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="symbol">:order</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">id desc</span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>859</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line859'><pre>        <span class="ident">return_objects</span> <span class="punct">&lt;&lt;</span> <span class="ident">obj</span>
</pre></a></td></tr><tr><td valign='top'><small>860</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line860'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>861</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line861'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>862</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line862'><pre>    <span class="keyword">return</span> <span class="ident">return_objects</span>
</pre></a></td></tr><tr><td valign='top'><small>863</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line863'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>864</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line864'><pre>
</pre></a></td></tr><tr><td valign='top'><small>865</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line865'><pre>  <span class="keyword">def </span><span class="method">self.images_for_taxon_concept</span><span class="punct">(</span><span class="ident">taxon_concept</span><span class="punct">,</span> <span class="ident">options</span> <span class="punct">=</span> <span class="punct">{})</span>
</pre></a></td></tr><tr><td valign='top'><small>866</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line866'><pre>    <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">]</span> <span class="punct">||=</span> <span class="constant">User</span><span class="punct">.</span><span class="ident">create_new</span>
</pre></a></td></tr><tr><td valign='top'><small>867</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line867'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:filter_by_hierarchy</span><span class="punct">]</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:hierarchy</span><span class="punct">].</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>868</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line868'><pre>      <span class="ident">options</span><span class="punct">[</span><span class="symbol">:filter_hierarchy</span><span class="punct">]</span> <span class="punct">=</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:hierarchy</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>869</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line869'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>870</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line870'><pre>    <span class="comment"># the user/agent has the ability to see some unpublished images, so create a UNION</span>
</pre></a></td></tr><tr><td valign='top'><small>871</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line871'><pre>    <span class="ident">show_unpublished</span> <span class="punct">=</span> <span class="punct">(</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">is_content_partner?</span> <span class="punct">||</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">is_curator?</span> <span class="punct">||</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">is_admin?</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>872</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line872'><pre>
</pre></a></td></tr><tr><td valign='top'><small>873</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line873'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:filter_hierarchy</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>874</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line874'><pre>      <span class="comment"># strict lookup</span>
</pre></a></td></tr><tr><td valign='top'><small>875</small></td><td valign='top'><ul><li>Found = in conditional.  It should probably be an == &raquo; roodi</li></ul></td><td valign='top'><a name='line875'><pre>      <span class="keyword">if</span> <span class="ident">entry_in_hierarchy</span> <span class="punct">=</span> <span class="ident">taxon_concept</span><span class="punct">.</span><span class="ident">entry</span><span class="punct">(</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:filter_hierarchy</span><span class="punct">],</span> <span class="constant">true</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>876</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line876'><pre>        <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">preload_associations</span><span class="punct">(</span><span class="ident">entry_in_hierarchy</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>877</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line877'><pre>          <span class="punct">[</span> <span class="symbol">:top_images</span> <span class="punct">=&gt;</span> <span class="symbol">:data_object</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>878</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line878'><pre>          <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:data_objects</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:id</span><span class="punct">,</span> <span class="symbol">:data_type_id</span><span class="punct">,</span> <span class="symbol">:vetted_id</span><span class="punct">,</span> <span class="symbol">:visibility_id</span><span class="punct">,</span> <span class="symbol">:published</span><span class="punct">,</span> <span class="symbol">:guid</span><span class="punct">,</span> <span class="symbol">:data_rating</span> <span class="punct">]</span> <span class="punct">}</span> <span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>879</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line879'><pre>        <span class="ident">image_data_objects</span> <span class="punct">=</span> <span class="ident">entry_in_hierarchy</span><span class="punct">.</span><span class="ident">top_images</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">ti</span><span class="punct">|</span> <span class="ident">ti</span><span class="punct">.</span><span class="ident">data_object</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>880</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line880'><pre>        <span class="keyword">if</span> <span class="ident">show_unpublished</span>
</pre></a></td></tr><tr><td valign='top'><small>881</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line881'><pre>          <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">preload_associations</span><span class="punct">(</span><span class="ident">entry_in_hierarchy</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>882</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line882'><pre>            <span class="punct">[</span> <span class="symbol">:top_unpublished_images</span> <span class="punct">=&gt;</span> <span class="symbol">:data_object</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>883</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line883'><pre>            <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:data_objects</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:id</span><span class="punct">,</span> <span class="symbol">:data_type_id</span><span class="punct">,</span> <span class="symbol">:vetted_id</span><span class="punct">,</span> <span class="symbol">:visibility_id</span><span class="punct">,</span> <span class="symbol">:published</span><span class="punct">,</span> <span class="symbol">:guid</span><span class="punct">,</span> <span class="symbol">:data_rating</span> <span class="punct">]</span> <span class="punct">}</span> <span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>884</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line884'><pre>          <span class="ident">image_data_objects</span> <span class="punct">+=</span> <span class="ident">entry_in_hierarchy</span><span class="punct">.</span><span class="ident">top_unpublished_images</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">ti</span><span class="punct">|</span> <span class="ident">ti</span><span class="punct">.</span><span class="ident">data_object</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>885</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line885'><pre>        <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>886</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line886'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>887</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line887'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>888</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line888'><pre>      <span class="ident">image_data_objects</span> <span class="punct">=</span> <span class="ident">taxon_concept</span><span class="punct">.</span><span class="ident">top_concept_images</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">tci</span><span class="punct">|</span> <span class="ident">tci</span><span class="punct">.</span><span class="ident">data_object</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>889</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line889'><pre>      <span class="comment"># this is a content partner, so we'll want o preload image contributors to prevent</span>
</pre></a></td></tr><tr><td valign='top'><small>890</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line890'><pre>      <span class="comment"># a bunch of queries later on in filter_list_for_user</span>
</pre></a></td></tr><tr><td valign='top'><small>891</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line891'><pre>      <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">is_content_partner?</span>
</pre></a></td></tr><tr><td valign='top'><small>892</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line892'><pre>        <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">preload_associations</span><span class="punct">(</span><span class="ident">image_data_objects</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>893</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line893'><pre>          <span class="punct">[</span> <span class="symbol">:hierarchy_entries</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:hierarchy</span> <span class="punct">=&gt;</span> <span class="symbol">:agent</span> <span class="punct">}</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>894</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line894'><pre>          <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="punct">{</span>
</pre></a></td></tr><tr><td valign='top'><small>895</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line895'><pre>            <span class="symbol">:hierarchy_entries</span> <span class="punct">=&gt;</span> <span class="symbol">:hierarchy_id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>896</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line896'><pre>            <span class="symbol">:agents</span> <span class="punct">=&gt;</span> <span class="punct">[</span><span class="symbol">:id</span><span class="punct">,</span> <span class="symbol">:full_name</span><span class="punct">,</span> <span class="symbol">:homepage</span><span class="punct">,</span> <span class="symbol">:logo_cache_url</span><span class="punct">]</span> <span class="punct">}</span> <span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>897</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line897'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>898</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line898'><pre>      <span class="keyword">if</span> <span class="ident">show_unpublished</span>
</pre></a></td></tr><tr><td valign='top'><small>899</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line899'><pre>        <span class="constant">TaxonConcept</span><span class="punct">.</span><span class="ident">preload_associations</span><span class="punct">(</span><span class="ident">taxon_concept</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>900</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line900'><pre>          <span class="punct">[</span> <span class="symbol">:top_unpublished_concept_images</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:data_object</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:hierarchy_entries</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:hierarchy</span> <span class="punct">=&gt;</span> <span class="symbol">:agent</span> <span class="punct">}</span> <span class="punct">}</span> <span class="punct">}</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>901</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line901'><pre>          <span class="symbol">:select</span> <span class="punct">=&gt;</span> <span class="punct">{</span>
</pre></a></td></tr><tr><td valign='top'><small>902</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line902'><pre>            <span class="symbol">:data_objects</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:id</span><span class="punct">,</span> <span class="symbol">:data_type_id</span><span class="punct">,</span> <span class="symbol">:vetted_id</span><span class="punct">,</span> <span class="symbol">:visibility_id</span><span class="punct">,</span> <span class="symbol">:published</span><span class="punct">,</span> <span class="symbol">:guid</span><span class="punct">,</span> <span class="symbol">:data_rating</span> <span class="punct">],</span>
</pre></a></td></tr><tr><td valign='top'><small>903</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line903'><pre>            <span class="symbol">:hierarchy_entries</span> <span class="punct">=&gt;</span> <span class="symbol">:hierarchy_id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>904</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line904'><pre>            <span class="symbol">:agents</span> <span class="punct">=&gt;</span> <span class="punct">[</span><span class="symbol">:id</span><span class="punct">,</span> <span class="symbol">:full_name</span><span class="punct">,</span> <span class="symbol">:homepage</span><span class="punct">,</span> <span class="symbol">:logo_cache_url</span><span class="punct">]</span> <span class="punct">}</span> <span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>905</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line905'><pre>        <span class="ident">image_data_objects</span> <span class="punct">+=</span> <span class="ident">taxon_concept</span><span class="punct">.</span><span class="ident">top_unpublished_concept_images</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">tci</span><span class="punct">|</span> <span class="ident">tci</span><span class="punct">.</span><span class="ident">data_object</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>906</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line906'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>907</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line907'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>908</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line908'><pre>
</pre></a></td></tr><tr><td valign='top'><small>909</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line909'><pre>    <span class="comment"># remove anything this agent/user should not have access to</span>
</pre></a></td></tr><tr><td valign='top'><small>910</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line910'><pre>    <span class="ident">image_data_objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">filter_list_for_user</span><span class="punct">(</span><span class="ident">image_data_objects</span><span class="punct">,</span> <span class="ident">options</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>911</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line911'><pre>    <span class="comment"># make the list unique by DataObject.guid</span>
</pre></a></td></tr><tr><td valign='top'><small>912</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line912'><pre>    <span class="ident">unique_image_objects</span> <span class="punct">=</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>913</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line913'><pre>    <span class="ident">used_guids</span> <span class="punct">=</span> <span class="punct">{}</span>
</pre></a></td></tr><tr><td valign='top'><small>914</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line914'><pre>    <span class="ident">image_data_objects</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">r</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>915</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line915'><pre>      <span class="ident">unique_image_objects</span> <span class="punct">&lt;&lt;</span> <span class="ident">r</span> <span class="keyword">if</span> <span class="ident">used_guids</span><span class="punct">[</span><span class="ident">r</span><span class="punct">.</span><span class="ident">guid</span><span class="punct">].</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>916</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line916'><pre>      <span class="ident">used_guids</span><span class="punct">[</span><span class="ident">r</span><span class="punct">.</span><span class="ident">guid</span><span class="punct">]</span> <span class="punct">=</span> <span class="constant">true</span>
</pre></a></td></tr><tr><td valign='top'><small>917</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line917'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>918</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line918'><pre>
</pre></a></td></tr><tr><td valign='top'><small>919</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line919'><pre>    <span class="keyword">return</span> <span class="punct">[]</span> <span class="keyword">if</span> <span class="ident">unique_image_objects</span><span class="punct">.</span><span class="ident">empty?</span>
</pre></a></td></tr><tr><td valign='top'><small>920</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line920'><pre>
</pre></a></td></tr><tr><td valign='top'><small>921</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line921'><pre>    <span class="comment"># sort the remainder by our rating criteria</span>
</pre></a></td></tr><tr><td valign='top'><small>922</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line922'><pre>    <span class="ident">unique_image_objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">sort_by_rating</span><span class="punct">(</span><span class="ident">unique_image_objects</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>923</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line923'><pre>
</pre></a></td></tr><tr><td valign='top'><small>924</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line924'><pre>    <span class="comment"># get the rest of the metadata for the selected page</span>
</pre></a></td></tr><tr><td valign='top'><small>925</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line925'><pre>    <span class="ident">image_page</span>  <span class="punct">=</span> <span class="punct">(</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:image_page</span><span class="punct">]</span> <span class="punct">||=</span> <span class="number">1</span><span class="punct">).</span><span class="ident">to_i</span>
</pre></a></td></tr><tr><td valign='top'><small>926</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line926'><pre>    <span class="ident">start</span>       <span class="punct">=</span> <span class="global">$MAX_IMAGES_PER_PAGE</span> <span class="punct">*</span> <span class="punct">(</span><span class="ident">image_page</span> <span class="punct">-</span> <span class="number">1</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>927</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line927'><pre>    <span class="ident">last</span>        <span class="punct">=</span> <span class="ident">start</span> <span class="punct">+</span> <span class="global">$MAX_IMAGES_PER_PAGE</span> <span class="punct">-</span> <span class="number">1</span>
</pre></a></td></tr><tr><td valign='top'><small>928</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line928'><pre>
</pre></a></td></tr><tr><td valign='top'><small>929</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line929'><pre>    <span class="ident">objects_with_metadata</span> <span class="punct">=</span> <span class="ident">eager_load_image_metadata</span><span class="punct">(</span><span class="ident">unique_image_objects</span><span class="punct">[</span><span class="ident">start</span><span class="punct">..</span><span class="ident">last</span><span class="punct">].</span><span class="ident">collect</span> <span class="punct">{|</span><span class="ident">r</span><span class="punct">|</span> <span class="ident">r</span><span class="punct">.</span><span class="ident">id</span><span class="punct">})</span>
</pre></a></td></tr><tr><td valign='top'><small>930</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line930'><pre>    <span class="ident">unique_image_objects</span><span class="punct">[</span><span class="ident">start</span><span class="punct">..</span><span class="ident">last</span><span class="punct">]</span> <span class="punct">=</span> <span class="ident">objects_with_metadata</span> <span class="keyword">unless</span> <span class="ident">objects_with_metadata</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>931</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line931'><pre>    <span class="keyword">if</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">]</span> <span class="punct">&amp;&amp;</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">is_curator?</span> <span class="punct">&amp;&amp;</span> <span class="ident">options</span><span class="punct">[</span><span class="symbol">:user</span><span class="punct">].</span><span class="ident">can_curate?</span><span class="punct">(</span><span class="ident">taxon_concept</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>932</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line932'><pre>      <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">preload_associations</span><span class="punct">(</span><span class="ident">unique_image_objects</span><span class="punct">[</span><span class="ident">start</span><span class="punct">..</span><span class="ident">last</span><span class="punct">],</span> <span class="symbol">:users_data_objects_ratings</span><span class="punct">,</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">users_data_objects_ratings.user_id=<span class="expr">#{options[:user].id}</span></span><span class="punct">&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>933</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line933'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>934</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line934'><pre>    <span class="keyword">return</span> <span class="ident">unique_image_objects</span>
</pre></a></td></tr><tr><td valign='top'><small>935</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line935'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>936</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line936'><pre>
</pre></a></td></tr><tr><td valign='top'><small>937</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line937'><pre>  <span class="keyword">def </span><span class="method">self.eager_load_image_metadata</span><span class="punct">(</span><span class="ident">data_object_ids</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>938</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line938'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">data_object_ids</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>939</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line939'><pre>    <span class="ident">add_include</span> <span class="punct">=</span> <span class="punct">[</span> <span class="symbol">:all_comments</span> <span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>940</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line940'><pre>    <span class="ident">add_select</span> <span class="punct">=</span> <span class="punct">{</span> <span class="symbol">:comments</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:parent_id</span><span class="punct">,</span> <span class="symbol">:visible_at</span> <span class="punct">]</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>941</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line941'><pre>    <span class="ident">except</span> <span class="punct">=</span> <span class="punct">[</span> <span class="symbol">:info_items</span> <span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>942</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line942'><pre>    <span class="ident">objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">core_relationships</span><span class="punct">(</span><span class="symbol">:except</span> <span class="punct">=&gt;</span> <span class="ident">except</span><span class="punct">,</span> <span class="symbol">:add_include</span> <span class="punct">=&gt;</span> <span class="ident">add_include</span><span class="punct">,</span> <span class="symbol">:add_select</span> <span class="punct">=&gt;</span> <span class="ident">add_select</span><span class="punct">).</span><span class="ident">find_all_by_id</span><span class="punct">(</span><span class="ident">data_object_ids</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>943</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line943'><pre>    <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">sort_by_rating</span><span class="punct">(</span><span class="ident">objects</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>944</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line944'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>945</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line945'><pre>
</pre></a></td></tr><tr><td valign='top'><small>946</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line946'><pre>  <span class="keyword">def </span><span class="method">self.latest_published_version_of</span><span class="punct">(</span><span class="ident">data_object_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>947</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line947'><pre>    <span class="ident">obj</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">find_by_sql</span><span class="punct">(&quot;</span><span class="string">SELECT do.* FROM data_objects do_old JOIN data_objects do ON (do_old.guid=do.guid) WHERE do_old.id=<span class="expr">#{data_object_id}</span> AND do.published=1 ORDER BY id desc LIMIT 1</span><span class="punct">&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>948</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line948'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">obj</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>949</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line949'><pre>    <span class="keyword">return</span> <span class="ident">obj</span><span class="punct">[</span><span class="number">0</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>950</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line950'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>951</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line951'><pre>
</pre></a></td></tr><tr><td valign='top'><small>952</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line952'><pre>  <span class="keyword">def </span><span class="method">self.latest_published_version_ids_of_do_ids</span><span class="punct">(</span><span class="ident">data_object_ids</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>953</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line953'><pre>    <span class="ident">latest_published_version_ids</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">find_by_sql</span><span class="punct">(&quot;</span><span class="string">SELECT do.id FROM data_objects do_old JOIN data_objects do ON (do_old.guid=do.guid) WHERE do.id IN (<span class="expr">#{data_object_ids.collect{|doi| doi}.join(', ')}</span>) AND do.published=1</span><span class="punct">&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>954</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line954'><pre>    <span class="ident">latest_published_version_ids</span><span class="punct">.</span><span class="ident">collect!</span><span class="punct">{|</span><span class="ident">data_object</span><span class="punct">|</span> <span class="punct">(</span><span class="ident">data_object</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)}.</span><span class="ident">uniq!</span>
</pre></a></td></tr><tr><td valign='top'><small>955</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line955'><pre>    <span class="ident">latest_published_version_ids</span>
</pre></a></td></tr><tr><td valign='top'><small>956</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line956'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>957</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line957'><pre>
</pre></a></td></tr><tr><td valign='top'><small>958</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line958'><pre>  <span class="keyword">def </span><span class="method">self.latest_published_version_of_guid</span><span class="punct">(</span><span class="ident">guid</span><span class="punct">,</span> <span class="ident">options</span><span class="punct">={})</span>
</pre></a></td></tr><tr><td valign='top'><small>959</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line959'><pre>    <span class="ident">options</span><span class="punct">[</span><span class="symbol">:return_only_id</span><span class="punct">]</span> <span class="punct">||=</span> <span class="constant">false</span>
</pre></a></td></tr><tr><td valign='top'><small>960</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line960'><pre>    <span class="ident">select</span> <span class="punct">=</span> <span class="punct">(</span><span class="ident">options</span><span class="punct">[</span><span class="symbol">:return_only_id</span><span class="punct">])</span> <span class="punct">?</span> <span class="punct">'</span><span class="string">id</span><span class="punct">'</span> <span class="punct">:</span> <span class="punct">'</span><span class="string">*</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>961</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line961'><pre>    <span class="ident">obj</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">find_by_sql</span><span class="punct">(&quot;</span><span class="string">SELECT <span class="expr">#{select}</span> FROM data_objects WHERE guid='<span class="expr">#{guid}</span>' AND published=1 ORDER BY id desc LIMIT 1</span><span class="punct">&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>962</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line962'><pre>    <span class="keyword">return</span> <span class="constant">nil</span> <span class="keyword">if</span> <span class="ident">obj</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>963</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line963'><pre>    <span class="keyword">return</span> <span class="ident">obj</span><span class="punct">[</span><span class="number">0</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>964</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line964'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>965</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line965'><pre>
</pre></a></td></tr><tr><td valign='top'><small>966</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line966'><pre>
</pre></a></td></tr><tr><td valign='top'><small>967</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line967'><pre>  <span class="keyword">def </span><span class="method">self.tc_ids_from_do_ids</span><span class="punct">(</span><span class="ident">obj_ids</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>968</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line968'><pre>    <span class="ident">obj_tc_id</span> <span class="punct">=</span> <span class="punct">{}</span> <span class="comment">#same Hash.new</span>
</pre></a></td></tr><tr><td valign='top'><small>969</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line969'><pre>    <span class="keyword">if</span><span class="punct">(</span><span class="ident">obj_ids</span><span class="punct">.</span><span class="ident">length</span> <span class="punct">&gt;</span> <span class="number">0</span><span class="punct">)</span> <span class="keyword">then</span>
</pre></a></td></tr><tr><td valign='top'><small>970</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line970'><pre>      <span class="ident">sql</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">SELECT dotc.taxon_concept_id tc_id , do.data_type_id, do.id do_id<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>971</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line971'><pre>      <span class="constant">FROM</span> <span class="ident">data_objects_taxon_concepts</span> <span class="ident">dotc</span>
</pre></a></td></tr><tr><td valign='top'><small>972</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line972'><pre>      <span class="constant">JOIN</span> <span class="ident">data_objects</span> <span class="keyword">do</span> <span class="constant">ON</span> <span class="ident">dotc</span><span class="punct">.</span><span class="ident">data_object_id</span> <span class="punct">=</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>973</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line973'><pre>      <span class="constant">JOIN</span> <span class="ident">taxon_concepts</span> <span class="ident">tc</span> <span class="constant">ON</span> <span class="ident">dotc</span><span class="punct">.</span><span class="ident">taxon_concept_id</span> <span class="punct">=</span> <span class="ident">tc</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>974</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line974'><pre>      <span class="constant">WHERE</span> <span class="ident">tc</span><span class="punct">.</span><span class="ident">published</span> <span class="constant">AND</span> <span class="ident">dotc</span><span class="punct">.</span><span class="ident">data_object_id</span> <span class="constant">IN</span> <span class="punct">(</span><span class="comment">#{obj_ids.join(',')})&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>975</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line975'><pre>      <span class="ident">rset</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">find_by_sql</span><span class="punct">([</span><span class="ident">sql</span><span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>976</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line976'><pre>      <span class="ident">rset</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">post</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>977</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line977'><pre>        <span class="ident">obj_tc_id</span><span class="punct">[&quot;</span><span class="string"><span class="expr">#{post.do_id}</span></span><span class="punct">&quot;]</span> <span class="punct">=</span> <span class="ident">post</span><span class="punct">.</span><span class="ident">tc_id</span>
</pre></a></td></tr><tr><td valign='top'><small>978</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line978'><pre>        <span class="keyword">if</span><span class="punct">(</span><span class="ident">post</span><span class="punct">.</span><span class="ident">data_type_id</span> <span class="punct">==</span> <span class="number">3</span><span class="punct">)</span><span class="keyword">then</span> <span class="ident">obj_tc_id</span><span class="punct">[&quot;</span><span class="string">datatype<span class="expr">#{post.do_id}</span></span><span class="punct">&quot;]</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">text</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>979</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line979'><pre>                                  <span class="keyword">else</span> <span class="ident">obj_tc_id</span><span class="punct">[&quot;</span><span class="string">datatype<span class="expr">#{post.do_id}</span></span><span class="punct">&quot;]</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">image</span><span class="punct">&quot;</span>
</pre></a></td></tr><tr><td valign='top'><small>980</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line980'><pre>        <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>981</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line981'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>982</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line982'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>983</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line983'><pre>    <span class="keyword">return</span> <span class="ident">obj_tc_id</span>
</pre></a></td></tr><tr><td valign='top'><small>984</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line984'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>985</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line985'><pre>
</pre></a></td></tr><tr><td valign='top'><small>986</small></td><td valign='top'><ul><li>Duplication - calls Activity.untrusted twice &raquo; reek</li><li>Duplication - calls Activity.untrusted.id twice &raquo; reek</li><li>Duplication - calls hierarchy_entry.associated_by_curator twice &raquo; reek</li><li>Duplication - calls id twice &raquo; reek</li><li>Duplication - calls log.untrust_reasons twice &raquo; reek</li><li>Duplication - calls log.untrust_reasons.collect twice &raquo; reek</li><li>Duplication - calls ur.untrust_reason_id twice &raquo; reek</li><li>LongMethod - has approx 7 statements &raquo; reek</li><li>LowCohesion - refers to hierarchy_entry more than self &raquo; reek</li><li>Complexity 6 &raquo; saikuro</li></ul></td><td valign='top'><a name='line986'><pre>  <span class="keyword">def </span><span class="method">untrust_reasons</span><span class="punct">(</span><span class="ident">hierarchy_entry</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>987</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line987'><pre>    <span class="keyword">if</span> <span class="ident">hierarchy_entry</span><span class="punct">.</span><span class="ident">associated_by_curator</span>
</pre></a></td></tr><tr><td valign='top'><small>988</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line988'><pre>      <span class="ident">object_id</span> <span class="punct">=</span> <span class="constant">CuratedDataObjectsHierarchyEntry</span><span class="punct">.</span><span class="ident">find_by_data_object_id_and_hierarchy_entry_id_and_user_id</span><span class="punct">(</span><span class="ident">id</span><span class="punct">,</span><span class="ident">hierarchy_entry</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span><span class="ident">hierarchy_entry</span><span class="punct">.</span><span class="ident">associated_by_curator</span><span class="punct">).</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>989</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line989'><pre>      <span class="ident">log</span> <span class="punct">=</span> <span class="constant">CuratorActivityLog</span><span class="punct">.</span><span class="ident">find_all_by_object_id_and_changeable_object_type_id_and_action_id</span><span class="punct">(</span><span class="ident">object_id</span><span class="punct">,</span> <span class="constant">ChangeableObjectType</span><span class="punct">.</span><span class="ident">curated_data_objects_hierarchy_entry</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="constant">Activity</span><span class="punct">.</span><span class="ident">untrusted</span><span class="punct">.</span><span class="ident">id</span><span class="punct">).</span><span class="ident">last</span>
</pre></a></td></tr><tr><td valign='top'><small>990</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line990'><pre>      <span class="ident">log</span> <span class="punct">?</span> <span class="ident">log</span><span class="punct">.</span><span class="ident">untrust_reasons</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{|</span><span class="ident">ur</span><span class="punct">|</span> <span class="ident">ur</span><span class="punct">.</span><span class="ident">untrust_reason_id</span><span class="punct">}</span> <span class="punct">:</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>991</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line991'><pre>    <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>992</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line992'><pre>      <span class="ident">log</span> <span class="punct">=</span> <span class="constant">CuratorActivityLog</span><span class="punct">.</span><span class="ident">find_all_by_object_id_and_changeable_object_type_id_and_action_id</span><span class="punct">(</span><span class="ident">id</span><span class="punct">,</span> <span class="constant">ChangeableObjectType</span><span class="punct">.</span><span class="ident">data_object</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="constant">Activity</span><span class="punct">.</span><span class="ident">untrusted</span><span class="punct">.</span><span class="ident">id</span><span class="punct">).</span><span class="ident">last</span>
</pre></a></td></tr><tr><td valign='top'><small>993</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line993'><pre>      <span class="ident">log</span> <span class="punct">?</span> <span class="ident">log</span><span class="punct">.</span><span class="ident">untrust_reasons</span><span class="punct">.</span><span class="ident">collect</span><span class="punct">{|</span><span class="ident">ur</span><span class="punct">|</span> <span class="ident">ur</span><span class="punct">.</span><span class="ident">untrust_reason_id</span><span class="punct">}</span> <span class="punct">:</span> <span class="punct">[]</span>
</pre></a></td></tr><tr><td valign='top'><small>994</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line994'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>995</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line995'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>996</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line996'><pre>
</pre></a></td></tr><tr><td valign='top'><small>997</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line997'><pre>  <span class="keyword">def </span><span class="method">self.generate_dataobject_stats</span><span class="punct">(</span><span class="ident">harvest_event_id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>998</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line998'><pre>    <span class="ident">ids</span> <span class="punct">=</span> <span class="ident">connection</span><span class="punct">.</span><span class="ident">select_values</span><span class="punct">(&quot;</span><span class="string">SELECT do.id<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>999</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line999'><pre>      <span class="constant">FROM</span> <span class="ident">data_objects_harvest_events</span> <span class="ident">dohe</span>
</pre></a></td></tr><tr><td valign='top'><small>1000</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1000'><pre>      <span class="constant">JOIN</span> <span class="ident">data_objects</span> <span class="keyword">do</span> <span class="constant">ON</span> <span class="ident">dohe</span><span class="punct">.</span><span class="ident">data_object_id</span> <span class="punct">=</span> <span class="keyword">do</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>1001</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1001'><pre>      <span class="constant">WHERE</span> <span class="ident">dohe</span><span class="punct">.</span><span class="ident">harvest_event_id</span> <span class="punct">=</span> <span class="comment">#{harvest_event_id}&quot;)</span>
</pre></a></td></tr><tr><td valign='top'><small>1002</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1002'><pre>    <span class="ident">data_objects</span> <span class="punct">=</span> <span class="constant">DataObject</span><span class="punct">.</span><span class="ident">find_all_by_id</span><span class="punct">(</span><span class="ident">ids</span><span class="punct">,</span> <span class="symbol">:include</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="symbol">:vetted</span><span class="punct">,</span> <span class="symbol">:data_type</span> <span class="punct">])</span>
</pre></a></td></tr><tr><td valign='top'><small>1003</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1003'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1004</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1004'><pre>    <span class="comment"># to get total_taxa count</span>
</pre></a></td></tr><tr><td valign='top'><small>1005</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1005'><pre>    <span class="ident">query</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">Select count(distinct he.taxon_concept_id) taxa_count<span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>1006</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1006'><pre>    <span class="constant">From</span> <span class="ident">harvest_events_hierarchy_entries</span> <span class="ident">hehe</span>
</pre></a></td></tr><tr><td valign='top'><small>1007</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1007'><pre>    <span class="constant">Join</span> <span class="ident">hierarchy_entries</span> <span class="ident">he</span> <span class="constant">ON</span> <span class="ident">hehe</span><span class="punct">.</span><span class="ident">hierarchy_entry_id</span> <span class="punct">=</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>1008</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1008'><pre>    <span class="constant">Join</span> <span class="ident">taxon_concepts</span> <span class="ident">tc</span> <span class="constant">ON</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">taxon_concept_id</span> <span class="punct">=</span> <span class="ident">tc</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>1009</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1009'><pre>    <span class="ident">where</span> <span class="ident">hehe</span><span class="punct">.</span><span class="ident">harvest_event_id</span> <span class="punct">=</span> <span class="comment">#{harvest_event_id}</span>
</pre></a></td></tr><tr><td valign='top'><small>1010</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1010'><pre>    <span class="keyword">and</span> <span class="ident">tc</span><span class="punct">.</span><span class="ident">supercedure_id</span><span class="punct">=</span><span class="number">0</span> <span class="keyword">and</span> <span class="ident">tc</span><span class="punct">.</span><span class="ident">vetted_id</span> <span class="punct">!=</span> <span class="comment">#{Vetted.untrusted.id}</span>
</pre></a></td></tr><tr><td valign='top'><small>1011</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1011'><pre>    <span class="keyword">and</span> <span class="ident">tc</span><span class="punct">.</span><span class="ident">published</span><span class="punct">=</span><span class="number">1</span><span class="punct">&quot;</span><span class="string"><span class="normal">
</span></span></pre></a></td></tr><tr><td valign='top'><small>1012</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1012'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1013</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1013'><pre>    <span class="ident">total_taxa</span> <span class="punct">=</span> <span class="ident">connection</span><span class="punct">.</span><span class="ident">select_values</span><span class="punct">(</span><span class="ident">query</span><span class="punct">)[</span><span class="number">0</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1014</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1014'><pre>    <span class="punct">[</span><span class="ident">data_objects</span><span class="punct">,</span> <span class="ident">total_taxa</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1015</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1015'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1016</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1016'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1017</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1017'><pre>  <span class="keyword">def </span><span class="method">flickr_photo_id</span>
</pre></a></td></tr><tr><td valign='top'><small>1018</small></td><td valign='top'><ul><li>Found = in conditional.  It should probably be an == &raquo; roodi</li></ul></td><td valign='top'><a name='line1018'><pre>    <span class="keyword">if</span> <span class="ident">matches</span> <span class="punct">=</span> <span class="ident">source_url</span><span class="punct">.</span><span class="ident">match</span><span class="punct">(/</span><span class="regex">flickr<span class="escape">\.</span>com<span class="escape">\/</span>photos<span class="escape">\/</span>.*?<span class="escape">\/</span>([0-9]+)<span class="escape">\/</span></span><span class="punct">/)</span>
</pre></a></td></tr><tr><td valign='top'><small>1019</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1019'><pre>      <span class="keyword">return</span> <span class="ident">matches</span><span class="punct">[</span><span class="number">1</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1020</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1020'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1021</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1021'><pre>    <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>1022</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1022'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1023</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1023'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1024</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1024'><pre>  <span class="comment"># TODO - we need to make sure that the user_id of curated_dohe is added to the HE...</span>
</pre></a></td></tr><tr><td valign='top'><small>1025</small></td><td valign='top'><ul><li>LongMethod - has approx 6 statements &raquo; reek</li><li>LowCohesion - refers to cdohe more than self &raquo; reek</li><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1025'><pre>  <span class="keyword">def </span><span class="method">curated_hierarchy_entries</span>
</pre></a></td></tr><tr><td valign='top'><small>1026</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1026'><pre>    <span class="ident">hierarchy_entries</span> <span class="punct">+</span> <span class="ident">curated_data_objects_hierarchy_entries</span><span class="punct">.</span><span class="ident">map</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">cdohe</span><span class="punct">|</span>
</pre></a></td></tr><tr><td valign='top'><small>1027</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1027'><pre>      <span class="ident">he</span> <span class="punct">=</span> <span class="ident">cdohe</span><span class="punct">.</span><span class="ident">hierarchy_entry</span>
</pre></a></td></tr><tr><td valign='top'><small>1028</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1028'><pre>      <span class="ident">he</span><span class="punct">.</span><span class="ident">associated_by_curator</span> <span class="punct">=</span> <span class="ident">cdohe</span><span class="punct">.</span><span class="ident">user</span>
</pre></a></td></tr><tr><td valign='top'><small>1029</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1029'><pre>      <span class="ident">he</span><span class="punct">.</span><span class="ident">vetted_id</span> <span class="punct">=</span> <span class="ident">cdohe</span><span class="punct">.</span><span class="ident">vetted_id</span>
</pre></a></td></tr><tr><td valign='top'><small>1030</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1030'><pre>      <span class="ident">he</span><span class="punct">.</span><span class="ident">visibility_id</span> <span class="punct">=</span> <span class="ident">cdohe</span><span class="punct">.</span><span class="ident">visibility_id</span>
</pre></a></td></tr><tr><td valign='top'><small>1031</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1031'><pre>      <span class="ident">he</span>
</pre></a></td></tr><tr><td valign='top'><small>1032</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1032'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1033</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1033'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1034</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1034'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1035</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1035'><pre>  <span class="keyword">def </span><span class="method">published_entries</span>
</pre></a></td></tr><tr><td valign='top'><small>1036</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1036'><pre>    <span class="ident">curated_hierarchy_entries</span><span class="punct">.</span><span class="ident">select</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">he</span><span class="punct">|</span> <span class="ident">he</span><span class="punct">.</span><span class="ident">published</span> <span class="punct">==</span> <span class="number">1</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>1037</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1037'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1038</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1038'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1039</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1039'><pre>  <span class="keyword">def </span><span class="method">first_concept_name</span>
</pre></a></td></tr><tr><td valign='top'><small>1040</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1040'><pre>    <span class="ident">sorted_entries</span> <span class="punct">=</span> <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">sort_by_vetted</span><span class="punct">(</span><span class="ident">hierarchy_entries</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1041</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1041'><pre>    <span class="ident">sorted_entries</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">name</span><span class="punct">.</span><span class="ident">string</span> <span class="keyword">rescue</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>1042</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1042'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1043</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1043'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1044</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1044'><pre>  <span class="keyword">def </span><span class="method">first_taxon_concept</span>
</pre></a></td></tr><tr><td valign='top'><small>1045</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1045'><pre>    <span class="ident">sorted_entries</span> <span class="punct">=</span> <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">sort_by_vetted</span><span class="punct">(</span><span class="ident">hierarchy_entries</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1046</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1046'><pre>    <span class="ident">sorted_entries</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">taxon_concept</span> <span class="keyword">rescue</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>1047</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1047'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1048</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1048'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1049</small></td><td valign='top'><ul><li>Complexity 2 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1049'><pre>  <span class="keyword">def </span><span class="method">first_hierarchy_entry</span>
</pre></a></td></tr><tr><td valign='top'><small>1050</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1050'><pre>    <span class="ident">sorted_entries</span> <span class="punct">=</span> <span class="constant">HierarchyEntry</span><span class="punct">.</span><span class="ident">sort_by_vetted</span><span class="punct">(</span><span class="ident">hierarchy_entries</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1051</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1051'><pre>    <span class="ident">sorted_entries</span><span class="punct">[</span><span class="number">0</span><span class="punct">]</span> <span class="keyword">rescue</span> <span class="constant">nil</span>
</pre></a></td></tr><tr><td valign='top'><small>1052</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1052'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1053</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1053'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1054</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1054'><pre>  <span class="comment"># TODO - check this against rating_for_user ... why the difference?</span>
</pre></a></td></tr><tr><td valign='top'><small>1055</small></td><td valign='top'><ul><li>UncommunicativeName - has the parameter name 'u' &raquo; reek</li><li>LowCohesion - refers to ratings_from_user more than self &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1055'><pre>  <span class="keyword">def </span><span class="method">rating_from_user</span><span class="punct">(</span><span class="ident">u</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1056</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1056'><pre>    <span class="ident">ratings_from_user</span> <span class="punct">=</span> <span class="ident">users_data_objects_ratings</span><span class="punct">.</span><span class="ident">select</span><span class="punct">{</span> <span class="punct">|</span><span class="ident">udor</span><span class="punct">|</span> <span class="ident">udor</span><span class="punct">.</span><span class="ident">user_id</span> <span class="punct">==</span> <span class="ident">u</span><span class="punct">.</span><span class="ident">id</span> <span class="punct">}</span>
</pre></a></td></tr><tr><td valign='top'><small>1057</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1057'><pre>    <span class="keyword">return</span> <span class="ident">ratings_from_user</span><span class="punct">[</span><span class="number">0</span><span class="punct">]</span> <span class="keyword">unless</span> <span class="ident">ratings_from_user</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>1058</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1058'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1059</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1059'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1060</small></td><td valign='top'><ul><li>Duplication - calls description twice &raquo; reek</li><li>Duplication - calls object_title twice &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1060'><pre>  <span class="keyword">def </span><span class="method">short_title</span>
</pre></a></td></tr><tr><td valign='top'><small>1061</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1061'><pre>    <span class="keyword">return</span> <span class="ident">object_title</span> <span class="keyword">unless</span> <span class="ident">object_title</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>1062</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1062'><pre>    <span class="comment"># TODO - ideally, we should extract some of the logic from data_objects/show to make this &quot;Image of Procyon Lotor&quot;.</span>
</pre></a></td></tr><tr><td valign='top'><small>1063</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1063'><pre>    <span class="keyword">return</span> <span class="ident">data_type</span><span class="punct">.</span><span class="ident">label</span> <span class="keyword">if</span> <span class="ident">description</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>1064</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1064'><pre>    <span class="ident">st</span> <span class="punct">=</span> <span class="ident">description</span><span class="punct">.</span><span class="ident">gsub</span><span class="punct">(/</span><span class="regex"><span class="escape">\n</span>.*$</span><span class="punct">/,</span> <span class="punct">'</span><span class="string"></span><span class="punct">')</span>
</pre></a></td></tr><tr><td valign='top'><small>1065</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1065'><pre>    <span class="ident">st</span><span class="punct">.</span><span class="ident">truncate</span><span class="punct">(</span><span class="number">32</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1066</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1066'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1067</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1067'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1068</small></td><td valign='top'><ul><li>Duplication - calls users_data_objects 3 times &raquo; reek</li><li>Duplication - calls users_data_objects[0] twice &raquo; reek</li><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1068'><pre>  <span class="keyword">def </span><span class="method">added_by_user?</span>
</pre></a></td></tr><tr><td valign='top'><small>1069</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1069'><pre>    <span class="ident">users_data_objects</span> <span class="punct">&amp;&amp;</span> <span class="ident">users_data_objects</span><span class="punct">[</span><span class="number">0</span><span class="punct">]</span> <span class="punct">&amp;&amp;</span> <span class="punct">!</span> <span class="ident">users_data_objects</span><span class="punct">[</span><span class="number">0</span><span class="punct">].</span><span class="ident">user</span><span class="punct">.</span><span class="ident">blank?</span>
</pre></a></td></tr><tr><td valign='top'><small>1070</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1070'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1071</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1071'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1072</small></td><td valign='top'><ul><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1072'><pre>  <span class="keyword">def </span><span class="method">add_curated_association</span><span class="punct">(</span><span class="ident">user</span><span class="punct">,</span> <span class="ident">hierarchy_entry</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1073</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1073'><pre>    <span class="ident">cdohe</span> <span class="punct">=</span> <span class="constant">CuratedDataObjectsHierarchyEntry</span><span class="punct">.</span><span class="ident">create</span><span class="punct">(</span><span class="symbol">:hierarchy_entry_id</span> <span class="punct">=&gt;</span> <span class="ident">hierarchy_entry</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>1074</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1074'><pre>                                                    <span class="symbol">:data_object_id</span> <span class="punct">=&gt;</span> <span class="constant">self</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span> <span class="symbol">:user_id</span> <span class="punct">=&gt;</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>1075</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1075'><pre>                                                    <span class="symbol">:vetted_id</span> <span class="punct">=&gt;</span> <span class="constant">Vetted</span><span class="punct">.</span><span class="ident">trusted</span><span class="punct">.</span><span class="ident">id</span><span class="punct">,</span>
</pre></a></td></tr><tr><td valign='top'><small>1076</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1076'><pre>                                                    <span class="symbol">:visibility_id</span> <span class="punct">=&gt;</span> <span class="constant">Visibility</span><span class="punct">.</span><span class="ident">visible</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1077</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1077'><pre>    <span class="ident">log_association</span><span class="punct">(</span><span class="ident">cdohe</span><span class="punct">,</span> <span class="ident">user</span><span class="punct">,</span> <span class="ident">hierarchy_entry</span><span class="punct">,</span> <span class="symbol">:add_association</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1078</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1078'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1079</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1079'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1080</small></td><td valign='top'><ul><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1080'><pre>  <span class="keyword">def </span><span class="method">remove_curated_association</span><span class="punct">(</span><span class="ident">user</span><span class="punct">,</span> <span class="ident">hierarchy_entry</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1081</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1081'><pre>    <span class="ident">cdohe</span> <span class="punct">=</span> <span class="constant">CuratedDataObjectsHierarchyEntry</span><span class="punct">.</span><span class="ident">find_by_data_object_id_and_hierarchy_entry_id</span><span class="punct">(</span><span class="ident">id</span><span class="punct">,</span> <span class="ident">hierarchy_entry</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1082</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1082'><pre>    <span class="keyword">raise</span> <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Exceptions</span><span class="punct">::</span><span class="constant">ObjectNotFound</span> <span class="keyword">if</span> <span class="ident">cdohe</span><span class="punct">.</span><span class="ident">nil?</span>
</pre></a></td></tr><tr><td valign='top'><small>1083</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1083'><pre>    <span class="keyword">raise</span> <span class="constant">EOL</span><span class="punct">::</span><span class="constant">Exceptions</span><span class="punct">::</span><span class="constant">WrongCurator</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(&quot;</span><span class="string">user did not create this association</span><span class="punct">&quot;)</span> <span class="keyword">unless</span> <span class="ident">cdohe</span><span class="punct">.</span><span class="ident">user_id</span> <span class="punct">=</span> <span class="ident">user</span><span class="punct">.</span><span class="ident">id</span>
</pre></a></td></tr><tr><td valign='top'><small>1084</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1084'><pre>    <span class="ident">cdohe</span><span class="punct">.</span><span class="ident">destroy</span>
</pre></a></td></tr><tr><td valign='top'><small>1085</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1085'><pre>    <span class="ident">log_association</span><span class="punct">(</span><span class="ident">cdohe</span><span class="punct">,</span> <span class="ident">user</span><span class="punct">,</span> <span class="ident">hierarchy_entry</span><span class="punct">,</span> <span class="symbol">:remove_association</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1086</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1086'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1087</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1087'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1088</small></td><td valign='top'><ul><li>Duplication - calls hierarchy_entry.id twice &raquo; reek</li><li>Duplication - calls id twice &raquo; reek</li><li>LongMethod - has approx 6 statements &raquo; reek</li><li>LowCohesion - refers to all_params more than self &raquo; reek</li><li>Complexity 3 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1088'><pre>  <span class="keyword">def </span><span class="method">curate_association</span><span class="punct">(</span><span class="ident">user</span><span class="punct">,</span> <span class="ident">hierarchy_entry</span><span class="punct">,</span> <span class="ident">all_params</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1089</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1089'><pre>    <span class="keyword">if</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:curate_vetted_status</span><span class="punct">]</span> <span class="punct">||</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:curate_visibility_status</span><span class="punct">]</span> <span class="punct">||</span> <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:curation_comment_status</span><span class="punct">]</span>
</pre></a></td></tr><tr><td valign='top'><small>1090</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1090'><pre>      <span class="keyword">if</span> <span class="ident">hierarchy_entry</span><span class="punct">.</span><span class="ident">associated_by_curator</span>
</pre></a></td></tr><tr><td valign='top'><small>1091</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1091'><pre>        <span class="ident">cdohe</span> <span class="punct">=</span> <span class="constant">CuratedDataObjectsHierarchyEntry</span><span class="punct">.</span><span class="ident">find_by_data_object_id_and_hierarchy_entry_id</span><span class="punct">(</span><span class="ident">id</span><span class="punct">,</span> <span class="ident">hierarchy_entry</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1092</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1092'><pre>        <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:changeable_object_type</span><span class="punct">]</span> <span class="punct">=</span> <span class="punct">'</span><span class="string">curated_data_objects_hierarchy_entry</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>1093</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1093'><pre>        <span class="ident">cdohe</span><span class="punct">.</span><span class="ident">curate</span><span class="punct">(</span><span class="ident">user</span><span class="punct">,</span> <span class="ident">all_params</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1094</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1094'><pre>      <span class="keyword">else</span>
</pre></a></td></tr><tr><td valign='top'><small>1095</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1095'><pre>        <span class="ident">dohe</span> <span class="punct">=</span> <span class="constant">DataObjectsHierarchyEntry</span><span class="punct">.</span><span class="ident">find_by_data_object_id_and_hierarchy_entry_id</span><span class="punct">(</span><span class="ident">id</span><span class="punct">,</span> <span class="ident">hierarchy_entry</span><span class="punct">.</span><span class="ident">id</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1096</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1096'><pre>        <span class="ident">all_params</span><span class="punct">[</span><span class="symbol">:changeable_object_type</span><span class="punct">]</span> <span class="punct">=</span> <span class="punct">'</span><span class="string">data_object</span><span class="punct">'</span>
</pre></a></td></tr><tr><td valign='top'><small>1097</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1097'><pre>        <span class="ident">dohe</span><span class="punct">.</span><span class="ident">curate</span><span class="punct">(</span><span class="ident">user</span><span class="punct">,</span> <span class="ident">all_params</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1098</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1098'><pre>      <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1099</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1099'><pre>      <span class="comment"># TODO - this will need to be re-designed:</span>
</pre></a></td></tr><tr><td valign='top'><small>1100</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1100'><pre>      <span class="comment"># update_solr_index(opts)</span>
</pre></a></td></tr><tr><td valign='top'><small>1101</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1101'><pre>    <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1102</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1102'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1103</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1103'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1104</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1104'><pre><span class="ident">private</span>
</pre></a></td></tr><tr><td valign='top'><small>1105</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1105'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1106</small></td><td valign='top'><ul><li>LowCohesion - doesn't depend on instance state &raquo; reek</li><li>LongParameterList - has 4 parameters &raquo; reek</li><li>LowCohesion - refers to action more than self &raquo; reek</li><li>LowCohesion - refers to user more than self &raquo; reek</li><li>Complexity 1 &raquo; saikuro</li></ul></td><td valign='top'><a name='line1106'><pre>  <span class="keyword">def </span><span class="method">log_association</span><span class="punct">(</span><span class="ident">object</span><span class="punct">,</span> <span class="ident">user</span><span class="punct">,</span> <span class="ident">hierarchy_entry</span><span class="punct">,</span> <span class="ident">action</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1107</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1107'><pre>    <span class="ident">user</span><span class="punct">.</span><span class="ident">track_curator_activity</span><span class="punct">(</span><span class="ident">object</span><span class="punct">,</span> <span class="punct">'</span><span class="string">curated_data_objects_hierarchy_entry</span><span class="punct">',</span> <span class="ident">action</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">)</span>
</pre></a></td></tr><tr><td valign='top'><small>1108</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1108'><pre>  <span class="keyword">end</span>
</pre></a></td></tr><tr><td valign='top'><small>1109</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1109'><pre>
</pre></a></td></tr><tr><td valign='top'><small>1110</small></td><td valign='top'>&nbsp;</td><td valign='top'><a name='line1110'><pre><span class="keyword">end</span>
</pre></a></td></tr><table></body></html>
